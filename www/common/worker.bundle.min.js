!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self)["cryptpad-worker-min"]={})}(this,(function(e){"use strict";function n(e,n){return n.forEach((function(n){n&&"string"!=typeof n&&!Array.isArray(n)&&Object.keys(n).forEach((function(t){if("default"!==t&&!(t in e)){var r=Object.getOwnPropertyDescriptor(n,t);Object.defineProperty(e,t,r.get?r:{enumerable:!0,get:function(){return n[t]}})}}))})),Object.freeze(e)}var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function r(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function o(e){if(e.__esModule)return e;var n=e.default;if("function"==typeof n){var t=function e(){return this instanceof e?Reflect.construct(n,arguments,this.constructor):n.apply(this,arguments)};t.prototype=n.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(e).forEach((function(n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})})),t}var a,i={exports:{}},c={exports:{}},s={exports:{}};function u(){return a||(a=1,function(e){var n;n=function(){var e=function(){},n=function(){return(new Date).getTime()},t=function(e,n,t){e.timeouts.push(setTimeout(n,t))},r=function(n,r){n.ws&&(n.ws.onmessage=e,n.ws.onopen=e,n.ws.close(),r?n.ws.onclose({reason:"offline"}):t(n,(function(){n.ws&&n.ws.onclose({reason:"forced closed because websocket failed to close"})}),1e4))},o=function(e,n){return!!e.ws&&(e.ws.send(JSON.stringify(n)),!0)},a=function(e,n){return function(e,t){var r=n[e];if(!r)throw new Error("no such event "+e);r.push(t)}},i=function(e,n,t,r){var o=r[n];if(!o)throw new Error("no such event "+n);var a=o.indexOf(t);-1!==a&&o.splice(a,1)},c=function(e,t,r){if(e.channels[t])return new Promise((function(n){n(e.channels[t])}));var c=e.queues.p2;1===r?c=e.queues.p1:3===r&&(c=e.queues.p3);var s={queue:c,onMessage:[],onJoin:[],onLeave:[],members:[],jSeq:e.seq++},u={message:s.onMessage,join:s.onJoin,leave:s.onLeave},l={_:s,time:n(),id:t,members:s.members,bcast:function(t){return function(e,t,r){var a=e.channels[t],i=e.seq++,c=[i,"MSG",t,r];if(!a)return new Promise((function(e,n){n({type:"NO_SUCH_CHANNEL",message:JSON.stringify(c)})}));var s=o(e,c);return new Promise((function(t,r){s?e.requests[i]={reject:r,resolve:t,time:n()}:r({type:"DISCONNECTED",message:JSON.stringify(c)})}))}(e,l.id,t)},leave:function(t){return function(e,t,r){if(e.channels[t]){if(delete e.channels[t],e.ws&&1===e.ws.readyState){var a=e.seq++;o(e,[a,"LEAVE",t,r]);var i=function(){};e.requests[a]={reject:i,resolve:i,time:n()}}}else console.debug("no such channel",t)}(e,l.id,t)},on:a(0,u),off:function(e,n){i(0,e,n,u)}};e.requests[s.jSeq]=l;var f=[s.jSeq,"JOIN",t],d=o(e,f);return new Promise((function(e,n){d?(l._.resolve=e,l._.reject=n):n({type:"DISCONNECTED",message:JSON.stringify(f)})}))},s=function(t){var r={message:t.onMessage,disconnect:t.onDisconnect,reconnect:t.onReconnect},s={webChannels:t.channels,getLag:function(){return function(e){return e.ws?e.pingOutstanding?Math.max(n()-e.timeOfLastPingSent,e.lastObservedLag):e.lastObservedLag:null}(t)},sendto:function(e,r){return function(e,t,r){var a=e.seq++,i=[a,"MSG",t,r],c=o(e,i);return new Promise((function(t,r){c?e.requests[a]={reject:r,resolve:t,time:n()}:r({type:"DISCONNECTED",message:JSON.stringify(i)})}))}(t,e,r)},join:function(e,n){return c(t,e,n)},disconnect:function(){return function(n){if(n.ws){var t=n.ws.onclose;n.ws.onclose=e,n.ws.close(),t({reason:"network.disconnect() called"})}n.timeouts.forEach(clearTimeout),n.timeouts=[]}(t)},on:a(0,r),off:function(e,n){i(0,e,n,r)}};return s.__defineGetter__("webChannels",(function(){return Object.keys(t.channels).map((function(e){return t.channels[e]}))})),s},u=function(e,t){var a=void 0;try{a=JSON.parse(t.data)}catch(e){return void console.log(e.stack)}if(e.timeOfLastMsgReceived=n(),0===a[0]){if("IDENT"===a[2])return e.uid=a[3],e.ws._onident(),void(e.pingInterval=setInterval((function(){if(!(n()-e.timeOfLastPingReceived<15e3||(n()-e.timeOfLastMsgReceived>6e4&&r(e),e.pingOutstanding))){var t=e.seq++,a=n();e.timeOfLastPingSent=a,e.pingOutstanding++,e.requests[t]={time:a,ping:a},o(e,[t,"PING"])}}),5e3));if(e.uid){if("PING"===a[2])return a[2]="PONG",void o(e,a);if("MSG"===a[2]){var i=void 0,c=e.queues.p2;if(a[3]===e.uid)i=e.onMessage,"number"==typeof a[5]&&(1===a[5]&&(c=e.queues.p1),3===a[5]&&(c=e.queues.p3));else{var s=e.channels[a[3]];if(!s)return void console.log("message to non-existent chan "+JSON.stringify(a));i=s._.onMessage,s._.queue&&(c=s._.queue)}c.push({msg:a,h:i}),function(e){if(!e.queues.busy){var n=function(){var t=e.queues.p1.shift()||e.queues.p2.shift()||e.queues.p3.shift();if(t){e.queues.busy=!0;var r=t.h,o=t.msg;r.forEach((function(e){setTimeout((function(){try{e(o[4],o[1])}catch(e){console.error(e)}}))})),setTimeout((function(){n()}))}else e.queues.busy=!1};n()}}(e)}if("LEAVE"===a[2]){var u=e.channels[a[3]];if(!u)return void(a[1]!==e.uid&&console.log("leaving non-existent chan "+JSON.stringify(a)));var l=u._.members.indexOf(a[1]);-1!==l&&u._.members.splice(l,1),u._.onLeave.forEach((function(e){try{e(a[1],a[4])}catch(e){console.log(e.stack)}}))}if("JOIN"===a[2]){var f=e.channels[a[3]];if(!f)return void console.log("ERROR: join to non-existent chan "+JSON.stringify(a));if(-1!==f._.members.indexOf(a[1]))return;var d=-1!==f._.members.indexOf(e.uid);f._.members.push(a[1]),d||a[1]!==e.uid||(f.myID=e.uid,f._.resolve(f)),d&&f._.onJoin.forEach((function(e){try{e(a[1])}catch(e){console.log(e.stack)}}))}}}else{var h=e.requests[a[0]];if(!h)return void console.log("error: "+JSON.stringify(a));if(delete e.requests[a[0]],"ACK"===a[1]){if(h.ping)return e.lastObservedLag=n()-Number(h.ping),e.timeOfLastPingReceived=n(),void e.pingOutstanding--;h.resolve()}else if("JACK"===a[1]){if(h._){if(!a[2])throw new Error("wrong type of ACK for channel join");return h.id=a[2],void(e.channels[h.id]=h)}h.resolve()}else if("ERROR"===a[1])if("function"==typeof h.reject)h.reject({type:a[2],message:a[3]});else if(h._&&"function"==typeof h._.reject){if("EJOINED"===a[2]&&!e.channels[a[3]])return h.id=a[3],void(e.channels[h.id]=h);h._.reject({type:a[2],message:a[3]})}else console.error(a);else h.reject({type:"UNKNOWN",message:JSON.stringify(a)})}};return{connect:function(o,a){a=a||function(e){return new globalThis.WebSocket(e)};var i={ws:null,seq:1,uid:null,network:null,channels:{},onMessage:[],onDisconnect:[],onReconnect:[],timeouts:[],requests:{},pingInterval:null,queues:{p1:[],p2:[],p3:[]},timeOfLastPingSent:-1,timeOfLastPingReceived:-1,timeOfLastMsgReceived:-1,lastObservedLag:0,pingOutstanding:0};i.network=s(i);var c=e,l=e;"undefined"!=typeof window&&window.addEventListener("offline",(function(){-1===["localhost","127.0.0.1",""].indexOf(window.location.hostname)&&r(i,!0)}));var f=function(){var s=i.ws=a(o);i.timeOfLastPingSent=i.timeOfLastPingReceived=n(),i.timeOfLastMsgReceived=n(),s.onmessage=function(e){return u(i,e)},s.onclose=function(n){s.onclose=e,clearInterval(i.pingInterval),i.timeouts.forEach(clearTimeout),i.ws=null,i.uid&&(i.uid=null,i.onDisconnect.forEach((function(e){try{e(n.reason)}catch(e){console.log(e.stack)}}))),t(i,f,i.uid?0:7e3)},s.onopen=function(){t(i,(function(){i.uid||(l({type:"TIMEOUT",message:"waited 30000ms"}),c=l=e,r(i))}),3e4)},i.ws._onident=function(){i.timeOfLastPingReceived=n(),i.timeOfLastMsgReceived=n(),i.lastObservedLag=n()-i.timeOfLastPingSent,c!==e?(c(i.network),c=l=e):(i.channels={},i.requests={},i.pingOutstanding=0,i.onReconnect.forEach((function(e){try{e(i.uid)}catch(e){console.log(e.stack)}})))}};return new Promise((function(e,n){c=e,l=n,f()}))}}},e.exports?e.exports=n():window.netflux_websocket=n()}(s)),s.exports}function l(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var f,d={exports:{}};function h(){return f||(f=1,function(e){!function(e){var n=function(e){var n,t=new Float64Array(16);if(e)for(n=0;n<e.length;n++)t[n]=e[n];return t},t=function(){throw new Error("no PRNG")},r=new Uint8Array(16),o=new Uint8Array(32);o[0]=9;var a=n(),i=n([1]),c=n([56129,1]),s=n([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),u=n([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),f=n([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),d=n([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),h=n([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);function p(e,n,t,r){e[n]=t>>24&255,e[n+1]=t>>16&255,e[n+2]=t>>8&255,e[n+3]=255&t,e[n+4]=r>>24&255,e[n+5]=r>>16&255,e[n+6]=r>>8&255,e[n+7]=255&r}function v(e,n,t,r,o){var a,i=0;for(a=0;a<o;a++)i|=e[n+a]^t[r+a];return(1&i-1>>>8)-1}function y(e,n,t,r){return v(e,n,t,r,16)}function m(e,n,t,r){return v(e,n,t,r,32)}function g(e,n,t,r){!function(e,n,t,r){for(var o,a=255&r[0]|(255&r[1])<<8|(255&r[2])<<16|(255&r[3])<<24,i=255&t[0]|(255&t[1])<<8|(255&t[2])<<16|(255&t[3])<<24,c=255&t[4]|(255&t[5])<<8|(255&t[6])<<16|(255&t[7])<<24,s=255&t[8]|(255&t[9])<<8|(255&t[10])<<16|(255&t[11])<<24,u=255&t[12]|(255&t[13])<<8|(255&t[14])<<16|(255&t[15])<<24,l=255&r[4]|(255&r[5])<<8|(255&r[6])<<16|(255&r[7])<<24,f=255&n[0]|(255&n[1])<<8|(255&n[2])<<16|(255&n[3])<<24,d=255&n[4]|(255&n[5])<<8|(255&n[6])<<16|(255&n[7])<<24,h=255&n[8]|(255&n[9])<<8|(255&n[10])<<16|(255&n[11])<<24,p=255&n[12]|(255&n[13])<<8|(255&n[14])<<16|(255&n[15])<<24,v=255&r[8]|(255&r[9])<<8|(255&r[10])<<16|(255&r[11])<<24,y=255&t[16]|(255&t[17])<<8|(255&t[18])<<16|(255&t[19])<<24,m=255&t[20]|(255&t[21])<<8|(255&t[22])<<16|(255&t[23])<<24,g=255&t[24]|(255&t[25])<<8|(255&t[26])<<16|(255&t[27])<<24,E=255&t[28]|(255&t[29])<<8|(255&t[30])<<16|(255&t[31])<<24,b=255&r[12]|(255&r[13])<<8|(255&r[14])<<16|(255&r[15])<<24,A=a,_=i,w=c,O=s,D=u,S=l,T=f,x=d,C=h,N=p,I=v,R=y,P=m,k=g,M=E,F=b,L=0;L<20;L+=2)A^=(o=(P^=(o=(C^=(o=(D^=(o=A+P|0)<<7|o>>>25)+A|0)<<9|o>>>23)+D|0)<<13|o>>>19)+C|0)<<18|o>>>14,S^=(o=(_^=(o=(k^=(o=(N^=(o=S+_|0)<<7|o>>>25)+S|0)<<9|o>>>23)+N|0)<<13|o>>>19)+k|0)<<18|o>>>14,I^=(o=(T^=(o=(w^=(o=(M^=(o=I+T|0)<<7|o>>>25)+I|0)<<9|o>>>23)+M|0)<<13|o>>>19)+w|0)<<18|o>>>14,F^=(o=(R^=(o=(x^=(o=(O^=(o=F+R|0)<<7|o>>>25)+F|0)<<9|o>>>23)+O|0)<<13|o>>>19)+x|0)<<18|o>>>14,A^=(o=(O^=(o=(w^=(o=(_^=(o=A+O|0)<<7|o>>>25)+A|0)<<9|o>>>23)+_|0)<<13|o>>>19)+w|0)<<18|o>>>14,S^=(o=(D^=(o=(x^=(o=(T^=(o=S+D|0)<<7|o>>>25)+S|0)<<9|o>>>23)+T|0)<<13|o>>>19)+x|0)<<18|o>>>14,I^=(o=(N^=(o=(C^=(o=(R^=(o=I+N|0)<<7|o>>>25)+I|0)<<9|o>>>23)+R|0)<<13|o>>>19)+C|0)<<18|o>>>14,F^=(o=(M^=(o=(k^=(o=(P^=(o=F+M|0)<<7|o>>>25)+F|0)<<9|o>>>23)+P|0)<<13|o>>>19)+k|0)<<18|o>>>14;A=A+a|0,_=_+i|0,w=w+c|0,O=O+s|0,D=D+u|0,S=S+l|0,T=T+f|0,x=x+d|0,C=C+h|0,N=N+p|0,I=I+v|0,R=R+y|0,P=P+m|0,k=k+g|0,M=M+E|0,F=F+b|0,e[0]=A>>>0&255,e[1]=A>>>8&255,e[2]=A>>>16&255,e[3]=A>>>24&255,e[4]=_>>>0&255,e[5]=_>>>8&255,e[6]=_>>>16&255,e[7]=_>>>24&255,e[8]=w>>>0&255,e[9]=w>>>8&255,e[10]=w>>>16&255,e[11]=w>>>24&255,e[12]=O>>>0&255,e[13]=O>>>8&255,e[14]=O>>>16&255,e[15]=O>>>24&255,e[16]=D>>>0&255,e[17]=D>>>8&255,e[18]=D>>>16&255,e[19]=D>>>24&255,e[20]=S>>>0&255,e[21]=S>>>8&255,e[22]=S>>>16&255,e[23]=S>>>24&255,e[24]=T>>>0&255,e[25]=T>>>8&255,e[26]=T>>>16&255,e[27]=T>>>24&255,e[28]=x>>>0&255,e[29]=x>>>8&255,e[30]=x>>>16&255,e[31]=x>>>24&255,e[32]=C>>>0&255,e[33]=C>>>8&255,e[34]=C>>>16&255,e[35]=C>>>24&255,e[36]=N>>>0&255,e[37]=N>>>8&255,e[38]=N>>>16&255,e[39]=N>>>24&255,e[40]=I>>>0&255,e[41]=I>>>8&255,e[42]=I>>>16&255,e[43]=I>>>24&255,e[44]=R>>>0&255,e[45]=R>>>8&255,e[46]=R>>>16&255,e[47]=R>>>24&255,e[48]=P>>>0&255,e[49]=P>>>8&255,e[50]=P>>>16&255,e[51]=P>>>24&255,e[52]=k>>>0&255,e[53]=k>>>8&255,e[54]=k>>>16&255,e[55]=k>>>24&255,e[56]=M>>>0&255,e[57]=M>>>8&255,e[58]=M>>>16&255,e[59]=M>>>24&255,e[60]=F>>>0&255,e[61]=F>>>8&255,e[62]=F>>>16&255,e[63]=F>>>24&255}(e,n,t,r)}function E(e,n,t,r){!function(e,n,t,r){for(var o,a=255&r[0]|(255&r[1])<<8|(255&r[2])<<16|(255&r[3])<<24,i=255&t[0]|(255&t[1])<<8|(255&t[2])<<16|(255&t[3])<<24,c=255&t[4]|(255&t[5])<<8|(255&t[6])<<16|(255&t[7])<<24,s=255&t[8]|(255&t[9])<<8|(255&t[10])<<16|(255&t[11])<<24,u=255&t[12]|(255&t[13])<<8|(255&t[14])<<16|(255&t[15])<<24,l=255&r[4]|(255&r[5])<<8|(255&r[6])<<16|(255&r[7])<<24,f=255&n[0]|(255&n[1])<<8|(255&n[2])<<16|(255&n[3])<<24,d=255&n[4]|(255&n[5])<<8|(255&n[6])<<16|(255&n[7])<<24,h=255&n[8]|(255&n[9])<<8|(255&n[10])<<16|(255&n[11])<<24,p=255&n[12]|(255&n[13])<<8|(255&n[14])<<16|(255&n[15])<<24,v=255&r[8]|(255&r[9])<<8|(255&r[10])<<16|(255&r[11])<<24,y=255&t[16]|(255&t[17])<<8|(255&t[18])<<16|(255&t[19])<<24,m=255&t[20]|(255&t[21])<<8|(255&t[22])<<16|(255&t[23])<<24,g=255&t[24]|(255&t[25])<<8|(255&t[26])<<16|(255&t[27])<<24,E=255&t[28]|(255&t[29])<<8|(255&t[30])<<16|(255&t[31])<<24,b=255&r[12]|(255&r[13])<<8|(255&r[14])<<16|(255&r[15])<<24,A=0;A<20;A+=2)a^=(o=(m^=(o=(h^=(o=(u^=(o=a+m|0)<<7|o>>>25)+a|0)<<9|o>>>23)+u|0)<<13|o>>>19)+h|0)<<18|o>>>14,l^=(o=(i^=(o=(g^=(o=(p^=(o=l+i|0)<<7|o>>>25)+l|0)<<9|o>>>23)+p|0)<<13|o>>>19)+g|0)<<18|o>>>14,v^=(o=(f^=(o=(c^=(o=(E^=(o=v+f|0)<<7|o>>>25)+v|0)<<9|o>>>23)+E|0)<<13|o>>>19)+c|0)<<18|o>>>14,b^=(o=(y^=(o=(d^=(o=(s^=(o=b+y|0)<<7|o>>>25)+b|0)<<9|o>>>23)+s|0)<<13|o>>>19)+d|0)<<18|o>>>14,a^=(o=(s^=(o=(c^=(o=(i^=(o=a+s|0)<<7|o>>>25)+a|0)<<9|o>>>23)+i|0)<<13|o>>>19)+c|0)<<18|o>>>14,l^=(o=(u^=(o=(d^=(o=(f^=(o=l+u|0)<<7|o>>>25)+l|0)<<9|o>>>23)+f|0)<<13|o>>>19)+d|0)<<18|o>>>14,v^=(o=(p^=(o=(h^=(o=(y^=(o=v+p|0)<<7|o>>>25)+v|0)<<9|o>>>23)+y|0)<<13|o>>>19)+h|0)<<18|o>>>14,b^=(o=(E^=(o=(g^=(o=(m^=(o=b+E|0)<<7|o>>>25)+b|0)<<9|o>>>23)+m|0)<<13|o>>>19)+g|0)<<18|o>>>14;e[0]=a>>>0&255,e[1]=a>>>8&255,e[2]=a>>>16&255,e[3]=a>>>24&255,e[4]=l>>>0&255,e[5]=l>>>8&255,e[6]=l>>>16&255,e[7]=l>>>24&255,e[8]=v>>>0&255,e[9]=v>>>8&255,e[10]=v>>>16&255,e[11]=v>>>24&255,e[12]=b>>>0&255,e[13]=b>>>8&255,e[14]=b>>>16&255,e[15]=b>>>24&255,e[16]=f>>>0&255,e[17]=f>>>8&255,e[18]=f>>>16&255,e[19]=f>>>24&255,e[20]=d>>>0&255,e[21]=d>>>8&255,e[22]=d>>>16&255,e[23]=d>>>24&255,e[24]=h>>>0&255,e[25]=h>>>8&255,e[26]=h>>>16&255,e[27]=h>>>24&255,e[28]=p>>>0&255,e[29]=p>>>8&255,e[30]=p>>>16&255,e[31]=p>>>24&255}(e,n,t,r)}var b=new Uint8Array([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]);function A(e,n,t,r,o,a,i){var c,s,u=new Uint8Array(16),l=new Uint8Array(64);for(s=0;s<16;s++)u[s]=0;for(s=0;s<8;s++)u[s]=a[s];for(;o>=64;){for(g(l,u,i,b),s=0;s<64;s++)e[n+s]=t[r+s]^l[s];for(c=1,s=8;s<16;s++)c=c+(255&u[s])|0,u[s]=255&c,c>>>=8;o-=64,n+=64,r+=64}if(o>0)for(g(l,u,i,b),s=0;s<o;s++)e[n+s]=t[r+s]^l[s];return 0}function _(e,n,t,r,o){var a,i,c=new Uint8Array(16),s=new Uint8Array(64);for(i=0;i<16;i++)c[i]=0;for(i=0;i<8;i++)c[i]=r[i];for(;t>=64;){for(g(s,c,o,b),i=0;i<64;i++)e[n+i]=s[i];for(a=1,i=8;i<16;i++)a=a+(255&c[i])|0,c[i]=255&a,a>>>=8;t-=64,n+=64}if(t>0)for(g(s,c,o,b),i=0;i<t;i++)e[n+i]=s[i];return 0}function w(e,n,t,r,o){var a=new Uint8Array(32);E(a,r,o,b);for(var i=new Uint8Array(8),c=0;c<8;c++)i[c]=r[c+16];return _(e,n,t,i,a)}function O(e,n,t,r,o,a,i){var c=new Uint8Array(32);E(c,a,i,b);for(var s=new Uint8Array(8),u=0;u<8;u++)s[u]=a[u+16];return A(e,n,t,r,o,s,c)}var D=function(e){var n,t,r,o,a,i,c,s;this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.leftover=0,this.fin=0,n=255&e[0]|(255&e[1])<<8,this.r[0]=8191&n,t=255&e[2]|(255&e[3])<<8,this.r[1]=8191&(n>>>13|t<<3),r=255&e[4]|(255&e[5])<<8,this.r[2]=7939&(t>>>10|r<<6),o=255&e[6]|(255&e[7])<<8,this.r[3]=8191&(r>>>7|o<<9),a=255&e[8]|(255&e[9])<<8,this.r[4]=255&(o>>>4|a<<12),this.r[5]=a>>>1&8190,i=255&e[10]|(255&e[11])<<8,this.r[6]=8191&(a>>>14|i<<2),c=255&e[12]|(255&e[13])<<8,this.r[7]=8065&(i>>>11|c<<5),s=255&e[14]|(255&e[15])<<8,this.r[8]=8191&(c>>>8|s<<8),this.r[9]=s>>>5&127,this.pad[0]=255&e[16]|(255&e[17])<<8,this.pad[1]=255&e[18]|(255&e[19])<<8,this.pad[2]=255&e[20]|(255&e[21])<<8,this.pad[3]=255&e[22]|(255&e[23])<<8,this.pad[4]=255&e[24]|(255&e[25])<<8,this.pad[5]=255&e[26]|(255&e[27])<<8,this.pad[6]=255&e[28]|(255&e[29])<<8,this.pad[7]=255&e[30]|(255&e[31])<<8};function S(e,n,t,r,o,a){var i=new D(a);return i.update(t,r,o),i.finish(e,n),0}function T(e,n,t,r,o,a){var i=new Uint8Array(16);return S(i,0,t,r,o,a),y(e,n,i,0)}function x(e,n,t,r,o){var a;if(t<32)return-1;for(O(e,0,n,0,t,r,o),S(e,16,e,32,t-32,e),a=0;a<16;a++)e[a]=0;return 0}function C(e,n,t,r,o){var a,i=new Uint8Array(32);if(t<32)return-1;if(w(i,0,32,r,o),0!==T(n,16,n,32,t-32,i))return-1;for(O(e,0,n,0,t,r,o),a=0;a<32;a++)e[a]=0;return 0}function N(e,n){var t;for(t=0;t<16;t++)e[t]=0|n[t]}function I(e){var n,t,r=1;for(n=0;n<16;n++)t=e[n]+r+65535,r=Math.floor(t/65536),e[n]=t-65536*r;e[0]+=r-1+37*(r-1)}function R(e,n,t){for(var r,o=~(t-1),a=0;a<16;a++)r=o&(e[a]^n[a]),e[a]^=r,n[a]^=r}function P(e,t){var r,o,a,i=n(),c=n();for(r=0;r<16;r++)c[r]=t[r];for(I(c),I(c),I(c),o=0;o<2;o++){for(i[0]=c[0]-65517,r=1;r<15;r++)i[r]=c[r]-65535-(i[r-1]>>16&1),i[r-1]&=65535;i[15]=c[15]-32767-(i[14]>>16&1),a=i[15]>>16&1,i[14]&=65535,R(c,i,1-a)}for(r=0;r<16;r++)e[2*r]=255&c[r],e[2*r+1]=c[r]>>8}function k(e,n){var t=new Uint8Array(32),r=new Uint8Array(32);return P(t,e),P(r,n),m(t,0,r,0)}function M(e){var n=new Uint8Array(32);return P(n,e),1&n[0]}function F(e,n){var t;for(t=0;t<16;t++)e[t]=n[2*t]+(n[2*t+1]<<8);e[15]&=32767}function L(e,n,t){for(var r=0;r<16;r++)e[r]=n[r]+t[r]}function K(e,n,t){for(var r=0;r<16;r++)e[r]=n[r]-t[r]}function H(e,n,t){var r,o,a=0,i=0,c=0,s=0,u=0,l=0,f=0,d=0,h=0,p=0,v=0,y=0,m=0,g=0,E=0,b=0,A=0,_=0,w=0,O=0,D=0,S=0,T=0,x=0,C=0,N=0,I=0,R=0,P=0,k=0,M=0,F=t[0],L=t[1],K=t[2],H=t[3],j=t[4],U=t[5],B=t[6],V=t[7],Y=t[8],G=t[9],J=t[10],q=t[11],W=t[12],z=t[13],Q=t[14],X=t[15];a+=(r=n[0])*F,i+=r*L,c+=r*K,s+=r*H,u+=r*j,l+=r*U,f+=r*B,d+=r*V,h+=r*Y,p+=r*G,v+=r*J,y+=r*q,m+=r*W,g+=r*z,E+=r*Q,b+=r*X,i+=(r=n[1])*F,c+=r*L,s+=r*K,u+=r*H,l+=r*j,f+=r*U,d+=r*B,h+=r*V,p+=r*Y,v+=r*G,y+=r*J,m+=r*q,g+=r*W,E+=r*z,b+=r*Q,A+=r*X,c+=(r=n[2])*F,s+=r*L,u+=r*K,l+=r*H,f+=r*j,d+=r*U,h+=r*B,p+=r*V,v+=r*Y,y+=r*G,m+=r*J,g+=r*q,E+=r*W,b+=r*z,A+=r*Q,_+=r*X,s+=(r=n[3])*F,u+=r*L,l+=r*K,f+=r*H,d+=r*j,h+=r*U,p+=r*B,v+=r*V,y+=r*Y,m+=r*G,g+=r*J,E+=r*q,b+=r*W,A+=r*z,_+=r*Q,w+=r*X,u+=(r=n[4])*F,l+=r*L,f+=r*K,d+=r*H,h+=r*j,p+=r*U,v+=r*B,y+=r*V,m+=r*Y,g+=r*G,E+=r*J,b+=r*q,A+=r*W,_+=r*z,w+=r*Q,O+=r*X,l+=(r=n[5])*F,f+=r*L,d+=r*K,h+=r*H,p+=r*j,v+=r*U,y+=r*B,m+=r*V,g+=r*Y,E+=r*G,b+=r*J,A+=r*q,_+=r*W,w+=r*z,O+=r*Q,D+=r*X,f+=(r=n[6])*F,d+=r*L,h+=r*K,p+=r*H,v+=r*j,y+=r*U,m+=r*B,g+=r*V,E+=r*Y,b+=r*G,A+=r*J,_+=r*q,w+=r*W,O+=r*z,D+=r*Q,S+=r*X,d+=(r=n[7])*F,h+=r*L,p+=r*K,v+=r*H,y+=r*j,m+=r*U,g+=r*B,E+=r*V,b+=r*Y,A+=r*G,_+=r*J,w+=r*q,O+=r*W,D+=r*z,S+=r*Q,T+=r*X,h+=(r=n[8])*F,p+=r*L,v+=r*K,y+=r*H,m+=r*j,g+=r*U,E+=r*B,b+=r*V,A+=r*Y,_+=r*G,w+=r*J,O+=r*q,D+=r*W,S+=r*z,T+=r*Q,x+=r*X,p+=(r=n[9])*F,v+=r*L,y+=r*K,m+=r*H,g+=r*j,E+=r*U,b+=r*B,A+=r*V,_+=r*Y,w+=r*G,O+=r*J,D+=r*q,S+=r*W,T+=r*z,x+=r*Q,C+=r*X,v+=(r=n[10])*F,y+=r*L,m+=r*K,g+=r*H,E+=r*j,b+=r*U,A+=r*B,_+=r*V,w+=r*Y,O+=r*G,D+=r*J,S+=r*q,T+=r*W,x+=r*z,C+=r*Q,N+=r*X,y+=(r=n[11])*F,m+=r*L,g+=r*K,E+=r*H,b+=r*j,A+=r*U,_+=r*B,w+=r*V,O+=r*Y,D+=r*G,S+=r*J,T+=r*q,x+=r*W,C+=r*z,N+=r*Q,I+=r*X,m+=(r=n[12])*F,g+=r*L,E+=r*K,b+=r*H,A+=r*j,_+=r*U,w+=r*B,O+=r*V,D+=r*Y,S+=r*G,T+=r*J,x+=r*q,C+=r*W,N+=r*z,I+=r*Q,R+=r*X,g+=(r=n[13])*F,E+=r*L,b+=r*K,A+=r*H,_+=r*j,w+=r*U,O+=r*B,D+=r*V,S+=r*Y,T+=r*G,x+=r*J,C+=r*q,N+=r*W,I+=r*z,R+=r*Q,P+=r*X,E+=(r=n[14])*F,b+=r*L,A+=r*K,_+=r*H,w+=r*j,O+=r*U,D+=r*B,S+=r*V,T+=r*Y,x+=r*G,C+=r*J,N+=r*q,I+=r*W,R+=r*z,P+=r*Q,k+=r*X,b+=(r=n[15])*F,i+=38*(_+=r*K),c+=38*(w+=r*H),s+=38*(O+=r*j),u+=38*(D+=r*U),l+=38*(S+=r*B),f+=38*(T+=r*V),d+=38*(x+=r*Y),h+=38*(C+=r*G),p+=38*(N+=r*J),v+=38*(I+=r*q),y+=38*(R+=r*W),m+=38*(P+=r*z),g+=38*(k+=r*Q),E+=38*(M+=r*X),a=(r=(a+=38*(A+=r*L))+(o=1)+65535)-65536*(o=Math.floor(r/65536)),i=(r=i+o+65535)-65536*(o=Math.floor(r/65536)),c=(r=c+o+65535)-65536*(o=Math.floor(r/65536)),s=(r=s+o+65535)-65536*(o=Math.floor(r/65536)),u=(r=u+o+65535)-65536*(o=Math.floor(r/65536)),l=(r=l+o+65535)-65536*(o=Math.floor(r/65536)),f=(r=f+o+65535)-65536*(o=Math.floor(r/65536)),d=(r=d+o+65535)-65536*(o=Math.floor(r/65536)),h=(r=h+o+65535)-65536*(o=Math.floor(r/65536)),p=(r=p+o+65535)-65536*(o=Math.floor(r/65536)),v=(r=v+o+65535)-65536*(o=Math.floor(r/65536)),y=(r=y+o+65535)-65536*(o=Math.floor(r/65536)),m=(r=m+o+65535)-65536*(o=Math.floor(r/65536)),g=(r=g+o+65535)-65536*(o=Math.floor(r/65536)),E=(r=E+o+65535)-65536*(o=Math.floor(r/65536)),b=(r=b+o+65535)-65536*(o=Math.floor(r/65536)),a=(r=(a+=o-1+37*(o-1))+(o=1)+65535)-65536*(o=Math.floor(r/65536)),i=(r=i+o+65535)-65536*(o=Math.floor(r/65536)),c=(r=c+o+65535)-65536*(o=Math.floor(r/65536)),s=(r=s+o+65535)-65536*(o=Math.floor(r/65536)),u=(r=u+o+65535)-65536*(o=Math.floor(r/65536)),l=(r=l+o+65535)-65536*(o=Math.floor(r/65536)),f=(r=f+o+65535)-65536*(o=Math.floor(r/65536)),d=(r=d+o+65535)-65536*(o=Math.floor(r/65536)),h=(r=h+o+65535)-65536*(o=Math.floor(r/65536)),p=(r=p+o+65535)-65536*(o=Math.floor(r/65536)),v=(r=v+o+65535)-65536*(o=Math.floor(r/65536)),y=(r=y+o+65535)-65536*(o=Math.floor(r/65536)),m=(r=m+o+65535)-65536*(o=Math.floor(r/65536)),g=(r=g+o+65535)-65536*(o=Math.floor(r/65536)),E=(r=E+o+65535)-65536*(o=Math.floor(r/65536)),b=(r=b+o+65535)-65536*(o=Math.floor(r/65536)),a+=o-1+37*(o-1),e[0]=a,e[1]=i,e[2]=c,e[3]=s,e[4]=u,e[5]=l,e[6]=f,e[7]=d,e[8]=h,e[9]=p,e[10]=v,e[11]=y,e[12]=m,e[13]=g,e[14]=E,e[15]=b}function j(e,n){H(e,n,n)}function U(e,t){var r,o=n();for(r=0;r<16;r++)o[r]=t[r];for(r=253;r>=0;r--)j(o,o),2!==r&&4!==r&&H(o,o,t);for(r=0;r<16;r++)e[r]=o[r]}function B(e,t){var r,o=n();for(r=0;r<16;r++)o[r]=t[r];for(r=250;r>=0;r--)j(o,o),1!==r&&H(o,o,t);for(r=0;r<16;r++)e[r]=o[r]}function V(e,t,r){var o,a,i=new Uint8Array(32),s=new Float64Array(80),u=n(),l=n(),f=n(),d=n(),h=n(),p=n();for(a=0;a<31;a++)i[a]=t[a];for(i[31]=127&t[31]|64,i[0]&=248,F(s,r),a=0;a<16;a++)l[a]=s[a],d[a]=u[a]=f[a]=0;for(u[0]=d[0]=1,a=254;a>=0;--a)R(u,l,o=i[a>>>3]>>>(7&a)&1),R(f,d,o),L(h,u,f),K(u,u,f),L(f,l,d),K(l,l,d),j(d,h),j(p,u),H(u,f,u),H(f,l,h),L(h,u,f),K(u,u,f),j(l,u),K(f,d,p),H(u,f,c),L(u,u,d),H(f,f,u),H(u,d,p),H(d,l,s),j(l,h),R(u,l,o),R(f,d,o);for(a=0;a<16;a++)s[a+16]=u[a],s[a+32]=f[a],s[a+48]=l[a],s[a+64]=d[a];var v=s.subarray(32),y=s.subarray(16);return U(v,v),H(y,y,v),P(e,y),0}function Y(e,n){return V(e,n,o)}function G(e,n){return t(n,32),Y(e,n)}function J(e,n,t){var o=new Uint8Array(32);return V(o,t,n),E(e,r,o,b)}D.prototype.blocks=function(e,n,t){for(var r,o,a,i,c,s,u,l,f,d,h,p,v,y,m,g,E,b,A,_=this.fin?0:2048,w=this.h[0],O=this.h[1],D=this.h[2],S=this.h[3],T=this.h[4],x=this.h[5],C=this.h[6],N=this.h[7],I=this.h[8],R=this.h[9],P=this.r[0],k=this.r[1],M=this.r[2],F=this.r[3],L=this.r[4],K=this.r[5],H=this.r[6],j=this.r[7],U=this.r[8],B=this.r[9];t>=16;)d=f=0,d+=(w+=8191&(r=255&e[n+0]|(255&e[n+1])<<8))*P,d+=(O+=8191&(r>>>13|(o=255&e[n+2]|(255&e[n+3])<<8)<<3))*(5*B),d+=(D+=8191&(o>>>10|(a=255&e[n+4]|(255&e[n+5])<<8)<<6))*(5*U),d+=(S+=8191&(a>>>7|(i=255&e[n+6]|(255&e[n+7])<<8)<<9))*(5*j),f=(d+=(T+=8191&(i>>>4|(c=255&e[n+8]|(255&e[n+9])<<8)<<12))*(5*H))>>>13,d&=8191,d+=(x+=c>>>1&8191)*(5*K),d+=(C+=8191&(c>>>14|(s=255&e[n+10]|(255&e[n+11])<<8)<<2))*(5*L),d+=(N+=8191&(s>>>11|(u=255&e[n+12]|(255&e[n+13])<<8)<<5))*(5*F),d+=(I+=8191&(u>>>8|(l=255&e[n+14]|(255&e[n+15])<<8)<<8))*(5*M),h=f+=(d+=(R+=l>>>5|_)*(5*k))>>>13,h+=w*k,h+=O*P,h+=D*(5*B),h+=S*(5*U),f=(h+=T*(5*j))>>>13,h&=8191,h+=x*(5*H),h+=C*(5*K),h+=N*(5*L),h+=I*(5*F),f+=(h+=R*(5*M))>>>13,h&=8191,p=f,p+=w*M,p+=O*k,p+=D*P,p+=S*(5*B),f=(p+=T*(5*U))>>>13,p&=8191,p+=x*(5*j),p+=C*(5*H),p+=N*(5*K),p+=I*(5*L),v=f+=(p+=R*(5*F))>>>13,v+=w*F,v+=O*M,v+=D*k,v+=S*P,f=(v+=T*(5*B))>>>13,v&=8191,v+=x*(5*U),v+=C*(5*j),v+=N*(5*H),v+=I*(5*K),y=f+=(v+=R*(5*L))>>>13,y+=w*L,y+=O*F,y+=D*M,y+=S*k,f=(y+=T*P)>>>13,y&=8191,y+=x*(5*B),y+=C*(5*U),y+=N*(5*j),y+=I*(5*H),m=f+=(y+=R*(5*K))>>>13,m+=w*K,m+=O*L,m+=D*F,m+=S*M,f=(m+=T*k)>>>13,m&=8191,m+=x*P,m+=C*(5*B),m+=N*(5*U),m+=I*(5*j),g=f+=(m+=R*(5*H))>>>13,g+=w*H,g+=O*K,g+=D*L,g+=S*F,f=(g+=T*M)>>>13,g&=8191,g+=x*k,g+=C*P,g+=N*(5*B),g+=I*(5*U),E=f+=(g+=R*(5*j))>>>13,E+=w*j,E+=O*H,E+=D*K,E+=S*L,f=(E+=T*F)>>>13,E&=8191,E+=x*M,E+=C*k,E+=N*P,E+=I*(5*B),b=f+=(E+=R*(5*U))>>>13,b+=w*U,b+=O*j,b+=D*H,b+=S*K,f=(b+=T*L)>>>13,b&=8191,b+=x*F,b+=C*M,b+=N*k,b+=I*P,A=f+=(b+=R*(5*B))>>>13,A+=w*B,A+=O*U,A+=D*j,A+=S*H,f=(A+=T*K)>>>13,A&=8191,A+=x*L,A+=C*F,A+=N*M,A+=I*k,w=d=8191&(f=(f=((f+=(A+=R*P)>>>13)<<2)+f|0)+(d&=8191)|0),O=h+=f>>>=13,D=p&=8191,S=v&=8191,T=y&=8191,x=m&=8191,C=g&=8191,N=E&=8191,I=b&=8191,R=A&=8191,n+=16,t-=16;this.h[0]=w,this.h[1]=O,this.h[2]=D,this.h[3]=S,this.h[4]=T,this.h[5]=x,this.h[6]=C,this.h[7]=N,this.h[8]=I,this.h[9]=R},D.prototype.finish=function(e,n){var t,r,o,a,i=new Uint16Array(10);if(this.leftover){for(a=this.leftover,this.buffer[a++]=1;a<16;a++)this.buffer[a]=0;this.fin=1,this.blocks(this.buffer,0,16)}for(t=this.h[1]>>>13,this.h[1]&=8191,a=2;a<10;a++)this.h[a]+=t,t=this.h[a]>>>13,this.h[a]&=8191;for(this.h[0]+=5*t,t=this.h[0]>>>13,this.h[0]&=8191,this.h[1]+=t,t=this.h[1]>>>13,this.h[1]&=8191,this.h[2]+=t,i[0]=this.h[0]+5,t=i[0]>>>13,i[0]&=8191,a=1;a<10;a++)i[a]=this.h[a]+t,t=i[a]>>>13,i[a]&=8191;for(i[9]-=8192,r=(1^t)-1,a=0;a<10;a++)i[a]&=r;for(r=~r,a=0;a<10;a++)this.h[a]=this.h[a]&r|i[a];for(this.h[0]=65535&(this.h[0]|this.h[1]<<13),this.h[1]=65535&(this.h[1]>>>3|this.h[2]<<10),this.h[2]=65535&(this.h[2]>>>6|this.h[3]<<7),this.h[3]=65535&(this.h[3]>>>9|this.h[4]<<4),this.h[4]=65535&(this.h[4]>>>12|this.h[5]<<1|this.h[6]<<14),this.h[5]=65535&(this.h[6]>>>2|this.h[7]<<11),this.h[6]=65535&(this.h[7]>>>5|this.h[8]<<8),this.h[7]=65535&(this.h[8]>>>8|this.h[9]<<5),o=this.h[0]+this.pad[0],this.h[0]=65535&o,a=1;a<8;a++)o=(this.h[a]+this.pad[a]|0)+(o>>>16)|0,this.h[a]=65535&o;e[n+0]=this.h[0]>>>0&255,e[n+1]=this.h[0]>>>8&255,e[n+2]=this.h[1]>>>0&255,e[n+3]=this.h[1]>>>8&255,e[n+4]=this.h[2]>>>0&255,e[n+5]=this.h[2]>>>8&255,e[n+6]=this.h[3]>>>0&255,e[n+7]=this.h[3]>>>8&255,e[n+8]=this.h[4]>>>0&255,e[n+9]=this.h[4]>>>8&255,e[n+10]=this.h[5]>>>0&255,e[n+11]=this.h[5]>>>8&255,e[n+12]=this.h[6]>>>0&255,e[n+13]=this.h[6]>>>8&255,e[n+14]=this.h[7]>>>0&255,e[n+15]=this.h[7]>>>8&255},D.prototype.update=function(e,n,t){var r,o;if(this.leftover){for((o=16-this.leftover)>t&&(o=t),r=0;r<o;r++)this.buffer[this.leftover+r]=e[n+r];if(t-=o,n+=o,this.leftover+=o,this.leftover<16)return;this.blocks(this.buffer,0,16),this.leftover=0}if(t>=16&&(o=t-t%16,this.blocks(e,n,o),n+=o,t-=o),t){for(r=0;r<t;r++)this.buffer[this.leftover+r]=e[n+r];this.leftover+=t}};var q=x,W=C;var z=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591];function Q(e,n,t,r){for(var o,a,i,c,s,u,l,f,d,h,p,v,y,m,g,E,b,A,_,w,O,D,S,T,x,C,N=new Int32Array(16),I=new Int32Array(16),R=e[0],P=e[1],k=e[2],M=e[3],F=e[4],L=e[5],K=e[6],H=e[7],j=n[0],U=n[1],B=n[2],V=n[3],Y=n[4],G=n[5],J=n[6],q=n[7],W=0;r>=128;){for(_=0;_<16;_++)w=8*_+W,N[_]=t[w+0]<<24|t[w+1]<<16|t[w+2]<<8|t[w+3],I[_]=t[w+4]<<24|t[w+5]<<16|t[w+6]<<8|t[w+7];for(_=0;_<80;_++)if(o=R,a=P,i=k,c=M,s=F,u=L,l=K,H,d=j,h=U,p=B,v=V,y=Y,m=G,g=J,q,S=65535&(D=q),T=D>>>16,x=65535&(O=H),C=O>>>16,S+=65535&(D=(Y>>>14|F<<18)^(Y>>>18|F<<14)^(F>>>9|Y<<23)),T+=D>>>16,x+=65535&(O=(F>>>14|Y<<18)^(F>>>18|Y<<14)^(Y>>>9|F<<23)),C+=O>>>16,S+=65535&(D=Y&G^~Y&J),T+=D>>>16,x+=65535&(O=F&L^~F&K),C+=O>>>16,S+=65535&(D=z[2*_+1]),T+=D>>>16,x+=65535&(O=z[2*_]),C+=O>>>16,O=N[_%16],T+=(D=I[_%16])>>>16,x+=65535&O,C+=O>>>16,x+=(T+=(S+=65535&D)>>>16)>>>16,S=65535&(D=A=65535&S|T<<16),T=D>>>16,x=65535&(O=b=65535&x|(C+=x>>>16)<<16),C=O>>>16,S+=65535&(D=(j>>>28|R<<4)^(R>>>2|j<<30)^(R>>>7|j<<25)),T+=D>>>16,x+=65535&(O=(R>>>28|j<<4)^(j>>>2|R<<30)^(j>>>7|R<<25)),C+=O>>>16,T+=(D=j&U^j&B^U&B)>>>16,x+=65535&(O=R&P^R&k^P&k),C+=O>>>16,f=65535&(x+=(T+=(S+=65535&D)>>>16)>>>16)|(C+=x>>>16)<<16,E=65535&S|T<<16,S=65535&(D=v),T=D>>>16,x=65535&(O=c),C=O>>>16,T+=(D=A)>>>16,x+=65535&(O=b),C+=O>>>16,P=o,k=a,M=i,F=c=65535&(x+=(T+=(S+=65535&D)>>>16)>>>16)|(C+=x>>>16)<<16,L=s,K=u,H=l,R=f,U=d,B=h,V=p,Y=v=65535&S|T<<16,G=y,J=m,q=g,j=E,_%16==15)for(w=0;w<16;w++)O=N[w],S=65535&(D=I[w]),T=D>>>16,x=65535&O,C=O>>>16,O=N[(w+9)%16],S+=65535&(D=I[(w+9)%16]),T+=D>>>16,x+=65535&O,C+=O>>>16,b=N[(w+1)%16],S+=65535&(D=((A=I[(w+1)%16])>>>1|b<<31)^(A>>>8|b<<24)^(A>>>7|b<<25)),T+=D>>>16,x+=65535&(O=(b>>>1|A<<31)^(b>>>8|A<<24)^b>>>7),C+=O>>>16,b=N[(w+14)%16],T+=(D=((A=I[(w+14)%16])>>>19|b<<13)^(b>>>29|A<<3)^(A>>>6|b<<26))>>>16,x+=65535&(O=(b>>>19|A<<13)^(A>>>29|b<<3)^b>>>6),C+=O>>>16,C+=(x+=(T+=(S+=65535&D)>>>16)>>>16)>>>16,N[w]=65535&x|C<<16,I[w]=65535&S|T<<16;S=65535&(D=j),T=D>>>16,x=65535&(O=R),C=O>>>16,O=e[0],T+=(D=n[0])>>>16,x+=65535&O,C+=O>>>16,C+=(x+=(T+=(S+=65535&D)>>>16)>>>16)>>>16,e[0]=R=65535&x|C<<16,n[0]=j=65535&S|T<<16,S=65535&(D=U),T=D>>>16,x=65535&(O=P),C=O>>>16,O=e[1],T+=(D=n[1])>>>16,x+=65535&O,C+=O>>>16,C+=(x+=(T+=(S+=65535&D)>>>16)>>>16)>>>16,e[1]=P=65535&x|C<<16,n[1]=U=65535&S|T<<16,S=65535&(D=B),T=D>>>16,x=65535&(O=k),C=O>>>16,O=e[2],T+=(D=n[2])>>>16,x+=65535&O,C+=O>>>16,C+=(x+=(T+=(S+=65535&D)>>>16)>>>16)>>>16,e[2]=k=65535&x|C<<16,n[2]=B=65535&S|T<<16,S=65535&(D=V),T=D>>>16,x=65535&(O=M),C=O>>>16,O=e[3],T+=(D=n[3])>>>16,x+=65535&O,C+=O>>>16,C+=(x+=(T+=(S+=65535&D)>>>16)>>>16)>>>16,e[3]=M=65535&x|C<<16,n[3]=V=65535&S|T<<16,S=65535&(D=Y),T=D>>>16,x=65535&(O=F),C=O>>>16,O=e[4],T+=(D=n[4])>>>16,x+=65535&O,C+=O>>>16,C+=(x+=(T+=(S+=65535&D)>>>16)>>>16)>>>16,e[4]=F=65535&x|C<<16,n[4]=Y=65535&S|T<<16,S=65535&(D=G),T=D>>>16,x=65535&(O=L),C=O>>>16,O=e[5],T+=(D=n[5])>>>16,x+=65535&O,C+=O>>>16,C+=(x+=(T+=(S+=65535&D)>>>16)>>>16)>>>16,e[5]=L=65535&x|C<<16,n[5]=G=65535&S|T<<16,S=65535&(D=J),T=D>>>16,x=65535&(O=K),C=O>>>16,O=e[6],T+=(D=n[6])>>>16,x+=65535&O,C+=O>>>16,C+=(x+=(T+=(S+=65535&D)>>>16)>>>16)>>>16,e[6]=K=65535&x|C<<16,n[6]=J=65535&S|T<<16,S=65535&(D=q),T=D>>>16,x=65535&(O=H),C=O>>>16,O=e[7],T+=(D=n[7])>>>16,x+=65535&O,C+=O>>>16,C+=(x+=(T+=(S+=65535&D)>>>16)>>>16)>>>16,e[7]=H=65535&x|C<<16,n[7]=q=65535&S|T<<16,W+=128,r-=128}return r}function X(e,n,t){var r,o=new Int32Array(8),a=new Int32Array(8),i=new Uint8Array(256),c=t;for(o[0]=1779033703,o[1]=3144134277,o[2]=1013904242,o[3]=2773480762,o[4]=1359893119,o[5]=2600822924,o[6]=528734635,o[7]=1541459225,a[0]=4089235720,a[1]=2227873595,a[2]=4271175723,a[3]=1595750129,a[4]=2917565137,a[5]=725511199,a[6]=4215389547,a[7]=327033209,Q(o,a,n,t),t%=128,r=0;r<t;r++)i[r]=n[c-t+r];for(i[t]=128,i[(t=256-128*(t<112?1:0))-9]=0,p(i,t-8,c/536870912|0,c<<3),Q(o,a,i,t),r=0;r<8;r++)p(e,8*r,o[r],a[r]);return 0}function Z(e,t){var r=n(),o=n(),a=n(),i=n(),c=n(),s=n(),l=n(),f=n(),d=n();K(r,e[1],e[0]),K(d,t[1],t[0]),H(r,r,d),L(o,e[0],e[1]),L(d,t[0],t[1]),H(o,o,d),H(a,e[3],t[3]),H(a,a,u),H(i,e[2],t[2]),L(i,i,i),K(c,o,r),K(s,i,a),L(l,i,a),L(f,o,r),H(e[0],c,s),H(e[1],f,l),H(e[2],l,s),H(e[3],c,f)}function $(e,n,t){var r;for(r=0;r<4;r++)R(e[r],n[r],t)}function ee(e,t){var r=n(),o=n(),a=n();U(a,t[2]),H(r,t[0],a),H(o,t[1],a),P(e,o),e[31]^=M(r)<<7}function ne(e,n,t){var r,o;for(N(e[0],a),N(e[1],i),N(e[2],i),N(e[3],a),o=255;o>=0;--o)$(e,n,r=t[o/8|0]>>(7&o)&1),Z(n,e),Z(e,e),$(e,n,r)}function te(e,t){var r=[n(),n(),n(),n()];N(r[0],f),N(r[1],d),N(r[2],i),H(r[3],f,d),ne(e,r,t)}function re(e,r,o){var a,i=new Uint8Array(64),c=[n(),n(),n(),n()];for(o||t(r,32),X(i,r,32),i[0]&=248,i[31]&=127,i[31]|=64,te(c,i),ee(e,c),a=0;a<32;a++)r[a+32]=e[a];return 0}var oe=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]);function ae(e,n){var t,r,o,a;for(r=63;r>=32;--r){for(t=0,o=r-32,a=r-12;o<a;++o)n[o]+=t-16*n[r]*oe[o-(r-32)],t=Math.floor((n[o]+128)/256),n[o]-=256*t;n[o]+=t,n[r]=0}for(t=0,o=0;o<32;o++)n[o]+=t-(n[31]>>4)*oe[o],t=n[o]>>8,n[o]&=255;for(o=0;o<32;o++)n[o]-=t*oe[o];for(r=0;r<32;r++)n[r+1]+=n[r]>>8,e[r]=255&n[r]}function ie(e){var n,t=new Float64Array(64);for(n=0;n<64;n++)t[n]=e[n];for(n=0;n<64;n++)e[n]=0;ae(e,t)}function ce(e,t,r,o){var a,i,c=new Uint8Array(64),s=new Uint8Array(64),u=new Uint8Array(64),l=new Float64Array(64),f=[n(),n(),n(),n()];X(c,o,32),c[0]&=248,c[31]&=127,c[31]|=64;var d=r+64;for(a=0;a<r;a++)e[64+a]=t[a];for(a=0;a<32;a++)e[32+a]=c[32+a];for(X(u,e.subarray(32),r+32),ie(u),te(f,u),ee(e,f),a=32;a<64;a++)e[a]=o[a];for(X(s,e,r+64),ie(s),a=0;a<64;a++)l[a]=0;for(a=0;a<32;a++)l[a]=u[a];for(a=0;a<32;a++)for(i=0;i<32;i++)l[a+i]+=s[a]*c[i];return ae(e.subarray(32),l),d}function se(e,t,r,o){var c,u=new Uint8Array(32),l=new Uint8Array(64),f=[n(),n(),n(),n()],d=[n(),n(),n(),n()];if(r<64)return-1;if(function(e,t){var r=n(),o=n(),c=n(),u=n(),l=n(),f=n(),d=n();return N(e[2],i),F(e[1],t),j(c,e[1]),H(u,c,s),K(c,c,e[2]),L(u,e[2],u),j(l,u),j(f,l),H(d,f,l),H(r,d,c),H(r,r,u),B(r,r),H(r,r,c),H(r,r,u),H(r,r,u),H(e[0],r,u),j(o,e[0]),H(o,o,u),k(o,c)&&H(e[0],e[0],h),j(o,e[0]),H(o,o,u),k(o,c)?-1:(M(e[0])===t[31]>>7&&K(e[0],a,e[0]),H(e[3],e[0],e[1]),0)}(d,o))return-1;for(c=0;c<r;c++)e[c]=t[c];for(c=0;c<32;c++)e[c+32]=o[c];if(X(l,e,r),ie(l),ne(f,d,l),te(d,t.subarray(32)),Z(f,d),ee(u,f),r-=64,m(t,0,u,0)){for(c=0;c<r;c++)e[c]=0;return-1}for(c=0;c<r;c++)e[c]=t[c+64];return r}var ue=16,le=64,fe=32,de=64;function he(e,n){if(32!==e.length)throw new Error("bad key size");if(24!==n.length)throw new Error("bad nonce size")}function pe(){for(var e=0;e<arguments.length;e++)if(!(arguments[e]instanceof Uint8Array))throw new TypeError("unexpected type, use Uint8Array")}function ve(e){for(var n=0;n<e.length;n++)e[n]=0}e.lowlevel={crypto_core_hsalsa20:E,crypto_stream_xor:O,crypto_stream:w,crypto_stream_salsa20_xor:A,crypto_stream_salsa20:_,crypto_onetimeauth:S,crypto_onetimeauth_verify:T,crypto_verify_16:y,crypto_verify_32:m,crypto_secretbox:x,crypto_secretbox_open:C,crypto_scalarmult:V,crypto_scalarmult_base:Y,crypto_box_beforenm:J,crypto_box_afternm:q,crypto_box:function(e,n,t,r,o,a){var i=new Uint8Array(32);return J(i,o,a),q(e,n,t,r,i)},crypto_box_open:function(e,n,t,r,o,a){var i=new Uint8Array(32);return J(i,o,a),W(e,n,t,r,i)},crypto_box_keypair:G,crypto_hash:X,crypto_sign:ce,crypto_sign_keypair:re,crypto_sign_open:se,crypto_secretbox_KEYBYTES:32,crypto_secretbox_NONCEBYTES:24,crypto_secretbox_ZEROBYTES:32,crypto_secretbox_BOXZEROBYTES:ue,crypto_scalarmult_BYTES:32,crypto_scalarmult_SCALARBYTES:32,crypto_box_PUBLICKEYBYTES:32,crypto_box_SECRETKEYBYTES:32,crypto_box_BEFORENMBYTES:32,crypto_box_NONCEBYTES:24,crypto_box_ZEROBYTES:32,crypto_box_BOXZEROBYTES:16,crypto_sign_BYTES:le,crypto_sign_PUBLICKEYBYTES:fe,crypto_sign_SECRETKEYBYTES:de,crypto_sign_SEEDBYTES:32,crypto_hash_BYTES:64,gf:n,D:s,L:oe,pack25519:P,unpack25519:F,M:H,A:L,S:j,Z:K,pow2523:B,add:Z,set25519:N,modL:ae,scalarmult:ne,scalarbase:te},e.randomBytes=function(e){var n=new Uint8Array(e);return t(n,e),n},e.secretbox=function(e,n,t){pe(e,n,t),he(t,n);for(var r=new Uint8Array(32+e.length),o=new Uint8Array(r.length),a=0;a<e.length;a++)r[a+32]=e[a];return x(o,r,r.length,n,t),o.subarray(ue)},e.secretbox.open=function(e,n,t){pe(e,n,t),he(t,n);for(var r=new Uint8Array(ue+e.length),o=new Uint8Array(r.length),a=0;a<e.length;a++)r[a+ue]=e[a];return r.length<32||0!==C(o,r,r.length,n,t)?null:o.subarray(32)},e.secretbox.keyLength=32,e.secretbox.nonceLength=24,e.secretbox.overheadLength=ue,e.scalarMult=function(e,n){if(pe(e,n),32!==e.length)throw new Error("bad n size");if(32!==n.length)throw new Error("bad p size");var t=new Uint8Array(32);return V(t,e,n),t},e.scalarMult.base=function(e){if(pe(e),32!==e.length)throw new Error("bad n size");var n=new Uint8Array(32);return Y(n,e),n},e.scalarMult.scalarLength=32,e.scalarMult.groupElementLength=32,e.box=function(n,t,r,o){var a=e.box.before(r,o);return e.secretbox(n,t,a)},e.box.before=function(e,n){pe(e,n),function(e,n){if(32!==e.length)throw new Error("bad public key size");if(32!==n.length)throw new Error("bad secret key size")}(e,n);var t=new Uint8Array(32);return J(t,e,n),t},e.box.after=e.secretbox,e.box.open=function(n,t,r,o){var a=e.box.before(r,o);return e.secretbox.open(n,t,a)},e.box.open.after=e.secretbox.open,e.box.keyPair=function(){var e=new Uint8Array(32),n=new Uint8Array(32);return G(e,n),{publicKey:e,secretKey:n}},e.box.keyPair.fromSecretKey=function(e){if(pe(e),32!==e.length)throw new Error("bad secret key size");var n=new Uint8Array(32);return Y(n,e),{publicKey:n,secretKey:new Uint8Array(e)}},e.box.publicKeyLength=32,e.box.secretKeyLength=32,e.box.sharedKeyLength=32,e.box.nonceLength=24,e.box.overheadLength=e.secretbox.overheadLength,e.sign=function(e,n){if(pe(e,n),n.length!==de)throw new Error("bad secret key size");var t=new Uint8Array(le+e.length);return ce(t,e,e.length,n),t},e.sign.open=function(e,n){if(pe(e,n),n.length!==fe)throw new Error("bad public key size");var t=new Uint8Array(e.length),r=se(t,e,e.length,n);if(r<0)return null;for(var o=new Uint8Array(r),a=0;a<o.length;a++)o[a]=t[a];return o},e.sign.detached=function(n,t){for(var r=e.sign(n,t),o=new Uint8Array(le),a=0;a<o.length;a++)o[a]=r[a];return o},e.sign.detached.verify=function(e,n,t){if(pe(e,n,t),n.length!==le)throw new Error("bad signature size");if(t.length!==fe)throw new Error("bad public key size");var r,o=new Uint8Array(le+e.length),a=new Uint8Array(le+e.length);for(r=0;r<le;r++)o[r]=n[r];for(r=0;r<e.length;r++)o[r+le]=e[r];return se(a,o,o.length,t)>=0},e.sign.keyPair=function(){var e=new Uint8Array(fe),n=new Uint8Array(de);return re(e,n),{publicKey:e,secretKey:n}},e.sign.keyPair.fromSecretKey=function(e){if(pe(e),e.length!==de)throw new Error("bad secret key size");for(var n=new Uint8Array(fe),t=0;t<n.length;t++)n[t]=e[32+t];return{publicKey:n,secretKey:new Uint8Array(e)}},e.sign.keyPair.fromSeed=function(e){if(pe(e),32!==e.length)throw new Error("bad seed size");for(var n=new Uint8Array(fe),t=new Uint8Array(de),r=0;r<32;r++)t[r]=e[r];return re(n,t,!0),{publicKey:n,secretKey:t}},e.sign.publicKeyLength=fe,e.sign.secretKeyLength=de,e.sign.seedLength=32,e.sign.signatureLength=le,e.hash=function(e){pe(e);var n=new Uint8Array(64);return X(n,e,e.length),n},e.hash.hashLength=64,e.verify=function(e,n){return pe(e,n),0!==e.length&&0!==n.length&&(e.length===n.length&&0===v(e,0,n,0,e.length))},e.setPRNG=function(e){t=e},function(){var n="undefined"!=typeof self?self.crypto||self.msCrypto:null;if(n&&n.getRandomValues){e.setPRNG((function(e,t){var r,o=new Uint8Array(t);for(r=0;r<t;r+=65536)n.getRandomValues(o.subarray(r,r+Math.min(t-r,65536)));for(r=0;r<t;r++)e[r]=o[r];ve(o)}))}else void 0!==l&&(n=require("crypto"))&&n.randomBytes&&e.setPRNG((function(e,t){var r,o=n.randomBytes(t);for(r=0;r<t;r++)e[r]=o[r];ve(o)}))}()}(e.exports?e.exports:self.nacl=self.nacl||{})}(d)),d.exports}var p,v,y,m,g,E,b,A={exports:{}},_=A.exports;function w(){return p||(p=1,function(e){var n,t;n=_,t=function(){var e={};function n(e){if(!/^(?:[A-Za-z0-9+\/]{2}[A-Za-z0-9+\/]{2})*(?:[A-Za-z0-9+\/]{2}==|[A-Za-z0-9+\/]{3}=)?$/.test(e))throw new TypeError("invalid encoding")}return e.decodeUTF8=function(e){if("string"!=typeof e)throw new TypeError("expected string");var n,t=unescape(encodeURIComponent(e)),r=new Uint8Array(t.length);for(n=0;n<t.length;n++)r[n]=t.charCodeAt(n);return r},e.encodeUTF8=function(e){var n,t=[];for(n=0;n<e.length;n++)t.push(String.fromCharCode(e[n]));return decodeURIComponent(escape(t.join("")))},"undefined"==typeof atob?void 0!==Buffer.from?(e.encodeBase64=function(e){return Buffer.from(e).toString("base64")},e.decodeBase64=function(e){return n(e),new Uint8Array(Array.prototype.slice.call(Buffer.from(e,"base64"),0))}):(e.encodeBase64=function(e){return new Buffer(e).toString("base64")},e.decodeBase64=function(e){return n(e),new Uint8Array(Array.prototype.slice.call(new Buffer(e,"base64"),0))}):(e.encodeBase64=function(e){var n,t=[],r=e.length;for(n=0;n<r;n++)t.push(String.fromCharCode(e[n]));return btoa(t.join(""))},e.decodeBase64=function(e){n(e);var t,r=atob(e),o=new Uint8Array(r.length);for(t=0;t<r.length;t++)o[t]=r.charCodeAt(t);return o}),e},e.exports?e.exports=t():(n.nacl||(n.nacl={}),n.nacl.util=t())}(A)),A.exports}function O(){return v||(v=1,function(e){var n,t,r,o,a,i;e.exports&&(e.exports=(n=u(),t=h(),r=w(),a=function(e){return e.replace(/^\d+:/,"")},i=(o={}).removeCp=function(e){return e.replace(/^cp\|([A-Za-z0-9+\/=]{0,20}\|)?/,"")},o.start=function(e){var o,c=(e=e||{}).network,s=e.websocketURL,u=e.userName,l=e.channel,f=e.crypto,d=e.readOnly||!1,h=!e.noChainPad&&(e.ChainPad||globalThis.ChainPad),p=void 0===e.useHistory||!!e.useHistory,v=!1,y=e.lastKnownHash,m={},g=[],E=e.priority||2,b=e.Cache,A=!1,_=Math.floor(1e6*Math.random()),w=e.metadata||{},O=w.validateKey=e.validateKey||w.validateKey;w.owners=e.owners||w.owners,w.expire=e.expire||w.expire;var D,S,T=!0,x=!1,C={setReadOnly:function(e,n){d=e,n&&(f=n)}},N=function(){},I=[],R={send:function(){}},P=function(){D&&"function"==typeof D.abort&&D.abort();var n=h.create({userName:u,initialState:e.initialState,transformFunction:e.transformFunction,patchTransformer:e.patchTransformer,validateContent:e.validateContent,avgSyncMilliseconds:e.avgSyncMilliseconds,logLevel:void 0!==e.logLevel?e.logLevel:1});return b&&Array.isArray(o)&&o.length&&(o.forEach((function(e){var t=e.patch;if(!/^\[/.test(t)){try{t=f.decrypt(t,O,!0)}catch(e){console.error(t,O,l),console.error(e)}t=a(t)}n.message(t)})),""===n.getUserDoc())?(n.abort(),o=[],b.clearChannel(l),P()):(n.onMessage((function(e,n,t){R.send(e,n,t)})),n.onPatch((function(t){e.onRemote&&e.onRemote({realtime:n,patch:t})})),n)},k={change:[],onChange:function(e){k.change.forEach((function(n){n(e)}))},users:[]},M=function(n){e.onJoin&&e.onJoin(n),32===n.length&&(-1===k.users.indexOf(n)&&k.users.push(n),k.onChange())},F=function(){},L=function(n){e.onLeave&&e.onLeave(n);var t=k.users.indexOf(n);-1!==t&&k.users.splice(t,1),k.onChange()},K=function(n,t){if(T){try{var r=D&&D.getUserDoc();if(A&&D&&(""===r||r===e.initialState))return void C.resetCache()}catch(e){console.error(e)}D&&D.start(),e.setMyID&&e.setMyID({myID:n.myID}),T=!1,e.onReady&&e.onReady({realtime:D,network:t,userList:k,myId:n.myID,leave:n.leave,metadata:w}),g.length&&(g.forEach((function(e){"function"==typeof e&&e()})),g=[])}},H=function(n,t){if(e.onChannelError&&e.onChannelError({channel:t.id,type:n.error,loaded:!T,error:n.error,message:n.message}),"EUNKNOWN"===n.error)return y=void 0,t&&t.leave(),b?(o=[],void b.clearChannel(l,(function(){h&&(C.realtime=D=P()),N(c,F)}))):void N(c,F);if("function"==typeof C.stop)try{C.stop()}catch(e){}},j=!0,U=function(e){b&&(o.length&&o[o.length-1].hash===e.hash||(!o.length&&j&&(e.isCheckpoint=!0,j=!1),(o.length||e.isCheckpoint)&&(o.push(e),b.storeCache(l,O,o,(function(e){if(e){b.clearChannel(l,(function(){console.warn("Cache cleared",l)}));var n=o;return o=[],void console.error(e,l,n,O)}})))))},B=function(n,t,r,o,c){var s=o.historyKeeper,u=n===s;if(!r||0!==t&&"0"!==t){if(!c||n===s){if(c){var d=JSON.parse(t);if(d.txid&&d.txid!==_)return;if(d.validateKey&&d.channel)return d.channel!==r.id||O||(O=d.validateKey),void(d.channel===r.id&&(w=d,e.onMetadataUpdate&&!T&&e.onMetadataUpdate(w)));if(d.state&&1===d.state&&d.channel)return void(d.channel===r.id&&(Object.keys(m).forEach((function(e){"function"==typeof m[e]&&m[e]("FAILED")})),m={},K(r,o)))}if(u){var h=JSON.parse(t);if(Array.isArray(h)&&h[0]&&h[0]!==_)return;if(h.channel===r.id&&h.error)return void H(h,r);if(t=h[4],h[3]!==r.id)return}if(y=t.slice(0,64),"function"==typeof m[y])return m[y](null,y),void delete m[y];var p,v=/^cp\|/.test(t);t=i(t);try{t=f.decrypt(t,O,u)}catch(e){console.error(t,O,l),console.error(e)}var E="string"==typeof t;!E&&t.content&&(p=t.author,t=t.content),T||e.onLocal&&e.onLocal(!0);var b=E?a(t):t,A=function(){try{if(D&&E&&D.message(b),e.onMessage){var t={time:h?h[5]:+new Date};e.onMessage(b,n,O,v,y,p,t)}var r=v;e.isCacheCheckpoint&&(r=e.isCacheCheckpoint(b,p)),U({patch:b,hash:y,isCheckpoint:r,author:p,time:h?h[5]:+new Date})}catch(e){console.error(e)}};T&&n!==s?g.push(A):A()}}else K(r,o)},V=function(n,a,c){R.wc=n,l=n.id,n.members.forEach(M);var s,u=function(e,t){B(t,e,n,a)};n.on("message",u),n.on("join",M),n.on("leave",L),R.stop=function(){n.off("message",u),n.off("join",M),n.off("leave",L),n.leave(),D&&D.abort()},c&&(R.send=function(n,o,c){var s=function(e,n){if(!d)try{var o=f.encrypt(e,n);if(0===e.indexOf("[4")){var a="";if(t&&r){var i=t.hash(r.decodeUTF8(e));a=r.encodeBase64(i.slice(0,8))+"|"}else console.log("Checkpoint sent without an ID. Nacl is missing.");o="cp|"+a+o}return o}catch(n){throw console.log(e),n}}(n,c);if(s){var u=s.slice(0,64),h=/^cp\|/.test(s);e.isCacheCheckpoint&&(h=e.isCacheCheckpoint(n,c)),m[u]=function(e,t){!e&&t&&U({patch:i(n),hash:u,isCheckpoint:h,author:c,time:+new Date}),o(e,t)},R.wc.bcast(s).then((function(){y=u,delete m[u],U({patch:i(n),hash:u,isCheckpoint:h,author:c,time:+new Date}),o(null,u)}),(function(e){if(console.error(e),!e||"enoent"!==e.type&&"ENOENT"!==e.type)delete m[u],o(e&&e.type||e);else{if(R.wc.leave(),v)return delete m[u],void o("STOPPED");T=!0,a.join(l,E).then((function(e){V(e,a,!1),R.send(n,o,c)}))}}))}},h&&!D&&(C.realtime=D=P()),e.onInit&&e.onInit({myID:n.myID,realtime:D,getLag:a.getLag,userList:k,network:a,channel:l})),e.onConnect&&e.onConnect(n,R.send),p?(n.members.forEach((function(e){16===e.length&&(s=e)})),S!==s&&(a.historyKeeper=s,S=s,I.forEach((function(e){e(s)}))),function(){var e={txid:_,priority:E,lastKnownHash:y,metadata:w};b&&Array.isArray(o)&&o.length&&(e.lastKnownHash=o[o.length-1].hash),g=[];var t=["GET_HISTORY",n.id,e];s&&a.sendto(s,JSON.stringify(t))}(),C.resetCache=function(){T=!0,o=[],b&&b.clearChannel(l),_=Math.floor(1e6*Math.random()),H({error:"EUNKNOWN",message:"Corrupted cache"},n)}):K(n,a)},Y=!1;"undefined"!=typeof window&&window.addEventListener("beforeunload",(function(){Y=!0}));var G=function(e,n){var t;return e.some((function(e){if(e.id===n)return t=e,!0})),t},J=function(n){e.onError&&e.onError({type:n.type||n,message:n.message,error:n.type,loaded:!T})};N=function(t,r){var a;"string"==typeof t&&(a=n.connect(t));var i=function(){x=!1,"string"==typeof t?a.then(r,J):"function"==typeof t.then?t.then(r,J):r(t)};if(b&&!x)return b.getChannelCache(l,(function(n,t){O=t?t.k:void 0,(o=t?t.c:[]).length?(A=!0,e.onCacheStart&&e.onCacheStart(),h&&(C.realtime=D=P()),o.length?(e.onMessage&&o.forEach((function(n){var t={time:n.time};e.onMessage(n.patch,"cache",O,n.isCheckpoint,n.hash,n.author,t)})),e.onCacheReady&&e.onCacheReady({id:l,realtime:D,networkPromise:a}),i()):i()):i()})),void(C.resetCache=function(){b&&b.clearChannel(l),o=[]});i()};var q=!0;return F=function(n,t){v||n.join(l||null,E).then((function(e){if(v)try{e.leave()}catch(e){}else V(e,n,t)}),(function(r){r&&"ERESTRICTED"===r.type&&Array.isArray(r.message)&&e.onRejected?e.onRejected(r.message,(function(e){e?J(r):F(n,t)})):J(r)}))},C.stop=function(){v=!0},N(c||s,(function(n){if(c=n,q){if(q=!1,v)return;var t=function(n){Y||"network.disconnect() called"!==n&&(e.onConnectionChange?e.onConnectionChange({state:!1}):e.onAbort&&e.onAbort({reason:n}))},r=function(n){if(e.onConnectionChange){e.onConnectionChange({state:!0,myId:n});var t=function(){T=!0,x=!0,k.users=[],N(c,F)};if(e.beforeReconnecting)return void e.beforeReconnecting((function(n,r){l=n,e.initialState=r,t()}));t()}},o=function(e,n){var t=G(c.webChannels,l);t&&B(n,e,t,c,!0)};c.on("disconnect",t),c.on("reconnect",r),c.on("message",o),C.network=c,C.stop=function(){R&&R.stop&&R.stop();var e=G(c.webChannels,l);if(e)try{e.leave("")}catch(e){}c.off("disconnect",t),c.off("reconnect",r),c.off("message",o),v=!0},c.onHistoryKeeperChange=function(e){I.push(e)}}F(c,!0)})),C},o))}(c)),c.exports}function D(){return E?g:(E=1,g=function(){if(m)return y;m=1;const e=n=>{if(Array.isArray(n))return n.map(e);if(n instanceof Object){let t=[],r=[];return Object.keys(n).forEach((e=>{/^(0|[1-9][0-9]*)$/.test(e)?t.push(+e):r.push(e)})),t.sort((function(e,n){return e-n})).concat(r.sort()).reduce(((t,r)=>(t[r]=e(n[r]),t)),{})}return n},n=JSON.stringify.bind(JSON);return y=(t,r,o)=>{let a=n(t,r,0);if(!a||"{"!==a[0]&&"["!==a[0])return a;let i=JSON.parse(a);return n(e(i),null,o)}}())}function S(){return b||(b=1,function(e){e.exports&&(e.exports=function(e,n){const t=globalThis;var r,o={},a=void 0===t.Proxy,i=o.DeepProxy=function(){var e={},r=e.isArray=Array.isArray||function(e){return"[object Array]"===Object.toString(e)},o=e.type=function(e){return null===e?"null":r(e)?"array":typeof e},i=e.isProxyable=function(e,n){return(void 0!==n||!a)&&-1!==["object","array"].indexOf(o(e))},c=e.set=function(n){return function(t,r,o){if("on"===r)throw new Error("'on' is a reserved attribute name for realtime lists and maps");return i(o)?t[r]=e.create(o,n):t[r]=o,n(),t[r]||!0}},s=e.pathMatches=function(e,n){return!n.some((function(n,t){return n!==e[t]}))},u=function(e,n){return n.pattern.length-e.pattern.length},l=function(e){return function(n,t,r){switch(n){case"change":t="array"===o(t)?t:[t],e.change.push({cb:function(e,n,o,a){if(s(o,t))return r(e,n,o,a)},pattern:t}),e.change.sort(u);break;case"remove":t="array"===o(t)?t:[t],e.remove.push({cb:function(e,n,o){if(s(n,t))return r(e,n,o)},pattern:t}),e.remove.sort(u);break;case"ready":e.ready.push({cb:function(e){t(e)}});break;case"cacheready":e.cacheready.push({cb:function(e){t(e)}});break;case"disconnect":e.disconnect.push({cb:function(e){t(e)}});break;case"reconnect":e.reconnect.push({cb:function(e){t(e)}});break;case"create":e.create.push({cb:function(e){t(e)}});break;case"error":e.error.push({cb:function(e){t(e)}})}return this}},f=e.get=function(){var e={cacheready:[],disconnect:[],reconnect:[],change:[],ready:[],remove:[],create:[],error:[]};return function(n,t){return"on"===t?l(e):"_isProxy"===t||("_events"===t?e:n[t])}},d=e.delete=function(e){return function(n,t){return void 0===n[t]||(delete n[t],e()),!0}},h=e.handlers=function(e,n){return n?{set:c(e),get:f(e),deleteProperty:d(e)}:{set:c(e),get:function(e,n){return"_isProxy"===n||e[n]},deleteProperty:d(e)}},p=e.remoteChangeFlag=!1,v=e.stringifyFakeProxy=function(e){var t=JSON.parse(n(e));return delete t._events,delete t._isProxy,n(t)};e.checkLocalChange=function(n,r){if(a&&!e.interval){var o=v(n);e.interval=t.setInterval((function(){var e=v(n);e!==o&&(o=e,p?p=!1:r())}),300)}};var y=e.create=function(e,n,r){var c="function"===o(n)?h(n,r):n;switch(o(e)){case"object":Object.keys(e).forEach((function(t){i(e[t])&&!e[t]._isProxy&&(e[t]=y(e[t],n))}));break;case"array":e.forEach((function(t,r){i(t)&&!t._isProxy&&(e[r]=y(e[r],n))}));break;default:throw new Error("attempted to make a proxy of an unproxyable object")}if(!a)return e._isProxy?e:new t.Proxy(e,c);var s=JSON.parse(JSON.stringify(e));if(r){var u={cacheready:[],disconnect:[],reconnect:[],change:[],ready:[],remove:[],create:[],error:[]};s.on=l(u),s._events=u}return s},m=function(e,n,t,r,o){var a=e.slice(0);a.push(n),t._events.change.some((function(e){return!1===e.cb(r,o,a,t)}))},g=e.find=function(e,n){for(var t=n.length,r=0;r<t;r++){if(void 0===e[n[r]])return;e=e[n[r]]}return e},E=function(e,n,t,r,a){var i=e.concat(n),c=g(t,i);switch(o(c)){case"array":a?m(e,n,t,r,void 0):t._events.remove.forEach((function(e){return e.cb(c,i,t)})),c.forEach((function(e,n){E(i,n,t)}));break;case"object":a?m(e,n,t,r,void 0):t._events.remove.forEach((function(e){return e.cb(c,i,t,r,!1)})),Object.keys(c).forEach((function(e){E(i,e,t,c[e],!1)}));break;default:t._events.remove.forEach((function(e){return e.cb(c,i,t)}))}},b=e.objects=function(n,t,r,a,i){var c=Object.keys(n),s=Object.keys(t);s.forEach((function(s){var u=o(t[s]),l=n[s];if(-1!==c.indexOf(s)){var f=o(n[s]);if(f===u)if(-1!==["array","object"].indexOf(f)){var d=a.slice(0).concat(s);"object"===f?b.call(i,n[s],t[s],r,d,i):e.arrays.call(i,n[s],t[s],r,d,i)}else n[s]!==t[s]&&(n[s]=t[s],m(a,s,i,l,t[s]));else{switch(console.log("type changed from [%s] to [%s]",f,u),u){case"undefined":throw new Error("first pass should never reveal undefined keys");case"array":case"object":n[s]=r(t[s]);break;default:n[s]=t[s]}m(a,s,i,l,t[s])}}else{switch(u){case"undefined":throw new Error("undefined type has key. this shouldn't happen?");case"array":case"object":n[s]=r(t[s]);break;default:n[s]=t[s]}m(a,s,i,l,t[s])}})),c.forEach((function(e){var r=n[e];"on"!==e&&"_events"!==e&&(-1!==s.indexOf(e)&&"undefined"!==o(t[e])||(E(a,e,i,r,!0),delete n[e]))}))},A=e.arrays=function(e,n,t,r,a){var i=e.length,c=n.length;if(i===c)e.forEach((function(i,c){var s=o(i),u=o(n[c]),l=i;if(s===u){var f=r.slice(0).concat(c);switch(u){case"undefined":throw new Error("existing key had type `undefined`. this should never happen");case"object":b.call(a,e[c],n[c],t,f,a)&&m(r,c,a,l,n[c]);break;case"array":A.call(a,e[c],n[c],t,f,a)&&m(r,c,a,l,n[c]);break;default:e[c]!==n[c]&&(e[c]=n[c],m(r,c,a,l,n[c]))}}else{switch(u){case"undefined":E(r,c,a,l,!0);break;case"object":case"array":e[c]=t(n[c]);break;default:e[c]=n[c]}m(r,c,a,l,n[c])}}));else{if(n.forEach((function(n,i){var c=o(e[i]),s=o(n),u=e[i];if(c!==s){switch(s){case"undefined":throw new Error("this should never happen");case"object":case"array":e[i]=t(n);break;default:e[i]=n}m(r,i,a,u,n)}else{var l=r.slice(0).concat(i);switch(s){case"object":b.call(a,e[i],n,t,l,a);break;case"array":A.call(a,e[i],n,t,l,a)&&m(r,i,a,u,n);break;default:n!==e[i]&&(e[i]=n,m(r,i,a,u,n))}}})),i>c)for(var s,u=c;u<=c;u++)s=e[u],E(r,u,a,s,!0);e.length=c}};return e.update=function(e,n,t){var r=o(e),a=o(n);if(r!==a)throw new Error("Proxy updates can't result in type changes");switch(a){case"array":A.call(e,e,n,(function(e){return y(e,t)}),[],e);break;case"object":b.call(e,e,n,(function(e){return y(e,t)}),[],e);break;default:throw new Error("unsupported realtime datatype:"+a)}},e}();return o.create=function(o){if(!i.isProxyable(o.data,!0))throw new Error("unsupported datatype: "+i.type(o.data));if("function"!=typeof(r=o.ChainPad||t.ChainPad).SmartJSONTransformer)throw new Error("Please update ChainPad");o.classic&&!o.crypto&&(console.error("[chainpad-listmap] no crypto module provided. messages will not be encrypted"),o.crypto={encrypt:function(e){return e},decrypt:function(e){return e}});var c=o.readOnly,s={initialState:n(o.data),patchTransformer:r.SmartJSONTransformer,validateContent:o.validateContent||function(e){try{return JSON.parse(e),!0}catch(n){return console.log(e),console.error("Failed to parse, rejecting patch"),!1}},readOnly:o.readOnly,userName:o.userName||"listmap",Cache:o.Cache,logLevel:void 0===o.logLevel?0:o.logLevel};o.classic&&(s.channel=o.channel,s.crypto=o.crypto,s.network=o.network,s.websocketURL=o.websocketURL,s.metadata=o.metadata||{validateKey:o.validateKey,owners:o.owners,expire:o.expire},s.onRejected=o.onRejected);var u,l,f,d={metadata:{}},h=!0,p=!1,v=a?i.stringifyFakeProxy:n,y=function(){var e=v(l);try{u.contentUpdate(e)}catch(e){l._events.error.forEach((function(n){n.cb({type:"CHAINPAD",error:e.message})}))}o.onLocal&&o.onLocal()},m=s.onLocal=function(e){h||c||(clearTimeout(f),e?y():f=setTimeout(y))},g=function(){i.remoteChangeFlag||m()};l=i.create(o.data,g,!0),s.onInit=function(e){l._events.create.forEach((function(n){n.cb(e)}))},s.onCacheReady=function(e){u&&u===e.realtime||(u=d.realtime=e.realtime);var n=u.getUserDoc(),t=JSON.parse(n);i.update(l,t,g),i.checkLocalChange(l,m),p||l._events.cacheready.forEach((function(n){n.cb(e)}))};var E=0;s.onReady=function(e){if(E=-1,p)return h=!1,s.onRemote(),void l._events.reconnect.forEach((function(n){n.cb(e)}));u&&u===e.realtime||(u=d.realtime=e.realtime),d.metadata=e.metadata;var n=u.getUserDoc(),t=JSON.parse(n);i.update(l,t,g),i.checkLocalChange(l,m),h=!1,p=!0,l._events.ready.forEach((function(n){n.cb(e)}))},s.onRemote=function(){if(!h){var e=u.getUserDoc(),n=JSON.parse(e);i.remoteChangeFlag=!0,i.update(l,n,g),i.remoteChangeFlag=!1}},s.onMessage=function(){-1!==E&&o.updateProgress&&o.updateProgress({progress:E++})},s.onAbort=function(e){l._events.disconnect.forEach((function(n){n.cb(e)}))},s.onConnectionChange=function(e){e.state?h=!0:l._events.disconnect.forEach((function(n){n.cb(e)}))},s.onMetadataUpdate=function(e){d.metadata=e,"function"==typeof o.onMetadataUpdate&&o.onMetadataUpdate(e)},s.onError=function(e){l._events.error.forEach((function(n){n.cb(e)}))},s.onChannelError=function(e){l._events.error.forEach((function(n){n.cb(e)}))},o.common&&"function"==typeof o.common.startRealtime?u=d.cpCnInner=o.common.startRealtime(s):d=e.start(s),d.proxy=l,d.realtime=u;var b=d.setReadOnly;return d.setReadOnly=function(e,n){c=e,b&&b(e,n)},d},o}(O(),D()))}(i)),i.exports}var T,x=S(),C={exports:{}};function N(){return T||(T=1,function(e){var n,r,o,a;a=function(){var e=l,n=function(t,r,o){r||(r=0);var a=n.resolve(t,r),i=n.m[r][a];if(!i&&e){if(i=e(a))return i}else if(i&&i.c&&(r=i.c,a=i.m,!(i=n.m[r][i.m])))throw new Error('failed to require "'+a+'" from '+r);if(!i)throw new Error('failed to require "'+t+'" from '+o);return i.exports||(i.exports={},i.call(i.exports,i,i.exports,n.relative(a,r))),i.exports};return n.resolve=function(e,t){var r=e,o=e+".js",a=e+"/index.js";return n.m[t][o]&&o?o:n.m[t][a]&&a?a:r},n.relative=function(e,t){return function(r){if("."!=r.charAt(0))return n(r,t,e);var o=e.split("/"),a=r.split("/");o.pop();for(var i=0;i<a.length;i++){var c=a[i];".."==c?o.pop():"."!=c&&o.push(c)}return n(o.join("/"),t,e)}},n}(),a.m=[],a.m[0]={"json.sortify":{c:1,m:"dist/JSON.sortify.js"},"fast-diff":{c:2,m:"diff.js"},"Diff.js":function(e,n,t){var r=t("fast-diff");e.exports.diff=function(e,n){return t=r(e,n),o=[],a=0,i=!0,c={offset:0,toInsert:"",toRemove:0,type:"Operation"},t.forEach((function(e,n){0===e[0]?(i||(o.push(c),a=c.offset+c.toRemove,c={offset:a,toInsert:"",toRemove:0,type:"Operation"}),a+=e[1].length,c.offset=a):1===e[0]?c.toInsert=e[1]:c.toRemove=e[1].length,n===t.length-1&&0!==e[0]&&o.push(c),i&&(i=!1)})),o;var t,o,a,i,c}},"Patch.js":function(e,n,t){var r=t("./Common"),o=t("./Operation"),a=t("./sha256"),i=e.exports,c=i.create=function(e,n){var t=Object.freeze({type:"Patch",operations:[],parentHash:e,isCheckpoint:!!n,mut:{inverseOf:void 0}});return n&&(t.mut.inverseOf=t),t},s=i.check=function(e,n){r.assert("Patch"===e.type),r.assert(Array.isArray(e.operations)),r.assert(/^[0-9a-f]{64}$/.test(e.parentHash));for(var t=e.operations.length-1;t>=0;t--)o.check(e.operations[t],n),t>0&&r.assert(!o.shouldMerge(e.operations[t],e.operations[t-1])),"number"==typeof n&&(n+=o.lengthChange(e.operations[t]));return e.isCheckpoint&&(r.assert(1===e.operations.length),r.assert(0===e.operations[0].offset),"number"==typeof n&&r.assert(!n||e.operations[0].toRemove===n)),e};i.toObj=function(e){r.PARANOIA&&s(e);var n,t=new Array(e.operations.length+1);for(n=0;n<e.operations.length;n++)t[n]=o.toObj(e.operations[n]);return t[n]=e.parentHash,t},i.fromObj=function(e,n){r.assert(Array.isArray(e)&&e.length>0);var t,i=c(a.check(e[e.length-1]),n);for(t=0;t<e.length-1;t++)i.operations[t]=o.fromObj(e[t]);return r.PARANOIA&&s(i),i};var u=function(e){return a.hex_sha256(e)},l=i.addOperation=function(e,n){r.PARANOIA&&(s(e),o.check(n));for(var t=0;t<e.operations.length;t++)if(o.shouldMerge(e.operations[t],n)){var a=o.merge(e.operations[t],n);if(e.operations.splice(t,1),null===a)return;n=a,t--}else{var i=o.rebase(e.operations[t],n);if(i===n)return void e.operations.splice(t,0,n);n=i}e.operations.push(n),r.PARANOIA&&s(e)};i.createCheckpoint=function(e,n,t){var a=o.create(0,e.length,n);r.PARANOIA&&t&&r.assert(t===u(e)),t=t||u(e);var i=c(t,!0);return i.operations[0]=a,i};var f=i.clone=function(e){r.PARANOIA&&s(e);for(var n=c(e.parentHash,e.isCheckpoint),t=0;t<e.operations.length;t++)n.operations[t]=e.operations[t];return n};i.merge=function(e,n){if(r.PARANOIA&&(s(e),s(n)),e.isCheckpoint)return r.assert(n.parentHash===e.parentHash),n.isCheckpoint?c(e.parentHash):f(n);if(n.isCheckpoint)return f(e);e=f(e);for(var t=n.operations.length-1;t>=0;t--)l(e,n.operations[t]);return e},i.apply=function(e,n){r.PARANOIA&&(s(e),r.assert("string"==typeof n),r.assert(a.hex_sha256(n)===e.parentHash));for(var t=n,i=e.operations.length-1;i>=0;i--)t=o.apply(e.operations[i],t);return t},i.lengthChange=function(e){r.PARANOIA&&s(e);for(var n=0,t=0;t<e.operations.length;t++)n+=o.lengthChange(e.operations[t]);return n},i.invert=function(e,n){r.PARANOIA&&(s(e),r.assert("string"==typeof n),r.assert(a.hex_sha256(n)===e.parentHash));for(var t=n,i=new Array(e.operations.length),u=e.operations.length-1;u>=0;u--)i[u]=o.invert(e.operations[u],t),t=o.apply(e.operations[u],t);var l=new Array(e.operations.length);!function(){for(var e=i.length-1;e>=0;e--){l[e]=i[e].offset;for(var n=e-1;n>=0;n--)l[e]+=i[n].toRemove-i[n].toInsert.length}}();var f=c(a.hex_sha256(t),e.isCheckpoint);f.operations.splice(0,f.operations.length);for(var d=0;d<i.length;d++)f.operations[d]=o.create(l[d],i[d].toRemove,i[d].toInsert);return r.PARANOIA&&s(f),f},i.simplify=function(e,n,t){r.PARANOIA&&(s(e),r.assert("string"==typeof n),r.assert(a.hex_sha256(n)===e.parentHash));for(var i=c(e.parentHash),u=n,l=[],f=0,d=e.operations.length-1;d>=0;d--){var h=t(e.operations[d],u,o.simplify);h&&(u=o.apply(h,u),l[f++]=h)}return Array.prototype.push.apply(i.operations,l.reverse()),i.operations[0]||i.operations.shift(),r.PARANOIA&&s(i),i},i.equals=function(e,n){if(e.operations.length!==n.operations.length)return!1;for(var t=0;t<e.operations.length;t++)if(!o.equals(e.operations[t],n.operations[t]))return!1;return!0};var d=function(e,n){return 0===e.offset&&e.toRemove===n.length&&e.toInsert===n};i.transform=function(e,n,t,o){if(r.PARANOIA&&(s(e,t.length),s(n,t.length),a.hex_sha256(t)!==e.parentHash))throw new Error("wrong hash");if(e.parentHash!==n.parentHash)throw new Error;var u=i.apply(n,t),l=c(n.mut.inverseOf?n.mut.inverseOf.parentHash:a.hex_sha256(u),e.isCheckpoint);if(0===n.operations.length)return f(e);if(0===e.operations.length){if(e.isCheckpoint)throw new Error;return l}if(e.isCheckpoint||1===e.operations.length&&d(e.operations[0],t))throw new Error("Attempting to transform a checkpoint, this should not happen");if(1===n.operations.length&&d(n.operations[0],t)){if(!n.isCheckpoint)throw new Error;return e}if(n.isCheckpoint)throw new Error;var h=o(e.operations,n.operations,t);return Array.prototype.push.apply(l.operations,h),r.PARANOIA&&s(l,u.length),l},i.random=function(e,n){r.assert("string"==typeof e),n=n||Math.floor(30*Math.random())+1;for(var t=c(a.hex_sha256(e)),i=e.length;n-- >0;){var u=o.random(i);i+=o.lengthChange(u),l(t,u)}return s(t),t},Object.freeze(e.exports)},"SHA256.js":function(e,n,t){!function(){function n(e,n){var t=(65535&e)+(65535&n);return(e>>16)+(n>>16)+(t>>16)<<16|65535&t}function t(e,n){return e>>>n|e<<32-n}function r(e,n){return e>>>n}function o(e,n,t){return e&n^~e&t}function a(e,n,t){return e&n^e&t^n&t}function i(e){return t(e,2)^t(e,13)^t(e,22)}function c(e){return t(e,6)^t(e,11)^t(e,25)}function s(e){return t(e,7)^t(e,18)^r(e,3)}e.exports.hex_sha256=function(e){return function(e){for(var n="0123456789abcdef",t="",r=0;r<4*e.length;r++)t+=n.charAt(e[r>>2]>>8*(3-r%4)+4&15)+n.charAt(e[r>>2]>>8*(3-r%4)&15);return t}(function(e,u){var l,f,d,h,p,v,y,m,g,E,b,A=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],_=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],w=function(e){for(var n=[];e>0;e--)n.push(void 0);return n}(64);e[u>>5]|=128<<24-u%32,e[15+(u+64>>9<<4)]=u;for(var O=0;O<e.length;O+=16){l=_[0],f=_[1],d=_[2],h=_[3],p=_[4],v=_[5],y=_[6],m=_[7];for(var D=0;D<64;D++)w[D]=D<16?e[D+O]:n(n(n(t(b=w[D-2],17)^t(b,19)^r(b,10),w[D-7]),s(w[D-15])),w[D-16]),g=n(n(n(n(m,c(p)),o(p,v,y)),A[D]),w[D]),E=n(i(l),a(l,f,d)),m=y,y=v,v=p,p=n(h,g),h=d,d=f,f=l,l=n(g,E);_[0]=n(l,_[0]),_[1]=n(f,_[1]),_[2]=n(d,_[2]),_[3]=n(h,_[3]),_[4]=n(p,_[4]),_[5]=n(v,_[5]),_[6]=n(y,_[6]),_[7]=n(m,_[7])}return _}(function(e){for(var n=Array(),t=0;t<8*e.length;t+=8)n[t>>5]|=(255&e.charCodeAt(t/8))<<24-t%32;return n}(e),8*e.length))}}()},"Common.js":function(e,n,r){e.exports.global=function(){if("undefined"!=typeof self)return self;if(void 0!==t)return t;if("undefined"!=typeof window)return window;throw new Error("no self, nor global, nor window")}();var o=function(n){return"undefined"!=typeof localStorage&&localStorage[n]?localStorage[n]:e.exports.global[n]},a=e.exports.PARANOIA=o("ChainPad_PARANOIA");e.exports.VALIDATE_ENTIRE_CHAIN_EACH_MSG=o("ChainPad_VALIDATE_ENTIRE_CHAIN_EACH_MSG"),e.exports.TESTING=o("ChainPad_TESTING"),e.exports.assert=function(e){if(!e)throw new Error("Failed assertion")},e.exports.isUint=function(e){return"number"==typeof e&&Math.floor(e)===e&&e>=0},e.exports.randomASCII=function(e){for(var n=[],t=0;t<e;t++)n[t]=String.fromCharCode(Math.floor(256*Math.random())%57+65);return n.join("")},e.exports.strcmp=function(e,n){if(a&&"string"!=typeof e)throw new Error;if(a&&"string"!=typeof n)throw new Error;return e===n?0:e>n?1:-1},Object.freeze(e.exports)},"sha256.js":function(e,n,t){var r=t("./sha256/exports.js"),o=t("./SHA256.js"),a=t("./Common");e.exports.check=function(e){if("string"!=typeof e)throw new Error;if(!/[a-f0-9]{64}/.test(e))throw new Error;return e},e.exports.hex_sha256=function(e){e+="";var n=r.hex(function(e){for(var n=new Uint8Array(e.length),t=0;t<e.length;t++)n[t]=255&e.charCodeAt(t);return n}(e));if(a.PARANOIA){var t=o.hex_sha256(e);if(t!==n){try{throw new Error}catch(n){console.log({hashErr:n,badHash:e,asmHasher:r.hex,oldHasher:o.hex_sha256})}return t}}return n},Object.freeze(e.exports)},"Message.js":function(e,n,t){var r=t("./Common"),o=t("./Patch"),a=t("./sha256"),i=e.exports,c=i.PATCH=2,s=i.CHECKPOINT=4,u=i.check=function(e){return r.assert("Message"===e.type),r.assert(e.messageType===c||e.messageType===s),o.check(e.content),r.assert("string"==typeof e.lastMsgHash),e},l=i.create=function(e,n,t){var o={type:"Message",messageType:e,content:n,lastMsgHash:t,hashOf:"",mut:{parentCount:void 0,isInitialMessage:!1,isFromMe:!1,parent:void 0,time:void 0,author:void 0,serverHash:void 0}};return o.hashOf=d(o),r.PARANOIA&&u(o),Object.freeze(o)},f=i.toStr=i.toString=function(e){if(r.PARANOIA&&u(e),e.messageType===c||e.messageType===s){if(!e.content)throw new Error;return JSON.stringify([e.messageType,o.toObj(e.content),e.lastMsgHash])}throw new Error};i.fromString=function(e){var n={};"object"==typeof e&&(n=e,e=e.msg);var t=JSON.parse(e);if(t[0]!==s&&t[0]!==c)throw new Error("invalid message type "+t[0]);var r=l(t[0],o.fromObj(t[1],t[0]===s),t[2]);return r.mut.author=n.author,r.mut.time=n.time&&new Date(n.time),r.mut.serverHash=n.serverHash,Object.freeze(r)};var d=i.hashOf=function(e){return r.PARANOIA&&u(e),a.hex_sha256(f(e))};Object.freeze(e.exports)},"ChainPad.js":function(e,n,t){var r=e.exports.Common=t("./Common"),o=e.exports.Operation=t("./Operation"),a=e.exports.Patch=t("./Patch"),i=e.exports.Message=t("./Message"),c=e.exports.Sha=t("./sha256"),s=e.exports.Diff=t("./Diff"),u=e.exports.TextTransformer=t("./transform/TextTransformer");e.exports.NaiveJSONTransformer=t("./transform/NaiveJSONTransformer"),e.exports.SmartJSONTransformer=t("./transform/SmartJSONTransformer");var l=e.exports.EMPTY_STR_HASH="e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",f=function(e,n){e.logLevel>1&&console.log("["+e.userName+"]  "+n)},d=function(e,n){e.logLevel>0&&console.error("["+e.userName+"]  "+n)},h=function(e,n,t){if(!e.aborted){t||(t=Math.floor(2*Math.random()*e.config.avgSyncMilliseconds));var r=setTimeout((function(){e.schedules.splice(e.schedules.indexOf(r),1),n()}),t);return e.schedules.push(r),r}},p=function(e,n){var t=e.schedules.indexOf(n);t>-1&&e.schedules.splice(t,1),clearTimeout(n)},v=function(e,n,t,o){var a=i.toStr(n);if(function(e,n,t){e.messageHandlers.length||t("no onMessage() handler registered");try{e.messageHandlers.forEach((function(e){e(n,(function(){t.apply(null,arguments),t=function(){}}))}))}catch(e){t(e.stack)}}(e,a,(function(t){if(t)f(e,"Posting to server failed ["+t+"]"),e.pending=null,e.syncSchedule=h(e,(function(){g(e)}));else{var o=e.pending;if(e.pending=null,!o)throw new Error;r.assert(o.hash===n.hashOf),R(e,a,!0)?(e.timeOfLastSuccess=+new Date,e.lag=+new Date-o.timeSent):f(e,"Our message ["+n.hashOf+"] failed validation"),o.callback()}})),e.pending)throw new Error("there is already a pending message");-1===e.timeOfLastSuccess&&(e.timeOfLastSuccess=+new Date),e.pending={hash:n.hashOf,timeSent:+new Date,callback:function(){e.syncSchedule=h(e,(function(){g(e)}),0),t()}},r.PARANOIA&&_(e)},y=function(e){var n=e.onSettle;e.onSettle=[],n.forEach((function(n){try{n()}catch(n){d(e,"Error in onSettle handler ["+n.stack+"]")}}))},m=function(e){if(!e.mut.inverseOf)throw new Error;return e.mut.inverseOf},g=function(e,n){if(r.PARANOIA&&_(e),e.syncSchedule&&!e.pending){if(p(e,e.syncSchedule),e.syncSchedule=null,e.uncommitted=a.simplify(e.uncommitted,e.authDoc,e.config.operationSimplify),0===e.uncommitted.operations.length)return y(e),e.timeOfLastSuccess=+new Date,void(e.syncSchedule=h(e,(function(){g(e)})));var t=D(e,e.best)+1;if(t%e.config.checkpointInterval!=0){var o;o=e.setContentPatch?e.setContentPatch:i.create(i.PATCH,e.uncommitted,e.best.hashOf),v(e,o,(function(){e.setContentPatch&&(f(e,"initial Ack received ["+o.hashOf+"]"),e.setContentPatch=null)}))}else{var c=e.best;if(f(e,"Sending checkpoint (interval ["+e.config.checkpointInterval+"]) patch no ["+t+"]"),f(e,D(e,e.best)),!c||!c.content||!m(c.content))throw new Error;var s=a.createCheckpoint(e.authDoc,e.authDoc,m(c.content).parentHash),u=i.create(i.CHECKPOINT,s,c.hashOf);v(e,u,(function(){f(e,"Checkpoint sent and accepted")}))}}},E=function(e,n){r.assert(n.lastMsgHash),r.assert(n.hashOf),e.messages[n.hashOf]=n,(e.messagesByParent[n.lastMsgHash]=e.messagesByParent[n.lastMsgHash]||[]).push(n)},b=function(e,n){r.assert(n.lastMsgHash),r.assert(n.hashOf),delete e.messages[n.hashOf];var t=e.messagesByParent[n.lastMsgHash];r.assert(t.indexOf(n)>-1),t.splice(t.indexOf(n),1),0===t.length&&delete e.messagesByParent[n.lastMsgHash];var o=e.messagesByParent[n.hashOf];if(o)for(var a=0;a<o.length;a++)delete o[a].mut.parent},A=function(e,n){return n.mut.parent=n.mut.parent||e.messages[n.lastMsgHash]},_=function(e){r.assert("ChainPad"===e.type),r.assert("string"==typeof e.authDoc),a.check(e.uncommitted,e.authDoc.length);var n=a.apply(e.uncommitted,e.authDoc);if(r.assert(n.length===w(e)),""!==e.userInterfaceContent&&r.assert(n===e.userInterfaceContent),r.VALIDATE_ENTIRE_CHAIN_EACH_MSG){var t=e.authDoc,o=e.best;r.assert(m(o.content).parentHash===e.uncommitted.parentHash);var i=[];do{i.push(o),t=a.apply(m(o.content),t)}while(o=A(e,o));if(e.rootMessage.content.isCheckpoint){if(t!==e.rootMessage.content.operations[0].toInsert)throw new Error}else if(""!==t)throw new Error;for(;o=i.pop();)t=a.apply(o.content,t);r.assert(t===e.authDoc)}},w=function(e){return e.authDoc.length+a.lengthChange(e.uncommitted)},O=function(e,n,t){if(!n)return!1;for(;;){if(!t)return!1;if(n===t)return!0;t=A(e,t)}},D=function(e,n){if("number"==typeof n.mut.parentCount)return n.mut.parentCount;for(var t=[];"number"!=typeof n.mut.parentCount;n=A(e,n)){if(!n){if(n===e.rootMessage)throw new Error("root message does not have parent count");throw new Error("parentCount called on unlinked message")}t.unshift(n)}for(var r=n.mut.parentCount,o=0;o<t.length;o++)t[o].mut.parentCount=++r;return r},S=function(e,n,t){var o;if(r.assert(t),n)r.assert(t.parentHash===e.uncommitted.parentHash),e.uncommitted=a.merge(m(t),e.uncommitted);else if(e.uncommitted=a.transform(e.uncommitted,t,e.authDoc,e.config.patchTransformer),e.config.validateContent){o=a.apply(t,e.authDoc);var i=a.apply(e.uncommitted,o);e.config.validateContent(i)||(d(e,"Transformed patch is not valid"),e.uncommitted=a.create(c.hex_sha256(e.authDoc)))}r.assert(e.uncommitted.parentHash===m(t).parentHash),e.authDoc=o||a.apply(t,e.authDoc),r.PARANOIA&&(r.assert(e.uncommitted.parentHash===m(t).parentHash),r.assert(c.hex_sha256(e.authDoc)===e.uncommitted.parentHash),e.userInterfaceContent=a.apply(e.uncommitted,e.authDoc))},T=function(e,n){var t=n;return(e.messagesByParent[n.hashOf]||[]).forEach((function(o){r.assert(o.lastMsgHash===n.hashOf),o=T(e,o),D(e,o)>D(e,t)&&(t=o)})),t},x=function(e,n){n.operations.length&&(e.patchHandlers.forEach((function(e){e(n)})),e.changeHandlers.forEach((function(e){n.operations.forEach((function(n){e(n.offset,n.toRemove,n.toInsert)}))})))},C=function(e,n){try{return e.config.validateContent(n())}catch(n){d(e,"Error in content validator ["+n.stack+"]")}return!1},N=function(e,n,t){for(var r=A(e,n);r;r=A(e,r))if(!1===t(r))return},I=function(e,n){e.mut.inverseOf||((e.mut.inverseOf=a.invert(e,n)).mut.inverseOf=e)},R=function(e,n,t){r.PARANOIA&&_(e);var s=i.fromString(n);if(f(e,JSON.stringify([s.hashOf,s.content.operations])),e.messages[s.hashOf]){if(e.setContentPatch&&e.setContentPatch.hashOf===s.hashOf)e.setContentPatch=null;else{if(s.content.isCheckpoint)return f(e,"["+(t?"our":"their")+"] Checkpoint ["+s.hashOf+"] is already known"),!0;f(e,"Patch ["+s.hashOf+"] is already known")}r.PARANOIA&&_(e)}else if(!s.content.isCheckpoint||C(e,(function(){return s.content.operations[0].toInsert}))){if(E(e,s),!O(e,e.rootMessage,s)){if(s.content.isCheckpoint&&e.best.mut.isInitialMessage){f(e,"applying checkpoint ["+s.hashOf+"]");var u=a.apply(e.uncommitted,e.authDoc);r.assert(!r.PARANOIA||e.userInterfaceContent===u);var l=a.invert(e.uncommitted,e.authDoc);return a.addOperation(l,o.create(0,e.authDoc.length,s.content.operations[0].toInsert)),l=a.simplify(l,u,e.config.operationSimplify),s.mut.parentCount=0,e.rootMessage=e.best=s,e.authDoc=s.content.operations[0].toInsert,e.uncommitted=a.create(c.hex_sha256(e.authDoc)),x(e,l),r.PARANOIA&&(e.userInterfaceContent=e.authDoc),!0}return f(e,"Patch ["+s.hashOf+"] not connected to root (parent: ["+s.lastMsgHash+"])"),void(r.PARANOIA&&_(e))}(s=T(e,s)).mut.isFromMe=t;var d=s.content,h=[],p=e.best;if(!O(e,e.best,s)){var v=D(e,e.best),g=D(e,s);if(!(v<g||v===g&&r.strcmp(e.best.hashOf,s.hashOf)>0))return f(e,"Patch ["+s.hashOf+"] chain is ["+g+"] best chain is ["+v+"]"),r.PARANOIA&&_(e),!0;for(;p&&!O(e,p,s);)h.push(p),p=A(e,p);r.assert(p),f(e,"Patch ["+s.hashOf+"] better than best chain, switching")}var R=[],P=s;do{R.unshift(P),P=A(e,P),r.assert(P)}while(P!==p);var k=e.authDoc;h.forEach((function(e){k=a.apply(m(e.content),k)})),R.forEach((function(e,n){n!==R.length-1&&(I(e.content,k),k=a.apply(e.content,k))}));var M=e.best;if(R.length>1?(M=R[R.length-2],r.assert(M)):h.length&&(M=A(e,h[h.length-1]),r.assert(M)),r.assert(m(M.content).parentHash),r.assert(!r.PARANOIA||m(M.content).parentHash===c.hex_sha256(k)),m(M.content).parentHash===d.parentHash){if(d.isCheckpoint&&e.config.noPrune);else if(d.isCheckpoint){var F;if(N(e,s,(function(e){if(e.content.isCheckpoint){if(F)return F=e,!1;F=e}})),F&&F!==e.rootMessage){var L=D(e,F);if(e.config.strictCheckpointValidation&&L%e.config.checkpointInterval!=0){if(f(e,"checkpoint ["+s.hashOf+"] at invalid point ["+L+"]"),r.PARANOIA&&_(e),r.TESTING)throw new Error;return void b(e,s)}f(e,"checkpoint ["+s.hashOf+"]"),N(e,F,(function(n){f(e,"pruning ["+n.hashOf+"]"),b(e,n)})),e.rootMessage=F}}else{var K=a.simplify(d,k,e.config.operationSimplify);if(!a.equals(K,d)){if(f(e,"patch ["+s.hashOf+"] can be simplified"),r.PARANOIA&&_(e),r.TESTING)throw new Error;return void b(e,s)}if(!C(e,(function(){return a.apply(d,k)})))return void f(e,"Patch ["+s.hashOf+"] failed content validation")}I(d,k),e.uncommitted=a.simplify(e.uncommitted,e.authDoc,e.config.operationSimplify);var H=a.apply(e.uncommitted,e.authDoc);r.PARANOIA&&r.assert(H===e.userInterfaceContent);var j=a.invert(e.uncommitted,e.authDoc);if(h.forEach((function(n){f(e,"reverting ["+n.hashOf+"]"),n.mut.isFromMe&&f(e,"reverting patch 'from me' ["+JSON.stringify(n.content.operations)+"]"),j=a.merge(j,m(n.content)),function(e,n,t){S(e,n,m(t))}(e,n.mut.isFromMe,n.content)})),R.forEach((function(n){f(e,"applying ["+n.hashOf+"]"),j=a.merge(j,n.content),S(e,n.mut.isFromMe,n.content)})),j=a.merge(j,e.uncommitted),j=a.simplify(j,H,e.config.operationSimplify),e.best=s,r.PARANOIA){var U=a.apply(j,H);r.assert(e.userInterfaceContent.length===w(e)),r.assert(U===e.userInterfaceContent)}return x(e,j),e.uncommitted.operations.length||y(e),r.PARANOIA&&_(e),!0}if(f(e,"patch ["+s.hashOf+"] parentHash is not valid"),r.PARANOIA&&_(e),r.TESTING)throw new Error;b(e,s)}else f(e,"Checkpoint ["+s.hashOf+"] failed content validation")},P=function(e,n){return Object.freeze({type:"Block",hashOf:n.hashOf,lastMsgHash:n.lastMsgHash,isCheckpoint:!!n.content.isCheckpoint,isFromMe:n.mut&&n.mut.isFromMe,author:n.mut&&n.mut.author,serverHash:n.mut&&n.mut.serverHash,time:n.mut&&n.mut.time,getParent:function(){var t=A(e,n);if(t)return P(e,t)},getContent:function(){return function(e,n){for(var t=[n];t[0]!==e.rootMessage;){var o=A(e,t[0]);if(!o)return{error:"not connected to root",doc:void 0};t.unshift(o)}var i="";e.rootMessage.content.operations.length&&(r.assert(1===e.rootMessage.content.operations.length),i=e.rootMessage.content.operations[0].toInsert);for(var c=1;c<t.length;c++)i=a.apply(t[c].content,i);return{error:void 0,doc:i}}(e,n)},getPatch:function(){return a.clone(n.content)},getInversePatch:function(){return a.clone(m(n.content))},equals:function(e,t){return t?n===t:!(!e||"object"!=typeof e||"Block"!==e.type)&&e.equals(e,n)}})};e.exports.create=function(e){var n=function(e){var n=a.create(l);I(n,"");var t=i.create(i.PATCH,n,"0000000000000000000000000000000000000000000000000000000000000000");t.mut.parentCount=0,t.mut.isInitialMessage=!0;var r,c=t;if(""!==e.initialState){var s=a.create(l);a.addOperation(s,o.create(0,0,e.initialState)),I(s,""),(r=i.create(i.PATCH,s,t.hashOf)).mut.isInitialMessage=!0,c=r}var u={type:"ChainPad",authDoc:e.initialState,config:e,logLevel:e.logLevel,uncommitted:a.create(m(c.content).parentHash),patchHandlers:[],changeHandlers:[],messageHandlers:[],schedules:[],aborted:!1,syncSchedule:-2,userInterfaceContent:e.initialState,setContentPatch:r,pending:void 0,messages:{},messagesByParent:{},rootMessage:t,onSettle:[],userName:e.userName,best:c,lag:0,timeOfLastSuccess:-1};return E(u,t),r&&E(u,r),u}(function(e){if((e=e||{}).transformFunction)throw new Error("chainpad config transformFunction is nolonger used");return Object.freeze({initialState:e.initialState||"",checkpointInterval:e.checkpointInterval||50,avgSyncMilliseconds:e.avgSyncMilliseconds||300,strictCheckpointValidation:e.strictCheckpointValidation||!1,operationSimplify:e.operationSimplify||o.simplify,logLevel:"number"==typeof e.logLevel?e.logLevel:2,noPrune:e.noPrune,patchTransformer:e.patchTransformer||u,userName:e.userName||"anonymous",validateContent:e.validateContent||function(e){return!0},diffFunction:e.diffFunction||function(e,n){return s.diff(e,n)}})}(e)),t={onPatch:function(e){r.assert("function"==typeof e),n.patchHandlers.push(e)},patch:function(e,o,i){if("number"!=typeof e)!function(e,n){r.PARANOIA&&(_(e),r.assert(a.invert(e.uncommitted,e.authDoc).parentHash===n.parentHash),e.userInterfaceContent=a.apply(n,e.userInterfaceContent)),a.check(n,w(e)),e.uncommitted=a.merge(e.uncommitted,n)}(n,e);else{if("number"!=typeof o||"string"!=typeof i)throw new Error;t.change(e,o,i)}},onChange:function(e){r.assert("function"==typeof e),n.changeHandlers.push(e)},change:function(e,t,i){0===t&&""===i||function(e,n){r.PARANOIA&&(_(e),e.userInterfaceContent=o.apply(n,e.userInterfaceContent)),o.check(n,w(e)),a.addOperation(e.uncommitted,n)}(n,o.create(e,t,i))},contentUpdate:function(e){var t=n.config.diffFunction(n.authDoc,e),r=a.create(n.uncommitted.parentHash);Array.prototype.push.apply(r.operations,t),n.uncommitted=r},onMessage:function(e){r.assert("function"==typeof e),n.messageHandlers.push(e)},message:function(e){R(n,e,!1)},start:function(){n.aborted=!1,n.syncSchedule&&p(n,n.syncSchedule),n.pending=null,n.syncSchedule=h(n,(function(){g(n)}))},abort:function(){n.aborted=!0,n.schedules.forEach((function(e){clearTimeout(e)}))},sync:function(){g(n)},getAuthDoc:function(){return n.authDoc},getUserDoc:function(){return a.apply(n.uncommitted,n.authDoc)},getDepthOfState:function(e,t){return function(e,n,t){if(r.assert("string"==typeof e),0===(n=n||0)&&t.authDoc===e)return 0;var o=c.hex_sha256(e),a=t.best,i=0;do{if(i<n);else if(a.content.parentHash===o)return i+1;i++}while(a=A(t,a));return-1}(e,t,n)},onSettle:function(e){r.assert("function"==typeof e),n.onSettle.push(e)},getAuthBlock:function(){return P(n,n.best)},getBlockForHash:function(e){r.assert("string"==typeof e);var t=n.messages[e];if(t)return P(n,t)},getLag:function(){var e=!!n.pending,t=n.lag;return n.pending&&(t=+new Date-n.timeOfLastSuccess),{pending:e,lag:t,active:!n.aborted&&-2!==n.syncSchedule}},_:void 0};return t._=n,Object.freeze(t)},Object.freeze(e.exports)},"Operation.js":function(e,n,t){var r=t("./Common"),o=e.exports,a=o.check=function(e,n){if(r.assert("Operation"===e.type),!r.isUint(e.offset))throw new Error;if(!r.isUint(e.toRemove))throw new Error;if("string"!=typeof e.toInsert)throw new Error;if(e.toRemove<1&&e.toInsert.length<1)throw new Error;return r.assert("number"!=typeof n||e.offset+e.toRemove<=n),e},i=o.create=function(e,n,t){var o={type:"Operation",offset:e||0,toRemove:n||0,toInsert:t||""};return r.PARANOIA&&a(o),Object.freeze(o)};o.toObj=function(e){return r.PARANOIA&&a(e),[e.offset,e.toRemove,e.toInsert]},o.fromObj=function(e){return r.assert(Array.isArray(e)&&3===e.length),i(e[0],e[1],e[2])};var c=o.apply=function(e,n){return r.PARANOIA&&(r.assert("string"==typeof n),a(e,n.length)),n.substring(0,e.offset)+e.toInsert+n.substring(e.offset+e.toRemove)};o.applyMulti=function(e,n){for(var t=e.length-1;t>=0;t--)n=c(e[t],n);return n};var s=o.invert=function(e,n){return r.PARANOIA&&(a(e),r.assert("string"==typeof n),r.assert(e.offset+e.toRemove<=n.length)),i(e.offset,e.toInsert.length,(" "+n.substring(e.offset,e.offset+e.toRemove)).slice(1))},u=/[\uD800-\uDBFF]|[\uDC00-\uDFFF]/,l=o.hasSurrogate=function(e){return u.test(e)};o.simplify=function(e,n){r.PARANOIA&&(a(e),r.assert("string"==typeof n),r.assert(e.offset+e.toRemove<=n.length));for(var t=s(e,n),o=Math.min(e.toInsert.length,t.toInsert.length),c=0;c<o&&t.toInsert[c]===e.toInsert[c];){if(l(t.toInsert[c])||l(e.toInsert[c])){if(e.toInsert[c+1]!==t.toInsert[c+1])break;c++}c++}var u=e.offset+c,f=e.toRemove-c,d=e.toInsert.substring(c),h=t.toInsert.substring(c);if(h.length===d.length){for(c=h.length-1;c>=0&&h[c]===d[c];c--);d=d.substring(0,c+1),f=c+1}return 0===f&&0===d.length?null:i(u,f,d)},o.equals=function(e,n){return e.toRemove===n.toRemove&&e.toInsert===n.toInsert&&e.offset===n.offset},o.lengthChange=function(e){return r.PARANOIA&&a(e),e.toInsert.length-e.toRemove},o.merge=function(e,n){r.PARANOIA&&(a(n),a(e));var t=e.offset,o=e.toRemove,c=e.toInsert,s=n.offset,u=n.toRemove,l=n.toInsert,f=s-t;if(u>0){var d=c;c=c.substring(0,f)+c.substring(f+u),(u-=d.length-c.length)<0&&(u=0),o+=u,u=0}if(f<0)t+=f,c=l+c;else if(c.length===f)c+=l;else{if(!(c.length>f))throw new Error("should never happen\n"+JSON.stringify([e,n],null,"  "));c=c.substring(0,f)+l+c.substring(f)}return""===c&&0===o?null:i(t,o,c)},o.shouldMerge=function(e,n){return r.PARANOIA&&(a(e),a(n)),n.offset<e.offset?e.offset<=n.offset+n.toRemove:n.offset<=e.offset+e.toInsert.length},o.rebase=function(e,n){return r.PARANOIA&&(a(e),a(n)),n.offset<e.offset?n:i(n.offset+e.toRemove-e.toInsert.length,n.toRemove,n.toInsert)},o.random=function(e){r.assert(r.isUint(e));var n=Math.floor(1e8*Math.random()%e)||0,t=Math.floor(1e8*Math.random()%(e-n))||0,o="";do{o=r.randomASCII(Math.floor(20*Math.random()))}while(0===t&&""===o);return i(n,t,o)},Object.freeze(e.exports)},"sha256/hash.js":function(e,n,t){var r=t("./utils.js");e.exports.hash_reset=function(){return this.result=null,this.pos=0,this.len=0,this.asm.reset(),this},e.exports.hash_process=function(e){if(null!==this.result)throw new IllegalStateError("state must be reset before processing new data");if(r.is_string(e)&&(e=r.string_to_bytes(e)),r.is_buffer(e)&&(e=new Uint8Array(e)),!r.is_bytes(e))throw new TypeError("data isn't of expected type");for(var n=this.asm,t=this.heap,o=this.pos,a=this.len,i=0,c=e.length,s=0;c>0;)a+=s=r._heap_write(t,o+a,e,i,c),i+=s,c-=s,o+=s=n.process(o,a),(a-=s)||(o=0);return this.pos=o,this.len=a,this},e.exports.hash_finish=function(){if(null!==this.result)throw new IllegalStateError("state must be reset before processing new data");return this.asm.finish(this.pos,this.len,0),this.result=new Uint8Array(this.HASH_SIZE),this.result.set(this.heap.subarray(0,this.HASH_SIZE)),this.pos=0,this.len=0,this}},"sha256/utils.js":function(e,n,t){var r=e.exports.string_to_bytes=function(e,n){n=!!n;for(var t=e.length,r=new Uint8Array(n?4*t:t),o=0,a=0;o<t;o++){var i=e.charCodeAt(o);if(n&&55296<=i&&i<=56319){if(++o>=t)throw new Error("Malformed string, low surrogate expected at position "+o);i=(55296^i)<<10|65536|56320^e.charCodeAt(o)}else if(!n&&i>>>8)throw new Error("Wide characters are not allowed.");!n||i<=127?r[a++]=i:i<=2047?(r[a++]=192|i>>6,r[a++]=128|63&i):i<=65535?(r[a++]=224|i>>12,r[a++]=128|i>>6&63,r[a++]=128|63&i):(r[a++]=240|i>>18,r[a++]=128|i>>12&63,r[a++]=128|i>>6&63,r[a++]=128|63&i)}return r.subarray(0,a)};e.exports.hex_to_bytes=function(e){var n=e.length;1&n&&(e="0"+e,n++);for(var t=new Uint8Array(n>>1),r=0;r<n;r+=2)t[r>>1]=parseInt(e.substr(r,2),16);return t},e.exports.base64_to_bytes=function(e){return r(atob(e))};var o=e.exports.bytes_to_string=function(e,n){n=!!n;for(var t=e.length,r=new Array(t),o=0,a=0;o<t;o++){var i=e[o];if(!n||i<128)r[a++]=i;else if(i>=192&&i<224&&o+1<t)r[a++]=(31&i)<<6|63&e[++o];else if(i>=224&&i<240&&o+2<t)r[a++]=(15&i)<<12|(63&e[++o])<<6|63&e[++o];else{if(!(i>=240&&i<248&&o+3<t))throw new Error("Malformed UTF8 character at byte offset "+o);var c=(7&i)<<18|(63&e[++o])<<12|(63&e[++o])<<6|63&e[++o];c<=65535?r[a++]=c:(c^=65536,r[a++]=55296|c>>10,r[a++]=56320|1023&c)}}for(var s="",u=16384,l=0;l<a;l+=u)s+=String.fromCharCode.apply(String,r.slice(l,l+u<=a?l+u:a));return s};e.exports.bytes_to_hex=function(e){for(var n="",t=0;t<e.length;t++){var r=(255&e[t]).toString(16);r.length<2&&(n+="0"),n+=r}return n},e.exports.bytes_to_base64=function(e){return btoa(o(e))},e.exports.pow2_ceil=function(e){return e-=1,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e+=1},e.exports.is_number=function(e){return"number"==typeof e},e.exports.is_string=function(e){return"string"==typeof e},e.exports.is_buffer=function(e){return e instanceof ArrayBuffer},e.exports.is_bytes=function(e){return e instanceof Uint8Array},e.exports.is_typed_array=function(e){return e instanceof Int8Array||e instanceof Uint8Array||e instanceof Int16Array||e instanceof Uint16Array||e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array||e instanceof Float64Array},e.exports._heap_init=function(e,n){var t=n.heap,r=t?t.byteLength:n.heapSize||65536;if(4095&r||r<=0)throw new Error("heap size must be a positive integer and a multiple of 4096");return t=t||new e(new ArrayBuffer(r))},e.exports._heap_write=function(e,n,t,r,o){var a=e.length-n,i=a<o?a:o;return e.set(t.subarray(r,r+i),n),i}},"sha256/sha256.js":function(e,n,t){var r=t("./utils.js"),o=t("./hash.js"),a=t("./sha256.asm.js");function i(e){e=e||{},this.heap=r._heap_init(Uint8Array,e),this.asm=e.asm||a.sha256_asm({Uint8Array},null,this.heap.buffer),this.BLOCK_SIZE=64,this.HASH_SIZE=32,this.reset()}i.BLOCK_SIZE=64,i.HASH_SIZE=32;var c=i.prototype;c.reset=o.hash_reset,c.process=o.hash_process,c.finish=o.hash_finish;var s=null;e.exports.get_sha256_instance=function(){return null===s&&(s=new i({heapSize:1048576})),s},e.exports.sha256_constructor=i},"sha256/exports.js":function(e,n,t){var r=t("./sha256.js"),o=t("./utils.js");function a(e){if(void 0===e)throw new SyntaxError("data required");return r.get_sha256_instance().reset().process(e).finish().result}r.sha256_constructor.bytes=a,r.sha256_constructor.hex=function(e){var n=a(e);return o.bytes_to_hex(n)},r.sha256_constructor.base64=function(e){var n=a(e);return o.bytes_to_base64(n)},e.exports=r.sha256_constructor},"sha256/sha256.asm.js":function(e,n,t){e.exports.sha256_asm=function(e,n,t){"use asm";var r=0,o=0,a=0,i=0,c=0,s=0,u=0,l=0,f=0,d=0;var h=0,p=0,v=0,y=0,m=0,g=0,E=0,b=0,A=0,_=0,w=0,O=0,D=0,S=0,T=0,x=0;var C=new e.Uint8Array(t);function N(e,n,t,f,d,h,p,v,y,m,g,E,b,A,_,w){e=e|0;n=n|0;t=t|0;f=f|0;d=d|0;h=h|0;p=p|0;v=v|0;y=y|0;m=m|0;g=g|0;E=E|0;b=b|0;A=A|0;_=_|0;w=w|0;var O=0,D=0,S=0,T=0,x=0,C=0,N=0,I=0,R=0;O=r;D=o;S=a;T=i;x=c;C=s;N=u;I=l;R=e+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x428a2f98|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;R=n+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x71374491|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;R=t+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0xb5c0fbcf|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;R=f+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0xe9b5dba5|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;R=d+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x3956c25b|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;R=h+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x59f111f1|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;R=p+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x923f82a4|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;R=v+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0xab1c5ed5|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;R=y+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0xd807aa98|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;R=m+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x12835b01|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;R=g+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x243185be|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;R=E+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x550c7dc3|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;R=b+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x72be5d74|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;R=A+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x80deb1fe|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;R=_+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x9bdc06a7|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;R=w+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0xc19bf174|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;e=R=(n>>>7^n>>>18^n>>>3^n<<25^n<<14)+(_>>>17^_>>>19^_>>>10^_<<15^_<<13)+e+m|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0xe49b69c1|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;n=R=(t>>>7^t>>>18^t>>>3^t<<25^t<<14)+(w>>>17^w>>>19^w>>>10^w<<15^w<<13)+n+g|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0xefbe4786|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;t=R=(f>>>7^f>>>18^f>>>3^f<<25^f<<14)+(e>>>17^e>>>19^e>>>10^e<<15^e<<13)+t+E|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x0fc19dc6|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;f=R=(d>>>7^d>>>18^d>>>3^d<<25^d<<14)+(n>>>17^n>>>19^n>>>10^n<<15^n<<13)+f+b|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x240ca1cc|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;d=R=(h>>>7^h>>>18^h>>>3^h<<25^h<<14)+(t>>>17^t>>>19^t>>>10^t<<15^t<<13)+d+A|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x2de92c6f|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;h=R=(p>>>7^p>>>18^p>>>3^p<<25^p<<14)+(f>>>17^f>>>19^f>>>10^f<<15^f<<13)+h+_|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x4a7484aa|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;p=R=(v>>>7^v>>>18^v>>>3^v<<25^v<<14)+(d>>>17^d>>>19^d>>>10^d<<15^d<<13)+p+w|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x5cb0a9dc|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;v=R=(y>>>7^y>>>18^y>>>3^y<<25^y<<14)+(h>>>17^h>>>19^h>>>10^h<<15^h<<13)+v+e|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x76f988da|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;y=R=(m>>>7^m>>>18^m>>>3^m<<25^m<<14)+(p>>>17^p>>>19^p>>>10^p<<15^p<<13)+y+n|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x983e5152|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;m=R=(g>>>7^g>>>18^g>>>3^g<<25^g<<14)+(v>>>17^v>>>19^v>>>10^v<<15^v<<13)+m+t|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0xa831c66d|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;g=R=(E>>>7^E>>>18^E>>>3^E<<25^E<<14)+(y>>>17^y>>>19^y>>>10^y<<15^y<<13)+g+f|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0xb00327c8|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;E=R=(b>>>7^b>>>18^b>>>3^b<<25^b<<14)+(m>>>17^m>>>19^m>>>10^m<<15^m<<13)+E+d|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0xbf597fc7|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;b=R=(A>>>7^A>>>18^A>>>3^A<<25^A<<14)+(g>>>17^g>>>19^g>>>10^g<<15^g<<13)+b+h|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0xc6e00bf3|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;A=R=(_>>>7^_>>>18^_>>>3^_<<25^_<<14)+(E>>>17^E>>>19^E>>>10^E<<15^E<<13)+A+p|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0xd5a79147|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;_=R=(w>>>7^w>>>18^w>>>3^w<<25^w<<14)+(b>>>17^b>>>19^b>>>10^b<<15^b<<13)+_+v|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x06ca6351|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;w=R=(e>>>7^e>>>18^e>>>3^e<<25^e<<14)+(A>>>17^A>>>19^A>>>10^A<<15^A<<13)+w+y|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x14292967|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;e=R=(n>>>7^n>>>18^n>>>3^n<<25^n<<14)+(_>>>17^_>>>19^_>>>10^_<<15^_<<13)+e+m|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x27b70a85|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;n=R=(t>>>7^t>>>18^t>>>3^t<<25^t<<14)+(w>>>17^w>>>19^w>>>10^w<<15^w<<13)+n+g|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x2e1b2138|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;t=R=(f>>>7^f>>>18^f>>>3^f<<25^f<<14)+(e>>>17^e>>>19^e>>>10^e<<15^e<<13)+t+E|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x4d2c6dfc|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;f=R=(d>>>7^d>>>18^d>>>3^d<<25^d<<14)+(n>>>17^n>>>19^n>>>10^n<<15^n<<13)+f+b|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x53380d13|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;d=R=(h>>>7^h>>>18^h>>>3^h<<25^h<<14)+(t>>>17^t>>>19^t>>>10^t<<15^t<<13)+d+A|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x650a7354|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;h=R=(p>>>7^p>>>18^p>>>3^p<<25^p<<14)+(f>>>17^f>>>19^f>>>10^f<<15^f<<13)+h+_|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x766a0abb|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;p=R=(v>>>7^v>>>18^v>>>3^v<<25^v<<14)+(d>>>17^d>>>19^d>>>10^d<<15^d<<13)+p+w|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x81c2c92e|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;v=R=(y>>>7^y>>>18^y>>>3^y<<25^y<<14)+(h>>>17^h>>>19^h>>>10^h<<15^h<<13)+v+e|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x92722c85|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;y=R=(m>>>7^m>>>18^m>>>3^m<<25^m<<14)+(p>>>17^p>>>19^p>>>10^p<<15^p<<13)+y+n|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0xa2bfe8a1|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;m=R=(g>>>7^g>>>18^g>>>3^g<<25^g<<14)+(v>>>17^v>>>19^v>>>10^v<<15^v<<13)+m+t|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0xa81a664b|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;g=R=(E>>>7^E>>>18^E>>>3^E<<25^E<<14)+(y>>>17^y>>>19^y>>>10^y<<15^y<<13)+g+f|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0xc24b8b70|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;E=R=(b>>>7^b>>>18^b>>>3^b<<25^b<<14)+(m>>>17^m>>>19^m>>>10^m<<15^m<<13)+E+d|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0xc76c51a3|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;b=R=(A>>>7^A>>>18^A>>>3^A<<25^A<<14)+(g>>>17^g>>>19^g>>>10^g<<15^g<<13)+b+h|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0xd192e819|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;A=R=(_>>>7^_>>>18^_>>>3^_<<25^_<<14)+(E>>>17^E>>>19^E>>>10^E<<15^E<<13)+A+p|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0xd6990624|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;_=R=(w>>>7^w>>>18^w>>>3^w<<25^w<<14)+(b>>>17^b>>>19^b>>>10^b<<15^b<<13)+_+v|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0xf40e3585|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;w=R=(e>>>7^e>>>18^e>>>3^e<<25^e<<14)+(A>>>17^A>>>19^A>>>10^A<<15^A<<13)+w+y|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x106aa070|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;e=R=(n>>>7^n>>>18^n>>>3^n<<25^n<<14)+(_>>>17^_>>>19^_>>>10^_<<15^_<<13)+e+m|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x19a4c116|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;n=R=(t>>>7^t>>>18^t>>>3^t<<25^t<<14)+(w>>>17^w>>>19^w>>>10^w<<15^w<<13)+n+g|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x1e376c08|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;t=R=(f>>>7^f>>>18^f>>>3^f<<25^f<<14)+(e>>>17^e>>>19^e>>>10^e<<15^e<<13)+t+E|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x2748774c|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;f=R=(d>>>7^d>>>18^d>>>3^d<<25^d<<14)+(n>>>17^n>>>19^n>>>10^n<<15^n<<13)+f+b|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x34b0bcb5|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;d=R=(h>>>7^h>>>18^h>>>3^h<<25^h<<14)+(t>>>17^t>>>19^t>>>10^t<<15^t<<13)+d+A|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x391c0cb3|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;h=R=(p>>>7^p>>>18^p>>>3^p<<25^p<<14)+(f>>>17^f>>>19^f>>>10^f<<15^f<<13)+h+_|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x4ed8aa4a|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;p=R=(v>>>7^v>>>18^v>>>3^v<<25^v<<14)+(d>>>17^d>>>19^d>>>10^d<<15^d<<13)+p+w|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x5b9cca4f|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;v=R=(y>>>7^y>>>18^y>>>3^y<<25^y<<14)+(h>>>17^h>>>19^h>>>10^h<<15^h<<13)+v+e|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x682e6ff3|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;y=R=(m>>>7^m>>>18^m>>>3^m<<25^m<<14)+(p>>>17^p>>>19^p>>>10^p<<15^p<<13)+y+n|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x748f82ee|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;m=R=(g>>>7^g>>>18^g>>>3^g<<25^g<<14)+(v>>>17^v>>>19^v>>>10^v<<15^v<<13)+m+t|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x78a5636f|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;g=R=(E>>>7^E>>>18^E>>>3^E<<25^E<<14)+(y>>>17^y>>>19^y>>>10^y<<15^y<<13)+g+f|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x84c87814|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;E=R=(b>>>7^b>>>18^b>>>3^b<<25^b<<14)+(m>>>17^m>>>19^m>>>10^m<<15^m<<13)+E+d|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x8cc70208|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;b=R=(A>>>7^A>>>18^A>>>3^A<<25^A<<14)+(g>>>17^g>>>19^g>>>10^g<<15^g<<13)+b+h|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0x90befffa|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;A=R=(_>>>7^_>>>18^_>>>3^_<<25^_<<14)+(E>>>17^E>>>19^E>>>10^E<<15^E<<13)+A+p|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0xa4506ceb|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;_=R=(w>>>7^w>>>18^w>>>3^w<<25^w<<14)+(b>>>17^b>>>19^b>>>10^b<<15^b<<13)+_+v|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0xbef9a3f7|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;w=R=(e>>>7^e>>>18^e>>>3^e<<25^e<<14)+(A>>>17^A>>>19^A>>>10^A<<15^A<<13)+w+y|0;R=R+I+(x>>>6^x>>>11^x>>>25^x<<26^x<<21^x<<7)+(N^x&(C^N))+0xc67178f2|0;I=N;N=C;C=x;x=T+R|0;T=S;S=D;D=O;O=R+(D&S^T&(D^S))+(D>>>2^D>>>13^D>>>22^D<<30^D<<19^D<<10)|0;r=r+O|0;o=o+D|0;a=a+S|0;i=i+T|0;c=c+x|0;s=s+C|0;u=u+N|0;l=l+I|0}function I(e){e=e|0;N(C[e|0]<<24|C[e|1]<<16|C[e|2]<<8|C[e|3],C[e|4]<<24|C[e|5]<<16|C[e|6]<<8|C[e|7],C[e|8]<<24|C[e|9]<<16|C[e|10]<<8|C[e|11],C[e|12]<<24|C[e|13]<<16|C[e|14]<<8|C[e|15],C[e|16]<<24|C[e|17]<<16|C[e|18]<<8|C[e|19],C[e|20]<<24|C[e|21]<<16|C[e|22]<<8|C[e|23],C[e|24]<<24|C[e|25]<<16|C[e|26]<<8|C[e|27],C[e|28]<<24|C[e|29]<<16|C[e|30]<<8|C[e|31],C[e|32]<<24|C[e|33]<<16|C[e|34]<<8|C[e|35],C[e|36]<<24|C[e|37]<<16|C[e|38]<<8|C[e|39],C[e|40]<<24|C[e|41]<<16|C[e|42]<<8|C[e|43],C[e|44]<<24|C[e|45]<<16|C[e|46]<<8|C[e|47],C[e|48]<<24|C[e|49]<<16|C[e|50]<<8|C[e|51],C[e|52]<<24|C[e|53]<<16|C[e|54]<<8|C[e|55],C[e|56]<<24|C[e|57]<<16|C[e|58]<<8|C[e|59],C[e|60]<<24|C[e|61]<<16|C[e|62]<<8|C[e|63])}function R(e){e=e|0;C[e|0]=r>>>24;C[e|1]=r>>>16&255;C[e|2]=r>>>8&255;C[e|3]=r&255;C[e|4]=o>>>24;C[e|5]=o>>>16&255;C[e|6]=o>>>8&255;C[e|7]=o&255;C[e|8]=a>>>24;C[e|9]=a>>>16&255;C[e|10]=a>>>8&255;C[e|11]=a&255;C[e|12]=i>>>24;C[e|13]=i>>>16&255;C[e|14]=i>>>8&255;C[e|15]=i&255;C[e|16]=c>>>24;C[e|17]=c>>>16&255;C[e|18]=c>>>8&255;C[e|19]=c&255;C[e|20]=s>>>24;C[e|21]=s>>>16&255;C[e|22]=s>>>8&255;C[e|23]=s&255;C[e|24]=u>>>24;C[e|25]=u>>>16&255;C[e|26]=u>>>8&255;C[e|27]=u&255;C[e|28]=l>>>24;C[e|29]=l>>>16&255;C[e|30]=l>>>8&255;C[e|31]=l&255}function P(){r=0x6a09e667;o=0xbb67ae85;a=0x3c6ef372;i=0xa54ff53a;c=0x510e527f;s=0x9b05688c;u=0x1f83d9ab;l=0x5be0cd19;f=d=0}function k(e,n,t,h,p,v,y,m,g,E){e=e|0;n=n|0;t=t|0;h=h|0;p=p|0;v=v|0;y=y|0;m=m|0;g=g|0;E=E|0;r=e;o=n;a=t;i=h;c=p;s=v;u=y;l=m;f=g;d=E}function M(e,n){e=e|0;n=n|0;var t=0;if(e&63)return-1;while((n|0)>=64){I(e);e=e+64|0;n=n-64|0;t=t+64|0}f=f+t|0;if(f>>>0<t>>>0)d=d+1|0;return t|0}function F(e,n,t){e=e|0;n=n|0;t=t|0;var r=0,o=0;if(e&63)return-1;if(~t)if(t&31)return-1;if((n|0)>=64){r=M(e,n)|0;if((r|0)==-1)return-1;e=e+r|0;n=n-r|0}r=r+n|0;f=f+n|0;if(f>>>0<n>>>0)d=d+1|0;C[e|n]=0x80;if((n|0)>=56){for(o=n+1|0;(o|0)<64;o=o+1|0)C[e|o]=0x00;I(e);n=0;C[e|0]=0}for(o=n+1|0;(o|0)<59;o=o+1|0)C[e|o]=0;C[e|56]=d>>>21&255;C[e|57]=d>>>13&255;C[e|58]=d>>>5&255;C[e|59]=d<<3&255|f>>>29;C[e|60]=f>>>21&255;C[e|61]=f>>>13&255;C[e|62]=f>>>5&255;C[e|63]=f<<3&255;I(e);if(~t)R(t);return r|0}function L(){r=h;o=p;a=v;i=y;c=m;s=g;u=E;l=b;f=64;d=0}function K(){r=A;o=_;a=w;i=O;c=D;s=S;u=T;l=x;f=64;d=0}function H(e,n,t,C,I,R,k,M,F,L,K,H,j,U,B,V){e=e|0;n=n|0;t=t|0;C=C|0;I=I|0;R=R|0;k=k|0;M=M|0;F=F|0;L=L|0;K=K|0;H=H|0;j=j|0;U=U|0;B=B|0;V=V|0;P();N(e^0x5c5c5c5c,n^0x5c5c5c5c,t^0x5c5c5c5c,C^0x5c5c5c5c,I^0x5c5c5c5c,R^0x5c5c5c5c,k^0x5c5c5c5c,M^0x5c5c5c5c,F^0x5c5c5c5c,L^0x5c5c5c5c,K^0x5c5c5c5c,H^0x5c5c5c5c,j^0x5c5c5c5c,U^0x5c5c5c5c,B^0x5c5c5c5c,V^0x5c5c5c5c);A=r;_=o;w=a;O=i;D=c;S=s;T=u;x=l;P();N(e^0x36363636,n^0x36363636,t^0x36363636,C^0x36363636,I^0x36363636,R^0x36363636,k^0x36363636,M^0x36363636,F^0x36363636,L^0x36363636,K^0x36363636,H^0x36363636,j^0x36363636,U^0x36363636,B^0x36363636,V^0x36363636);h=r;p=o;v=a;y=i;m=c;g=s;E=u;b=l;f=64;d=0}function j(e,n,t){e=e|0;n=n|0;t=t|0;var f=0,d=0,h=0,p=0,v=0,y=0,m=0,g=0,E=0;if(e&63)return-1;if(~t)if(t&31)return-1;E=F(e,n,-1)|0;f=r,d=o,h=a,p=i,v=c,y=s,m=u,g=l;K();N(f,d,h,p,v,y,m,g,0x80000000,0,0,0,0,0,0,768);if(~t)R(t);return E|0}function U(e,n,t,f,d){e=e|0;n=n|0;t=t|0;f=f|0;d=d|0;var h=0,p=0,v=0,y=0,m=0,g=0,E=0,b=0,A=0,_=0,w=0,O=0,D=0,S=0,T=0,x=0;if(e&63)return-1;if(~d)if(d&31)return-1;C[e+n|0]=t>>>24;C[e+n+1|0]=t>>>16&255;C[e+n+2|0]=t>>>8&255;C[e+n+3|0]=t&255;j(e,n+4|0,-1)|0;h=A=r,p=_=o,v=w=a,y=O=i,m=D=c,g=S=s,E=T=u,b=x=l;f=f-1|0;while((f|0)>0){L();N(A,_,w,O,D,S,T,x,0x80000000,0,0,0,0,0,0,768);A=r,_=o,w=a,O=i,D=c,S=s,T=u,x=l;K();N(A,_,w,O,D,S,T,x,0x80000000,0,0,0,0,0,0,768);A=r,_=o,w=a,O=i,D=c,S=s,T=u,x=l;h=h^r;p=p^o;v=v^a;y=y^i;m=m^c;g=g^s;E=E^u;b=b^l;f=f-1|0}r=h;o=p;a=v;i=y;c=m;s=g;u=E;l=b;if(~d)R(d);return 0}return{reset:P,init:k,process:M,finish:F,hmac_reset:L,hmac_init:H,hmac_finish:j,pbkdf2_generate_block:U}}},"transform/TextTransformer.js":function(e,n,t){var r=t("../Operation"),o=t("../Common"),a=function(e,n){o.PARANOIA&&(r.check(e),r.check(n));var t=function(e,n){if(e.offset>n.offset){if(e.offset>n.offset+n.toRemove)return r.create(e.offset-n.toRemove+n.toInsert.length,e.toRemove,e.toInsert);var t=e.toRemove-(n.offset+n.toRemove-e.offset);return t<0&&(t=0),0===t&&0===e.toInsert.length?null:r.create(n.offset+n.toInsert.length,t,e.toInsert)}if(e.offset+e.toRemove<n.offset)return e;var o=n.offset-e.offset;return 0===o&&0===e.toInsert.length?null:r.create(e.offset,o,e.toInsert)}(e,n);return o.PARANOIA&&t&&r.check(t),t};e.exports=function(e,n,t){var i,c=t;for(i=n.length-1;i>=0;i--)c=r.apply(n[i],c);var s=[];for(i=e.length-1;i>=0;i--){for(var u=e[i],l=n.length-1;l>=0;l--){try{u=a(u,n[l])}catch(e){return console.error("The pluggable transform function threw an error, failing operational transformation"),console.error(e.stack),[]}if(!u)break}u&&(o.PARANOIA&&r.check(u,c.length),s.unshift(u))}return s}},"transform/NaiveJSONTransformer.js":function(e,n,t){var r=t("./TextTransformer"),o=t("../Operation"),a=t("../Common");e.exports=function(e,n,t){var i,c,s,u=a.global.REALTIME_DEBUG=a.global.REALTIME_DEBUG||{};try{i=r(e,n,t),c=o.applyMulti(n,t),s=o.applyMulti(i,c);try{return JSON.parse(s),i}catch(r){console.error(r),u.ot_parseError={type:"resultParseError",resultOps:i,toTransform:e,transformBy:n,text1:t,text2:c,text3:s,error:r},console.log("Debugging info available at `window.REALTIME_DEBUG.ot_parseError`")}}catch(r){console.error(r),u.ot_applyError={type:"resultParseError",resultOps:i,toTransform:e,transformBy:n,text1:t,text2:c,text3:s,error:r},console.log("Debugging info available at `window.REALTIME_DEBUG.ot_applyError`")}return[]}},"transform/SmartJSONTransformer.js":function(e,n,t){var r,o,a,i=t("json.sortify"),c=t("../Diff"),s=t("../Operation"),u=t("./TextTransformer"),l=function(e){return null===e?"null":(n=e,"[object Array]"===Object.prototype.toString.call(n)?"array":typeof e);var n},f=function(e,n){for(var t=n.length,r=0;r<t;r++){if(void 0===e[n[r]])return;e=e[n[r]]}return e},d=function(e,n){var t=l(e);if(t!==l(n))return!1;if("object"===t){var r=Object.keys(e),o=Object.keys(n);return r.length===o.length&&!r.some((function(t){return!d(e[t],n[t])}))&&!o.some((function(n){return!(n in e)}))}return"array"===t?e.length===n.length&&!e.some((function(e,t){return!d(e,n[t])})):e===n},h=function(e,n,t,r,o){if("replace"===e)return{type:"replace",path:n,value:t,prev:r};if("splice"===e){if("number"!=typeof r)throw new Error;if("number"!=typeof o)throw new Error;return{type:"splice",path:n,value:t,offset:r,removals:o}}if("remove"!==e)throw new Error("expected a removal");return{type:"remove",path:n,value:t}},p=function(e,n,t,r){e.push(h("replace",n,t,r))},v=function(e,n,t,r,o){e.push(h("splice",n,t,r,o))},y=function(e,n){return!e.some((function(e,t){return e!==n[t]}))},m=(o={},a=1,(r=["replace","remove","splice"]).forEach((function(e){return o[e]={},r.forEach((function(n){o[e][n]=a++}))})),o),g=function(e,n,t){if("array"!==l(e)||"array"!==l(n))throw new Error("[resolve] expected two arrays");return n=n.filter((function(n){return!e.some((function(e){if("remove"===e.type&&y(e.path,n.path)&&n.path.length-e.path.length>1)return!0}))&&("splice"!==n.type||!e.some((function(e){if("splice"===e.type&&y(e.path,n.path)&&e.path.length-n.path.length<0){if(!e.removals)return;for(var t=e.offset,r=e.offset+e.removals;t<r;t++)if(t===n.path[e.path.length])return!0}})))&&(!e.some((function(e){return"remove"===n.type&&d(e.path,n.path)}))||void 0)})).filter((function(n){return!e.some((function(e){if("replace"===n.type&&"replace"===e.type&&d(e.path,n.path))return"string"!=typeof e.value||"string"!=typeof n.value||!t||e.prev!==n.prev||e.value===n.value||t(e,n,m.replace.replace)}))})).map((function(n){return e.forEach((function(e){if("splice"===e.type){if(d(e.path,n.path)){if("splice"===n.type){if(n.offset>e.offset+n.removals)return void(n.offset+=e.value.length-e.removals);if(n.offset<e.offset)return void(n.removals=Math.max(e.offset-n.offset,0));n.removals=Math.max(n.removals-(n.offset+e.removals-n.offset),0),n.offset+=e.value.length-e.removals}return}if(y(e.path,n.path)){var t=e.path.length;"number"==typeof n.path[t]&&e.offset<=n.path[t]&&(n.path[t]+=e.value.length-e.removals)}}})),n})),n},E=function(e,n,t,r){var o=Object.keys(e),a=Object.keys(n);a.forEach((function(a){var i=l(n[a]),c=e[a],s=t.concat(a);if(-1!==o.indexOf(a)){var u=l(c);if(u===i)"object"===u?E(e[a],n[a],s,r):"array"===u?b(e[a],n[a],s,r):e[a]!==n[a]&&p(r,s,n[a],c);else{if(console.log("type changed from [%s] to [%s]",u,i),"undefined"===i)throw new Error("first pass should never reveal undefined keys");p(r,s,n[a],c)}}else{if("undefined"===i)throw new Error("undefined type has key. this shouldn't happen?");if(c)throw new Error("no such key existed in b, so 'old' should be falsey");p(r,s,n[a],c)}})),o.forEach((function(o){-1!==a.indexOf(o)&&"undefined"!==l(n[o])||function(e,n,t){e.push(h("remove",n,t))}(r,t.concat(o),e[o])}))},b=function(e,n,t,r){var o=e.slice(0);if(0===o.length)v(r,t,n,0,0);else if(function(e,n){if(e.length!==n.length)return!1;for(var t=0;t<e.length;t++)if(l(e[t])!==l(n[t]))return!1;return!0}(o,n))o.forEach((function(e,o){var a=n[o];if(a!==e){var i=e,c=t.concat(o);switch(l(e)){case"undefined":throw new Error("existing key had type `undefined`. this should never happen");case"object":E(e,a,c,r);break;case"array":b(e,a,c,r);break;default:p(r,c,a,i)}}}));else{for(var a=0,i=0;a<o.length&&d(o[a],n[a]);)a++;for(;d(o[o.length-1-i],n[n.length-1-i])&&i+a<o.length&&i+a<n.length;)i++;var c=o.length-a-i,s=[];n.length!==a+i&&(s=n.slice(a,n.length-i)),v(r,t,s,a,c)}},A=function(e,n){var t=[],r=l(e),o=l(n);if(r!==o)throw new Error("Can't merge two objects of differing types");if("array"===o)b(e,n,[],t);else{if("object"!==o)throw new Error("unsupported datatype"+o);E(e,n,[],t)}return t},_=function(e,n){return n.forEach((function(n){!function(e,n){var t,r,o;switch(n.type){case"replace":r=n.path[n.path.length-1],t=n.path.slice(0,n.path.length-1);var a=f(e,t);if(!a)throw new Error("cannot apply change to non-existent element");a[r]=n.value;break;case"splice":var i=f(e,n.path);if(!i)throw console.error("[applyOp] expected path [%s] to exist in object",n.path.join(",")),new Error("Path did not exist");if("array"!==l(i))throw new Error("Can't splice non-array");Array.prototype.splice.apply(i,[n.offset,n.removals].concat(n.value));break;case"remove":r=n.path[n.path.length-1],t=n.path.slice(0,n.path.length-1),void 0!==(o=f(e,t))&&delete o[r];break;default:throw new Error("unsupported operation type")}}(e,n)})),e},w=function(e,n,t){if(e.prev!==n.prev)throw new Error("Parent values don't match!");if(t===m.splice.splice)return console.log(e),console.log(n),console.log("\n\n\n\n\n\n\n\n\n"),!0;var r=e.prev,o=c.diff(r,e.value),a=c.diff(r,n.value),i=u(a,o,r),l=s.applyMulti(o,r),f=s.applyMulti(i,l);n.value=f};e.exports=function(e,n,t){var r=JSON.parse(t),o=s.applyMulti(n,t),a=JSON.parse(o),u=s.applyMulti(e,t),l=JSON.parse(u);try{var f=A(r,l),d=A(r,a),h=g(d,f,w);_(r,d),_(r,h);var p=i(r);return c.diff(o,p)}catch(e){console.error(e)}return[]},e.exports._={clone:function(e){return JSON.parse(JSON.stringify(e))},pathOverlaps:y,deepEqual:d,diff:A,resolve:g,patch:_,arbiter:w}}},a.m[1]={"dist/JSON.sortify.js":function(e,n,t){var r;r=function(){var e=function e(n){if(Array.isArray(n))return n.map(e);if(n instanceof Object){var t=(r=[],o=[],Object.keys(n).forEach((function(e){/^(0|[1-9][0-9]*)$/.test(e)?r.push(+e):o.push(e)})),{v:r.sort((function(e,n){return e-n})).concat(o.sort()).reduce((function(t,r){return t[r]=e(n[r]),t}),{})});if("object"==typeof t)return t.v}var r,o;return n},n=JSON.stringify.bind(JSON);return function(t,r,o){var a=n(t,r,0);if(!a||"{"!==a[0]&&"["!==a[0])return a;var i=JSON.parse(a);return n(e(i),null,o)}},void 0!==e&&e.exports?e.exports=r():JSON.sortify=r()}},a.m[2]={"diff.js":function(e,n,t){var r=-1;function o(e,n,t,u){if(e===n)return e?[[0,e]]:[];if(null!=t){var l=function(e,n,t){var r="number"==typeof t?{index:t,length:0}:t.oldRange,o="number"==typeof t?null:t.newRange,a=e.length,i=n.length;if(0===r.length&&(null===o||0===o.length)){var c=r.index,s=e.slice(0,c),u=e.slice(c),l=o?o.index:null,f=c+i-a;if((null===l||l===f)&&!(f<0||f>i)){var d=n.slice(0,f);if((y=n.slice(f))===u){var p=Math.min(c,f);if((g=s.slice(0,p))===(b=d.slice(0,p)))return h(g,s.slice(p),d.slice(p),u)}}if(null===l||l===c){var v=c,y=(d=n.slice(0,v),n.slice(v));if(d===s){var m=Math.min(a-v,i-v);if((E=u.slice(u.length-m))===(A=y.slice(y.length-m)))return h(s,u.slice(0,u.length-m),y.slice(0,y.length-m),E)}}}if(r.length>0&&o&&0===o.length){var g=e.slice(0,r.index),E=e.slice(r.index+r.length);if(!(i<(p=g.length)+(m=E.length))){var b=n.slice(0,p),A=n.slice(i-m);if(g===b&&E===A)return h(g,e.slice(p,a-m),n.slice(p,i-m),E)}}return null}(e,n,t);if(l)return l}var f=i(e,n),d=e.substring(0,f);f=c(e=e.substring(f),n=n.substring(f));var p=e.substring(e.length-f),v=function(e,n){var t;if(!e)return[[1,n]];if(!n)return[[r,e]];var s=e.length>n.length?e:n,u=e.length>n.length?n:e,l=s.indexOf(u);if(-1!==l)return t=[[1,s.substring(0,l)],[0,u],[1,s.substring(l+u.length)]],e.length>n.length&&(t[0][0]=t[2][0]=r),t;if(1===u.length)return[[r,e],[1,n]];var f=function(e,n){var t=e.length>n.length?e:n,r=e.length>n.length?n:e;if(t.length<4||2*r.length<t.length)return null;function o(e,n,t){for(var r,o,a,s,u=e.substring(t,t+Math.floor(e.length/4)),l=-1,f="";-1!==(l=n.indexOf(u,l+1));){var d=i(e.substring(t),n.substring(l)),h=c(e.substring(0,t),n.substring(0,l));f.length<h+d&&(f=n.substring(l-h,l)+n.substring(l,l+d),r=e.substring(0,t-h),o=e.substring(t+d),a=n.substring(0,l-h),s=n.substring(l+d))}return 2*f.length>=e.length?[r,o,a,s,f]:null}var a,s,u,l,f,d=o(t,r,Math.ceil(t.length/4)),h=o(t,r,Math.ceil(t.length/2));if(!d&&!h)return null;a=h?d&&d[4].length>h[4].length?d:h:d,e.length>n.length?(s=a[0],u=a[1],l=a[2],f=a[3]):(l=a[0],f=a[1],s=a[2],u=a[3]);var p=a[4];return[s,u,l,f,p]}(e,n);if(f){var d=f[0],h=f[1],p=f[2],v=f[3],y=f[4],m=o(d,p),g=o(h,v);return m.concat([[0,y]],g)}return function(e,n){for(var t=e.length,o=n.length,i=Math.ceil((t+o)/2),c=i,s=2*i,u=new Array(s),l=new Array(s),f=0;f<s;f++)u[f]=-1,l[f]=-1;u[c+1]=0,l[c+1]=0;for(var d=t-o,h=d%2!=0,p=0,v=0,y=0,m=0,g=0;g<i;g++){for(var E=-g+p;E<=g-v;E+=2){for(var b=c+E,A=(S=E===-g||E!==g&&u[b-1]<u[b+1]?u[b+1]:u[b-1]+1)-E;S<t&&A<o&&e.charAt(S)===n.charAt(A);)S++,A++;if(u[b]=S,S>t)v+=2;else if(A>o)p+=2;else if(h&&(O=c+d-E)>=0&&O<s&&-1!==l[O]&&S>=(w=t-l[O]))return a(e,n,S,A)}for(var _=-g+y;_<=g-m;_+=2){for(var w,O=c+_,D=(w=_===-g||_!==g&&l[O-1]<l[O+1]?l[O+1]:l[O-1]+1)-_;w<t&&D<o&&e.charAt(t-w-1)===n.charAt(o-D-1);)w++,D++;if(l[O]=w,w>t)m+=2;else if(D>o)y+=2;else if(!h){var S;if((b=c+d-_)>=0&&b<s&&-1!==u[b])if(A=c+(S=u[b])-b,S>=(w=t-w))return a(e,n,S,A)}}}return[[r,e],[1,n]]}(e,n)}(e=e.substring(0,e.length-f),n=n.substring(0,n.length-f));return d&&v.unshift([0,d]),p&&v.push([0,p]),s(v,u),v}function a(e,n,t,r){var a=e.substring(0,t),i=n.substring(0,r),c=e.substring(t),s=n.substring(r),u=o(a,i),l=o(c,s);return u.concat(l)}function i(e,n){if(!e||!n||e.charAt(0)!==n.charAt(0))return 0;for(var t=0,r=Math.min(e.length,n.length),o=r,a=0;t<o;)e.substring(a,o)==n.substring(a,o)?a=t=o:r=o,o=Math.floor((r-t)/2+t);return u(e.charCodeAt(o-1))&&o--,o}function c(e,n){if(!e||!n||e.slice(-1)!==n.slice(-1))return 0;for(var t=0,r=Math.min(e.length,n.length),o=r,a=0;t<o;)e.substring(e.length-o,e.length-a)==n.substring(n.length-o,n.length-a)?a=t=o:r=o,o=Math.floor((r-t)/2+t);return l(e.charCodeAt(e.length-o))&&o--,o}function s(e,n){e.push([0,""]);for(var t,o=0,a=0,u=0,l="",h="";o<e.length;)if(o<e.length-1&&!e[o][1])e.splice(o,1);else switch(e[o][0]){case 1:u++,h+=e[o][1],o++;break;case r:a++,l+=e[o][1],o++;break;case 0:var p=o-u-a-1;if(n){if(p>=0&&d(e[p][1])){var v=e[p][1].slice(-1);if(e[p][1]=e[p][1].slice(0,-1),l=v+l,h=v+h,!e[p][1]){e.splice(p,1),o--;var y=p-1;e[y]&&1===e[y][0]&&(u++,h=e[y][1]+h,y--),e[y]&&e[y][0]===r&&(a++,l=e[y][1]+l,y--),p=y}}f(e[o][1])&&(v=e[o][1].charAt(0),e[o][1]=e[o][1].slice(1),l+=v,h+=v)}if(o<e.length-1&&!e[o][1]){e.splice(o,1);break}if(l.length>0||h.length>0){l.length>0&&h.length>0&&(0!==(t=i(h,l))&&(p>=0?e[p][1]+=h.substring(0,t):(e.splice(0,0,[0,h.substring(0,t)]),o++),h=h.substring(t),l=l.substring(t)),0!==(t=c(h,l))&&(e[o][1]=h.substring(h.length-t)+e[o][1],h=h.substring(0,h.length-t),l=l.substring(0,l.length-t)));var m=u+a;0===l.length&&0===h.length?(e.splice(o-m,m),o-=m):0===l.length?(e.splice(o-m,m,[1,h]),o=o-m+1):0===h.length?(e.splice(o-m,m,[r,l]),o=o-m+1):(e.splice(o-m,m,[r,l],[1,h]),o=o-m+2)}0!==o&&0===e[o-1][0]?(e[o-1][1]+=e[o][1],e.splice(o,1)):o++,u=0,a=0,l="",h=""}""===e[e.length-1][1]&&e.pop();var g=!1;for(o=1;o<e.length-1;)0===e[o-1][0]&&0===e[o+1][0]&&(e[o][1].substring(e[o][1].length-e[o-1][1].length)===e[o-1][1]?(e[o][1]=e[o-1][1]+e[o][1].substring(0,e[o][1].length-e[o-1][1].length),e[o+1][1]=e[o-1][1]+e[o+1][1],e.splice(o-1,1),g=!0):e[o][1].substring(0,e[o+1][1].length)==e[o+1][1]&&(e[o-1][1]+=e[o+1][1],e[o][1]=e[o][1].substring(e[o+1][1].length)+e[o+1][1],e.splice(o+1,1),g=!0)),o++;g&&s(e,n)}function u(e){return e>=55296&&e<=56319}function l(e){return e>=56320&&e<=57343}function f(e){return l(e.charCodeAt(0))}function d(e){return u(e.charCodeAt(e.length-1))}function h(e,n,t,o){return d(e)||f(o)?null:function(e){for(var n=[],t=0;t<e.length;t++)e[t][1].length>0&&n.push(e[t]);return n}([[0,e],[r,n],[1,t],[0,o]])}function p(e,n,t){return o(e,n,t,!0)}p.INSERT=1,p.DELETE=r,p.EQUAL=0,e.exports=p}},n=a("ChainPad.js"),r="ChainPad",e.exports=n,"undefined"!=typeof window?o=window:void 0!==t?o=t:"undefined"!=typeof self&&(o=self),o[r]=n}(C)),C.exports}var I,R,P=N(),k=n({__proto__:null,default:r(P)},[P]),M={exports:{}},F={exports:{}};function L(){return I||(I=1,function(e){e.exports=function(e,n,t,r,o,a,i,c){function s(e){var n=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],t=1779033703,r=3144134277,o=1013904242,a=2773480762,i=1359893119,c=2600822924,s=528734635,u=1541459225,l=new Array(64);function f(e){for(var f=0,d=e.length;d>=64;){var h,p,v,y,m,g=t,E=r,b=o,A=a,_=i,w=c,O=s,D=u;for(p=0;p<16;p++)v=f+4*p,l[p]=(255&e[v])<<24|(255&e[v+1])<<16|(255&e[v+2])<<8|255&e[v+3];for(p=16;p<64;p++)y=((h=l[p-2])>>>17|h<<15)^(h>>>19|h<<13)^h>>>10,m=((h=l[p-15])>>>7|h<<25)^(h>>>18|h<<14)^h>>>3,l[p]=(y+l[p-7]|0)+(m+l[p-16]|0)|0;for(p=0;p<64;p++)y=(((_>>>6|_<<26)^(_>>>11|_<<21)^(_>>>25|_<<7))+(_&w^~_&O)|0)+(D+(n[p]+l[p]|0)|0)|0,m=((g>>>2|g<<30)^(g>>>13|g<<19)^(g>>>22|g<<10))+(g&E^g&b^E&b)|0,D=O,O=w,w=_,_=A+y|0,A=b,b=E,E=g,g=y+m|0;t=t+g|0,r=r+E|0,o=o+b|0,a=a+A|0,i=i+_|0,c=c+w|0,s=s+O|0,u=u+D|0,f+=64,d-=64}}f(e);var d,h=e.length%64,p=e.length/536870912|0,v=e.length<<3,y=h<56?56:120,m=e.slice(e.length-h,e.length);for(m.push(128),d=h+1;d<y;d++)m.push(0);return m.push(p>>>24&255),m.push(p>>>16&255),m.push(p>>>8&255),m.push(p>>>0&255),m.push(v>>>24&255),m.push(v>>>16&255),m.push(v>>>8&255),m.push(v>>>0&255),f(m),[t>>>24&255,t>>>16&255,t>>>8&255,t>>>0&255,r>>>24&255,r>>>16&255,r>>>8&255,r>>>0&255,o>>>24&255,o>>>16&255,o>>>8&255,o>>>0&255,a>>>24&255,a>>>16&255,a>>>8&255,a>>>0&255,i>>>24&255,i>>>16&255,i>>>8&255,i>>>0&255,c>>>24&255,c>>>16&255,c>>>8&255,c>>>0&255,s>>>24&255,s>>>16&255,s>>>8&255,s>>>0&255,u>>>24&255,u>>>16&255,u>>>8&255,u>>>0&255]}function u(e,n,t){e=e.length<=64?e:s(e);var r,o=64+n.length+4,a=new Array(o),i=new Array(64),c=[];for(r=0;r<64;r++)a[r]=54;for(r=0;r<e.length;r++)a[r]^=e[r];for(r=0;r<n.length;r++)a[64+r]=n[r];for(r=o-4;r<o;r++)a[r]=0;for(r=0;r<64;r++)i[r]=92;for(r=0;r<e.length;r++)i[r]^=e[r];function u(){for(var e=o-1;e>=o-4;e--){if(a[e]++,a[e]<=255)return;a[e]=0}}for(;t>=32;)u(),c=c.concat(s(i.concat(s(a)))),t-=32;return t>0&&(u(),c=c.concat(s(i.concat(s(a))).slice(0,t))),c}function l(e,n,t,r){var o,a,i=e[0]^n[t++],c=e[1]^n[t++],s=e[2]^n[t++],u=e[3]^n[t++],l=e[4]^n[t++],f=e[5]^n[t++],d=e[6]^n[t++],h=e[7]^n[t++],p=e[8]^n[t++],v=e[9]^n[t++],y=e[10]^n[t++],m=e[11]^n[t++],g=e[12]^n[t++],E=e[13]^n[t++],b=e[14]^n[t++],A=e[15]^n[t++],_=i,w=c,O=s,D=u,S=l,T=f,x=d,C=h,N=p,I=v,R=y,P=m,k=g,M=E,F=b,L=A;for(a=0;a<8;a+=2)_^=(o=(k^=(o=(N^=(o=(S^=(o=_+k)<<7|o>>>25)+_)<<9|o>>>23)+S)<<13|o>>>19)+N)<<18|o>>>14,T^=(o=(w^=(o=(M^=(o=(I^=(o=T+w)<<7|o>>>25)+T)<<9|o>>>23)+I)<<13|o>>>19)+M)<<18|o>>>14,R^=(o=(x^=(o=(O^=(o=(F^=(o=R+x)<<7|o>>>25)+R)<<9|o>>>23)+F)<<13|o>>>19)+O)<<18|o>>>14,L^=(o=(P^=(o=(C^=(o=(D^=(o=L+P)<<7|o>>>25)+L)<<9|o>>>23)+D)<<13|o>>>19)+C)<<18|o>>>14,_^=(o=(D^=(o=(O^=(o=(w^=(o=_+D)<<7|o>>>25)+_)<<9|o>>>23)+w)<<13|o>>>19)+O)<<18|o>>>14,T^=(o=(S^=(o=(C^=(o=(x^=(o=T+S)<<7|o>>>25)+T)<<9|o>>>23)+x)<<13|o>>>19)+C)<<18|o>>>14,R^=(o=(I^=(o=(N^=(o=(P^=(o=R+I)<<7|o>>>25)+R)<<9|o>>>23)+P)<<13|o>>>19)+N)<<18|o>>>14,L^=(o=(F^=(o=(M^=(o=(k^=(o=L+F)<<7|o>>>25)+L)<<9|o>>>23)+k)<<13|o>>>19)+M)<<18|o>>>14;n[r++]=e[0]=_+i|0,n[r++]=e[1]=w+c|0,n[r++]=e[2]=O+s|0,n[r++]=e[3]=D+u|0,n[r++]=e[4]=S+l|0,n[r++]=e[5]=T+f|0,n[r++]=e[6]=x+d|0,n[r++]=e[7]=C+h|0,n[r++]=e[8]=N+p|0,n[r++]=e[9]=I+v|0,n[r++]=e[10]=R+y|0,n[r++]=e[11]=P+m|0,n[r++]=e[12]=k+g|0,n[r++]=e[13]=M+E|0,n[r++]=e[14]=F+b|0,n[r++]=e[15]=L+A|0}function f(e,n,t,r,o){for(;o--;)e[n++]=t[r++]}function d(e,n,t,r,o){for(;o--;)e[n++]^=t[r++]}function h(e,n,t,r,o){f(e,0,n,t+16*(2*o-1),16);for(var a=0;a<2*o;a+=2)l(e,n,t+16*a,r+8*a),l(e,n,t+16*a+16,r+8*a+16*o)}function p(e,n,t){return e[n+16*(2*t-1)]}function v(e){for(var n=[],t=0;t<e.length;t++){var r=e.charCodeAt(t);r<128?n.push(r):r>127&&r<2048?(n.push(r>>6|192),n.push(63&r|128)):(n.push(r>>12|224),n.push(r>>6&63|128),n.push(63&r|128))}return n}if(t<1||t>31)throw new Error("scrypt: logN not be between 1 and 31");var y,m,g,E,b=1<<t>>>0;if(1*r>=1<<30||r>16777216||r>8388608||b>16777216/r)throw new Error("scrypt: parameters are too large");"string"==typeof e&&(e=v(e)),"string"==typeof n&&(n=v(n)),"undefined"!=typeof Int32Array?(y=new Int32Array(64*r),m=new Int32Array(32*b*r),E=new Int32Array(16)):(y=[],m=[],E=new Array(16)),g=u(e,n,128*r);var A=32*r;function _(){for(var e=0;e<32*r;e++){var n=4*e;y[0+e]=(255&g[n+3])<<24|(255&g[n+2])<<16|(255&g[n+1])<<8|255&g[n+0]}}function w(e,n){for(var t=e;t<n;t+=2)f(m,t*(32*r),y,0,32*r),h(E,y,0,A,r),f(m,(t+1)*(32*r),y,A,32*r),h(E,y,A,0,r)}function O(e,n){for(var t=e;t<n;t+=2){var o=p(y,0,r)&b-1;d(y,0,m,o*(32*r),32*r),h(E,y,0,A,r),o=p(y,A,r)&b-1,d(y,A,m,o*(32*r),32*r),h(E,y,A,0,r)}}function D(){for(var e=0;e<32*r;e++){var n=y[0+e];g[4*e+0]=n>>>0&255,g[4*e+1]=n>>>8&255,g[4*e+2]=n>>>16&255,g[4*e+3]=n>>>24&255}}var S="undefined"!=typeof setImmediate?setImmediate:setTimeout;function T(e,n,t,r,o){!function a(){S((function(){r(e,e+t<n?e+t:n),(e+=t)<n?a():o()}))}()}function x(n){var t=u(e,g,o);return"base64"===n?function(e){for(var n,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),r=e.length,o=[],a=0;a<r;)n=((a<r?e[a++]:0)<<16)+((a<r?e[a++]:0)<<8)+(a<r?e[a++]:0),o.push(t[n>>>18&63]),o.push(t[n>>>12&63]),o.push(t[n>>>6&63]),o.push(t[n>>>0&63]);return r%3>0&&(o[o.length-1]="=",r%3==1&&(o[o.length-2]="=")),o.join("")}(t):"hex"===n?function(e){for(var n="0123456789abcdef".split(""),t=e.length,r=[],o=0;o<t;o++)r.push(n[e[o]>>>4&15]),r.push(n[e[o]>>>0&15]);return r.join("")}(t):t}"function"==typeof a&&(c=i,i=a,a=1e3),a<=0?(_(),w(0,b),O(0,b),D(),i(x(c))):(_(),T(0,b,2*a,w,(function(){T(0,b,2*a,O,(function(){D(),i(x(c))}))})))}}(F)),F.exports}function K(){return R||(R=1,function(e){var n;n=function(e,n,t,r){var o={Nacl:e,PQC:t},a=n.encodeBase64,i=e=>{let t;return(t=e.length%4)&&(e+="=".repeat(4-t)),n.decodeBase64(e)},c=n.decodeUTF8,s=n.encodeUTF8,u=function(e){for(var n="",t=0;t<e.length;t++)e[t]<16&&(n+="0"),n+=e[t].toString(16);return n},l=function(e,n){if(!e||!n)throw new Error("Both NaCl and KEM keys required for key derivation");var t=new Uint8Array(32);return r(Array.from(w([e,n])),Array.from(c("CryptPad.mailbox.pqc.salt")),8,1024,128,200,(function(e){for(var n=0;n<e.length;n++)t[n]=e[n]}),"binary"),t},f=o.CryptoAgility={};f.decodeBase64=i,f.encodeBase64=a,f.decodeUTF8=c,f.encodeUTF8=s,f.signKeyPairFromSeed=function(n){return e.sign.keyPair.fromSeed(n)},f.signKeyPairFromSecretKey=function(n){return e.sign.keyPair.fromSecretKey(n)},f.signKeyPair=function(){return e.sign.keyPair()},f.sign=function(n,t){return e.sign(n,t)},f.signOpen=function(n,t){return e.sign.open(n,t)},f.signDetached=function(n,t){return e.sign.detached(n,t)},f.verifyDetached=function(n,t,r){return e.sign.detached.verify(t,n,r)},f.curveKeyPair=function(){return e.box.keyPair()},f.box=function(n,t,r,o){return e.box(n,t,r,o)},f.boxOpen=function(n,t,r,o){return e.box.open(n,t,r,o)},f.boxKeyPairFromSecretKey=function(n){return e.box.keyPair.fromSecretKey(n)},f.secretbox=function(n,t,r){return e.secretbox(n,t,r)},f.secretboxOpen=function(n,t,r){return e.secretbox.open(n,t,r)},f.createHash=function(n){return e.hash(n)},f.bytes=function(n){return e.randomBytes(n)},f.boxNonceLength=function(){return e.box.nonceLength},f.signSeedLength=function(){return e.sign.seedLength},f.boxKeyLength=function(){return e.box.publicKeyLength},f.secretboxKeyLength=function(){return e.secretbox.keyLength},f.secretboxNonceLength=function(){return e.secretbox.nonceLength},f.signKeyLength=function(){return e.sign.publicKeyLength};var d=o.Box={};d.encrypt=function(n,t,r,o){return e.box(n,t,r,o)},d.decrypt=function(n,t,r,o){return e.box.open(n,t,r,o)},d.encryptAfter=function(n,t,r){return e.box.after(n,t,r)},d.decryptAfter=function(n,t,r){return e.box.open.after(n,t,r)},d.getSharedSecret=function(n,t){return e.box.before(n,t)};var h=o.SecretBox={};h.encrypt=function(n,t,r){return e.secretbox(n,t,r)},h.decrypt=function(n,t,r){return e.secretbox.open(n,t,r)};var p=o.Sign={};p.sign=function(n,t){return e.sign(n,t)},p.verify=function(n,t){return e.sign.open(n,t)},p.detached=function(n,t){return e.sign.detached(n,t)},p.verifyDetached=function(n,t,r){return e.sign.detached.verify(t,n,r)};var v=o.encrypt=function(e,n){return function(e,n){var t=c(e),r=f.bytes(24),o=h.encrypt(t,r,n);if(!o)throw new Error;return a(r)+"|"+a(o)}(e,n)},y=o.decrypt=function(e,n){return function(e,n){var t=e.split("|");if(2!==t.length)throw new Error;var r=i(t[0]),o=i(t[1]),a=h.decrypt(o,r,n);if(!a)throw new Error;return s(a)}(e,n)},m=o.parseKey=function(e){try{var n=i(e),t=f.createHash(n),r=t.subarray(32);return{lookupKey:r,cryptKey:t.subarray(0,32),channel:a(r).substring(0,10)}}catch(e){throw console.error("[chainpad-crypto.parseKey] invalid string supplied"),e}},g=o.rand64=function(e){return a(f.bytes(e))};o.genKey=function(){return g(18)};var E=function(e){return a(e).replace(/\//g,"-").replace(/=+$/g,"")},b=function(e){return i(e.replace(/\-/g,"/"))};o.b64RemoveSlashes=function(e){return e.replace(/\//g,"-")},o.b64AddSlashes=function(e){return e.replace(/\-/g,"/")},o.createEncryptor=function(n){var t;if("object"==typeof n){var r={};if(!(t=n.cryptKey))throw new Error("NO_DECRYPTION_KEY_PROVIDED");if(n.signKey){var o=i(n.signKey);r.encrypt=function(n){return a(e.sign(c(v(n,t)),o))}}return r.decrypt=function(n,r,o){if(!r&&!o)throw new Error("UNSUPPORTED_DECRYPTION_CONFIGURATION");!0!==r||o||console.error("UNEXPECTED_CONFIGURATION");var a=o||"string"!=typeof r?i(n).subarray(64):e.sign.open(i(n),i(r));if(a)return y(s(a),t)},r}return t=m(n).cryptKey,{encrypt:function(e){return v(e,t)},decrypt:function(e){return y(e,t)}}},o.createEditCryptor=function(n,t){try{if(!n){if(t&&18!==t.length)throw new Error("expected supplied seed to have length of 18");t||(t=e.randomBytes(18)),n=a(t)}var r=e.hash(i(n)),o=e.sign.keyPair.fromSeed(r.subarray(0,32)),c=r.subarray(32,64);return{editKeyStr:n,signKey:a(o.secretKey),validateKey:a(o.publicKey),cryptKey:c,viewKeyStr:E(c)}}catch(e){throw console.error("[chainpad-crypto.createEditCryptor] invalid string supplied"),e}},o.createViewCryptor=function(e){try{if(!e)throw new Error("Cannot open a new pad in read-only mode!");return{cryptKey:i(e),viewKeyStr:e}}catch(e){throw console.error("[chainpad-crypto.createViewCryptor] invalid string supplied"),e}};var A=o.createViewCryptor2=function(n,t){try{if(!n)throw new Error("Cannot open a new pad in read-only mode!");var r=b(n),o=r;if(t){var i=c(t);(o=new Uint8Array(r.length+i.length)).set(i),o.set(r,i.length)}var s=e.hash(o),u=s.subarray(0,16),l=s.subarray(16,48),f=e.sign.keyPair.fromSeed(s.subarray(32,64));return{viewKeyStr:n,cryptKey:l,chanId:E(u),secondarySignKey:a(f.secretKey),secondaryValidateKey:a(f.publicKey)}}catch(e){throw console.error("[chainpad-crypto.createViewCryptor2] invalid string supplied"),e}};o.createEditCryptor2=function(n,t,r){try{if(!n){if(t&&18!==t.length)throw new Error("expected supplied seed to have length of 18");t||(t=e.randomBytes(18)),n=E(t)}t||(t=b(n));var o=t;if(r){var i=c(r);(o=new Uint8Array(t.length+i.length)).set(i),o.set(t,i.length)}var s=e.hash(o),u=e.sign.keyPair.fromSeed(s.subarray(0,32)),l=e.hash(u.secretKey).subarray(0,e.secretbox.keyLength),f=s.subarray(32,64),d=E(f),h=A(d,r);return{editKeyStr:n,viewKeyStr:d,signKey:a(u.secretKey),validateKey:a(u.publicKey),cryptKey:h.cryptKey,secondaryKey:a(l),chanId:h.chanId,secondarySignKey:h.secondarySignKey,secondaryValidateKey:h.secondaryValidateKey}}catch(e){throw console.error("[chainpad-crypto.createEditCryptor2] invalid string supplied"),e}},o.createFileCryptor2=function(n,t){try{var r;n||(r=e.randomBytes(18),n=E(r)),r||(r=b(n));var o=r;if(t){var a=c(t);(o=new Uint8Array(r.length+a.length)).set(a),o.set(r,a.length)}var i=e.hash(o),s=i.subarray(0,24);return{fileKeyStr:n,cryptKey:i.subarray(24,56),chanId:E(s)}}catch(e){throw console.error("[chainpad-crypto.createFileCryptor2] invalid string supplied"),e}};var _=o.Curve={},w=function(e){var n=0;e.forEach((function(e){n+=e.length}));var t=new Uint8Array(n),r=0;return e.forEach((function(e){t.set(e,r),r+=e.length})),t};_.encrypt=function(n,t){var r=c(n),o=e.randomBytes(24),i=e.box.after(r,o,t);return a(o)+"|"+a(i)},_.decrypt=function(n,t){var r=n.split("|"),o=i(r[0]),a=i(r[1]),c=e.box.open.after(a,o,t);return c?s(c):null},_.signAndEncrypt=function(n,t,r){var o=_.encrypt(n,t);return a(e.sign(c(o),r))},_.openSigned=function(e,n){var t=i(e).subarray(64);return _.decrypt(s(t),n)},_.deriveKeys=function(n,t){try{var r=i(n),o=i(t),s=e.box.before(r,o),u=c("CryptPad.signingKeyGenerationSalt"),l=e.hash(w([u,s])),f=e.sign.keyPair.fromSeed(l.subarray(0,32)),d=l.subarray(32,64);return{cryptKey:a(d),signKey:a(f.secretKey),validateKey:a(f.publicKey)}}catch(e){return console.error("invalid keys or other problem deriving keys"),console.error(e),null}},_.createEncryptor=function(e){if(e&&"object"==typeof e){var n=i(e.cryptKey),t=i(e.signKey),r=i(e.validateKey);return{encrypt:function(e){return _.signAndEncrypt(e,n,t)},decrypt:function(e){return _.openSigned(e,n,r)}}}console.error("invalid input for createEncryptor")};var O=function(e,n,t){return new Uint8Array(Array.prototype.slice.call(e,n,t))},D=o.Mailbox={},S=function(n,t){var r=e.randomBytes(e.box.nonceLength),a=e.box(n,r,t.their_public,t.my_private),i=w([r,t.my_public,a]);if(t.their_kem_public&&o.PQC&&o.PQC.ml_kem&&o.PQC.ml_kem.ml_kem512)try{var c=o.PQC.ml_kem.ml_kem512.encapsulate(t.their_kem_public),s=c.sharedSecret,u=c.ciphertext,f=e.box.before(t.their_public,t.my_private),d=l(f,s),h=e.randomBytes(e.secretbox.nonceLength),p=e.secretbox(i,h,d);i=w([new Uint8Array([1]),u,h,p])}catch(e){console.warn("PQC encryption failed, falling back to traditional:",e),i=w([new Uint8Array([0]),i])}else i=w([new Uint8Array([0]),i]);return i},T=function(n,t){var r=n[0],a=O(n,1);if(1===r&&t.my_kem_private&&o.PQC&&o.PQC.ml_kem&&o.PQC.ml_kem.ml_kem512)try{var i=O(a,0,768),c=O(a,768,768+e.secretbox.nonceLength),s=O(a,768+e.secretbox.nonceLength),u=o.PQC.ml_kem.ml_kem512.decapsulate(i,t.my_kem_private),f=e.box.before(t.their_public||t.sender_public,t.my_private),d=l(f,u),h=e.secretbox.open(s,c,d);if(!h)throw new Error("Failed to decrypt PQC layer");a=h}catch(e){throw console.error("PQC decryption failed:",e),new Error("E_PQC_DECRYPTION_FAILURE")}var p=O(a,0,e.box.nonceLength),v=O(a,e.box.nonceLength,e.box.nonceLength+e.box.publicKeyLength),y=O(a,e.box.nonceLength+e.box.publicKeyLength),m=e.box.open(y,p,t.their_public||v,t.my_private);if(!m)throw new Error("E_DECRYPTION_FAILURE");return{content:m,author:v}},x=function(n,t){var r=2420;if(n.length>=2484&&t.dsaPublic&&o.PQC&&o.PQC.ml_dsa&&o.PQC.ml_dsa.ml_dsa44)try{var a=O(n,0,64+n.length-64-r),i=O(n,n.length-r),c=O(n,64,n.length-r);return e.sign.open(a,t.validateKey)&&o.PQC.ml_dsa.ml_dsa44.verify(t.dsaPublic,c,i)?c:null}catch(e){return console.error("PQC signature verification failed:",e),null}return e.sign.open(n,t.validateKey)},C=D.sealSecretLetter=function(n,t){var r=c(n),i=S(r,{their_public:t.their_public,their_kem_public:t.their_kem_public,my_private:t.my_private,my_public:t.my_public}),s=t.ephemeral_keypair||e.box.keyPair(),u=S(i,{their_public:t.their_public,their_kem_public:t.their_kem_public,my_private:s.secretKey,my_public:s.publicKey});return t.signingKey&&(u=function(n,t){var r=e.sign(n,t.signingKey);if(t.dsaPrivate&&o.PQC&&o.PQC.ml_dsa&&o.PQC.ml_dsa.ml_dsa44)try{var a=o.PQC.ml_dsa.ml_dsa44.sign(t.dsaPrivate,n);return w([r,a])}catch(e){console.warn("ML-DSA signing failed, using only NaCl:",e)}return r}(u,{signingKey:t.signingKey,dsaPrivate:t.dsaPrivate})),a(u)};D.openOwnSecretLetter=function(e,n){var t=i(e);if(n.validateKey&&!(t=x(t,{validateKey:n.validateKey,dsaPublic:n.dsaPublic})))throw new Error("E_SIGNATURE_VERIFICATION_FAILED");var r=T(t,{my_private:n.ephemeral_private,my_kem_private:n.ephemeral_kem_private,their_public:n.their_public}),o=T(r.content,{my_private:n.my_private,my_kem_private:n.my_kem_private,their_public:n.their_public});return{content:s(o.content),author:a(o.author)}};var N=D.openSecretLetter=function(e,n){var t=i(e);if(n.validateKey&&!(t=x(t,{validateKey:n.validateKey,dsaPublic:n.dsaPublic})))throw new Error("E_SIGNATURE_VERIFICATION_FAILED");var r=T(t,{my_private:n.my_private,my_kem_private:n.my_kem_private}),o=T(r.content,{my_private:n.my_private,my_kem_private:n.my_kem_private});return{content:s(o.content),author:a(o.author)}};D.createEncryptor=function(e){if(e&&"object"==typeof e){["curvePublic","curvePrivate"].forEach((function(n){if("string"!=typeof e[n])throw console.log(n),new Error("Expected key was not present")}));var n=i(e.curvePrivate),t=i(e.curvePublic),r=e.kemPrivate?i(e.kemPrivate):void 0,o=e.kemPublic?i(e.kemPublic):void 0,a=e.signingKey?i(e.signingKey):void 0,c=e.validateKey?i(e.validateKey):void 0,s=e.dsaPrivate?i(e.dsaPrivate):void 0,u=e.dsaPublic?i(e.dsaPublic):void 0;return{encrypt:function(c,u,l){var f=i(u),d=l?i(l):void 0;try{return C(c,{signingKey:a,dsaPrivate:s,ephemeral_keypair:e.ephemeral_keypair,their_public:f,their_kem_public:d,my_private:n,my_kem_private:r,my_public:t,my_kem_public:o})}catch(e){return console.error(e),null}},decrypt:function(e){try{return N(e,{validateKey:c,dsaPublic:u,my_private:n,my_kem_private:r})}catch(e){return console.error(e),null}}}}console.error("invalid Mailbox.createEncryptor keys")};var I=o.Team={},R={teamCurvePublic:"team_curve_public",teamCurvePrivate:"team_curve_private",myCurvePublic:"my_curve_public",myCurvePrivate:"my_curve_private",teamEdPublic:"team_ed_public",teamEdPrivate:"team_ed_private"},P=function(n){var t=e.hash(n);return[O(t,0,32),O(t,32)]},k=function(n){var t=P(n),r=e.box.keyPair.fromSecretKey(t[0]),i=O(t[1],0,16);return{channel:u(i),teamCurvePublic:a(r.publicKey),teamCurvePrivate:a(r.secretKey),viewKeyStr:o.b64RemoveSlashes(a(n))}};return I.deriveGuestKeys=function(e){return k(i(o.b64AddSlashes(e)))},I.createSeed=function(){return o.b64AddSlashes(a(e.randomBytes(18)))},I.deriveMemberKeys=function(n,t){var r,c;try{if((r=i(o.b64AddSlashes(n))).length<18)throw new Error("INVALID_SEED")}catch(e){throw e}if(c=t,!Boolean(c.curvePublic&&i(c.curvePublic).length===e.box.publicKeyLength&&c.curvePrivate&&i(c.curvePrivate).length===e.box.secretKeyLength))throw new Error("INVALID_OWN_KEYS");var s,u,l,f=P(r),d=e.sign.keyPair.fromSeed(f[0]),h=k(f[1]);return s={myCurvePublic:t.curvePublic,myCurvePrivate:t.curvePrivate,teamEdPrivate:a(d.secretKey),teamEdPublic:a(d.publicKey)},u=h,l=JSON.parse(JSON.stringify(s)),Object.keys(u).forEach((function(e){l[e]=u[e]})),l},I.createEncryptor=function(n){var t={};Object.keys(R).forEach((function(e){if(n[e])try{t[R[e]]=i(n[e])}catch(n){throw console.log(e),new Error("INVALID_KEY_SUPPLIED")}}));var r,o={};if(r=t,Boolean(r.my_curve_private&&r.my_curve_private.length===e.box.secretKeyLength&&r.my_curve_public&&r.my_curve_public.length===e.box.publicKeyLength&&r.team_curve_public&&r.team_curve_public.length===e.box.publicKeyLength&&r.team_ed_private&&r.team_ed_private.length===e.sign.secretKeyLength)&&(o.encrypt=function(n){try{return function(n,t){var r=c(n),o=S(r,{their_public:t.team_curve_public,my_private:t.my_curve_private,my_public:t.my_curve_public}),i=e.box.keyPair(),s=S(o,{their_public:t.team_curve_public,my_private:i.secretKey,my_public:i.publicKey});return a(e.sign(s,t.team_ed_private))}(n,t)}catch(e){return console.error(e),null}}),function(n){return Boolean(n.team_curve_private&&n.team_curve_private.length===e.box.secretKeyLength&&n.team_ed_public&&n.team_ed_public.length===e.sign.publicKeyLength)}(t)&&(o.decrypt=function(n,r){try{return function(n,t,r){var o,c=i(n);if(null===(o=!0===r?O(c,64):e.sign.open(c,t.team_ed_public)))throw new Error("E_VALIDATION_FAILURE");var u=T(o,{my_private:t.team_curve_private}),l=T(u.content,{my_private:t.team_curve_private});return{content:s(l.content),author:a(l.author)}}(n,t,r)}catch(e){return console.error(e),null}}),0===Object.keys(o).length)throw new Error("INVALID_TEAM_CONFIGURATION");return o},o},e.exports?e.exports=n(h(),w(),L()):window.chainpad_crypto=n(window.nacl,window.PostQuantum,window.scrypt),function(){var n=function(e,n,t,r){var o={Nacl:e,PQC:t},a=n.encodeBase64,i=e=>{let t;return(t=e.length%4)&&(e+="=".repeat(4-t)),n.decodeBase64(e)},c=n.decodeUTF8,s=n.encodeUTF8,u=function(e){for(var n="",t=0;t<e.length;t++)e[t]<16&&(n+="0"),n+=e[t].toString(16);return n},l=function(e,n){if(!e||!n)throw new Error("Both NaCl and KEM keys required for key derivation");var t=new Uint8Array(32);return r(Array.from(w([e,n])),Array.from(c("CryptPad.mailbox.pqc.salt")),8,1024,128,200,(function(e){for(var n=0;n<e.length;n++)t[n]=e[n]}),"binary"),t},f=o.CryptoAgility={};f.decodeBase64=i,f.encodeBase64=a,f.decodeUTF8=c,f.encodeUTF8=s,f.signKeyPairFromSeed=function(n){return e.sign.keyPair.fromSeed(n)},f.signKeyPairFromSecretKey=function(n){return e.sign.keyPair.fromSecretKey(n)},f.signKeyPair=function(){return e.sign.keyPair()},f.sign=function(n,t){return e.sign(n,t)},f.signOpen=function(n,t){return e.sign.open(n,t)},f.signDetached=function(n,t){return e.sign.detached(n,t)},f.verifyDetached=function(n,t,r){return e.sign.detached.verify(t,n,r)},f.curveKeyPair=function(){return e.box.keyPair()},f.box=function(n,t,r,o){return e.box(n,t,r,o)},f.boxOpen=function(n,t,r,o){return e.box.open(n,t,r,o)},f.boxKeyPairFromSecretKey=function(n){return e.box.keyPair.fromSecretKey(n)},f.secretbox=function(n,t,r){return e.secretbox(n,t,r)},f.secretboxOpen=function(n,t,r){return e.secretbox.open(n,t,r)},f.createHash=function(n){return e.hash(n)},f.bytes=function(n){return e.randomBytes(n)},f.boxNonceLength=function(){return e.box.nonceLength},f.signSeedLength=function(){return e.sign.seedLength},f.boxKeyLength=function(){return e.box.publicKeyLength},f.secretboxKeyLength=function(){return e.secretbox.keyLength},f.secretboxNonceLength=function(){return e.secretbox.nonceLength},f.signKeyLength=function(){return e.sign.publicKeyLength};var d=o.Box={};d.encrypt=function(n,t,r,o){return e.box(n,t,r,o)},d.decrypt=function(n,t,r,o){return e.box.open(n,t,r,o)},d.encryptAfter=function(n,t,r){return e.box.after(n,t,r)},d.decryptAfter=function(n,t,r){return e.box.open.after(n,t,r)},d.getSharedSecret=function(n,t){return e.box.before(n,t)};var h=o.SecretBox={};h.encrypt=function(n,t,r){return e.secretbox(n,t,r)},h.decrypt=function(n,t,r){return e.secretbox.open(n,t,r)};var p=o.Sign={};p.sign=function(n,t){return e.sign(n,t)},p.verify=function(n,t){return e.sign.open(n,t)},p.detached=function(n,t){return e.sign.detached(n,t)},p.verifyDetached=function(n,t,r){return e.sign.detached.verify(t,n,r)};var v=o.encrypt=function(e,n){return function(e,n){var t=c(e),r=f.bytes(24),o=h.encrypt(t,r,n);if(!o)throw new Error;return a(r)+"|"+a(o)}(e,n)},y=o.decrypt=function(e,n){return function(e,n){var t=e.split("|");if(2!==t.length)throw new Error;var r=i(t[0]),o=i(t[1]),a=h.decrypt(o,r,n);if(!a)throw new Error;return s(a)}(e,n)},m=o.parseKey=function(e){try{var n=i(e),t=f.createHash(n),r=t.subarray(32);return{lookupKey:r,cryptKey:t.subarray(0,32),channel:a(r).substring(0,10)}}catch(e){throw console.error("[chainpad-crypto.parseKey] invalid string supplied"),e}},g=o.rand64=function(e){return a(f.bytes(e))};o.genKey=function(){return g(18)};var E=function(e){return a(e).replace(/\//g,"-").replace(/=+$/g,"")},b=function(e){return i(e.replace(/\-/g,"/"))};o.b64RemoveSlashes=function(e){return e.replace(/\//g,"-")},o.b64AddSlashes=function(e){return e.replace(/\-/g,"/")},o.createEncryptor=function(n){var t;if("object"==typeof n){var r={};if(!(t=n.cryptKey))throw new Error("NO_DECRYPTION_KEY_PROVIDED");if(n.signKey){var o=i(n.signKey);r.encrypt=function(n){return a(e.sign(c(v(n,t)),o))}}return r.decrypt=function(n,r,o){if(!r&&!o)throw new Error("UNSUPPORTED_DECRYPTION_CONFIGURATION");!0!==r||o||console.error("UNEXPECTED_CONFIGURATION");var a=o||"string"!=typeof r?i(n).subarray(64):e.sign.open(i(n),i(r));if(a)return y(s(a),t)},r}return t=m(n).cryptKey,{encrypt:function(e){return v(e,t)},decrypt:function(e){return y(e,t)}}},o.createEditCryptor=function(n,t){try{if(!n){if(t&&18!==t.length)throw new Error("expected supplied seed to have length of 18");t||(t=e.randomBytes(18)),n=a(t)}var r=e.hash(i(n)),o=e.sign.keyPair.fromSeed(r.subarray(0,32)),c=r.subarray(32,64);return{editKeyStr:n,signKey:a(o.secretKey),validateKey:a(o.publicKey),cryptKey:c,viewKeyStr:E(c)}}catch(e){throw console.error("[chainpad-crypto.createEditCryptor] invalid string supplied"),e}},o.createViewCryptor=function(e){try{if(!e)throw new Error("Cannot open a new pad in read-only mode!");return{cryptKey:i(e),viewKeyStr:e}}catch(e){throw console.error("[chainpad-crypto.createViewCryptor] invalid string supplied"),e}};var A=o.createViewCryptor2=function(n,t){try{if(!n)throw new Error("Cannot open a new pad in read-only mode!");var r=b(n),o=r;if(t){var i=c(t);(o=new Uint8Array(r.length+i.length)).set(i),o.set(r,i.length)}var s=e.hash(o),u=s.subarray(0,16),l=s.subarray(16,48),f=e.sign.keyPair.fromSeed(s.subarray(32,64));return{viewKeyStr:n,cryptKey:l,chanId:E(u),secondarySignKey:a(f.secretKey),secondaryValidateKey:a(f.publicKey)}}catch(e){throw console.error("[chainpad-crypto.createViewCryptor2] invalid string supplied"),e}};o.createEditCryptor2=function(n,t,r){try{if(!n){if(t&&18!==t.length)throw new Error("expected supplied seed to have length of 18");t||(t=e.randomBytes(18)),n=E(t)}t||(t=b(n));var o=t;if(r){var i=c(r);(o=new Uint8Array(t.length+i.length)).set(i),o.set(t,i.length)}var s=e.hash(o),u=e.sign.keyPair.fromSeed(s.subarray(0,32)),l=e.hash(u.secretKey).subarray(0,e.secretbox.keyLength),f=s.subarray(32,64),d=E(f),h=A(d,r);return{editKeyStr:n,viewKeyStr:d,signKey:a(u.secretKey),validateKey:a(u.publicKey),cryptKey:h.cryptKey,secondaryKey:a(l),chanId:h.chanId,secondarySignKey:h.secondarySignKey,secondaryValidateKey:h.secondaryValidateKey}}catch(e){throw console.error("[chainpad-crypto.createEditCryptor2] invalid string supplied"),e}},o.createFileCryptor2=function(n,t){try{var r;n||(r=e.randomBytes(18),n=E(r)),r||(r=b(n));var o=r;if(t){var a=c(t);(o=new Uint8Array(r.length+a.length)).set(a),o.set(r,a.length)}var i=e.hash(o),s=i.subarray(0,24);return{fileKeyStr:n,cryptKey:i.subarray(24,56),chanId:E(s)}}catch(e){throw console.error("[chainpad-crypto.createFileCryptor2] invalid string supplied"),e}};var _=o.Curve={},w=function(e){var n=0;e.forEach((function(e){n+=e.length}));var t=new Uint8Array(n),r=0;return e.forEach((function(e){t.set(e,r),r+=e.length})),t};_.encrypt=function(n,t){var r=c(n),o=e.randomBytes(24),i=e.box.after(r,o,t);return a(o)+"|"+a(i)},_.decrypt=function(n,t){var r=n.split("|"),o=i(r[0]),a=i(r[1]),c=e.box.open.after(a,o,t);return c?s(c):null},_.signAndEncrypt=function(n,t,r){var o=_.encrypt(n,t);return a(e.sign(c(o),r))},_.openSigned=function(e,n){var t=i(e).subarray(64);return _.decrypt(s(t),n)},_.deriveKeys=function(n,t){try{var r=i(n),o=i(t),s=e.box.before(r,o),u=c("CryptPad.signingKeyGenerationSalt"),l=e.hash(w([u,s])),f=e.sign.keyPair.fromSeed(l.subarray(0,32)),d=l.subarray(32,64);return{cryptKey:a(d),signKey:a(f.secretKey),validateKey:a(f.publicKey)}}catch(e){return console.error("invalid keys or other problem deriving keys"),console.error(e),null}},_.createEncryptor=function(e){if(e&&"object"==typeof e){var n=i(e.cryptKey),t=i(e.signKey),r=i(e.validateKey);return{encrypt:function(e){return _.signAndEncrypt(e,n,t)},decrypt:function(e){return _.openSigned(e,n,r)}}}console.error("invalid input for createEncryptor")};var O=function(e,n,t){return new Uint8Array(Array.prototype.slice.call(e,n,t))},D=o.Mailbox={},S=function(n,t){var r=e.randomBytes(e.box.nonceLength),a=e.box(n,r,t.their_public,t.my_private),i=w([r,t.my_public,a]);if(t.their_kem_public&&o.PQC&&o.PQC.ml_kem&&o.PQC.ml_kem.ml_kem512)try{var c=o.PQC.ml_kem.ml_kem512.encapsulate(t.their_kem_public),s=c.sharedSecret,u=c.ciphertext,f=e.box.before(t.their_public,t.my_private),d=l(f,s),h=e.randomBytes(e.secretbox.nonceLength),p=e.secretbox(i,h,d);i=w([new Uint8Array([1]),u,h,p])}catch(e){console.warn("PQC encryption failed, falling back to traditional:",e),i=w([new Uint8Array([0]),i])}else i=w([new Uint8Array([0]),i]);return i},T=function(n,t){var r=n[0],a=O(n,1);if(1===r&&t.my_kem_private&&o.PQC&&o.PQC.ml_kem&&o.PQC.ml_kem.ml_kem512)try{var i=O(a,0,768),c=O(a,768,768+e.secretbox.nonceLength),s=O(a,768+e.secretbox.nonceLength),u=o.PQC.ml_kem.ml_kem512.decapsulate(i,t.my_kem_private),f=e.box.before(t.their_public||t.sender_public,t.my_private),d=l(f,u),h=e.secretbox.open(s,c,d);if(!h)throw new Error("Failed to decrypt PQC layer");a=h}catch(e){throw console.error("PQC decryption failed:",e),new Error("E_PQC_DECRYPTION_FAILURE")}var p=O(a,0,e.box.nonceLength),v=O(a,e.box.nonceLength,e.box.nonceLength+e.box.publicKeyLength),y=O(a,e.box.nonceLength+e.box.publicKeyLength),m=e.box.open(y,p,t.their_public||v,t.my_private);if(!m)throw new Error("E_DECRYPTION_FAILURE");return{content:m,author:v}},x=function(n,t){var r=2420;if(n.length>=2484&&t.dsaPublic&&o.PQC&&o.PQC.ml_dsa&&o.PQC.ml_dsa.ml_dsa44)try{var a=O(n,0,64+n.length-64-r),i=O(n,n.length-r),c=O(n,64,n.length-r);return e.sign.open(a,t.validateKey)&&o.PQC.ml_dsa.ml_dsa44.verify(t.dsaPublic,c,i)?c:null}catch(e){return console.error("PQC signature verification failed:",e),null}return e.sign.open(n,t.validateKey)},C=D.sealSecretLetter=function(n,t){var r=c(n),i=S(r,{their_public:t.their_public,their_kem_public:t.their_kem_public,my_private:t.my_private,my_public:t.my_public}),s=t.ephemeral_keypair||e.box.keyPair(),u=S(i,{their_public:t.their_public,their_kem_public:t.their_kem_public,my_private:s.secretKey,my_public:s.publicKey});return t.signingKey&&(u=function(n,t){var r=e.sign(n,t.signingKey);if(t.dsaPrivate&&o.PQC&&o.PQC.ml_dsa&&o.PQC.ml_dsa.ml_dsa44)try{var a=o.PQC.ml_dsa.ml_dsa44.sign(t.dsaPrivate,n);return w([r,a])}catch(e){console.warn("ML-DSA signing failed, using only NaCl:",e)}return r}(u,{signingKey:t.signingKey,dsaPrivate:t.dsaPrivate})),a(u)};D.openOwnSecretLetter=function(e,n){var t=i(e);if(n.validateKey&&!(t=x(t,{validateKey:n.validateKey,dsaPublic:n.dsaPublic})))throw new Error("E_SIGNATURE_VERIFICATION_FAILED");var r=T(t,{my_private:n.ephemeral_private,my_kem_private:n.ephemeral_kem_private,their_public:n.their_public}),o=T(r.content,{my_private:n.my_private,my_kem_private:n.my_kem_private,their_public:n.their_public});return{content:s(o.content),author:a(o.author)}};var N=D.openSecretLetter=function(e,n){var t=i(e);if(n.validateKey&&!(t=x(t,{validateKey:n.validateKey,dsaPublic:n.dsaPublic})))throw new Error("E_SIGNATURE_VERIFICATION_FAILED");var r=T(t,{my_private:n.my_private,my_kem_private:n.my_kem_private}),o=T(r.content,{my_private:n.my_private,my_kem_private:n.my_kem_private});return{content:s(o.content),author:a(o.author)}};D.createEncryptor=function(e){if(e&&"object"==typeof e){["curvePublic","curvePrivate"].forEach((function(n){if("string"!=typeof e[n])throw console.log(n),new Error("Expected key was not present")}));var n=i(e.curvePrivate),t=i(e.curvePublic),r=e.kemPrivate?i(e.kemPrivate):void 0,o=e.kemPublic?i(e.kemPublic):void 0,a=e.signingKey?i(e.signingKey):void 0,c=e.validateKey?i(e.validateKey):void 0,s=e.dsaPrivate?i(e.dsaPrivate):void 0,u=e.dsaPublic?i(e.dsaPublic):void 0;return{encrypt:function(c,u,l){var f=i(u),d=l?i(l):void 0;try{return C(c,{signingKey:a,dsaPrivate:s,ephemeral_keypair:e.ephemeral_keypair,their_public:f,their_kem_public:d,my_private:n,my_kem_private:r,my_public:t,my_kem_public:o})}catch(e){return console.error(e),null}},decrypt:function(e){try{return N(e,{validateKey:c,dsaPublic:u,my_private:n,my_kem_private:r})}catch(e){return console.error(e),null}}}}console.error("invalid Mailbox.createEncryptor keys")};var I=o.Team={},R={teamCurvePublic:"team_curve_public",teamCurvePrivate:"team_curve_private",myCurvePublic:"my_curve_public",myCurvePrivate:"my_curve_private",teamEdPublic:"team_ed_public",teamEdPrivate:"team_ed_private"},P=function(n){var t=e.hash(n);return[O(t,0,32),O(t,32)]},k=function(n){var t=P(n),r=e.box.keyPair.fromSecretKey(t[0]),i=O(t[1],0,16);return{channel:u(i),teamCurvePublic:a(r.publicKey),teamCurvePrivate:a(r.secretKey),viewKeyStr:o.b64RemoveSlashes(a(n))}};return I.deriveGuestKeys=function(e){return k(i(o.b64AddSlashes(e)))},I.createSeed=function(){return o.b64AddSlashes(a(e.randomBytes(18)))},I.deriveMemberKeys=function(n,t){var r,c;try{if((r=i(o.b64AddSlashes(n))).length<18)throw new Error("INVALID_SEED")}catch(e){throw e}if(c=t,!Boolean(c.curvePublic&&i(c.curvePublic).length===e.box.publicKeyLength&&c.curvePrivate&&i(c.curvePrivate).length===e.box.secretKeyLength))throw new Error("INVALID_OWN_KEYS");var s,u,l,f=P(r),d=e.sign.keyPair.fromSeed(f[0]),h=k(f[1]);return s={myCurvePublic:t.curvePublic,myCurvePrivate:t.curvePrivate,teamEdPrivate:a(d.secretKey),teamEdPublic:a(d.publicKey)},u=h,l=JSON.parse(JSON.stringify(s)),Object.keys(u).forEach((function(e){l[e]=u[e]})),l},I.createEncryptor=function(n){var t={};Object.keys(R).forEach((function(e){if(n[e])try{t[R[e]]=i(n[e])}catch(n){throw console.log(e),new Error("INVALID_KEY_SUPPLIED")}}));var r,o={};if(r=t,Boolean(r.my_curve_private&&r.my_curve_private.length===e.box.secretKeyLength&&r.my_curve_public&&r.my_curve_public.length===e.box.publicKeyLength&&r.team_curve_public&&r.team_curve_public.length===e.box.publicKeyLength&&r.team_ed_private&&r.team_ed_private.length===e.sign.secretKeyLength)&&(o.encrypt=function(n){try{return function(n,t){var r=c(n),o=S(r,{their_public:t.team_curve_public,my_private:t.my_curve_private,my_public:t.my_curve_public}),i=e.box.keyPair(),s=S(o,{their_public:t.team_curve_public,my_private:i.secretKey,my_public:i.publicKey});return a(e.sign(s,t.team_ed_private))}(n,t)}catch(e){return console.error(e),null}}),function(n){return Boolean(n.team_curve_private&&n.team_curve_private.length===e.box.secretKeyLength&&n.team_ed_public&&n.team_ed_public.length===e.sign.publicKeyLength)}(t)&&(o.decrypt=function(n,r){try{return function(n,t,r){var o,c=i(n);if(null===(o=!0===r?O(c,64):e.sign.open(c,t.team_ed_public)))throw new Error("E_VALIDATION_FAILURE");var u=T(o,{my_private:t.team_curve_private}),l=T(u.content,{my_private:t.team_curve_private});return{content:s(l.content),author:a(l.author)}}(n,t,r)}catch(e){return console.error(e),null}}),0===Object.keys(o).length)throw new Error("INVALID_TEAM_CONFIGURATION");return o},o};e.exports?e.exports=n(h(),w(),L()):window.chainpad_crypto=n(window.nacl,window.PostQuantum,window.scrypt)}()}(M)),M.exports}var H,j=K(),U={exports:{}};function B(){return H||(H=1,function(e){e.exports&&(e.exports=((e={})=>{var n={setCustomize:n=>{e=n.ApiConfig},getWebsocketURL:function(n){var t=e.websocketPath||"/cryptpad_websocket";if(/^ws{1,2}:\/\//.test(t))return t;var r=new URL(n||globalThis?.location?.href||e.httpUnsafeOrigin);return n&&(r.href=n),r.protocol.replace(/http/,"ws")+"//"+r.host+t}};return n})())}(U)),U.exports}var V,Y=B(),G=n({__proto__:null,default:r(Y)},[Y]),J={exports:{}};function q(){return V||(V=1,function(e){e.exports&&(e.exports=function(e={}){return{setCustomize:n=>{e=n.AppConfig},userHashKey:"User_hash",userNameKey:"User_name",blockHashKey:"Block_hash",fileHashKey:"FS_hash",sessionJWT:"Session_JWT",ssoSeed:"SSO_seed",displayNameKey:"cryptpad.username",oldStorageKey:"CryptPad_RECENTPADS",storageKey:"filesData",tokenKey:"loginToken",prefersDriveRedirectKey:"prefersDriveRedirect",isPremiumKey:"isPremiumUser",displayPadCreationScreen:"displayPadCreationScreen",deprecatedKey:"deprecated",MAX_TEAMS_SLOTS:e.maxTeamsSlots||5,MAX_TEAMS_OWNED:e.maxOwnedTeams||5,MAX_PREMIUM_TEAMS_SLOTS:Math.max(e.maxTeamsSlots||0,e.maxPremiumTeamsSlots||0)||5,MAX_PREMIUM_TEAMS_OWNED:Math.max(e.maxOwnedTeams||0,e.maxPremiumTeamsOwned||0)||5,criticalApps:["profile","settings","debug","admin","support","notifications","calendar","moderation","oldadmin"],earlyAccessApps:[]}}(void 0))}(J)),J.exports}var W,z=q(),Q=n({__proto__:null,default:r(z)},[z]),X={exports:{}},Z={exports:{}},$=Z.exports;function ee(){return W||(W=1,function(e){!function(n){const t=e=>{var t=n.CryptPad_Util={};n.atob=n.atob||function(e){return Buffer.from(e,"base64").toString("binary")},n.btoa=n.btoa||function(e){return Buffer.from(e,"binary").toString("base64")},t.encodeBase64=e.CryptoAgility.encodeBase64,t.decodeBase64=e.CryptoAgility.decodeBase64,t.encodeUTF8=e.CryptoAgility.encodeUTF8,t.decodeUTF8=e.CryptoAgility.decodeUTF8,t.slice=function(e,n,t){return Array.prototype.slice.call(e,n,t)},t.u8ToBase64=(e,n)=>{const t=new FileReader;t.onload=()=>{let e=t.result,r=e.slice(e.indexOf(",")+1);n(r)},t.readAsDataURL(new Blob([e]))},t.shuffleArray=function(e){for(var n=e.length-1;n>0;n--){var t=Math.floor(Math.random()*(n+1)),r=e[n];e[n]=e[t],e[t]=r}},t.bake=function(e,n){return void 0===n&&(n=[]),Array.isArray(n)||(n=[n]),function(){return e.apply(null,n)}},t.both=function(e,n){if("function"!=typeof e)throw new Error("INVALID_USAGE");return"function"!=typeof n&&(n=function(e){return e}),function(){return e.apply(null,arguments),n.apply(null,arguments)}},t.clone=function(e){return null==e?e:JSON.parse(JSON.stringify(e))},t.serializeError=function(e){if(!(e instanceof Error))return e;var n={};return Object.getOwnPropertyNames(e).forEach((function(t){n[t]=e[t]})),n},t.tryParse=function(e){try{return JSON.parse(e)}catch(e){return}},t.mkAsync=function(e,n){if("function"!=typeof e)throw new Error("EXPECTED_FUNCTION");return function(){var t=Array.prototype.slice.call(arguments);setTimeout((function(){e.apply(null,t)}),n)}},t.mkEvent=function(e){var n=[],t=!1;let r;return{reg:function(r){e&&t?setTimeout(r):n.push(r)},unreg:function(e){-1!==n.indexOf(e)?n.splice(n.indexOf(e),1):console.log("event handler was already unregistered")},fire:function(){if(!e||!t){var o=Array.prototype.slice.call(arguments);t||r.apply(null,o),t=!0,n.forEach((function(e){e.apply(null,o)}))}},promise:new Promise((e=>{r=e}))}},t.mkTimeout=function(e,n){n=n||0;var r=t.once(e),o=setTimeout((function(){r("TIMEOUT")}),n);return t.both(r,(function(){clearTimeout(o)}))},t.onClickEnter=function(e,n,t){e.on("click keydown",(function(e){var r="click"===e.type,o="keydown"===e.type&&13===e.which,a="keydown"===e.type&&32===e.which&&t&&t.space;(r||o||a)&&("keydown"===e.type&&e.preventDefault(),n(e))}))},t.response=function(e){var n={},t={};"function"!=typeof e&&(e=function(e){throw new Error(e)});var r=function(e){clearTimeout(t[e]),delete t[e],delete n[e]};return{clear:r,expected:function(e){return Boolean(n[e])},expectation:function(e){return n[e]},expect:function(o,a,i){"string"!=typeof o&&e("EXPECTED_STRING"),"function"!=typeof a&&e("EXPECTED_CALLBACK"),n[o]=a,"number"==typeof i&&i&&(t[o]=setTimeout((function(){"function"==typeof n[o]&&n[o]("TIMEOUT"),r(o)}),i))},handle:function(t,o){var a=n[t];if("function"==typeof a){try{a.apply(null,Array.isArray(o)?o:[o])}catch(n){e("HANDLER_ERROR",{error:n,id:t,args:o})}r(t)}else e("MISSING_CALLBACK",{id:t,args:o})},_pending:n}},t.inc=function(e,n,t){e[n]=(e[n]||0)+("number"==typeof t?t:1)},t.values=function(e){return Object.keys(e).map((function(n){return e[n]}))},t.find=function(e,n){for(var t=n.length,r=0;r<t;r++){if(void 0===e[n[r]])return;e=e[n[r]]}return e},t.uid=function(){return Number(Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)).toString(32).replace(/\./g,"")},t.guid=function(e){var n=t.uid();return void 0===e[n]?n:t.guid(e)},t.fixHTML=function(e){return e?e.replace(/[<>&"']/g,(function(e){return{"<":"&lt;",">":"&gt","&":"&amp;",'"':"&#34;","'":"&#39;"}[e]})):""},t.hexToBase64=function(e){var t=e.replace(/\r|\n/g,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" "),r=String.fromCharCode.apply(null,t);return n.btoa(r).replace(/\//g,"-").replace(/=+$/,"")},t.base64ToHex=function(e){var t=[];return n.atob(e.replace(/-/g,"/")).split("").forEach((function(e){var n=e.charCodeAt(0).toString(16);1===n.length&&(n="0"+n),t.push(n)})),t.join("")},t.uint8ArrayToHex=function(e){for(var n="",t=0;t<e.length;t++)e[t]<16&&(n+="0"),n+=e[t].toString(16);return n},t.hexToUint8Array=function(e){for(var n=new Uint8Array(Math.ceil(e.length/2)),t=0;t<n.length;t++)n[t]=parseInt(e.substr(2*t,2),16);return n},t.uint8ArrayJoin=function(e){for(var n=0,t=0;t<e.length;t++)n+=e[t].length;var r=new Uint8Array(n);t=0;for(var o=0;t<e.length;t++)r.set(e[t],o),o+=e[t].length;return r},t.escapeKeyCharacters=function(e){return e&&e.replace&&e.replace(/\//g,"-")},t.unescapeKeyCharacters=function(e){return e.replace(/\-/g,"/")},t.deduplicateString=function(e){for(var n=e.slice(),t=0;t<n.length;t++)for(var r=t+1;r<n.length;r++)n[t]===n[r]&&n.splice(r--,1);return n},t.fixFileName=function(e){return e.replace(/ /g,"-").replace(/[\/\?]/g,"_").replace(/_+/g,"_")};var r=1048576,o=1073741824;t.bytesToGigabytes=function(e){return Math.ceil(e/o*100)/100},t.bytesToMegabytes=function(e){return Math.ceil(e/r*100)/100},t.bytesToKilobytes=function(e){return Math.ceil(e/1024*100)/100},t.magnitudeOfBytes=function(e){return e>=o?"GB":e>=r?"MB":"KB"};t.getBlock=function(e,n,r){var o=t.once(t.mkAsync(r)),a={};"string"==typeof n.bearer&&n.bearer&&(a.authorization=`Bearer ${n.bearer}`),fetch(e,{method:"GET",credentials:"include",headers:a}).then((e=>{e.ok?o(void 0,e):401!==e.status&&404!==e.status?o(e.status,e):e.json().then((n=>{o(e.status,n)})).catch((()=>{o(e.status)}))})).catch((e=>{o(e)}))},t.fetchApi=function(e,n,t,r){const o=new URL(e);o.pathname=`api/${n}`;let a=o.href+(t?"?"+ +new Date:"");if("undefined"!=typeof self&&self.crypto)fetch(a).then((e=>{if(!e.ok)throw new Error(`Fetch error: ${e.status}`);return e.text()})).then((e=>{r(JSON.parse(e.slice(27,-5)))})).catch((e=>{console.error(e.message),r({})}));else if(void 0!==l){("http:"===o.protocol?require("node:http"):require("node:https")).get(o.href,(e=>{let n="";e.on("data",(e=>{n+=e})),e.on("end",(()=>{try{r(JSON.parse(n.slice(27,-5)))}catch(e){console.error(e),r({})}}))}))}},t.fetch=function(e,n,r,o){var a,i=t.once(t.mkAsync(n)),c=function(e){var n=e.replace(/(\/)*$/,""),t=n.lastIndexOf("/"),r=n.slice(t+1);return/^[a-f0-9]{48}$/.test(r)||(r=void 0),r}(e),s=function(){(a=new XMLHttpRequest).open("GET",e,!0),r&&a.addEventListener("progress",(function(e){if(e.lengthComputable){var n=e.loaded/e.total;r(n)}}),!1),a.responseType="arraybuffer",a.onerror=function(e){i(e)},a.onload=function(){if(/^4/.test(""+this.status))return i("XHR_ERROR");var e=a.response;if(e){var n=new Uint8Array(e);return c?void function(e,n,t){o&&"function"==typeof o.setBlobCache?o.setBlobCache(e,n,t):t("EINVAL")}(c,n,(function(){i(null,n)})):void i(void 0,n)}i("ENOENT")},a.send(null)};if(c)return function(e,n){o&&"function"==typeof o.getBlobCache?o.getBlobCache(e,n):n("EINVAL")}(c,(function(e,n){!e&&n?i(void 0,n):s()})),{cancel:function(){a&&a.abort&&a.abort()}};s()},t.dataURIToBlob=function(e){for(var n=atob(e.split(",")[1]),t=e.split(",")[0].split(":")[1].split(";")[0],r=new ArrayBuffer(n.length),o=new Uint8Array(r),a=0;a<n.length;a++)o[a]=n.charCodeAt(a);return new Blob([r],{type:t})},t.throttle=function(e,n){var r,o,a=0,i=function(t){r=setTimeout((function(){r=void 0;var t=+new Date-a;t<n?i(n-t):e.apply(null,o)}),t)},c=function(){a=+new Date,o=t.slice(arguments),r||i(n)};return c.clear=function(){clearTimeout(r),r=void 0},c},t.notAgainForAnother=function(e,n){if("function"!=typeof e||"number"!=typeof n)throw new Error("invalid inputs");var r=null;return function(){var o=+new Date;return r&&o<=r+n?n-(o-r):(r=o,e.apply(null,t.slice(arguments)),null)}},t.createRandomInteger=function(){return Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)},t.noop=function(){},t.once=function(e,n){return function(){e&&(e.apply(this,Array.prototype.slice.call(arguments)),e=n)}},t.blobToImage=function(e,n){var t=new FileReader;t.onloadend=function(){n(t.result)},t.readAsDataURL(e)},t.blobURLToImage=function(e,n){var t=new XMLHttpRequest;t.onload=function(){var e=new FileReader;e.onloadend=function(){n(e.result)},e.readAsDataURL(t.response)},t.open("GET",e),t.responseType="blob",t.send()},t.isObject=function(e){return"object"==typeof e&&"[object Object]"===Object.prototype.toString.call(e)},t.isCircular=function(e){try{return JSON.stringify(e),!1}catch(e){return!0}},t.extend=function(e,n){if(t.isObject(e)&&t.isObject(n))if(t.isCircular(n))console.log("Extend doesn't accept circular objects");else for(var r in n)t.isObject(n[r])?(e[r]=t.isObject(e[r])?e[r]:{},t.extend(e[r],n[r])):Array.isArray(n[r])?e[r]=n[r].slice():e[r]=n[r];else console.log("Extend only works with 2 objects")},t.isChecked=function(e){return!!e&&(void 0!==e.tagName?Boolean(e.checked):"function"==typeof e.prop&&Boolean(e.prop("checked")))},t.hexToRGB=function(e){var n=e.replace(/^#/,"");return[parseInt(n.slice(0,2),16),parseInt(n.slice(2,4),16),parseInt(n.slice(4,6),16)]},t.rgbToHex=function(e){return`#${e.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/).slice(1).map((e=>parseInt(e,10).toString(16).padStart(2,"0"))).join("")}`},t.isSmallScreen=function(){return n.innerHeight<800||n.innerWidth<800},t.stripTags=function(e){var n=document.createElement("div");return n.innerHTML=e,n.innerText},t.parseFilename=function(e){if(!e||!e.trim())return{};var n=/^(\.?.+?)(\.[^.]+)?$/.exec(e)||[];return{name:n[1],ext:n[2]}},t.isPlainTextFile=function(e,n){if(e&&0===e.indexOf("text/"))return!0;var r=t.parseFilename(n);return!(e||!n||r.ext)||("application/x-javascript"===e||"application/xml"===e)},t.isSpreadsheet=function(e,n){return e&&("application/vnd.oasis.opendocument.spreadsheet"===e||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"===e)||n&&(n.endsWith(".xlsx")||n.endsWith(".ods"))},t.isOfficeDoc=function(e,n){return e&&("application/vnd.oasis.opendocument.text"===e||"application/vnd.openxmlformats-officedocument.wordprocessingml.document"===e)||n&&(n.endsWith(".docx")||n.endsWith(".odt"))},t.isPresentation=function(e,n){return e&&("application/vnd.oasis.opendocument.presentation"===e||"application/vnd.openxmlformats-officedocument.presentationml.presentation"===e)||n&&(n.endsWith(".pptx")||n.endsWith(".odp"))},t.isValidURL=function(e){return!!new RegExp("^(https?:\\/\\/)((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?").test(e)};var a=/([\uD800-\uDBFF][\uDC00-\uDFFF])/;t.getFirstCharacter=function(e){if(!e||!e.trim())return"?";var n=function(e){for(var n=e.split(a),t=[],r=0;r<n.length;r++){var o=n[r];""!==o&&t.push(o)}return t}(e);return function(e){return a.test(e)}(n[0])?n[0]:e[0]},t.getRandomColor=function(e){var n=function(){return e?Math.floor(156*Math.random())+70:Math.floor(200*Math.random())+25};return"#"+n().toString(16)+n().toString(16)+n().toString(16)},t.checkRestrictedApp=function(e,n,t,r,o){if(Array.isArray(t)&&t.includes(e)&&!n.enableEarlyAccess)return-2;var a=n.premiumTypes;return Array.isArray(a)&&a.includes(e)?o?r?1:0:-1:2};return t.supportsWasm=function(){return!("undefined"==typeof Atomics||!function(){try{return"[object SharedArrayBuffer]"===Object.prototype.toString.call(new n.WebAssembly.Memory({shared:!0,initial:0,maximum:0}).buffer)}catch(e){console.error(e)}return!1}()||"undefined"==typeof WebAssembly)},t.getKeysArray=function(e){return[...Array(e).keys()]},t.getVersionFromUrlArgs=e=>{let n=/ver=([0-9.]+)(-[0-9]*)?/.exec(e);return Array.isArray(n)&&n[1]||void 0},t.Saferphore={create:e=>{var n,t=[];return n=function(){if(e<0)throw new Error("(resourceCount < 0) should never happen");var r;0!==e&&0!==t.length&&(e--,t.shift()((r=0,function(t){if(r++)throw new Error("returnAfter() called multiple times");var o=0;return function(){if(o++)throw new Error("returnAfter wrapped callback called multiple times");t&&t.apply(null,arguments),e++,n()}})))},{take:function(e){t.push(e),n()}}}},t};e.exports&&(e.exports=t(K()))}("undefined"!=typeof self?self:$)}(Z)),Z.exports}var ne,te,re={exports:{}};function oe(){return ne||(ne=1,function(e){e.exports&&(e.exports=function(){var e={},n=function(e){return e.replace(/-/g,"/")};return e.parseUser=function(e){var t,r,o,a=function(e){if(/^\[.*?@.*\]$/.test(e)){var t,r=e.slice(1,-1);if(r=r.replace(/\/([a-zA-Z0-9+-]{43}=)$/,(function(e,r){return t=n(r),""})),t){var o=r.lastIndexOf("@");if(!(o<1))return{domain:r.slice(o+1),user:r.slice(0,o),pubkey:t}}}}(e);if(function(e){if(e&&e.domain&&e.user&&e.pubkey)return!0}(a))return a;if(e.replace(/^https*:\/\/([^\/]+)\/user\/#\/1\/([^\/]+)\/([a-zA-Z0-9+-]{43}=)$/,(function(e,a,i,c){return t=a,r=i,o=n(c),""})),!t)throw new Error("Could not parse user id ["+e+"]");return{domain:t,user:r,pubkey:o}},e.serialize=function(e,n,t){return"["+n+"@"+e.replace(/https*:\/\//,"")+"/"+t.replace(/\//g,"-")+"]"},e.canonicalize=function(t){if("string"==typeof t){if(44===t.length)return n(t);try{return e.parseUser(t).pubkey}catch(e){return}}},e}())}(re)),re.exports}function ae(){return te||(te=1,function(e){!function(n){e.exports&&(e.exports=function(e,t,r){var o=n.CryptPad_Hash={},a=e.uint8ArrayToHex,i=e.hexToBase64,c=e.base64ToHex;o.encodeBase64=e.encodeBase64,o.decodeBase64=e.decodeBase64,o.hashChannelList=function(n){return e.encodeBase64(t.CryptoAgility.createHash(e.decodeUTF8(JSON.stringify(n))))},o.generateSignPair=function(){var e=t.CryptoAgility.signKeyPair(),n=function(e){return t.b64RemoveSlashes(e).replace(/=+$/g,"")};return{validateKey:o.encodeBase64(e.publicKey),signKey:o.encodeBase64(e.secretKey),safeValidateKey:n(o.encodeBase64(e.publicKey)),safeSignKey:n(o.encodeBase64(e.secretKey))}},o.getSignPublicFromPrivate=function(n){var r=t.b64AddSlashes(n),o=e.decodeBase64(r),a=t.CryptoAgility.signKeyPairFromSecretKey(o);return e.encodeBase64(a.publicKey)},o.getCurvePublicFromPrivate=function(n){var r=t.b64AddSlashes(n),o=e.decodeBase64(r),a=t.CryptoAgility.boxKeyPairFromSecretKey(o);return e.encodeBase64(a.publicKey)};var s=o.getEditHashFromKeys=function(e){var n=e.version,r=e.keys;if(0===n)return e.channel+e.key;if(1===n){if(!r.editKeyStr)return;return"/1/edit/"+i(e.channel)+"/"+t.b64RemoveSlashes(r.editKeyStr)+"/"}if(2===n){if(!r.editKeyStr)return;var o=e.password?"p/":"";return"/2/"+e.type+"/edit/"+t.b64RemoveSlashes(r.editKeyStr)+"/"+o}},u=o.getViewHashFromKeys=function(e){var n=e.version,r=e.keys;if(0!==n){if(1===n){if(!r.viewKeyStr)return;return"/1/view/"+i(e.channel)+"/"+t.b64RemoveSlashes(r.viewKeyStr)+"/"}if(2===n){if(!r.viewKeyStr)return;var o=e.password?"p/":"";return"/2/"+e.type+"/view/"+t.b64RemoveSlashes(r.viewKeyStr)+"/"+o}}};o.getHiddenHashFromKeys=function(e,n,t){t=t||{};var r=n.keys&&n.keys.editKeyStr||n.key,a=!t.view&&r?"edit/":"view/",i=n.password?"p/":"";n.keys&&n.keys.fileKeyStr&&(a="");var c="/3/"+e+"/"+a+n.channel+"/"+i,s=o.parseTypeHash(e,c);return s&&s.getHash?s.getHash(t||{}):c};var l=o.getFileHashFromKeys=function(e){var n=e.version,r=e.keys;if(0!==n){if(1===n)return"/1/"+i(e.channel)+"/"+t.b64RemoveSlashes(r.fileKeyStr)+"/";if(2===n){if(!r.fileKeyStr)return;var o=e.password?"p/":"";return"/2/"+e.type+"/"+t.b64RemoveSlashes(r.fileKeyStr)+"/"+o}}};o.getPublicSigningKeyString=r.serialize,o.ephemeralChannelLength=34,o.createChannelId=function(e){var n=a(t.CryptoAgility.bytes(e?17:16));if(-1===[32,34].indexOf(n.length)||/[^a-f0-9]/.test(n))throw new Error("channel ids must consist of 32 hex characters");return n},o.getChannelIdFromKey=function(e){if(e)return a(o.decodeBase64(e).subarray(0,16))},o.getBoxPublicFromSecret=function(e){if(e){var n=o.decodeBase64(e),r=t.CryptoAgility.boxKeyPairFromSecretKey(n);return o.encodeBase64(r.publicKey)}},o.checkBoxKeyPair=function(e,n){if(!n||!e)return!1;var r=o.decodeBase64(e),a=t.CryptoAgility.boxKeyPairFromSecretKey(r);return n===o.encodeBase64(a.publicKey)},o.createRandomHash=function(e,n){var r;return"file"===e?(r=t.createFileCryptor2(void 0,n),l({password:Boolean(n),version:2,type:e,keys:r})):(r=t.createEditCryptor2(void 0,void 0,n),s({password:Boolean(n),version:2,type:e,keys:r}))};var f=o.parseTypeHash=function(e,n){if(n){var r,o=[],a={},i=(r=n,r.replace(/\/+/g,"/")).split("/"),c=function(){a.password=-1!==o.indexOf("p"),a.present=-1!==o.indexOf("present"),a.embed=-1!==o.indexOf("embed"),a.versionHash=function(e){var n;return e.some((function(e){if(/^hash=/.test(e))return n=e.slice(5),!0})),n?t.b64AddSlashes(n):""}(o),a.auditorKey=function(e){var n;return e.some((function(e){if(/^auditor=/.test(e))return n=e.slice(8),!0})),n?t.b64AddSlashes(n):""}(o),a.newPadOpts=function(e){var n;return e.some((function(e){if(/^newpad=/.test(e))return n=e.slice(7),!0})),n||""}(o),a.loginOpts=function(e){var n;return e.some((function(e){if(/^login=/.test(e))return n=e.slice(6),!0})),n||""}(o),a.ownerKey=function(e){var n;return e.some((function(e){if(86===e.length)return n=e,!0})),n}(o)};return i[1]&&"4"===i[1]?(a.getHash=function(n){if(!n||!Object.keys(n).length)return"";var t="/4/"+e+"/";return n.newPadOpts&&(t+="newpad="+n.newPadOpts+"/"),n.loginOpts&&(t+="login="+n.loginOpts+"/"),t},a.getOptions=function(){var e={};return a.newPadOpts&&(e.newPadOpts=a.newPadOpts),a.loginOpts&&(e.loginOpts=a.loginOpts),e},a.version=4,a.app=i[2],o=i.slice(3),c(),a):-1===["media","file","user","invite"].indexOf(e)?(a.type="pad",a.getHash=function(){return n},a.getOptions=function(){return{embed:a.embed,present:a.present,ownerKey:a.ownerKey,versionHash:a.versionHash,auditorKey:a.auditorKey,newPadOpts:a.newPadOpts,loginOpts:a.loginOpts,password:a.password}},"/"!==n.slice(0,1)&&n.length>=56?(a.channel=n.slice(0,32),a.key=n.slice(32,56),a.version=0,a):(a.getHash=function(e){var n=i.slice(0,5).join("/")+"/",r=void 0!==e.ownerKey?e.ownerKey:a.ownerKey;r&&(n+=r+"/"),(a.password||e.password)&&(n+="p/"),e.embed&&(n+="embed/"),e.present&&(n+="present/");var o=void 0!==e.versionHash?e.versionHash:a.versionHash;o&&(n+="hash="+t.b64RemoveSlashes(o)+"/");var c=void 0!==e.auditorKey?e.auditorKey:a.auditorKey;return c&&(n+="auditor="+t.b64RemoveSlashes(c)+"/"),e.newPadOpts&&(n+="newpad="+e.newPadOpts+"/"),e.loginOpts&&(n+="login="+e.loginOpts+"/"),n},i[1]&&"1"===i[1]?(a.version=1,a.mode=i[2],a.channel=i[3],a.key=t.b64AddSlashes(i[4]),o=i.slice(5),c(),a):i[1]&&"2"===i[1]?(a.version=2,a.app=i[2],a.mode=i[3],a.key=i[4],o=i.slice(5),c(),a):i[1]&&"3"===i[1]?(a.version=3,a.app=i[2],a.mode=i[3],a.channel=i[4],o=i.slice(5),c(),a):a)):(a.getHash=function(){return i.join("/")},-1!==["media","file"].indexOf(e)?(a.type="file",a.getOptions=function(){return{embed:a.embed,present:a.present,ownerKey:a.ownerKey,newPadOpts:a.newPadOpts,loginOpts:a.loginOpts,password:a.password}},a.getHash=function(e){var n=i.slice(0,4).join("/")+"/",t=void 0!==e.ownerKey?e.ownerKey:a.ownerKey;return t&&(n+=t+"/"),(a.password||e.password)&&(n+="p/"),e.embed&&(n+="embed/"),e.present&&(n+="present/"),e.newPadOpts&&(n+="newpad="+e.newPadOpts+"/"),e.loginOpts&&(n+="login="+e.loginOpts+"/"),n},i[1]&&"1"===i[1]?(a.version=1,a.channel=i[2].replace(/-/g,"/"),a.key=i[3].replace(/-/g,"/"),o=i.slice(4),c(),a):i[1]&&"2"===i[1]?(a.version=2,a.app=i[2],a.key=i[3],o=i.slice(4),c(),a):i[1]&&"3"===i[1]?(a.version=3,a.app=i[2],a.channel=i[3],o=i.slice(4),c(),a):a):-1!==["user"].indexOf(e)?(a.type="user",i[1]&&"1"===i[1]?(a.version=1,a.user=i[2],a.pubkey=i[3].replace(/-/g,"/"),a):a):-1!==["invite"].indexOf(e)?(a.type="invite",i[1]&&"2"===i[1]?(a.version=2,a.app=i[2],a.mode=i[3],a.key=i[4],o=i.slice(5),a.password=-1!==o.indexOf("p"),a):a):void 0)}},d=o.parsePadUrl=function(e){var n,t={};return e?("/"!==e.slice(-1)&&"#"!==e.slice(-1)&&(e+="/"),e=e.replace(/\/\?[^#]+#/,"/#"),t.getUrl=function(e){e=e||{};var n="/";return t.type?(n+=t.type+"/",!t.hashData&&e&&Object.keys(e).length?n+"#"+function(e){if(!e||!Object.keys(e).length)return"";var n="/4/"+t.type+"/";return e.newPadOpts&&(n+="newpad="+e.newPadOpts+"/"),e.loginOpts&&(n+="login="+e.loginOpts+"/"),n}(e):t.hashData?n+="#"+t.hashData.getHash(e):n):n},t.getOptions=function(){return t.hashData&&t.hashData.getOptions?t.hashData.getOptions():{}},/^https*:\/\//.test(e)?(e.replace(/^https*:\/\/([^\/]*)\/(.*?)\//i,(function(e,n,r){return t.domain=n,t.type=r,""})),-1===(n=e.indexOf("/#"))||(t.hash=e.slice(n+2),t.hashData=f(t.type,t.hash)),t):/^\/($|[^\/])/.test(e)?(n=e.indexOf("/#"),t.type=e.slice(1,n),-1===n||(t.hash=e.slice(n+2),t.hashData=f(t.type,t.hash)),t):t):t};return o.hashToHref=function(e,n){return"/"+n+"/#"+e},o.hrefToHash=function(e){return o.parsePadUrl(e).hash},o.getRelativeHref=function(e){if(e&&-1!==e.indexOf("#")){var n=d(e);return"/"+n.type+"/#"+n.hash}},o.getSecrets=function(n,r,o){var a,i,s={},u=function(){s.keys=t.createEditCryptor2(void 0,void 0,o),s.channel=c(s.keys.chanId),s.version=2,s.type=n};if(!r)return u(),s;if(r){if(!n)throw new Error("getSecrets with a hash requires a type parameter");a=f(n,r),i=r}if(0===i.length)return u(),s;if(0===a.version)s.channel=a.channel,s.key=a.key,s.version=0;else if(1===a.version){if(s.version=1,"pad"===a.type){if(s.channel=c(a.channel),"edit"===a.mode){if(s.keys=t.createEditCryptor(a.key),s.key=s.keys.editKeyStr,32!==s.channel.length||24!==s.key.length)throw new Error("The channel key and/or the encryption key is invalid")}else if("view"===a.mode&&(s.keys=t.createViewCryptor(a.key),32!==s.channel.length))throw new Error("The channel key is invalid")}else if("file"===a.type)s.channel=c(a.channel),s.keys={fileKeyStr:a.key,cryptKey:e.decodeBase64(a.key)};else if("user"===a.type)throw new Error("User hashes can't be opened (yet)")}else if(2===a.version)if(s.version=2,s.type=n,s.password=o,"pad"===a.type){if("edit"===a.mode){if(s.keys=t.createEditCryptor2(a.key,void 0,o),s.channel=c(s.keys.chanId),s.key=s.keys.editKeyStr,32!==s.channel.length||24!==s.key.length)throw new Error("The channel key and/or the encryption key is invalid")}else if("view"===a.mode&&(s.keys=t.createViewCryptor2(a.key,o),s.channel=c(s.keys.chanId),32!==s.channel.length))throw new Error("The channel key is invalid")}else if("file"===a.type){if(s.keys=t.createFileCryptor2(a.key,o),s.channel=c(s.keys.chanId),s.key=s.keys.fileKeyStr,48!==s.channel.length||24!==s.key.length)throw new Error("The channel key and/or the encryption key is invalid")}else if("user"===a.type)throw new Error("User hashes can't be opened (yet)");return s},o.getHashes=function(e){var n={};return(e=JSON.parse(JSON.stringify(e))).keys||e.key?(e.keys||(e.keys={}),(e.keys.editKeyStr||0===e.version&&e.key)&&(n.editHash=s(e)),e.keys.viewKeyStr&&(n.viewHash=u(e)),e.keys.fileKeyStr&&(n.fileHash=l(e)),n):n},o.getFormData=function(n,r,a){var i=(n=n||o.getSecrets("form",r,a))&&n.keys,c=i&&i.secondaryKey;if(c){var s=t.CryptoAgility.boxKeyPairFromSecretKey(e.decodeUTF8(c).slice(0,32)),u={};u.form_public=e.encodeBase64(s.publicKey);var l=u.form_private=e.encodeBase64(s.secretKey),f=o.getViewHashFromKeys({version:1,channel:n.channel,keys:{viewKeyStr:e.encodeBase64(i.cryptKey)}}),d=o.parseTypeHash("pad",f);return u.form_auditorHash=d.getHash({auditorKey:l}),u}},o.hrefToHexChannelId=function(e,n){var t=o.parsePadUrl(e);if(t&&t.hash)return o.getSecrets(t.type,t.hash,n).channel},o.getBlobPathFromHex=function(e){return"/blob/"+e.slice(0,2)+"/"+e},o.serializeHash=function(e){return e&&"/"!==e.slice(-1)&&(e+="/"),e},o.createInviteUrl=function(e,t){return t=t||o.createChannelId(),n.location.origin+"/invite/#/1/"+t+"/"+e.replace(/\//g,"-")+"/"},o.isValidChannel=function(e){return/^[a-zA-Z0-9]{32,48}$/.test(e)},o.isValidHref=function(e){if(e){var n=o.parsePadUrl(e);if(n&&n.type){if(n.hash){if(!n.hashData)return;if(void 0===n.hashData.version)return;if("pad"===n.hashData.type||"file"===n.hashData.type){if(!n.hashData.key&&!n.hashData.channel)return;if(n.hashData.key&&!/^[a-zA-Z0-9+-/=]+$/.test(n.hashData.key))return}}return n}}},o.decodeDataOptions=function(n){var t=decodeURIComponent(n),r=e.encodeUTF8(e.decodeBase64(t));return e.tryParse(r)||{}},o.encodeDataOptions=function(n){var t=JSON.stringify(n),r=e.encodeBase64(e.decodeUTF8(t));return encodeURIComponent(r)},o.getNewPadURL=function(e,n){var t=o.parsePadUrl(e),r=t.getOptions();return r.newPadOpts=o.encodeDataOptions(n),t.getUrl(r)},o.getLoginURL=function(e,n){var t=o.parsePadUrl(e),r=t.getOptions();return r.loginOpts=o.encodeDataOptions(n),t.getUrl(r)},o}(ee(),K(),oe(),h()))}("undefined"!=typeof window?window:{})}(X)),X.exports}var ie,ce,se=ae(),ue=ee(),le={exports:{}},fe={exports:{}};function de(){return ie||(ie=1,function(e){e.exports=function e(n,t,r){function o(i,c){if(!t[i]){if(!n[i]){if(!c&&l)return l(i);if(a)return a(i,!0);var s=new Error("Cannot find module '"+i+"'");throw s.code="MODULE_NOT_FOUND",s}var u=t[i]={exports:{}};n[i][0].call(u.exports,(function(e){var t=n[i][1][e];return o(t||e)}),u,u.exports,e,n,t,r)}return t[i].exports}for(var a=l,i=0;i<r.length;i++)o(r[i]);return o}({1:[function(e,n,r){(function(e){var t,r,o=e.MutationObserver||e.WebKitMutationObserver;if(o){var a=0,i=new o(l),c=e.document.createTextNode("");i.observe(c,{characterData:!0}),t=function(){c.data=a=++a%2}}else if(e.setImmediate||void 0===e.MessageChannel)t="document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var n=e.document.createElement("script");n.onreadystatechange=function(){l(),n.onreadystatechange=null,n.parentNode.removeChild(n),n=null},e.document.documentElement.appendChild(n)}:function(){setTimeout(l,0)};else{var s=new e.MessageChannel;s.port1.onmessage=l,t=function(){s.port2.postMessage(0)}}var u=[];function l(){var e,n;r=!0;for(var t=u.length;t;){for(n=u,u=[],e=-1;++e<t;)n[e]();t=u.length}r=!1}function f(e){1!==u.push(e)||r||t()}n.exports=f}).call(this,void 0!==t?t:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(e,n,t){var r=e(1);function o(){}var a={},i=["REJECTED"],c=["FULFILLED"],s=["PENDING"];function u(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=s,this.queue=[],this.outcome=void 0,e!==o&&h(this,e)}function l(e,n,t){this.promise=e,"function"==typeof n&&(this.onFulfilled=n,this.callFulfilled=this.otherCallFulfilled),"function"==typeof t&&(this.onRejected=t,this.callRejected=this.otherCallRejected)}function f(e,n,t){r((function(){var r;try{r=n(t)}catch(n){return a.reject(e,n)}r===e?a.reject(e,new TypeError("Cannot resolve promise with itself")):a.resolve(e,r)}))}function d(e){var n=e&&e.then;if(e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof n)return function(){n.apply(e,arguments)}}function h(e,n){var t=!1;function r(n){t||(t=!0,a.reject(e,n))}function o(n){t||(t=!0,a.resolve(e,n))}function i(){n(o,r)}var c=p(i);"error"===c.status&&r(c.value)}function p(e,n){var t={};try{t.value=e(n),t.status="success"}catch(e){t.status="error",t.value=e}return t}function v(e){return e instanceof this?e:a.resolve(new this(o),e)}function y(e){var n=new this(o);return a.reject(n,e)}function m(e){var n=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var t=e.length,r=!1;if(!t)return this.resolve([]);for(var i=new Array(t),c=0,s=-1,u=new this(o);++s<t;)l(e[s],s);return u;function l(e,o){function s(e){i[o]=e,++c!==t||r||(r=!0,a.resolve(u,i))}n.resolve(e).then(s,(function(e){r||(r=!0,a.reject(u,e))}))}}function g(e){var n=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var t=e.length,r=!1;if(!t)return this.resolve([]);for(var i=-1,c=new this(o);++i<t;)s(e[i]);return c;function s(e){n.resolve(e).then((function(e){r||(r=!0,a.resolve(c,e))}),(function(e){r||(r=!0,a.reject(c,e))}))}}n.exports=u,u.prototype.catch=function(e){return this.then(null,e)},u.prototype.then=function(e,n){if("function"!=typeof e&&this.state===c||"function"!=typeof n&&this.state===i)return this;var t=new this.constructor(o);return this.state!==s?f(t,this.state===c?e:n,this.outcome):this.queue.push(new l(t,e,n)),t},l.prototype.callFulfilled=function(e){a.resolve(this.promise,e)},l.prototype.otherCallFulfilled=function(e){f(this.promise,this.onFulfilled,e)},l.prototype.callRejected=function(e){a.reject(this.promise,e)},l.prototype.otherCallRejected=function(e){f(this.promise,this.onRejected,e)},a.resolve=function(e,n){var t=p(d,n);if("error"===t.status)return a.reject(e,t.value);var r=t.value;if(r)h(e,r);else{e.state=c,e.outcome=n;for(var o=-1,i=e.queue.length;++o<i;)e.queue[o].callFulfilled(n)}return e},a.reject=function(e,n){e.state=i,e.outcome=n;for(var t=-1,r=e.queue.length;++t<r;)e.queue[t].callRejected(n);return e},u.resolve=v,u.reject=y,u.all=m,u.race=g},{1:1}],3:[function(e,n,r){(function(n){"function"!=typeof n.Promise&&(n.Promise=e(2))}).call(this,void 0!==t?t:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{2:2}],4:[function(e,n,t){var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function o(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function a(){try{if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof webkitIndexedDB)return webkitIndexedDB;if("undefined"!=typeof mozIndexedDB)return mozIndexedDB;if("undefined"!=typeof OIndexedDB)return OIndexedDB;if("undefined"!=typeof msIndexedDB)return msIndexedDB}catch(e){return}}var i=a();function c(){try{if(!i||!i.open)return!1;var e="undefined"!=typeof openDatabase&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),n="function"==typeof fetch&&-1!==fetch.toString().indexOf("[native code");return(!e||n)&&"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(e){return!1}}function s(e,n){e=e||[],n=n||{};try{return new Blob(e,n)}catch(o){if("TypeError"!==o.name)throw o;for(var t=new("undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder),r=0;r<e.length;r+=1)t.append(e[r]);return t.getBlob(n.type)}}"undefined"==typeof Promise&&e(3);var u=Promise;function l(e,n){n&&e.then((function(e){n(null,e)}),(function(e){n(e)}))}function f(e,n,t){"function"==typeof n&&e.then(n),"function"==typeof t&&e.catch(t)}function d(e){return"string"!=typeof e&&(console.warn(e+" used as a key, but it is not a string."),e=String(e)),e}function h(){if(arguments.length&&"function"==typeof arguments[arguments.length-1])return arguments[arguments.length-1]}var p="local-forage-detect-blob-support",v=void 0,y={},m=Object.prototype.toString,g="readonly",E="readwrite";function b(e){for(var n=e.length,t=new ArrayBuffer(n),r=new Uint8Array(t),o=0;o<n;o++)r[o]=e.charCodeAt(o);return t}function A(e){return new u((function(n){var t=e.transaction(p,E),r=s([""]);t.objectStore(p).put(r,"key"),t.onabort=function(e){e.preventDefault(),e.stopPropagation(),n(!1)},t.oncomplete=function(){var e=navigator.userAgent.match(/Chrome\/(\d+)/),t=navigator.userAgent.match(/Edge\//);n(t||!e||parseInt(e[1],10)>=43)}})).catch((function(){return!1}))}function _(e){return"boolean"==typeof v?u.resolve(v):A(e).then((function(e){return v=e}))}function w(e){var n=y[e.name],t={};t.promise=new u((function(e,n){t.resolve=e,t.reject=n})),n.deferredOperations.push(t),n.dbReady?n.dbReady=n.dbReady.then((function(){return t.promise})):n.dbReady=t.promise}function O(e){var n=y[e.name].deferredOperations.pop();if(n)return n.resolve(),n.promise}function D(e,n){var t=y[e.name].deferredOperations.pop();if(t)return t.reject(n),t.promise}function S(e,n){return new u((function(t,r){if(y[e.name]=y[e.name]||F(),e.db){if(!n)return t(e.db);w(e),e.db.close()}var o=[e.name];n&&o.push(e.version);var a=i.open.apply(i,o);n&&(a.onupgradeneeded=function(n){var t=a.result;try{t.createObjectStore(e.storeName),n.oldVersion<=1&&t.createObjectStore(p)}catch(t){if("ConstraintError"!==t.name)throw t;console.warn('The database "'+e.name+'" has been upgraded from version '+n.oldVersion+" to version "+n.newVersion+', but the storage "'+e.storeName+'" already exists.')}}),a.onerror=function(e){e.preventDefault(),r(a.error)},a.onsuccess=function(){var n=a.result;n.onversionchange=function(e){e.target.close()},t(n),O(e)}}))}function T(e){return S(e,!1)}function x(e){return S(e,!0)}function C(e,n){if(!e.db)return!0;var t=!e.db.objectStoreNames.contains(e.storeName),r=e.version<e.db.version,o=e.version>e.db.version;if(r&&(e.version!==n&&console.warn('The database "'+e.name+"\" can't be downgraded from version "+e.db.version+" to version "+e.version+"."),e.version=e.db.version),o||t){if(t){var a=e.db.version+1;a>e.version&&(e.version=a)}return!0}return!1}function N(e){return new u((function(n,t){var r=new FileReader;r.onerror=t,r.onloadend=function(t){var r=btoa(t.target.result||"");n({__local_forage_encoded_blob:!0,data:r,type:e.type})},r.readAsBinaryString(e)}))}function I(e){return s([b(atob(e.data))],{type:e.type})}function R(e){return e&&e.__local_forage_encoded_blob}function P(e){var n=this,t=n._initReady().then((function(){var e=y[n._dbInfo.name];if(e&&e.dbReady)return e.dbReady}));return f(t,e,e),t}function k(e){w(e);for(var n=y[e.name],t=n.forages,r=0;r<t.length;r++){var o=t[r];o._dbInfo.db&&(o._dbInfo.db.close(),o._dbInfo.db=null)}return e.db=null,T(e).then((function(n){return e.db=n,C(e)?x(e):n})).then((function(r){e.db=n.db=r;for(var o=0;o<t.length;o++)t[o]._dbInfo.db=r})).catch((function(n){throw D(e,n),n}))}function M(e,n,t,r){void 0===r&&(r=1);try{var o=e.db.transaction(e.storeName,n);t(null,o)}catch(o){if(r>0&&(!e.db||"InvalidStateError"===o.name||"NotFoundError"===o.name))return u.resolve().then((function(){if(!e.db||"NotFoundError"===o.name&&!e.db.objectStoreNames.contains(e.storeName)&&e.version<=e.db.version)return e.db&&(e.version=e.db.version+1),x(e)})).then((function(){return k(e).then((function(){M(e,n,t,r-1)}))})).catch(t);t(o)}}function F(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function L(e){var n=this,t={db:null};if(e)for(var r in e)t[r]=e[r];var o=y[t.name];o||(o=F(),y[t.name]=o),o.forages.push(n),n._initReady||(n._initReady=n.ready,n.ready=P);var a=[];function i(){return u.resolve()}for(var c=0;c<o.forages.length;c++){var s=o.forages[c];s!==n&&a.push(s._initReady().catch(i))}var l=o.forages.slice(0);return u.all(a).then((function(){return t.db=o.db,T(t)})).then((function(e){return t.db=e,C(t,n._defaultConfig.version)?x(t):e})).then((function(e){t.db=o.db=e,n._dbInfo=t;for(var r=0;r<l.length;r++){var a=l[r];a!==n&&(a._dbInfo.db=t.db,a._dbInfo.version=t.version)}}))}function K(e,n){var t=this;e=d(e);var r=new u((function(n,r){t.ready().then((function(){M(t._dbInfo,g,(function(o,a){if(o)return r(o);try{var i=a.objectStore(t._dbInfo.storeName).get(e);i.onsuccess=function(){var e=i.result;void 0===e&&(e=null),R(e)&&(e=I(e)),n(e)},i.onerror=function(){r(i.error)}}catch(e){r(e)}}))})).catch(r)}));return l(r,n),r}function H(e,n){var t=this,r=new u((function(n,r){t.ready().then((function(){M(t._dbInfo,g,(function(o,a){if(o)return r(o);try{var i=a.objectStore(t._dbInfo.storeName).openCursor(),c=1;i.onsuccess=function(){var t=i.result;if(t){var r=t.value;R(r)&&(r=I(r));var o=e(r,t.key,c++);void 0!==o?n(o):t.continue()}else n()},i.onerror=function(){r(i.error)}}catch(e){r(e)}}))})).catch(r)}));return l(r,n),r}function j(e,n,t){var r=this;e=d(e);var o=new u((function(t,o){var a;r.ready().then((function(){return a=r._dbInfo,"[object Blob]"===m.call(n)?_(a.db).then((function(e){return e?n:N(n)})):n})).then((function(n){M(r._dbInfo,E,(function(a,i){if(a)return o(a);try{var c=i.objectStore(r._dbInfo.storeName);null===n&&(n=void 0);var s=c.put(n,e);i.oncomplete=function(){void 0===n&&(n=null),t(n)},i.onabort=i.onerror=function(){var e=s.error?s.error:s.transaction.error;o(e)}}catch(e){o(e)}}))})).catch(o)}));return l(o,t),o}function U(e,n){var t=this;e=d(e);var r=new u((function(n,r){t.ready().then((function(){M(t._dbInfo,E,(function(o,a){if(o)return r(o);try{var i=a.objectStore(t._dbInfo.storeName).delete(e);a.oncomplete=function(){n()},a.onerror=function(){r(i.error)},a.onabort=function(){var e=i.error?i.error:i.transaction.error;r(e)}}catch(e){r(e)}}))})).catch(r)}));return l(r,n),r}function B(e){var n=this,t=new u((function(e,t){n.ready().then((function(){M(n._dbInfo,E,(function(r,o){if(r)return t(r);try{var a=o.objectStore(n._dbInfo.storeName).clear();o.oncomplete=function(){e()},o.onabort=o.onerror=function(){var e=a.error?a.error:a.transaction.error;t(e)}}catch(e){t(e)}}))})).catch(t)}));return l(t,e),t}function V(e){var n=this,t=new u((function(e,t){n.ready().then((function(){M(n._dbInfo,g,(function(r,o){if(r)return t(r);try{var a=o.objectStore(n._dbInfo.storeName).count();a.onsuccess=function(){e(a.result)},a.onerror=function(){t(a.error)}}catch(e){t(e)}}))})).catch(t)}));return l(t,e),t}function Y(e,n){var t=this,r=new u((function(n,r){e<0?n(null):t.ready().then((function(){M(t._dbInfo,g,(function(o,a){if(o)return r(o);try{var i=a.objectStore(t._dbInfo.storeName),c=!1,s=i.openKeyCursor();s.onsuccess=function(){var t=s.result;t?0===e||c?n(t.key):(c=!0,t.advance(e)):n(null)},s.onerror=function(){r(s.error)}}catch(e){r(e)}}))})).catch(r)}));return l(r,n),r}function G(e){var n=this,t=new u((function(e,t){n.ready().then((function(){M(n._dbInfo,g,(function(r,o){if(r)return t(r);try{var a=o.objectStore(n._dbInfo.storeName).openKeyCursor(),i=[];a.onsuccess=function(){var n=a.result;n?(i.push(n.key),n.continue()):e(i)},a.onerror=function(){t(a.error)}}catch(e){t(e)}}))})).catch(t)}));return l(t,e),t}function J(e,n){n=h.apply(this,arguments);var t=this.config();(e="function"!=typeof e&&e||{}).name||(e.name=e.name||t.name,e.storeName=e.storeName||t.storeName);var r,o=this;if(e.name){var a=e.name===t.name&&o._dbInfo.db?u.resolve(o._dbInfo.db):T(e).then((function(n){var t=y[e.name],r=t.forages;t.db=n;for(var o=0;o<r.length;o++)r[o]._dbInfo.db=n;return n}));r=e.storeName?a.then((function(n){if(n.objectStoreNames.contains(e.storeName)){var t=n.version+1;w(e);var r=y[e.name],o=r.forages;n.close();for(var a=0;a<o.length;a++){var c=o[a];c._dbInfo.db=null,c._dbInfo.version=t}var s=new u((function(n,r){var o=i.open(e.name,t);o.onerror=function(e){o.result.close(),r(e)},o.onupgradeneeded=function(){o.result.deleteObjectStore(e.storeName)},o.onsuccess=function(){var e=o.result;e.close(),n(e)}}));return s.then((function(e){r.db=e;for(var n=0;n<o.length;n++){var t=o[n];t._dbInfo.db=e,O(t._dbInfo)}})).catch((function(n){throw(D(e,n)||u.resolve()).catch((function(){})),n}))}})):a.then((function(n){w(e);var t=y[e.name],r=t.forages;n.close();for(var o=0;o<r.length;o++)r[o]._dbInfo.db=null;var a=new u((function(n,t){var r=i.deleteDatabase(e.name);r.onerror=function(){var e=r.result;e&&e.close(),t(r.error)},r.onblocked=function(){console.warn('dropInstance blocked for database "'+e.name+'" until all open connections are closed')},r.onsuccess=function(){var e=r.result;e&&e.close(),n(e)}}));return a.then((function(e){t.db=e;for(var n=0;n<r.length;n++)O(r[n]._dbInfo)})).catch((function(n){throw(D(e,n)||u.resolve()).catch((function(){})),n}))}))}else r=u.reject("Invalid arguments");return l(r,n),r}var q={_driver:"asyncStorage",_initStorage:L,_support:c(),iterate:H,getItem:K,setItem:j,removeItem:U,clear:B,length:V,key:Y,keys:G,dropInstance:J};function W(){return"function"==typeof openDatabase}var z="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Q="~~local_forage_type~",X=/^~~local_forage_type~([^~]+)~/,Z="__lfsc__:",$=Z.length,ee="arbf",ne="blob",te="si08",re="ui08",oe="uic8",ae="si16",ie="si32",ce="ur16",se="ui32",ue="fl32",le="fl64",fe=$+ee.length,de=Object.prototype.toString;function he(e){var n,t,r,o,a,i=.75*e.length,c=e.length,s=0;"="===e[e.length-1]&&(i--,"="===e[e.length-2]&&i--);var u=new ArrayBuffer(i),l=new Uint8Array(u);for(n=0;n<c;n+=4)t=z.indexOf(e[n]),r=z.indexOf(e[n+1]),o=z.indexOf(e[n+2]),a=z.indexOf(e[n+3]),l[s++]=t<<2|r>>4,l[s++]=(15&r)<<4|o>>2,l[s++]=(3&o)<<6|63&a;return u}function pe(e){var n,t=new Uint8Array(e),r="";for(n=0;n<t.length;n+=3)r+=z[t[n]>>2],r+=z[(3&t[n])<<4|t[n+1]>>4],r+=z[(15&t[n+1])<<2|t[n+2]>>6],r+=z[63&t[n+2]];return t.length%3==2?r=r.substring(0,r.length-1)+"=":t.length%3==1&&(r=r.substring(0,r.length-2)+"=="),r}function ve(e,n){var t="";if(e&&(t=de.call(e)),e&&("[object ArrayBuffer]"===t||e.buffer&&"[object ArrayBuffer]"===de.call(e.buffer))){var r,o=Z;e instanceof ArrayBuffer?(r=e,o+=ee):(r=e.buffer,"[object Int8Array]"===t?o+=te:"[object Uint8Array]"===t?o+=re:"[object Uint8ClampedArray]"===t?o+=oe:"[object Int16Array]"===t?o+=ae:"[object Uint16Array]"===t?o+=ce:"[object Int32Array]"===t?o+=ie:"[object Uint32Array]"===t?o+=se:"[object Float32Array]"===t?o+=ue:"[object Float64Array]"===t?o+=le:n(new Error("Failed to get type for BinaryArray"))),n(o+pe(r))}else if("[object Blob]"===t){var a=new FileReader;a.onload=function(){var t=Q+e.type+"~"+pe(this.result);n(Z+ne+t)},a.readAsArrayBuffer(e)}else try{n(JSON.stringify(e))}catch(t){console.error("Couldn't convert value into a JSON string: ",e),n(null,t)}}function ye(e){if(e.substring(0,$)!==Z)return JSON.parse(e);var n,t=e.substring(fe),r=e.substring($,fe);if(r===ne&&X.test(t)){var o=t.match(X);n=o[1],t=t.substring(o[0].length)}var a=he(t);switch(r){case ee:return a;case ne:return s([a],{type:n});case te:return new Int8Array(a);case re:return new Uint8Array(a);case oe:return new Uint8ClampedArray(a);case ae:return new Int16Array(a);case ce:return new Uint16Array(a);case ie:return new Int32Array(a);case se:return new Uint32Array(a);case ue:return new Float32Array(a);case le:return new Float64Array(a);default:throw new Error("Unkown type: "+r)}}var me={serialize:ve,deserialize:ye,stringToBuffer:he,bufferToString:pe};function ge(e,n,t,r){e.executeSql("CREATE TABLE IF NOT EXISTS "+n.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],t,r)}function Ee(e){var n=this,t={db:null};if(e)for(var r in e)t[r]="string"!=typeof e[r]?e[r].toString():e[r];var o=new u((function(e,r){try{t.db=openDatabase(t.name,String(t.version),t.description,t.size)}catch(e){return r(e)}t.db.transaction((function(o){ge(o,t,(function(){n._dbInfo=t,e()}),(function(e,n){r(n)}))}),r)}));return t.serializer=me,o}function be(e,n,t,r,o,a){e.executeSql(t,r,o,(function(e,i){i.code===i.SYNTAX_ERR?e.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[n.storeName],(function(e,c){c.rows.length?a(e,i):ge(e,n,(function(){e.executeSql(t,r,o,a)}),a)}),a):a(e,i)}),a)}function Ae(e,n){var t=this;e=d(e);var r=new u((function(n,r){t.ready().then((function(){var o=t._dbInfo;o.db.transaction((function(t){be(t,o,"SELECT * FROM "+o.storeName+" WHERE key = ? LIMIT 1",[e],(function(e,t){var r=t.rows.length?t.rows.item(0).value:null;r&&(r=o.serializer.deserialize(r)),n(r)}),(function(e,n){r(n)}))}))})).catch(r)}));return l(r,n),r}function _e(e,n){var t=this,r=new u((function(n,r){t.ready().then((function(){var o=t._dbInfo;o.db.transaction((function(t){be(t,o,"SELECT * FROM "+o.storeName,[],(function(t,r){for(var a=r.rows,i=a.length,c=0;c<i;c++){var s=a.item(c),u=s.value;if(u&&(u=o.serializer.deserialize(u)),void 0!==(u=e(u,s.key,c+1)))return void n(u)}n()}),(function(e,n){r(n)}))}))})).catch(r)}));return l(r,n),r}function we(e,n,t,r){var o=this;e=d(e);var a=new u((function(a,i){o.ready().then((function(){void 0===n&&(n=null);var c=n,s=o._dbInfo;s.serializer.serialize(n,(function(n,u){u?i(u):s.db.transaction((function(t){be(t,s,"INSERT OR REPLACE INTO "+s.storeName+" (key, value) VALUES (?, ?)",[e,n],(function(){a(c)}),(function(e,n){i(n)}))}),(function(n){if(n.code===n.QUOTA_ERR){if(r>0)return void a(we.apply(o,[e,c,t,r-1]));i(n)}}))}))})).catch(i)}));return l(a,t),a}function Oe(e,n,t){return we.apply(this,[e,n,t,1])}function De(e,n){var t=this;e=d(e);var r=new u((function(n,r){t.ready().then((function(){var o=t._dbInfo;o.db.transaction((function(t){be(t,o,"DELETE FROM "+o.storeName+" WHERE key = ?",[e],(function(){n()}),(function(e,n){r(n)}))}))})).catch(r)}));return l(r,n),r}function Se(e){var n=this,t=new u((function(e,t){n.ready().then((function(){var r=n._dbInfo;r.db.transaction((function(n){be(n,r,"DELETE FROM "+r.storeName,[],(function(){e()}),(function(e,n){t(n)}))}))})).catch(t)}));return l(t,e),t}function Te(e){var n=this,t=new u((function(e,t){n.ready().then((function(){var r=n._dbInfo;r.db.transaction((function(n){be(n,r,"SELECT COUNT(key) as c FROM "+r.storeName,[],(function(n,t){var r=t.rows.item(0).c;e(r)}),(function(e,n){t(n)}))}))})).catch(t)}));return l(t,e),t}function xe(e,n){var t=this,r=new u((function(n,r){t.ready().then((function(){var o=t._dbInfo;o.db.transaction((function(t){be(t,o,"SELECT key FROM "+o.storeName+" WHERE id = ? LIMIT 1",[e+1],(function(e,t){var r=t.rows.length?t.rows.item(0).key:null;n(r)}),(function(e,n){r(n)}))}))})).catch(r)}));return l(r,n),r}function Ce(e){var n=this,t=new u((function(e,t){n.ready().then((function(){var r=n._dbInfo;r.db.transaction((function(n){be(n,r,"SELECT key FROM "+r.storeName,[],(function(n,t){for(var r=[],o=0;o<t.rows.length;o++)r.push(t.rows.item(o).key);e(r)}),(function(e,n){t(n)}))}))})).catch(t)}));return l(t,e),t}function Ne(e){return new u((function(n,t){e.transaction((function(r){r.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],(function(t,r){for(var o=[],a=0;a<r.rows.length;a++)o.push(r.rows.item(a).name);n({db:e,storeNames:o})}),(function(e,n){t(n)}))}),(function(e){t(e)}))}))}function Ie(e,n){n=h.apply(this,arguments);var t=this.config();(e="function"!=typeof e&&e||{}).name||(e.name=e.name||t.name,e.storeName=e.storeName||t.storeName);var r,o=this;return l(r=e.name?new u((function(n){var r;r=e.name===t.name?o._dbInfo.db:openDatabase(e.name,"","",0),e.storeName?n({db:r,storeNames:[e.storeName]}):n(Ne(r))})).then((function(e){return new u((function(n,t){e.db.transaction((function(r){function o(e){return new u((function(n,t){r.executeSql("DROP TABLE IF EXISTS "+e,[],(function(){n()}),(function(e,n){t(n)}))}))}for(var a=[],i=0,c=e.storeNames.length;i<c;i++)a.push(o(e.storeNames[i]));u.all(a).then((function(){n()})).catch((function(e){t(e)}))}),(function(e){t(e)}))}))})):u.reject("Invalid arguments"),n),r}var Re={_driver:"webSQLStorage",_initStorage:Ee,_support:W(),iterate:_e,getItem:Ae,setItem:Oe,removeItem:De,clear:Se,length:Te,key:xe,keys:Ce,dropInstance:Ie};function Pe(){try{return"undefined"!=typeof localStorage&&"setItem"in localStorage&&!!localStorage.setItem}catch(e){return!1}}function ke(e,n){var t=e.name+"/";return e.storeName!==n.storeName&&(t+=e.storeName+"/"),t}function Me(){var e="_localforage_support_test";try{return localStorage.setItem(e,!0),localStorage.removeItem(e),!1}catch(e){return!0}}function Fe(){return!Me()||localStorage.length>0}function Le(e){var n=this,t={};if(e)for(var r in e)t[r]=e[r];return t.keyPrefix=ke(e,n._defaultConfig),Fe()?(n._dbInfo=t,t.serializer=me,u.resolve()):u.reject()}function Ke(e){var n=this,t=n.ready().then((function(){for(var e=n._dbInfo.keyPrefix,t=localStorage.length-1;t>=0;t--){var r=localStorage.key(t);0===r.indexOf(e)&&localStorage.removeItem(r)}}));return l(t,e),t}function He(e,n){var t=this;e=d(e);var r=t.ready().then((function(){var n=t._dbInfo,r=localStorage.getItem(n.keyPrefix+e);return r&&(r=n.serializer.deserialize(r)),r}));return l(r,n),r}function je(e,n){var t=this,r=t.ready().then((function(){for(var n=t._dbInfo,r=n.keyPrefix,o=r.length,a=localStorage.length,i=1,c=0;c<a;c++){var s=localStorage.key(c);if(0===s.indexOf(r)){var u=localStorage.getItem(s);if(u&&(u=n.serializer.deserialize(u)),void 0!==(u=e(u,s.substring(o),i++)))return u}}}));return l(r,n),r}function Ue(e,n){var t=this,r=t.ready().then((function(){var n,r=t._dbInfo;try{n=localStorage.key(e)}catch(e){n=null}return n&&(n=n.substring(r.keyPrefix.length)),n}));return l(r,n),r}function Be(e){var n=this,t=n.ready().then((function(){for(var e=n._dbInfo,t=localStorage.length,r=[],o=0;o<t;o++){var a=localStorage.key(o);0===a.indexOf(e.keyPrefix)&&r.push(a.substring(e.keyPrefix.length))}return r}));return l(t,e),t}function Ve(e){var n=this.keys().then((function(e){return e.length}));return l(n,e),n}function Ye(e,n){var t=this;e=d(e);var r=t.ready().then((function(){var n=t._dbInfo;localStorage.removeItem(n.keyPrefix+e)}));return l(r,n),r}function Ge(e,n,t){var r=this;e=d(e);var o=r.ready().then((function(){void 0===n&&(n=null);var t=n;return new u((function(o,a){var i=r._dbInfo;i.serializer.serialize(n,(function(n,r){if(r)a(r);else try{localStorage.setItem(i.keyPrefix+e,n),o(t)}catch(e){"QuotaExceededError"!==e.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==e.name||a(e),a(e)}}))}))}));return l(o,t),o}function Je(e,n){if(n=h.apply(this,arguments),!(e="function"!=typeof e&&e||{}).name){var t=this.config();e.name=e.name||t.name,e.storeName=e.storeName||t.storeName}var r,o=this;return r=e.name?new u((function(n){e.storeName?n(ke(e,o._defaultConfig)):n(e.name+"/")})).then((function(e){for(var n=localStorage.length-1;n>=0;n--){var t=localStorage.key(n);0===t.indexOf(e)&&localStorage.removeItem(t)}})):u.reject("Invalid arguments"),l(r,n),r}var qe={_driver:"localStorageWrapper",_initStorage:Le,_support:Pe(),iterate:je,getItem:He,setItem:Ge,removeItem:Ye,clear:Ke,length:Ve,key:Ue,keys:Be,dropInstance:Je},We=function(e,n){return e===n||"number"==typeof e&&"number"==typeof n&&isNaN(e)&&isNaN(n)},ze=function(e,n){for(var t=e.length,r=0;r<t;){if(We(e[r],n))return!0;r++}return!1},Qe=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},Xe={},Ze={},$e={INDEXEDDB:q,WEBSQL:Re,LOCALSTORAGE:qe},en=[$e.INDEXEDDB._driver,$e.WEBSQL._driver,$e.LOCALSTORAGE._driver],nn=["dropInstance"],tn=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(nn),rn={description:"",driver:en.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function on(e,n){e[n]=function(){var t=arguments;return e.ready().then((function(){return e[n].apply(e,t)}))}}function an(){for(var e=1;e<arguments.length;e++){var n=arguments[e];if(n)for(var t in n)n.hasOwnProperty(t)&&(Qe(n[t])?arguments[0][t]=n[t].slice():arguments[0][t]=n[t])}return arguments[0]}var cn=function(){function e(n){for(var t in o(this,e),$e)if($e.hasOwnProperty(t)){var r=$e[t],a=r._driver;this[t]=a,Xe[a]||this.defineDriver(r)}this._defaultConfig=an({},rn),this._config=an({},this._defaultConfig,n),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch((function(){}))}return e.prototype.config=function(e){if("object"===(void 0===e?"undefined":r(e))){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var n in e){if("storeName"===n&&(e[n]=e[n].replace(/\W/g,"_")),"version"===n&&"number"!=typeof e[n])return new Error("Database version must be a number.");this._config[n]=e[n]}return!("driver"in e)||!e.driver||this.setDriver(this._config.driver)}return"string"==typeof e?this._config[e]:this._config},e.prototype.defineDriver=function(e,n,t){var r=new u((function(n,t){try{var r=e._driver,o=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!e._driver)return void t(o);for(var a=tn.concat("_initStorage"),i=0,c=a.length;i<c;i++){var s=a[i];if((!ze(nn,s)||e[s])&&"function"!=typeof e[s])return void t(o)}var f=function(){for(var n=function(e){return function(){var n=new Error("Method "+e+" is not implemented by the current driver"),t=u.reject(n);return l(t,arguments[arguments.length-1]),t}},t=0,r=nn.length;t<r;t++){var o=nn[t];e[o]||(e[o]=n(o))}};f();var d=function(t){Xe[r]&&console.info("Redefining LocalForage driver: "+r),Xe[r]=e,Ze[r]=t,n()};"_support"in e?e._support&&"function"==typeof e._support?e._support().then(d,t):d(!!e._support):d(!0)}catch(e){t(e)}}));return f(r,n,t),r},e.prototype.driver=function(){return this._driver||null},e.prototype.getDriver=function(e,n,t){var r=Xe[e]?u.resolve(Xe[e]):u.reject(new Error("Driver not found."));return f(r,n,t),r},e.prototype.getSerializer=function(e){var n=u.resolve(me);return f(n,e),n},e.prototype.ready=function(e){var n=this,t=n._driverSet.then((function(){return null===n._ready&&(n._ready=n._initDriver()),n._ready}));return f(t,e,e),t},e.prototype.setDriver=function(e,n,t){var r=this;Qe(e)||(e=[e]);var o=this._getSupportedDrivers(e);function a(){r._config.driver=r.driver()}function i(e){return r._extend(e),a(),r._ready=r._initStorage(r._config),r._ready}function c(e){return function(){var n=0;function t(){for(;n<e.length;){var o=e[n];return n++,r._dbInfo=null,r._ready=null,r.getDriver(o).then(i).catch(t)}a();var c=new Error("No available storage method found.");return r._driverSet=u.reject(c),r._driverSet}return t()}}var s=null!==this._driverSet?this._driverSet.catch((function(){return u.resolve()})):u.resolve();return this._driverSet=s.then((function(){var e=o[0];return r._dbInfo=null,r._ready=null,r.getDriver(e).then((function(e){r._driver=e._driver,a(),r._wrapLibraryMethodsWithReady(),r._initDriver=c(o)}))})).catch((function(){a();var e=new Error("No available storage method found.");return r._driverSet=u.reject(e),r._driverSet})),f(this._driverSet,n,t),this._driverSet},e.prototype.supports=function(e){return!!Ze[e]},e.prototype._extend=function(e){an(this,e)},e.prototype._getSupportedDrivers=function(e){for(var n=[],t=0,r=e.length;t<r;t++){var o=e[t];this.supports(o)&&n.push(o)}return n},e.prototype._wrapLibraryMethodsWithReady=function(){for(var e=0,n=tn.length;e<n;e++)on(this,tn[e])},e.prototype.createInstance=function(n){return new e(n)},e}(),sn=new cn;n.exports=sn},{3:3}]},{},[4])(4)}(fe)),fe.exports}function he(){return ce||(ce=1,function(e){(()=>{const n=(e,n)=>{let t=globalThis,r=globalThis;var o=t.CryptPad_Cache={},a=e.mkEvent(!0),i=!1,c=!1,s=!1;try{var u=t.indexedDB.open("test_db",1);u.onsuccess=function(){i=(s=!0)&&!c,a.fire()},u.onerror=function(){a.fire()}}catch(e){a.fire()}o.enable=function(){c=!1,i=s&&!c},o.disable=function(){c=!0,i=s&&!c},o.isEnabled=()=>i;var l=n.createInstance({driver:n.INDEXEDDB,name:"cp_cache"});o.getBlobCache=function(n,t){t=e.once(e.mkAsync(t||function(){})),a.reg((function(){i?l.getItem(n,(function(r,o){!r&&o&&o.c?(t(null,o.c),o.t=+new Date,l.setItem(n,o,(function(e){e&&console.error(e)}))):t(e.serializeError(r||"EINVAL"))})):t("NOCACHE")}))},o.setBlobCache=function(n,t,r){r=e.once(e.mkAsync(r||function(){})),a.reg((function(){i?t?l.setItem(n,{c:t,t:+new Date},(function(n){r(e.serializeError(n))})):r("EINVAL"):r("NOCACHE")}))},o.getChannelCache=function(n,t){t=e.once(e.mkAsync(t||function(){})),a.reg((function(){i?l.getItem(n,(function(r,o){!r&&o&&Array.isArray(o.c)?(t(null,o),o.t=+new Date,l.setItem(n,o,(function(e){e&&console.error(e)}))):t(e.serializeError(r||"EINVAL"))})):t("NOCACHE")}))};var f={};return o.storeCache=function(n,t,r,o){o=e.once(e.mkAsync(o||function(){})),a.reg((function(){f[n]=f[n]||e.throttle((function(t,r,o){var a,c;i?Array.isArray(r)&&t?(a=r,Array.isArray(a)&&(a.length>100&&a.splice(0,a.length-100),a.some((function(e,n){if(e.isCheckpoint)return c=n,!0})),a.splice(0,c)),l.setItem(n,{k:t,c:r,t:+new Date},(function(n){n&&o(e.serializeError(n))}))):o("EINVAL"):o("NOCACHE")}),50),f[n](t,r,o)}))},o.leaveChannel=function(e){delete f[e]},o.clearChannel=function(n,t){t=e.once(e.mkAsync(t||function(){})),a.reg((function(){i?l.removeItem(n,(function(){t()})):t("NOCACHE")}))},o.clear=function(n){n=e.once(e.mkAsync(n||function(){})),a.reg((function(){i?l.clear(n):n("NOCACHE")}))},o.getKeys=function(n){n=e.once(e.mkAsync(n||function(){})),a.reg((function(){i?l.keys().then((function(e){n(null,e)})).catch((function(e){n(e)})):n("NOCACHE")}))},o.getTime=function(n,t){t=e.once(e.mkAsync(t||function(){})),a.reg((function(){i?l.getItem(n,(function(n,r){!n&&r&&r.c?t(null,r.t):t(e.serializeError(n||"EINVAL"))})):t("NOCACHE")}))},r.CryptPad_clearIndexedDB=o.clear,o};e.exports&&(e.exports=n(ee(),de()))})()}(le)),le.exports}var pe=he(),ve=n({__proto__:null,default:r(pe)},[pe]);const ye=ue.mkEvent(!0),me=ue.mkEvent(!0),ge=ue.mkEvent(),Ee=ue.mkEvent();let be={};const Ae={setCustomize:e=>{be=e.ApiConfig},init:e=>{var n,t;const{broadcast:r,userHash:o,anonHash:a}=e,i=o||a||se.createRandomHash("drive"),c=e.store,s=se.getSecrets("drive",i),u={data:{},websocketURL:Y.getWebsocketURL(),network:null===(n=e.store)||void 0===n?void 0:n.network,channel:s.channel,readOnly:!1,validateKey:(null===(t=s.keys)||void 0===t?void 0:t.validateKey)||void 0,crypto:j.createEncryptor(s.keys),Cache:ve,userName:"fs",logLevel:1,ChainPad:k,updateProgress:function(e){e.type="drive",r([],"LOADING_DRIVE",e)},classic:!0},l=globalThis.CP_account_rt=x.create(u);c.driveSecret=s,c.proxy=l.proxy,c.onRpcReadyEvt=ue.mkEvent(!0),c.loggedIn=void 0!==e.userHash;const f={loggedIn:c.loggedIn};return l.proxy.on("create",(function(e){c.realtime=e.realtime,c.network=e.network,c.loggedIn||(f.anonHash=se.getEditHashFromKeys(s))})).on("cacheready",(function(n){if(c.realtime=n.realtime,c.offline=!0,c.networkPromise=n.networkPromise,c.cacheReturned=f,c.networkPromise&&c.networkPromise.then){const e=setTimeout((function(){c.networkTimeout=!0,r([],"LOADING_DRIVE",{type:"offline"})}),5e3);c.networkPromise.then((function(n){c.network||(c.network=n),clearTimeout(e)}),(function(n){console.error(n),clearTimeout(e)}))}e.cache&&(f.edPublic=l.proxy.edPublic,ye.fire(f))})).on("ready",(function(n){delete c.networkTimeout,c.ready||(c.driveMetadata=n.metadata,l.proxy.drive||(l.proxy.drive={}),!l.proxy[z.displayNameKey]&&c.noDriveName&&(l.proxy[z.displayNameKey]=c.noDriveName),!l.proxy.uid&&c.noDriveUid&&(l.proxy.uid=c.noDriveUid),!l.proxy.form_seed&&e.form_seed&&(l.proxy.form_seed=e.form_seed),l.proxy.edPublic&&Array.isArray(be.adminKeys)&&-1!==be.adminKeys.indexOf(l.proxy.edPublic)&&(c.isAdmin=!0),f.edPublic=l.proxy.edPublic,me.fire(f))})).on("error",(function(e){"EDELETED"===e.error&&(c.ownDeletion||(c.isDeleted=!0,r([],"DRIVE_DELETED",e.message)))})).on("disconnect",(function(){c.offline=!0,ge.fire(),r([],"UPDATE_METADATA")})).on("reconnect",(function(){c.offline=!1,Ee.fire(),r([],"UPDATE_METADATA")})),{channel:s.channel,onAccountCacheReady:ye.reg,onAccountReady:me.reg,onDisconnect:ge.reg,onReconnect:Ee.reg}}};var _e,we=Object.freeze({__proto__:null,Account:Ae}),Oe={exports:{}};function De(){return _e||(_e=1,function(e){(()=>{const n=(e={},n={})=>{var t={setCustomize:t=>{n=t.Messages,e=t.AppConfig},init:function(e){t.state=e}};return t.send=function(n,r,o){("function"!=typeof o&&(o=function(){}),e.disableFeedback)?o():n&&(!0===r||t.state)?function(e,n){var t=new XMLHttpRequest;t.open("HEAD",e),t.onreadystatechange=function(){this.readyState===this.DONE&&n&&n()},t.send()}("/common/feedback.html?"+n+"="+Math.random().toString(16).replace(/0./,""),o):o()},t.reportAppUsage=function(){var e=window.location.pathname.split("/").filter((function(e){return e})).join(".");/^#\/1\/view\//.test(window.location.hash)?t.send(e+"_VIEW"):t.send(e)},t.reportScreenDimensions=function(){var e=window.innerHeight,n=window.innerWidth;t.send("DIMENSIONS:"+e+"x"+n)},t.reportLanguage=function(){n&&t.send("LANG_"+n._languageUsed)},t};e.exports&&(e.exports=n(void 0,void 0))})()}(Oe)),Oe.exports}var Se,Te=De(),xe=n({__proto__:null,default:r(Te)},[Te]),Ce={exports:{}};function Ne(){return Se||(Se=1,function(e){e.exports&&(e.exports=function(e={},n){var t={setCustomize:n=>{e=n.AppConfig}};t.MINIMUM_PASSWORD_LENGTH="number"==typeof e.minimumPasswordLength?e.minimumPasswordLength:8,t.MINIMUM_NAME_LENGTH=1,t.MAXIMUM_NAME_LENGTH=64,t.isEmail=function(e){return/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(e).toLowerCase())},t.isLongEnoughPassword=function(e){return e.length>=t.MINIMUM_PASSWORD_LENGTH};var r=t.isString=function(e){return"string"==typeof e};return t.isValidUsername=function(e){return!!(r(e)&&e.length>=t.MINIMUM_NAME_LENGTH)},t.isValidPassword=function(e){return!(!e||!r(e))},t.passwordsMatch=function(e,n){return r(e)&&r(n)&&e===n},t.customSalt=function(){return"string"==typeof e.loginSalt?e.loginSalt:""},t.deriveFromPassphrase=function(e,r,o,a){n(r,e+t.customSalt(),8,1024,o||128,200,a,void 0)},t.dispenser=function(e){var n={used:0};return function(t){if(n.used+t>e.length)throw new Error("exceeded available entropy");if("number"!=typeof t)throw new Error("expected a number");if(t<=0)throw new Error("expected to consume a positive number of bytes");var r;return r=e.slice?e.slice(n.used,n.used+t):e.subarray(n.used,n.used+t),n.used+=t,r}},t}(void 0,L()))}(Ce)),Ce.exports}var Ie,Re,Pe,ke=Ne(),Me=n({__proto__:null,default:r(ke)},[ke]),Fe={exports:{}},Le={exports:{}},Ke={exports:{}},He={exports:{}};function je(){return Ie||(Ie=1,function(e){e.exports&&(e.exports={whenRealtimeSyncs:function(e,n){"function"==typeof e.getAuthDoc?setTimeout((function(){e.getAuthDoc()!==e.getUserDoc()?e.onSettle(n):n()}),0):console.error("improper use of this function")}})}(He)),He.exports}function Ue(){return Re||(Re=1,function(e){(()=>{const n=(e,n,t)=>{let r=globalThis;var o={setCustomize:()=>{}},a=function(e){try{return JSON.parse(JSON.stringify(e))}catch(e){return}};return o.init=function(o,i,c){var s=o.loggedIn,u=o.sharedFolder,l=o.readOnly,f=o.Messages||{},d=i.ROOT,h=i.FILES_DATA,p=i.STATIC_DATA,v=i.OLD_FILES_DATA,y=i.UNSORTED,m=i.TRASH,g=i.TEMPLATE,E=i.SHARED_FOLDERS,b=i.SHARED_FOLDERS_TEMP,A=i.debug;i._setReadOnly=function(e){(l=e)||i.fixFiles()},i.setHref=function(e,n,t){(n||e)&&(l||(n?[n]:i.findChannels([e])).forEach((function(e){var n=i.getFileData(e,!0);i.getHref(n)!==t&&(n.href=i.cryptor.encrypt(t))})))},i.setPadAttribute=function(e,n,t,r){if(r=r||function(){},l)r("EFORBIDDEN");else{var o=i.getIdFromHref(e);if(o)if(n&&n.trim()){var c=i.getFileData(o,!0);"href"===n?i.setHref(null,o,t):c[n]=a(t),r(null)}else r("E_INVAL_ATTR");else r("E_INVAL_HREF")}},i.getPadAttribute=function(e,n,t){t=t||function(){};var r=i.getIdFromHref(e);if(r){var o=i.getFileData(r);t(null,a(o[n]))}else t(null,void 0)},i.pushData=function(n,t){if("function"!=typeof t&&(t=function(){}),l)t("EFORBIDDEN");else{var r=e.createRandomInteger(),o=a(n);o.href&&-1!==o.href.indexOf("#")&&(o.href=i.cryptor.encrypt(o.href)),c[h][r]=o,t(null,r)}},i.pushLink=function(n,t){if("function"!=typeof t&&(t=function(){}),l)t("EFORBIDDEN");else{var r=e.createRandomInteger(),o=a(n);c[p][r]=o,t(null,r)}},i.pushSharedFolder=function(n,t){if("function"!=typeof t&&(t=function(){}),l)t("EFORBIDDEN");else{var r,u=a(n);if(Object.keys(c[E]).some((function(e){if(c[E][e].channel===u.channel)return u.href&&!c[E][e].href&&(c[E][e].href=u.href),r=e,!0})))t("EEXISTS",r);else if(s&&!o.testMode){var f=e.createRandomInteger();u.href&&-1!==u.href.indexOf("#")&&(u.href=i.cryptor.encrypt(u.href)),c[E][f]=u,t(null,f)}else t("EAUTH")}},i.deprecateSharedFolder=function(e,n){if(!l){var t=c[E][e];if(t){if(!(!t.href||-1===i.cryptor.decrypt(t.href).indexOf("#")))(c[b][e]=JSON.parse(JSON.stringify(t))).legacy="PASSWORD_CHANGE"!==n;var r=i.findFile(Number(e));i.delete(r,null,!0),delete c[E][e]}}};var _=function(e){l||delete c[h][e]};i.checkDeletedFiles=function(e){if(s||o.testMode)if(l)e("EFORBIDDEN");else{var t=i.getFiles([d,"hrefArray",m]),r=[];i.getFiles([h,E,p]).forEach((function(e){if(-1===t.indexOf(e)){var a=i.isSharedFolder(e)?c[E][e]:i.getFileData(e),s=a.channel;a.lastVersion&&r.push(n.hrefToHexChannelId(a.lastVersion)),a.rtChannel&&r.push(a.rtChannel),s&&r.push(s),i.isSharedFolder(e)?(delete c[E][e],o.removeProxy&&o.removeProxy(e)):c[p][e]?delete c[p][e]:_(e)}})),r.length?e(null,r):e()}else e()};i.deleteMultiplePermanently=function(e,n,t){if(l)t("EFORBIDDEN");else{var r=e.filter((function(e){return i.isPathIn(e,[h])}));if(!s&&!o.testMode)return r.forEach((function(e){var n=e[1];n&&_(n)})),void t();var a=e.filter((function(e){return i.isPathIn(e,["hrefArray"])})),u=e.filter((function(e){return i.isPathIn(e,[d])})),f=e.filter((function(e){return i.isPathIn(e,[m])})),p=[];a.forEach((function(e){var n=i.find(e);p.push({root:e[0],id:n})})),function(e){l||e.forEach((function(e){var n=c[e.root].indexOf(e.id);c[e.root].splice(n,1)}))}(p),u.forEach((function(e){var n=e.slice(),t=n.pop();delete i.find(n)[t]}));var v,y=[];f.forEach((function(e){var n=e.slice(),t=n.pop(),r=i.find(n);4!==e.length?delete r[t]:y.push({name:e[1],el:r})})),v=y,l||v.forEach((function(e){var n=c[m][e.name].indexOf(e.el);c[m][e.name].splice(n,1)})),n?t():i.checkDeletedFiles(t)}},i.copyFromOtherDrive=function(e,t,r,o){if(!l){var a=[];if(Object.keys(r).forEach((function(e){e=Number(e);var n=r[e];if(n.static)return delete n.static,void(c[p][e]=n);n.href&&(n.href=i.cryptor.encrypt(n.href));var t=!1;for(var o in c[h])if(c[h][o].channel===n.channel){c[h][o].href||(c[h][o].href=n.href),t=!0;break}t?a.push(e):c[h][e]=n})),i.isFile(t)&&-1!==a.indexOf(t))i.log(f.sharedFolders_duplicate);else{if(i.isFolder(t)){var s=function(e){for(var n in e)i.isFile(e[n])?-1!==a.indexOf(e[n])&&(i.log(f.sharedFolders_duplicate),delete e[n]):i.isFolder(e[n])&&s(e[n])};s(t)}var u=i.find(e),d=i.isFile(t)?n.createChannelId():o,v=i.getAvailableName(u,d);Array.isArray(u)?u.push(t):u[v]=t}}};i.copyElement=function(e,t){if(!l&&!i.comparePath(e,t)){var r=i.find(e),o=i.find(t);if(i.isPathIn(t,[m])){if(!e||e.length<2||e[0]===m)return void A("Can't move an element from the trash to the trash: ",e);var a=e[e.length-1],s=i.isPathIn(e,["hrefArray"])?i.getTitle(r):a,u=e.slice();return u.pop(),function(e,n,t){if(!l){var r=c[m];void 0===r[e]&&(r[e]=[]);var o={element:n,path:t};r[e].push(o)}}(s,r,u),!0}if(i.isPathIn(t,["hrefArray"])){if(i.isFolder(r))return void i.log(f.fo_moveUnsortedError);if(e[0]===t[0])return;var d=t[0];return-1===c[d].indexOf(r)&&c[d].push(r),!0}var h=i.isFile(r)?i.getAvailableName(o,n.createChannelId()):i.isInTrashRoot(e)?e[1]:e.pop();if(void 0===o[h])return o[h]=r,!0;i.log(f.fo_unavailableName)}},i.forget=function(e){if(!l){var n=i.getIdFromHref(e);if(n){if(!s&&!o.testMode)return _(n),!0;var t=i.findFile(n);return i.move(t,[m]),!0}}},i.restoreHref=function(e){if(!l){var n=i.getIdFromHref(e);if(n&&i.isFile(n)){var t=i.findFile(n),r=!0;t.forEach((function(e){e[0]!==m?r=!1:i.delete(e,null,!0)})),r&&i.add(n)}}},i.add=function(e,t){if(!l&&(s||o.testMode)){e=Number(e);var r=c[h][e]||c[p][e]||c[E][e];if(r&&"object"==typeof r){var a,u=t;if(t&&!Array.isArray(t)&&(u=decodeURIComponent(t).split(",")),t&&i.isPathIn(u,["hrefArray"]))(a=i.find(u)).push(e);else if(-1!==i.getFiles([d,m,"hrefArray"]).indexOf(e)||u||(u=[d]),t&&i.isPathIn(u,[d])){if(a=i.find(u)){var f=i.getAvailableName(a,n.createChannelId());return void(a[f]=e)}a=i.find([d]),u.slice(1).forEach((function(e){a=a[e]=a[e]||{}})),a[n.createChannelId()]=e}}}},i.setFolderData=function(e,t,r,o){if(!l){var a=i.find(e);if(i.isFolder(a)&&!i.isSharedFolder(a)){if(!i.hasFolderData(a))a["000"+n.createChannelId().slice(0,-3)]={metadata:!0};i.getFolderData(a)[t]=r,o()}}};var w=function(e){i.rt?(i.rt.sync(),t.whenRealtimeSyncs(i.rt,e)):r.setTimeout(e,1e3)};return i.migrateReadOnly=function(e){if(!l&&o.editKey)if(c.version>=2)e();else{c.migrateRo=1;w((function(){var n=JSON.parse(JSON.stringify(c));i.reencrypt(o.editKey,o.editKey,n),setTimeout((function(){c.version>=2?e():(Object.keys(n).forEach((function(e){c[e]=n[e]})),c.version=2,delete c.migrateRo,w(e))}),1e3)}))}else e({error:"EFORBIDDEN"})},i.migrate=function(t){if(l)t();else{!function(){if(c[y]&&c[v]){A("UNSORTED still exists in the object, removing it...");var e=c[y];0!==e.length?(e.forEach((function(e){"string"==typeof e&&(0===c[v].filter((function(n){return n.href===e})).length&&c[v].push({href:e}))})),delete c[y]):delete c[y]}}(),function(t){if(c[v])try{A("Migrating file system..."),c.migrate=1;w((function(){var r=c[v].slice();c[h]||(c[h]={});var o=c[h];r.forEach((function(t){if(t&&t.href){var r=t.href,a=e.createRandomInteger(),c=i.findFile(r),s=t,u=n.createChannelId();o[a]=s||{href:r},c.forEach((function(e){var n=e.slice(),t=n.pop(),r=i.find(n);if(i.isInTrashRoot(e))return r.element=a,void(o[a].filename=e[1]);i.isPathIn(e,["hrefArray"])?r[t]=a:(r[u]=a,o[a].filename=t,delete r[t])}))}})),delete c[v],delete c.migrate,t()}))}catch(e){console.error(e),t()}else t()}(t)}},i.fixFiles=function(t){if(!l){t&&(A=function(){});var r=+new Date;A("Cleaning file system...");var a=JSON.stringify(c),f=function(t){"object"!=typeof c[d]&&(A("ROOT was not an object"),c[d]={});var r=t||c[d];if(!r)return console.error("Invalid element in root");var o,a=0,s=c[p],u=c[h];for(var l in r)if(null!==(o=r[l]))if(i.isFolderData(o))0!==a&&(A("Multiple metadata files in folder"),delete r[l]),a++;else if(i.isFile(o,!0)||i.isFolder(o))if(i.isFolder(o))f(o);else{if("string"==typeof o){var v=e.createRandomInteger(),y=n.createChannelId();u[v]={href:i.cryptor.encrypt(o),filename:l},r[y]=v,delete r[l]}if("number"==typeof o)u[o]||s[o]||(A("An element in ROOT doesn't have associated data",o,l),delete r[l])}else A("An element in ROOT was not a folder nor a file. ",o),delete r[l];else console.error("element[%s] is null",l),delete r[l]};e.isObject(c[p])||(A("STATIC_DATA was not an object"),c[p]={}),f(),function(){if(!u){"object"!=typeof c[m]&&(A("TRASH was not an object"),c[m]={});var n,t=c[m],r=function(t,r,o){if("object"==typeof t){if(!i.isSharedFolder(t.element))if(i.isFile(t.element,!0)||i.isFolder(t.element))if(Array.isArray(t.path)){if("string"==typeof t.element){var a=e.createRandomInteger();c[h][a]={href:i.cryptor.encrypt(t.element),filename:o},t.element=a}if(i.isFolder(t.element)&&f(t.element),"number"==typeof t.element)c[h][t.element]||c[p][t.element]||(A("An element in TRASH doesn't have associated data",t.element,o),n.push(r))}else n.push(r);else n.push(r)}else n.push(r)};for(var o in t)if(Array.isArray(t[o]))if(0===t[o].length)A("Empty array in TRASH root. ",t[o]),delete t[o];else{n=[];for(var a=0;a<t[o].length;a++)r(t[o][a],a,o);for(var s=n.length-1;s>=0;s--)t[o].splice(n[s],1)}else A("An element in TRASH root is not an array. ",t[o]),delete t[o]}}(),function(){if(!u){Array.isArray(c[g])||(A("TEMPLATE was not an array"),c[g]=[]);var n=e.deduplicateString(c[g]);n.length!==c[g].length&&(c[g]=n);var t=c[g],r=i.getFiles([d]),o=[];t.forEach((function(n,a){if(i.isFile(n,!0)&&-1===r.indexOf(n)){if("string"==typeof n){var s=e.createRandomInteger();return c[h][s]={href:i.cryptor.encrypt(n)},void(t[a]=s)}if("number"==typeof n)c[h][n]||(A("An element in TEMPLATE doesn't have associated data",n),o.push(n))}else o.push(n)})),o.forEach((function(e){var n=t.indexOf(e);-1!==n&&t.splice(n,1)}))}}(),function(){"object"!=typeof c[h]&&(A("FILES_DATA was not an object"),c[h]={});var e=c[h],t=i.getFiles([d,m,"hrefArray"]),r=i.find([d]),a=[];for(var u in e)if(String(u)===String(Number(u))){var f=e[u=Number(u)];if(f&&"object"==typeof f)if(f.href||f.roHref){var v;try{v=f.href&&(-1!==f.href.indexOf("#")?f.href:i.cryptor.decrypt(f.href))}catch(e){}if(!v||-1!==v.indexOf("#")){var y,g=n.parsePadUrl(v||f.roHref);if(g.hash)if(g.type){if(v&&"pad"===g.hashData.type&&g.hashData.version)if("view"===g.hashData.mode)f.roHref=v,delete f.href;else if(f.roHref){var E=n.parsePadUrl(f.roHref);E.hash&&E.type||(y=n.getSecrets(g.type,g.hash,f.password),f.roHref="/"+g.type+"/#"+n.getViewHashFromKeys(y))}else y=n.getSecrets(g.type,g.hash,f.password),f.roHref="/"+g.type+"/#"+n.getViewHashFromKeys(y);if(0===g.hashData.version&&delete f.roHref,v&&"/"!==v.slice(0,1)&&(f.href=i.cryptor.encrypt(n.getRelativeHref(v))),f.ctime||(f.ctime=f.atime),f.title||(f.title=i.getDefaultName(g)),!f.channel)try{y||(y=n.getSecrets(g.type,g.hash,f.password)),f.channel=y.channel,console.log(f),A("Adding missing channel in filesData ",f.channel)}catch(e){console.error(e)}if(n.isValidChannel(f.channel)||console.error("Remove invalid channel",f.channel,f),!s&&!o.testMode||-1!==t.indexOf(u));else A("An element in filesData was not in ROOT, TEMPLATE or TRASH.",u,f),r[n.createChannelId()]=u}else A("Removing an element in filesData with a invalid type.",f),a.push(u);else A("Removing an element in filesData with a invalid href.",f),a.push(u)}}else A("Removing an element in filesData with a missing href.",f),a.push(u);else A("An element in filesData was not an object.",f),a.push(u)}else A("Invalid file ID in filesData.",u),a.push(u);a.forEach((function(e){_(e)}));var b=c[p],w=[];for(var O in b){var D=b[O=Number(O)];D&&"object"==typeof D&&D.href?!s&&!o.testMode||-1!==t.indexOf(O)||w.push(O):w.push(O)}w.forEach((function(e){l||delete c[p][e]}))}(),Object.keys(c).forEach((function(e){"/"===e.slice(0,1)&&delete c[e]})),function(){if(!u){"object"!=typeof c[E]&&(A("SHARED_FOLDER was not an object"),c[E]={});var e,t,r=c[E],o=i.getFiles([d,m]),a=i.find([d]);for(var s in r){var l;t=r[s],s=Number(s);try{l=t.href&&(-1!==t.href.indexOf("#")?t.href:i.cryptor.decrypt(t.href))}catch(e){}if((e=n.parsePadUrl(l||t.roHref))&&e.hash&&"undefined"!==e.hash){if(-1===o.indexOf(s))console.log("missing"+s),a[n.createChannelId()]=s}else delete r[s]}}}(),function(){if(!u){"object"!=typeof c[b]&&(A("SHARED_FOLDER_TEMP was not an object"),c[b]={});var e=c[b],n=c[E];for(var t in e)n[t]&&delete e[t]}}();var v=+new Date-r+"ms";JSON.stringify(c)===a?A("File system was clean.",v):A("Your file system was corrupted. It has been cleaned so that the pads you visit can be stored safely.",v)}},i},o};e.exports&&(e.exports=n(ee(),ae(),je()))})()}(Ke)),Ke.exports}function Be(){return Pe||(Pe=1,function(e){(()=>{const n=(e,n,t,r,o,a={})=>{let i=globalThis;var c={setCustomize:e=>{a=e.Messages,r.setCustomize(e)}},s=c.ROOT="root",u=c.UNSORTED="unsorted",l=c.TRASH="trash",f=c.TEMPLATE="template",d=c.SHARED_FOLDERS="sharedFolders",h=c.SHARED_FOLDERS_TEMP="sharedFoldersTemp",p=c.FILES_DATA=t.storageKey,v=c.OLD_FILES_DATA=t.oldStorageKey,y=c.STATIC_DATA="static";c.getDefaultName=function(e){var n=e.type;return a.type[n]+" - "+function(){if(i.Intl&&i.Intl.DateTimeFormat)return new i.Intl.DateTimeFormat(void 0,{weekday:"short",year:"numeric",month:"long",day:"numeric"}).format(new Date);return(new Date).toString().split(" ").slice(0,4).join(" ")}()};var m=c.createCryptor=function(e){var n={};if(!e)return n.encrypt=function(e){return e},n.decrypt=function(e){return e},n;try{var t=o.createEncryptor(e);n.encrypt=function(e){try{return"/file/#"===e.slice(0,7)?e:t.encrypt(e)}catch(e){return}},n.decrypt=function(e){try{return t.decrypt(e)}catch(e){return}}}catch(e){console.error(e)}return n};return c.getHref=function(e,n){if(e.href&&-1!==e.href.indexOf("#"))return e.href;if(e.href&&n){var t=n.decrypt(e.href);if(t&&-1!==t.indexOf("#"))return t}return e.roHref},c.reencrypt=function(e,n,t){if(t){var r=m(e),o=m(n);Object.keys(t[p]).forEach((function(e){var n=t[p][e]||{};if(n.href&&n.roHref&&!n.fileType){var a=n.href&&-1===n.href.indexOf("#")?r.decrypt(n.href):n.href;if(!a)return;n.href=o.encrypt(a)}})),Object.keys(t[d]||{}).forEach((function(e){var n=t[d][e]||{};if(n.href){var a=n.href&&-1===n.href.indexOf("#")?r.decrypt(n.href):n.href;if(!a)return;n.href=o.encrypt(a)}})),Object.keys(t[h]||{}).forEach((function(e){var n=t[h][e]||{};if(n.href){var a=n.href&&-1===n.href.indexOf("#")?r.decrypt(n.href):n.href;if(!a)return;n.href=o.encrypt(a)}}))}else console.error("Nothing to reencrypt")},c.init=function(t,o){var i={};i.cryptor=m(o.editKey),i.setReadOnly=function(e,n){o.editKey=n,i.cryptor=m(n),i.cryptor.k=Math.random(),i.readOnly=e,i._setReadOnly&&i._setReadOnly(e)},i.readOnly=o.readOnly,i.reencrypt=c.reencrypt,i.getDefaultName=c.getDefaultName;var g=o.sframeChan,E=a.fm_newFolder||"New folder",b=a.fm_newFile||"New file";i.ROOT=s,i.STATIC_DATA=y,i.UNSORTED=u,i.TRASH=l,i.TEMPLATE=f,i.SHARED_FOLDERS=d,i.SHARED_FOLDERS_TEMP=h,i.FILES_DATA=p,i.OLD_FILES_DATA=v;var A=i.sharedFolder=o.sharedFolder;i.id=o.id;var _=function(){console.debug.apply(console,arguments)},w=i.log=o.log||_,O=o.logError||_,D=i.debug=o.debug||_;i.fixFiles=function(){};var S=i.error=function(){g?g.query("Q_DRIVE_USEROBJECT",{cmd:"fixFiles",data:{}},(function(){})):("function"==typeof i.fixFiles&&i.fixFiles(),console.error.apply(console,arguments),i.fixFiles())};o.outer&&r.init(o,i,t),i.getStructure=function(){var e={};return e[s]={},e[l]={},e[p]={},e[f]=[],e[d]={},e};var T=i.getHref=function(e){return c.getHref(e,i.cryptor)},x=function(e){return null===e?"null":Array.isArray(e)?"array":typeof e};i.isValidDrive=function(e){var n=i.getStructure();return"object"==typeof e&&Object.keys(n).every((function(t){return e[t]&&x(n[t])===x(e[t])}))};var C=function(){return[f]},N=function(e,n){return e===n},I=i.isSharedFolder=function(e){return!A&&Boolean(t[d]&&t[d][e])},R=i.isFile=function(e,n){return!I(e)&&("number"==typeof e||(void 0!==t[v]||n)&&"string"==typeof e)},P=i.isFolderData=function(e){return"object"==typeof e&&!0===e.metadata};i.isReadOnlyFile=function(e){if(!R(e))return!1;var n=i.getFileData(e);return n.roHref?Boolean(n.roHref&&!n.href):void 0},i.isStaticFile=function(e){return Boolean(t[y]&&t[y][e])};var k=i.isFolder=function(e){return!P(e)&&("object"==typeof e&&!e.channel||I(e))};i.isFolderEmpty=function(e){return!!k(e)&&(0===Object.keys(e).length||!(1!==Object.keys(e).length||!P(e[Object.keys(e)[0]])))},i.hasSubfolder=function(e,n){if(!k(e))return!1;var t=0,r=function(e){t+=k(e.element)?1:0};for(var o in e)n?Array.isArray(e[o])&&e[o].forEach(r):t+=k(e[o])?1:0;return t},i.hasFile=function(e,n){if(!k(e))return!1;var t=0,r=function(e){t+=R(e.element)?1:0};for(var o in e)n?Array.isArray(e[o])&&e[o].forEach(r):t+=R(e[o])?1:0;return t},i.hasFolderData=function(e){for(var n in e)if(P(e[n]))return!0};var M=i.hasSubSharedFolder=function(e){for(var n in e){if(I(e[n]))return!0;if(k(e[n])&&M(e[n]))return!0}return!1},F=i.getFileData=function(n,r){if(n){var a,c;try{a=(t[y]||{})[n]}catch(e){console.error(e)}if(a){var s=r?a:e.clone(a);return r||(s.static=!0),s}try{c=t[p][n]||{}}catch(e){console.error(e),c={}}if(!r&&(c=JSON.parse(JSON.stringify(c))).href&&-1===c.href.indexOf("#"))if(o.editKey)try{c.href=i.cryptor.decrypt(c.href)}catch(e){delete c.href}else delete c.href;return c}};i.getFolderData=function(e){for(var n in e)if(P(e[n]))return e[n];return{}};var L=i.getTitle=function(e,n){if(I(e))return"??";var t=F(e);if(t){if(t.static)return t.name;if(e&&(t.href||t.roHref))return"title"===n?t.title:"name"===n?t.filename:t.filename||t.title||b;S("getTitle called with a non-existing file id: ",e,t)}else S("unable to retrieve data about the requested file: ",e,t)},K=i.comparePath=function(e,n){if(!(e&&n&&Array.isArray(e)&&Array.isArray(n)))return!1;if(e.length!==n.length)return!1;for(var t=!0,r=e.length-1;t&&r>=0;)t=e[r]===n[r],r--;return t},H=i.isSubpath=function(e,n){var t=n.slice(),r=e.slice(0,t.length);return K(t,r)},j=i.isPathIn=function(e,n){if(n){var t=n.indexOf("hrefArray");return-1!==t&&(n.splice(t,1),n=n.concat(C())),n.some((function(n){return Array.isArray(e)&&e[0]===n}))}},U=i.isInTrashRoot=function(e){return e[0]===l&&4===e.length},B=function(e,n){if(n){if(0===n.length)return e;var t=n.slice(),r=t.shift();if(void 0!==e[r])return B(e[r],t);D("Unable to find the key '"+r+"' in the root object provided:",e)}else S("Invalid path:\n",n,"\nin root\n",e)},V=i.find=function(e){return B(t,e)},Y=i.getFilesRecursively=function(e,n){for(var t in n=n||[],e)R(e[t])||I(e[t])?-1===n.indexOf(e[t])&&n.push(e[t]):P(e[t])||Y(e[t],n);return n},G={array:function(e){return t[e]||(t[e]=[]),t[e].slice()}};C().forEach((function(e){G[e]=function(){return G.array(e)}})),G.hrefArray=function(){var n=[];return A?n:(C().forEach((function(e){n=n.concat(G[e]())})),e.deduplicateString(n))},G[s]=function(){var e=[];return Y(t[s],e),e},G[l]=function(){var e=t[l],n=[],r=function(e){R(e.element)||I(e.element)?-1===n.indexOf(e.element)&&n.push(e.element):Y(e.element,n)};for(var o in e){if(!Array.isArray(e[o]))return void S("Trash contains a non-array element");e[o].forEach(r)}return n},G[v]=function(){var e=[];return t[v]?(t[v].forEach((function(n){n.href&&-1===e.indexOf(n.href)&&e.push(n.href)})),e):e},G[y]=function(){return t[y]?Object.keys(t[y]).map(Number).filter(Boolean):[]},G[p]=function(){return t[p]?Object.keys(t[p]).map(Number).filter(Boolean):[]},G[d]=function(){return t[d]?Object.keys(t[d]).map(Number).filter(Boolean):[]};var J=i.getFiles=function(n){var t=[];return n&&n.length||(n=[s,"hrefArray",l,v,p,d]),n.forEach((function(e){"function"==typeof G[e]&&(t=t.concat(G[e]()))})),e.deduplicateString(t)},q=i.getIdFromHref=function(e){var r,o=function(e){if(e)return n.parsePadUrl(e).getUrl().replace(/\/p\/?/,"/")},a=o(e);return J([p]).some((function(e){if(o(T(t[p][e]))===a||o(t[p][e].roHref)===a)return r=e,!0})),r};i.getSFIdFromHref=function(e){var r,o=function(e){if(e)return n.parsePadUrl(e).getUrl().replace(/\/p\/?/,"/")},a=o(e);return J([d]).some((function(e){if(o(T(t[d][e]))===a||o(t[d][e].roHref)===a)return r=e,!0})),r};var W=function(e,n){if(!j(e,[s,l]))return[];n=Array.isArray(n)?n:[n];var t={},r=V(e),o=function(e){Object.keys(e).forEach((n=>{t[n]||=[],Array.prototype.push.apply(t[n],e[n])}))};if(R(r)||I(r))return n.some((n=>{N(n,r)&&(t[n]||=[],t[n].push(e))})),t;if(k(r))for(var a in r){let t=e.slice();t.push(a),o(W(t,n))}return t},z=function(e,n){if(A)return{};if(!t[e])return{};var r=t[e].slice(),o={},a=-1;return n.forEach((n=>{for(;-1!==(a=r.indexOf(n,a+1));)o[n]||=[],o[n].push([e,a])})),o},Q=function(e,n){if(A)return[];var t=V(e),r={},o=function(e){Object.keys(e).forEach((n=>{r[n]||=[],Array.prototype.push.apply(r[n],e[n])}))};if(1===e.length&&"object"==typeof t&&Object.keys(t).forEach((function(r){var a=t[r];if(Array.isArray(a)){var i=e.slice();i.push(r),o(Q(i,n))}})),2===e.length){if(!Array.isArray(t))return[];t.forEach((function(t,a){var i=e.slice();i.push(a),i.push("element"),R(t.element)?n.some((e=>{N(e,t.element)&&(r[e]||=[],r[e].push(i))})):o(Q(i,n))}))}return e.length>=4&&o(W(e,n)),r},X=i.findFiles=function(e){var n=W([s],e),t=z(f,e),r=Q([l],e);let o={};return e.forEach((e=>{o[e]=[]})),[n,t,r].forEach((e=>{Object.keys(e).forEach((n=>{o[n]||=[],Array.prototype.push.apply(o[n],e[n])}))})),o},Z=i.findFile=function(e){return X([e])[e]||[]};i.findChannels=function(e,n){var r=t[p],o=t[d],a=[p];return n&&a.push(d),J(a).filter((function(n){var t=r[n]||o[n]||{};return-1!==e.indexOf(t.channel)}))},i.search=function(r){if("string"!=typeof r)return[];r=r.trim();var o,a=[],c=t[p],u=t[d],l=r.toLowerCase();/^#/.test(l)&&(o=[l.slice(1).trim()]);J([p,d]).forEach((function(e){var n=c[e]||u[e];if(n)if(Array.isArray(n.tags)&&(t=n.tags,o&&t.length&&(t=t.map((function(e){return e.toLowerCase()})),o.some((function(e){return t.some((function(n){return n===e}))})))))a.push(e);else{var t,r=n.title||n.lastTitle;(r&&-1!==r.toLowerCase().indexOf(l)||n.filename&&-1!==n.filename.toLowerCase().indexOf(l))&&a.push(e)}}));var f=n.getRelativeHref(r);if(f){var h=q(f);h&&a.push(h)}a=e.deduplicateString(a);var v=[];a.forEach((function(e){v.push({id:e,paths:Z(e),data:i.getFileData(e)})}));var y=[],m=function(e,n){for(var t in e)k(e[t])&&!I(e[t])&&(-1!==t.toLowerCase().indexOf(l)&&y.push({id:null,paths:[n.concat(t)],data:{title:t}}),m(e[t],n.concat(t)))};return m(t[s],[s]),y=y.sort((function(e,n){return e.data.title.toLowerCase()>n.data.title.toLowerCase()})),v=y.concat(v)},i.getRecentPads=function(){var e=t[p];return Object.keys(e).filter((function(n){return e[n]})).sort((function(n,t){return e[t].atime-e[n].atime})).map((function(e){return Number(e)}))},i.getOwnedPads=function(e){var n=t[p];return Object.keys(n).filter((function(t){return n[t].owners&&-1!==n[t].owners.indexOf(e)})).map((function(e){return Number(e)}))};var $=i.getAvailableName=function(e,n){if(void 0===e[n])return n;for(var t=n,r=1;void 0!==e[t];)t=n+"_"+r,r++;return t},ee=i.move=function(e,n,t){if(g)g.query("Q_DRIVE_USEROBJECT",{cmd:"move",data:{paths:e,newPath:n}},t);else{var r=[];e.forEach((function(e){var t=e.slice();t.pop(),K(t,n)||(H(n,e)?w(a.fo_moveFolderToChildError):i.copyElement(e.slice(),n)&&r.push(e))})),i.delete(r,t)}};return i.restore=function(e,n){if(g)g.query("Q_DRIVE_USEROBJECT",{cmd:"restore",data:{path:e}},n);else if(U(e)){var t=e.slice();t.pop();var r=V(t).path;ee([e],r,n)}},i.addFolder=function(e,n,t){if(g)g.query("Q_DRIVE_USEROBJECT",{cmd:"addFolder",data:{path:e,name:n}},t);else{var r=V(e),o=$(r,n||E);r[o]={};var a=e.slice();a.push(o),t({newPath:a})}},i.delete=function(e,n,t){g?g.query("Q_DRIVE_USEROBJECT",{cmd:"delete",data:{paths:e,nocheck:t}},n):(n=n||function(){},i.deleteMultiplePermanently(e,t,n))},i.emptyTrash=function(e){e=e||function(){},g?g.query("Q_DRIVE_USEROBJECT",{cmd:"emptyTrash"},e):(t[l]={},i.checkDeletedFiles(e))},i.ownedInTrash=function(e){return J([l]).map((function(n){var r=I(n)?t[d][n]:i.getFileData(n);if(r)return e(r.owners)?r.channel:void 0})).filter(Boolean)},i.rename=function(e,n,r){if(r=r||function(){},g)g.query("Q_DRIVE_USEROBJECT",{cmd:"rename",data:{path:e,newName:n}},r);else if(e.length<=1)O("Renaming `root` is forbidden");else{var o,i=V(e);if(k(i)&&!I(i)){var c=e.slice(),s=c.pop();if(!n||!n.trim()||s===n)return;var u=V(c);return void 0!==u[n]?void w(a.fo_existingNameError):(u[n]=i,delete u[s],void("function"==typeof r&&r()))}if(o=I(i)?t[d][i]:t[p][i]||t[y][i])return t[y][i]?n&&n.trim()?(o.name=n,void r()):void r():n&&""!==n.trim()?void(L(i,"name")!==n&&(o.filename=n,"function"==typeof r&&r())):(delete o.filename,void("function"==typeof r&&r()))}},i.getTagsList=function(){var e,n={},r=function(e){n[e]=n[e]?++n[e]:1};for(var o in t[p])(e=t[p][o]).tags&&Array.isArray(e.tags)&&e.tags.forEach(r);return n},i},c};e.exports&&(e.exports=n(ee(),ae(),q(),Ue(),K(),void 0))})()}(Le)),Le.exports}var Ve,Ye,Ge,Je,qe={exports:{}};function We(){return Ve||(Ve=1,function(e){e.exports=function(e){var n,t=[],r=[],o=0,a=function(e){return o++,function(){for(e&&e.apply(null,arguments),o=(o||1)-1;!o&&t.length&&!n;)t.shift()(a)}};a.abort=function(){r.forEach(clearTimeout),n=1};var i={nThen:function(e){return n||(o?t.push(e):e(a)),i},orTimeout:function(e,c){if(n)return i;if(!c)throw Error("Must specify milliseconds to orTimeout()");var s,u=setTimeout((function(){for(;t.shift()!==s;);for(e(a),o=(o||1)-1;!o&&t.length;)t.shift()(a)}),c);return t.push(s=function(){var e=r.indexOf(u);if(e>-1)return r.splice(e,1),void clearTimeout(u);throw new Error("timeout not listed in array")}),r.push(u),i}};return i.nThen(e)}}(qe)),qe.exports}function ze(){if(Ge)return Ye;Ge=1;return Ye=((e,n,t,r,o,a,i,c)=>{var s={},u={};return s.checkMigration=function(e,t,r,o){var a=n.once(n.mkAsync(o));if(t)if(e)if(t.version>=2)a();else if(t.migrateRo){var i,c=!1,s=setInterval((function(){if(t.version>=2)return c=!0,clearTimeout(i),clearInterval(s),void a()}),100);i=setTimeout((function(){clearInterval(s),r.migrateReadOnly((function(){c=!0,a()}))}),2e4);t.on("change",["version"],(function(){c||t.version>=2&&(c=!0,clearTimeout(i),clearInterval(s),a())}))}else r.migrateReadOnly(a);else a();else a()},s.migrate=function(e){var t=u[e];if(t){var r=t.teams;if(Array.isArray(r)&&r.length){var o=r[0];if(o.secondaryKey){var a=n.find(o,["store","manager","folders",o.id]);a&&a.proxy&&!a.proxy.version&&a.userObject.migrateReadOnly((function(){r.forEach((function(e){n.find(e,["store","manager","folders",e.id,"userObject"]).setReadOnly(!1,e.secondarykey)}))}))}}}},s.load=function(t,l,f,d){var h=n.once(n.mkAsync(d)),p=t.network,v=t.store,y=t.isNew,m=t.isNewChannel,g=v.id,E=v.handleSharedFolder,b=v.manager.user.userObject.getHref(f),A=e.parsePadUrl(b),_=e.getSecrets("drive",A.hash,f.password);if(!_.keys)return v.manager.deprecateProxy(l),void h(null);var w=_.keys.secondaryKey;o((function(e){t.cache&&r.getChannelCache(_.channel,e((function(n){if("EINVAL"===n)return e.abort(),v.manager.restrictedProxy(l,_.channel),void h(null)})))})).nThen((function(e){m(null,{channel:_.channel},e((function(n){if(n.isNew&&!y)return v.manager.deprecateProxy(l,_.channel,n.reason),e.abort(),void h(null)})))})).nThen((function(){var e=u[_.channel];if(e&&e.readOnly&&w&&s.upgrade(_.channel,_),e&&e.ready&&e.rt)return setTimeout((function(){v.manager.addProxy(l,e.rt,(function(){s.leave(_.channel,g)}),w),h(e.rt)})),e.teams.push({cb:h,store:v,id:l}),void(E&&E(l,e.rt));if(e&&!e.ready&&e.rt)return e.teams.push({cb:h,store:v,secondaryKey:w,id:l}),void(E&&E(l,e.rt));e=u[_.channel]={teams:[{cb:h,store:v,secondaryKey:w,id:l}],readOnly:!Boolean(w)};var n=f.owners,o={data:{},channel:_.channel,readOnly:!Boolean(w),crypto:a.createEncryptor(_.keys),userName:"sharedFolder",logLevel:1,ChainPad:c,classic:!0,network:p,Cache:r,metadata:{validateKey:_.keys.validateKey||void 0,owners:n},onRejected:t.Store&&t.Store.onRejected},d=e.rt=i.create(o);d.proxy.on("cacheready",(function(){e.teams&&(e.teams.forEach((function(n){d.cache=!0,n.store.manager.addProxy(n.id,d,(function(){s.leave(_.channel,n.store.id)}),n.secondaryKey,t.updatePassword),t.updatePassword=!1,n.cb(e.rt)})),e.ready=!0)})),d.proxy.on("ready",(function(){y&&!Object.keys(d.proxy).length&&(d.proxy.version=2),e.teams&&(e.teams.forEach((function(n){d.cache=!1,n.store.manager.addProxy(n.id,d,(function(){s.leave(_.channel,n.store.id)}),n.secondaryKey,t.updatePassword),n.cb(e.rt)})),e.ready=!0)})),d.proxy.on("error",(function(n){if(n&&n.error){if("EDELETED"===n.error){try{e.teams.forEach((function(e){e.store.manager.deprecateProxy(e.id,_.channel,n.message),e.store.handleSharedFolder&&e.store.handleSharedFolder(e.id,null),e.cb()}))}catch(e){}return delete u[_.channel],void h()}if("ERESTRICTED"===n.error)return e.teams.forEach((function(e){e.store.manager.restrictedProxy(e.id,_.channel),e.cb()})),delete u[_.channel],void h()}})),E&&E(l,d)}))},s.upgrade=function(e,n){var t=u[e];if(t&&t.readOnly&&t.rt.setReadOnly&&n.keys&&n.keys.editKeyStr){var r=a.createEncryptor(n.keys);t.readOnly=!1,t.rt.setReadOnly(!1,r)}},s.leave=function(e,n){var t=u[e];if(t){var r,o=t.teams;if(Array.isArray(o))o.some((function(e,t){if(e.store.id===n)return e.store.handleSharedFolder&&e.store.handleSharedFolder(e.id,null),r=t,!0})),void 0!==r&&(o.splice(r,1),o.length||t.rt&&t.rt.stop&&t.rt.stop())}},s.updatePassword=function(r,a,i,c){var l=a.oldChannel,f=a.href,d=a.password,h=e.parsePadUrl(f),p=e.getSecrets(h.type,h.hash,d),v=u[l];if(v){if(v.rt&&v.rt.stop)try{v.rt.stop()}catch(e){}var y=o;v.teams.forEach((function(e){y=y((function(o){var a=e.store,c=e.id,u=n.find(a.proxy,["drive",t.SHARED_FOLDERS])||{};if(c&&u[c]){var f=JSON.parse(JSON.stringify(u[c]));f.password=d,s.load({network:i,store:a,updatePassword:!0,Store:r,isNewChannel:r.isNewChannel},c,f,o()),a.rpc&&(a.rpc.unpin([l],o()),a.rpc.pin([p.channel],o()))}})).nThen})),y((function(){c()}))}else c({error:"ENOTFOUND"})},s.loadSharedFolders=function(e,n,r,a,i,c,u,l){var f=a[t.SHARED_FOLDERS]||{},d=Object.keys(f).length,h=1,p=c();u=u||function(){},o((function(t){Object.keys(f).forEach((function(o){var a=f[o];s.load({network:n,store:r,Store:e,cache:l,isNewChannel:e.isNewChannel},o,a,t((function(){u({progress:h,max:d}),h++})))}))})).nThen((function(){setTimeout(p)}))},s.isSharedFolderChannel=function(e){return Object.keys(u).includes(e)},s})(ae(),ee(),Be(),he(),We(),K(),S(),N()),Ye}function Qe(){return Je||(Je=1,function(e){(()=>{const n=(e,n,t,r={},o,a,i={})=>{var c=function(n,t,r,o,a,i){if(!n.folders[t]||i||n.folders[t].restricted){var c=function(e){var n={};for(var t in e.cfg)n[t]=e.cfg[t];return n}(n);c.sharedFolder=!0,c.id=t,c.editKey=a,c.rt=r.realtime,c.readOnly=Boolean(!a);var s=e.init(r.proxy,c);s.fixFiles&&s.fixFiles();var u=r.proxy;if(u.metadata&&u.metadata.title){var l=n.user.proxy[e.SHARED_FOLDERS][t];l&&(l.lastTitle=u.metadata.title)}return n.folders[t]={proxy:r.proxy,userObject:s,leave:o,restricted:u.restricted,offline:Boolean(r.cache)},u.on&&(u.on("disconnect",(function(){n.folders[t].offline=!0})),u.on("reconnect",(function(){n.folders[t].offline=!1}))),s}n.folders[t].offline&&!r.cache&&n.Store&&(n.folders[t].offline=!1,n.folders[t].userObject.fixFiles&&n.folders[t].userObject.fixFiles(),n.Store.refreshDriveUI())},s=function(e,n){var t=e.folders[n];t&&(t.leave(),delete e.folders[n])},u=function(t,r,o,a){if(!t.folders[r]||!t.folders[r].deleting){if(t.user.userObject.readOnly){return s(t,r),c(t,r,{proxy:{deprecated:!0}},(function(){})),void t.Store.refreshDriveUI()}if(o&&t.unpinPads([o],(function(){})),a&&"PASSWORD_CHANGE"!==a){let o=n.find(t,["user","proxy",e.SHARED_FOLDERS]),a=o[r]&&o[r].lastTitle;return a&&((e,n,t)=>{var r=e.store.mailbox;if(r){var o,a=e.cfg.teamId;o=a?e.store.modules.team.getTeamsData()[a]:e.Store.getMetadata(null,null,(()=>{})).user,r.sendTo("SF_DELETED",{sfId:n,team:a,title:t},{curvePublic:o.curvePublic,channel:o.notifications},(e=>{console.error(e)}))}})(t,r,a),delete o[r],void(t.Store&&t.Store.refreshDriveUI&&t.Store.refreshDriveUI())}t.user.userObject.deprecateSharedFolder(r,a),s(t,r),t.Store&&t.Store.refreshDriveUI&&t.Store.refreshDriveUI()}},l=function(e,n){s(e,n),c(e,n,{proxy:{restricted:!0,root:{},filesData:{}}},(function(){})),e.Store.refreshDriveUI()},f=function(e,n){return Array.isArray(n)&&-1!==n.indexOf(e.edPublic)},d=function(e){var n=[e.user.userObject],t=Object.keys(e.folders).map((function(n){return e.folders[n].userObject}));return Array.prototype.push.apply(n,t),n},h=function(e,n){var t=d(e),r=e.user.userObject;return t.some((function(e){if(Object.keys(e.getFileData(n)).length)return r=e,!0})),r},p=function(e,n){var t=Number(n.id);if(t)return e.user.userObject.findFile(t)[0]},v=function(n,t,r){var o=[];return n.user.userObject.findChannels([t],!0).forEach((function(t){var a=n.user.proxy[e.SHARED_FOLDERS][t];a&&!r&&(a=JSON.parse(JSON.stringify(a))),a||(a=n.user.userObject.getFileData(t,r)),o.push({id:t,data:a,userObject:n.user.userObject})})),Object.keys(n.folders).forEach((function(e){n.folders[e].userObject.findChannels([t]).forEach((function(t){o.push({id:t,fId:e,data:n.folders[e].userObject.getFileData(t,r),userObject:n.folders[e].userObject})}))})),o},y=function(e,n){var t=[],r=e.user.userObject.getIdFromHref(n);return r&&t.push({data:e.user.userObject.getFileData(r),userObject:e.user.userObject}),Object.keys(e.folders).forEach((function(r){var o=e.folders[r].userObject.getIdFromHref(n);o&&t.push({fId:r,data:e.folders[r].userObject.getFileData(o),userObject:e.folders[r].userObject})})),t},m=function(e,n){var t=[],r=d(e);let o={};return r.forEach((function(e){var a=Number(e.id);let i;if(a){i=e.findFile(n);let t=(o[a]||[])[0];if(!t)return;i.forEach((function(e){Array.prototype.unshift.apply(e,t)}))}else{let t=[n],a=r.map((e=>+e.id)).filter(Boolean);Array.prototype.push.apply(t,a),o=e.findFiles(t),i=o[n]}Array.prototype.push.apply(t,i)})),t},g=function(e,n){var t={},r=d(e);let o={};return r.forEach((function(e){var a=Number(e.id);if(!e.id){let e=r.map((e=>+e.id)).filter(Boolean);Array.prototype.push.apply(n,e)}var i=e.findFiles(n);if(e.id||(o=i),a){let e=(o[a]||[])[0];if(!e)return;Object.keys(i).forEach((n=>{i[n].forEach((n=>{Array.prototype.unshift.apply(n,e)}))}))}Object.keys(i).forEach((e=>{t[e]||=[],Array.prototype.push.apply(t[e],i[e])}))})),t},E=function(e,t,r){if(r)return e.user.userObject.findChannels(t);var o=[];return d(e).forEach((function(e){var n=e.findChannels(t);Array.prototype.push.apply(o,n)})),o=n.deduplicateString(o)},b=function(e,n,t){var r=d(e),o={};return r.some((function(e){if((o=e.getFileData(n,t))&&Object.keys(o).length)return!0})),o},A=function(t,r){var o;if(t.isHistoryMode&&!t.folders[r])o=!0;else if(!t.folders[r])return{};var a=o?{}:t.folders[r].proxy;Object.keys(a.metadata||{}).length>1&&(a.metadata={title:a.metadata.title});var i=n.clone(a.metadata||{});for(var c in t.user.proxy[e.SHARED_FOLDERS][r]||{})if(void 0!==t.user.proxy[e.SHARED_FOLDERS][r][c]){var s=n.clone(t.user.proxy[e.SHARED_FOLDERS][r][c]);if("href"===c&&-1===s.indexOf("#"))try{s=t.user.userObject.cryptor.decrypt(s)}catch(e){}"href"===c&&-1===s.indexOf("#")&&(s=void 0),i[c]=s}return i},_=function(e,n){var t,r={id:null,userObject:e.user.userObject,path:n};if(!Array.isArray(n)||n.length<=1)return r;for(var o=e.user.userObject,a=2;a<n.length;a++)if(t=o.find(n.slice(0,a)),o.isSharedFolder(t)){r={id:t,userObject:e.folders[t]?.userObject,path:n.slice(a)};break}return r},w=function(e,n){var t=[],r={};return n.forEach((function(n){var o=_(e,n);o.id?r[o.id]?r[o.id].push(o.path):r[o.id]=[o.path]:t.push(o.path)})),{main:t,folders:r}},O=function(e,n){var t=_(e,n);return"number"==typeof t.id&&t.id},D=function(e,n,t){if(!n||!O(e,n)){var r=b(e,t||e.user.userObject.find(n));if(r&&f(e,r.owners)){var o=r.channel;if(o)return Object.keys(e.folders).map((function(n){return e.folders[n].userObject})).some((function(e){return e.findChannels([o]).length}))}}},S=function(e,t,o){var a=[],i=[];return t.forEach((function(t,c){var s=o.find(t),u=[],l=t[t.length-1];if(o.isFile(s))u.push(s);else if(o.isSharedFolder(s)){u.push(s);var f=e.folders[s].proxy.metadata||{};f&&(l=f.title)}else{try{s=JSON.parse(JSON.stringify(s))}catch(e){return}o.getFilesRecursively(s,u)}if(u.some((function(e){return o.isSharedFolder(e)})))return e.cfg&&e.cfg.log&&e.cfg.log(r._getKey("fm_moveNestedSF",[l])),void i.unshift(c);u=n.deduplicateString(u);var d={};u.forEach((function(e){d[e]=o.getFileData(e)})),a.push({el:s,data:d,key:l})})),i.forEach((function(e){t.splice(e,1)})),a},T=function(e,n){var r;return v(e,n).some((function(e){if(e&&e.data&&e.data.href){var n=t.parsePadUrl(e.data.href),o=n.hashData;if(o&&"view"!==o.mode)return r=n.hash,!0}})),r},x=function(e,n,t){var r=w(e,n.paths),o=_(e,n.newPath),i=n.copy;o.userObject.isFolder(o.path)?a((function(n){if(r.main.length)if(o.id){var t=S(e,r.main,e.user.userObject),a=o.userObject;if(t.forEach((function(e){a.copyFromOtherDrive(o.path,e.el,e.data,e.key)})),i)return;r.main.length&&e.user.userObject.delete(r.main,n())}else e.user.userObject.move(r.main,o.path,n());var c=Object.keys(r.folders);c.length&&c.forEach((function(t){var a=Number(t),c=r.folders[a];if(o.id===a)o.userObject.move(c,o.path,n());else{var s=e.folders[a].userObject,u=o.userObject;if(S(e,c,s).forEach((function(e){u.copyFromOtherDrive(o.path,e.el,e.data,e.key)})),i)return;s.delete(c,n())}}))})).nThen((function(){t()})):t()},C=function(n,o,c){var s=_(n,(o=o||{}).path);if(s&&s.userObject)if(s.id)c({error:"EINVAL"});else if(n.pinPads){var u,l=o.folderData||{};a((function(){if(!o.folderData){var e=t.createRandomHash("drive",o.password),r=t.getSecrets("drive",e,o.password),a=t.getHashes(r);l={href:"/drive/#"+a.editHash,roHref:"/drive/#"+a.viewHash,channel:r.channel,lastTitle:o.name,ctime:+new Date},o.password&&(l.password=o.password),o.owned&&(l.owners=[n.edPublic])}})).nThen((function(e){n.Store.pad.getMetadata(null,{channel:l.channel},e((function(n){if(n&&(n.error||n.rejected))return e.abort(),void c({error:n.error||"ERESTRICTED"})})))})).nThen((function(e){n.pinPads([l.channel],e())})).nThen((function(e){n.user.userObject.pushSharedFolder(l,e((function(r,o){if("EEXISTS"===r&&l.href&&o){var a=t.parsePadUrl(l.href),s=t.getSecrets("drive",a.hash,l.password);return i.upgrade(s.channel,s),n.folders[o]&&n.folders[o].userObject.setReadOnly(!1,s.keys.secondaryKey),e.abort(),void c(o)}return"EEXISTS"===r&&o?(e.abort(),void c(o)):r?(e.abort(),void c(r)):void(u=o)})))})).nThen((function(t){n.user.userObject.add(u,s.path),n.loadSharedFolder(u,l,t((function(a){if(!a)return t.abort(),void c({error:"EDELETED"});a.proxy.metadata||(a.proxy.metadata={title:o.name||r.fm_newFolder}),o.folderData&&n.Store.pad.getMetadata(null,{channel:l.channel},(function(t){var r=n.user.proxy[e.SHARED_FOLDERS][u];t.owners&&(r.owners=t.owners),t.expire&&(r.expire=+t.expire)}))})),!Boolean(o.folderData))})).nThen((function(){n.onSync((function(){c(u)}))}))}else c({error:"EAUTH"});else c({error:"E_NOTFOUND"})},N=function(r,o,i){var c=(o=o||{}).resolved||w(r,o.paths);if(c.main.length||Object.keys(c.folders).length){if(o.paths&&1===o.paths.length&&o.paths[0][0]===e.SHARED_FOLDERS_TEMP)return delete n.find(r,["user","proxy",e.SHARED_FOLDERS_TEMP])[o.paths[0][1]],void r.onSync(i);var s=[];a((function(t){if(c.main.length){var o=r.user.userObject;n.find(r.settings,["drive","hideDuplicate"])&&c.main.forEach((function(n){var t=o.find(n);if(n[0]!==e.FILES_DATA&&!o.isFile(t)&&!o.isSharedFolder(t)){var a=[];o.getFilesRecursively(t,a),a.forEach((function(n){D(r,null,n)&&r.user.userObject.add(Number(n),[e.ROOT])}))}})),o.delete(c.main,t((function(e,n){r.unpinPads&&n&&Array.prototype.push.apply(s,n)})))}})).nThen((function(e){Object.keys(c.folders).forEach((function(n){r.folders[n].userObject.delete(c.folders[n],e((function(e,n){r.unpinPads&&n&&Array.prototype.push.apply(s,n)})))}))})).nThen((function(e){if(r.unpinPads){s=n.deduplicateString(s);var o=[];E(r,s).forEach((function(e){var n=b(r,e),a=[n.channel];n.answersChannel&&a.push(n.answersChannel),n.rtChannel&&a.push(n.rtChannel),n.lastVersion&&a.push(t.hrefToHexChannelId(n.lastVersion)),Array.prototype.push.apply(o,a)}));var a=[];s.forEach((function(e){-1===o.indexOf(e)&&(a.push(e),r.Store.checkDeletedPad(e))})),r.unpinPads(a,e((function(e){if(e&&e.error)return console.error(e.error)})))}})).nThen((function(){i()}))}else i({error:"E_NOTFOUND"})},I=function(t,r,i){var c=w(t,(r=r||{}).paths||[]);if(r.channel||c.main.length||Object.keys(c.folders).length){var s={main:[],folders:{}},u=function(r,a,i,c){var u,l=n.once(n.mkAsync(c)),f=r;if(!f&&a){var d=a.find(i);if(!a.isFile(d)&&!a.isSharedFolder(d))return;var h=a.isFile(d)?a.getFileData(d):A(t,d);f=h.channel}Object.keys(t.user.proxy[e.SHARED_FOLDERS]||{}).some((function(n){if((t.user.proxy[e.SHARED_FOLDERS][n]||{}).channel===f)return u=Number(n),t.folders[n].deleting=!0,!0})),t.removeOwnedChannel(f,(function(e){if(e&&e.error&&"ENOENT"!==e.error)return u&&t.folders[u]&&t.folders[u].deleting&&delete t.folders[u].deleting,o.send("ERROR_DELETING_OWNED_PAD="+f+"|"+e.error,!0),void l();var n=E(t,[f]);if(u&&n.push(u),!n.length)return s=void 0,void l();n.forEach((function(e){var n=m(t,e),r=w(t,n);Array.prototype.push.apply(s.main,r.main),Object.keys(r.folders).forEach((function(e){s.folders[e]?Array.prototype.push.apply(s.folders[e],r.folders[e]):s.folders[e]=r.folders[e]}))})),l()}))};a((function(e){r.channel&&u(r.channel,null,null,e()),c.main.forEach((function(n){u(null,t.user.userObject,n,e())})),Object.keys(c.folders).forEach((function(n){var r=t.folders[n].userObject;c.folders[n].forEach((function(n){u(null,r,n,e())}))}))})).nThen((function(){s?N(t,{resolved:s},i):i(),r.channel&&t.Store.refreshDriveUI()}))}else i({error:"E_NOTFOUND"})},R={move:x,restore:function(e,n,t){n=n||{},e.user.userObject.restore(n.path,t)},addFolder:function(e,n,t){var r=_(e,(n=n||{}).path);r&&r.userObject?r.userObject.addFolder(r.path,n.name,(function(n){if(n.newPath&&r.id){var o=p(e,r.userObject);o&&Array.prototype.unshift.apply(n.newPath,o)}t(n)})):t({error:"E_NOTFOUND"})},addSharedFolder:C,addLink:function(e,n,t){var r=_(e,(n=n||{}).path);if(r&&r.userObject){var o=r.userObject,a=+new Date;o.pushLink({name:n.name,href:n.href,atime:a,ctime:a},(function(n,a){n?t({error:n}):(o.add(a,r.path),e.onSync(t))}))}else t({error:"E_NOTFOUND"})},restoreSharedFolder:function(r,o,i){var c=o.id,s=o.password,u=n.find(r,["user","proxy",e.SHARED_FOLDERS_TEMP]),l=u&&u[c];if(l)if(r.Store){var f=r.user.userObject.getHref?r.user.userObject.getHref(l):l.href,d=!1;a((function(e){r.Store.isNewChannel(null,{href:f,password:s},e((function(e){d=!(!e||e.error)&&e.isNew})))})).nThen((function(){if(d)i({error:"ENOTFOUND"});else{var e=n.clone(l),o=t.parsePadUrl(f),a=t.getSecrets(o.type,o.hash,s);e.password=s,e.channel=a.channel,a.keys.editKeyStr&&(e.href="/drive/#"+t.getEditHashFromKeys(a)),e.roHref="/drive/#"+t.getViewHashFromKeys(a),delete e.legacy,C(r,{path:["root"],folderData:e},(function(){delete u[c],r.onSync(i)}))}}))}else i({error:"ESTORE"});else i({error:"EINVAL"})},convertFolderToSharedFolder:function(n,t,r){var o=t.path,i=n.user.userObject.find(o);if(o.length<=1||o[0]!==e.ROOT)r({error:"E_INVAL_PATH"});else if(O(n,o))r({error:"E_INVAL_NESTING"});else if(n.user.userObject.hasSubSharedFolder(i))r({error:"E_INVAL_NESTING"});else{var c,s=o.slice(0,-1),u=n.user.userObject.find(s),l=o[o.length-1];a((function(e){C(n,{path:s,name:l,owned:t.owned,password:t.password||""},e((function(n){if("object"==typeof n&&n&&n.error)return e.abort(),void r(n);c=n})))})).nThen((function(t){if(!c)return t.abort(),void r({error:"E_NO_ID"});var a,l=[];for(var f in i)(n.user.userObject.isFolder(i[f])||n.user.userObject.isFile(i[f]))&&l.push(o.concat(f));if(Object.keys(u).some((function(e){if(u[e]===c)return a=e,!0})),!a)return t.abort(),void r({error:"E_NO_KEY"});var d=s.concat(a).concat(e.ROOT);x(n,{paths:l,newPath:d,copy:!1},t())})).nThen((function(t){var r=[];Object.keys(i).forEach((function(e){if(n.user.userObject.isFile(i[e])){var t=n.user.userObject.getFileData(i[e]);t&&f(n,t.owners)&&r.push(o.concat(e))}})),x(n,{paths:r,newPath:[e.ROOT],copy:!1},t())})).nThen((function(){var t=n.user.proxy[e.SHARED_FOLDERS][c],a=n.user.userObject.getFolderData(i);for(var s in a)"metadata"!==s&&(t[s]=a[s]);n.user.userObject.delete([o],(function(){r({fId:c})}))}))}},delete:N,deleteOwned:I,emptyTrash:function(e,t,r){a((function(r){if(t&&t.deleteOwned){var i=e.user.userObject.ownedInTrash((function(n){return f(e,n)})),c=a;i.forEach((function(n){c=c((function(t){e.removeOwnedChannel(n,t((function(e){setTimeout(t(),50),e&&e.error&&"ENOENT"!==e.error&&(console.error(e.error,n),o.send("ERROR_EMPTYTRASH_OWNED="+n+"|"+e.error,!0)),console.warn("DELETED",n)})))})).nThen})),c(r())}e.user.userObject.emptyTrash(r((function(t,o){var i=a;setTimeout(r((function(){if(Array.isArray(o)){var t=r(),a=n.deduplicateString(o),c=[];a.forEach((function(n){i=i((function(t){v(e,n,!0).length||c.push(n),e.Store.checkDeletedPad(n,t())})).nThen})),i((function(){e.unpinPads(c,(function(){t()}))}))}})))})))})).nThen(r)},rename:function(n,t,o){var a=_(n,(t=t||{}).path);if(a&&a.userObject){if(!a.id){var i=n.user.userObject.find(a.path);if(n.user.userObject.isSharedFolder(i)&&n.folders[i])return n.folders[i].proxy.metadata.title=t.newName||r.fm_folder,n.user.proxy[e.SHARED_FOLDERS][i].lastTitle=t.newName||r.fm_folder,void o()}a.userObject.rename(a.path,t.newName,o)}else o({error:"E_NOTFOUND"})},setFolderData:function(n,t,r){var o=_(n,(t=t||{}).path);if(o&&o.userObject){if(!o.id){var a=n.user.userObject.find(o.path);if(n.user.userObject.isSharedFolder(a)&&n.folders[a])return n.user.proxy[e.SHARED_FOLDERS][a][t.key]=t.value,void n.onSync(r)}o.userObject.setFolderData(o.path,t.key,t.value,(function(){n.onSync(r)}))}else r({error:"E_NOTFOUND"})},updateStaticAccess:function(e,n,t){h(e,n).getFileData(n,!0).atime=+new Date,e.onSync(t)}},P=function(e,n,t){var r=n.cmd,o=n.data||{},a=R[r];"function"!=typeof a?t():a(e,o,t)},k=function(n,t,r){if(r=r||function(){},t.attr&&t.attr.trim()){var o=n.user.userObject.getSFIdFromHref(t.href);o&&("href"===t.attr&&(t.value=n.user.userObject.cryptor.encrypt(t.value)),n.user.proxy[e.SHARED_FOLDERS][o][t.attr]=t.value);var i=y(n,t.href),c=a;i.forEach((function(e){c=c((function(n){e.userObject.setPadAttribute(t.href,t.attr,t.value,n())})).nThen})),c((function(){r()}))}else r("E_INVAL_ATTR")},M=function(e,n,t){t=t||function(){};var r=e.user.userObject.getSFIdFromHref(n.href);if(r){var o=A(e,r),a=n.attr?o[n.attr]:JSON.parse(JSON.stringify(o));setTimeout((function(){t(null,{value:a,atime:1})}))}else{var i=y(e,n.href),c={};i.forEach((function(e){var t=e.data.atime,r=n.attr?e.data[n.attr]:JSON.parse(JSON.stringify(e.data));(!c.value||c.atime<t)&&(c.atime=t,c.value=r)})),setTimeout((function(){t(null,c)}))}},F=function(e){var n={};return d(e).forEach((function(e){var t=e.getTagsList();Object.keys(t).forEach((function(e){n[e]=n[e]?n[e]+t[e]:t[e]}))})),n},L=function(e,n){var t=d(e),r=[],o=[];return t.forEach((function(e){var t=e.getFiles(n).map((function(n){return{id:n,data:e.getFileData(n)}})).filter((function(e){if(-1===o.indexOf(e.data.channel||e.id))return o.push(e.data.channel||e.id),!0}));Array.prototype.push.apply(r,t)})),r},K=function(e){return e.filter((function(e){if("string"==typeof e)return-1!==[32,48].indexOf(e.length)}))},H=function(n,r){var o=[],a=function(e){return"expirable"===r?function(t){var r=e.getFileData(t);r&&-1===o.indexOf(r.channel)&&(function(e,n){return Array.isArray(n)&&n.length&&(!e.edPublic||-1===n.indexOf(e.edPublic))}(n,r.owners)||r.expire&&r.expire<+new Date)&&o.push(r.channel)}:"owned"===r?function(t){var r=e.getFileData(t);r&&-1===o.indexOf(r.channel)&&f(n,r.owners)&&o.push(r.channel)}:"pin"===r?function(n){var r=e.getFileData(n);if(r){if(r.lastVersion){var a=t.hrefToHexChannelId(r.lastVersion);-1===o.indexOf(a)&&o.push(a)}r.answersChannel&&-1===o.indexOf(r.answersChannel)&&o.push(r.answersChannel),r.rtChannel&&-1===o.indexOf(r.rtChannel)&&o.push(r.rtChannel),r.ooImages&&Array.isArray(r.ooImages)&&Array.prototype.push.apply(o,r.ooImages),-1===o.indexOf(r.channel)&&o.push(r.channel)}}:void 0};if("owned"===r&&!n.edPublic)return K(o);if("pin"===r&&!n.edPublic)return K(o);if(d(n).forEach((function(n){n.getFiles([e.FILES_DATA]).forEach(a(n))})),"owned"===r){var i=Object.keys(n.user.proxy[e.SHARED_FOLDERS]).filter((function(t){var r=n.user.proxy[e.SHARED_FOLDERS][t].owners;if(f(n,r))return!0})).map((function(t){return n.user.proxy[e.SHARED_FOLDERS][t].channel}));Array.prototype.push.apply(o,i)}if("pin"===r){var c=Object.keys(n.folders).map((function(t){try{return n.user.proxy[e.SHARED_FOLDERS][t].channel}catch(e){console.error(e)}})).filter(Boolean);Array.prototype.push.apply(o,c)}return K(o)},j=function(e,n,t,r){var o=e.user.userObject,i=["root"];if(n){var c=_(e,n);o=c.userObject,i=c.path}var s=function(){var e;a((function(n){o.pushData(t,n((function(n,t){n?e=n:o.add(t,i)})))})).nThen((function(){r(e)}))};e.pinPads?e.pinPads([t.channel],(function(e){e&&e.error?r(e.error):s()})):s()},U=function(e,n,t,r){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"rename",data:{path:n,newName:t}},r)},B=function(e,n,t,r,o){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"move",data:{paths:n,newPath:t,copy:o}},r)},V=function(e,n,t){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"emptyTrash",data:{deleteOwned:n}},t)},Y=function(e,n,t,r){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"addFolder",data:{path:n,name:t}},r)},G=function(e,n,t,r){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"addSharedFolder",data:{path:n,name:t.name,owned:t.owned,password:t.password}},r)},J=function(e,n,t,r){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"addLink",data:{path:n,name:t.name,href:t.url}},r)},q=function(e,n,t,r){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"restoreSharedFolder",data:{id:n,password:t}},r)},W=function(e,n,t,r,o){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"convertFolderToSharedFolder",data:{path:n,owned:t,password:r}},o)},z=function(e,n,t){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"delete",data:{paths:n}},t)},Q=function(e,n,t){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"deleteOwned",data:{paths:n}},t)},X=function(e,n,t){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"restore",data:{path:n}},t)},Z=function(e,n,t){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"setFolderData",data:n},t)},$=function(e,n,t){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"updateStaticAccess",data:n},t)},ee=E,ne=b,te=p,re=function(e,n,t){if(t)return e.folders[t].userObject.find(n);var r=_(e,n);return r.userObject.find(r.path)},oe=function(e,n,t){var r=h(e,n);return String(r.getTitle(n,t))},ae=function(e,n){return h(e,n).isStaticFile(n)},ie=function(e,n){return h(e,n).isReadOnlyFile(n)},ce=function(e,t){var r=[];return d(e).forEach((function(e){Array.prototype.push.apply(r,e.getFiles(t))})),r=n.deduplicateString(r)},se=function(e,n){var t=[];return d(e).forEach((function(r){var o=p(e,r),a=r.search(n);a.length&&(o&&a.forEach((function(e){e.inSharedFolder=!0,e.paths.forEach((function(e){Array.prototype.unshift.apply(e,o)}))})),Array.prototype.push.apply(t,a))})),t},ue=function(n){var t=[];return d(n).forEach((function(n){var r=n.getFiles([e.FILES_DATA,e.STATIC_DATA]).map((function(e){return[Number(e),n.getFileData(e)]}));Array.prototype.push.apply(t,r)})),t.filter((function(e){return e[1].atime})).sort((function(e,n){return n[1].atime-e[1].atime}))},le=function(e){return e.user.userObject.getOwnedPads(e.edPublic)},fe=function(e,n){e.isHistoryMode=Boolean(n)},de=function(e,n){var t=_(e,n);if(!t||!t.userObject)return{};if(!t.id){var r=e.user.userObject.find(t.path);if(e.user.userObject.isSharedFolder(r))return A(e,r)}var o=t.userObject.find(t.path);return t.userObject.getFolderData(o)},he=O,pe=function(e,n){return e.user.userObject.isValidDrive(n)},ve=function(e,n,t){return e.user.userObject.isFile(n,t)},ye=function(e,n){return e.user.userObject.isFolder(n)},me=function(e,n){return e.user.userObject.isSharedFolder(n)},ge=function(e,n){if(e.folders[n]){var t=e.folders[n].userObject;return t.isFolderEmpty(t.find[t.ROOT])}return e.user.userObject.isFolderEmpty(n)},Ee=function(e,n,t){return e.user.userObject.isPathIn(n,t)},be=function(e,n,t){return e.user.userObject.isSubpath(n,t)},Ae=function(e,n){return e.user.userObject.isInTrashRoot(n)},_e=function(e,n,t){return e.user.userObject.comparePath(n,t)},we=function(e,n,t){if(e.folders[n]){var r=e.folders[n].userObject;return r.hasSubfolder(r.find[r.ROOT])}return e.user.userObject.hasSubfolder(n,t)},Oe=function(e,n){return e.user.userObject.hasSubSharedFolder(n)},De=function(e,n,t){if(e.folders[n]){var r=e.folders[n].userObject;return r.hasFile(r.find[r.ROOT])}return e.user.userObject.hasFile(n,t)},Se=function(e){return e.user.userObject.ownedInTrash((function(n){return f(e,n)}))},Te=D;return{setCustomize:n=>{r=n.Messages,e.setCustomize(n)},create:function(n,t,r){var o={pinPads:t.pin,unpinPads:t.unpin,onSync:t.onSync,Store:t.Store,store:t.store,removeOwnedChannel:t.removeOwnedChannel,loadSharedFolder:t.loadSharedFolder,cfg:r,edPublic:t.edPublic,settings:t.settings,user:{proxy:n},folders:{}};r.removeProxy=function(e){s(o,e)},o.user.userObject=e.init(n,r);var a=function(e){return function(){return[].unshift.call(arguments,o),e.apply(null,arguments)}};return{addProxy:a(c),removeProxy:a(s),deprecateProxy:a(u),restrictedProxy:a(l),addSharedFolder:a(C),addPin:function(e,n){o.pinPads=e,o.unpinPads=n},removePin:function(){delete o.pinPads,delete o.unpinPads},command:a(P),getPadAttribute:a(M),setPadAttribute:a(k),getTagsList:a(F),getSecureFilesList:a(L),getSharedFolderData:a(A),getChannelsList:a(H),addPad:a(j),delete:a(N),deleteOwned:a(I),findChannel:a(v),findHref:a(y),findFile:a(m),getEditHash:a(T),user:o.user,folders:o.folders}},createInner:function(n,t,r,o){var a={cfg:o,sframeChan:t,edPublic:r,user:{proxy:n,userObject:e.init(n,o)},folders:{}},i=function(e){return function(){return[].unshift.call(arguments,a),e.apply(null,arguments)}};return{addProxy:i(c),removeProxy:i(s),setHistoryMode:i(fe),rename:i(U),move:i(B),emptyTrash:i(V),addFolder:i(Y),addSharedFolder:i(G),addLink:i(J),restoreSharedFolder:i(q),convertFolderToSharedFolder:i(W),delete:i(z),deleteOwned:i(Q),restore:i(X),setFolderData:i(Z),updateStaticAccess:i($),getFileData:i(ne),find:i(re),getTitle:i(oe),isReadOnlyFile:i(ie),isStaticFile:i(ae),getFiles:i(ce),search:i(se),getRecentPads:i(ue),getOwnedPads:i(le),getTagsList:i(F),findFile:i(m),findFiles:i(g),findChannels:i(ee),getSharedFolderData:i(A),getFolderData:i(de),isInSharedFolder:i(he),getUserObjectPath:i(te),isDuplicateOwned:i(Te),ownedInTrash:i(Se),isValidDrive:i(pe),isFile:i(ve),isFolder:i(ye),isSharedFolder:i(me),isFolderEmpty:i(ge),isPathIn:i(Ee),isSubpath:i(be),isInTrashRoot:i(Ae),comparePath:i(_e),hasSubfolder:i(we),hasSubSharedFolder:i(Oe),hasFile:i(De),user:a.user,folders:a.folders}}}};e.exports&&(e.exports=n(Be(),ee(),ae(),void 0,De(),We(),ze()))})()}(Fe)),Fe.exports}var Xe,Ze,$e=Qe(),en=n({__proto__:null,default:r($e)},[$e]),nn=Be(),tn=n({__proto__:null,default:r(nn)},[nn]),rn={exports:{}},on={exports:{}};function an(){return Ze||(Ze=1,function(e){e.exports&&(e.exports=((e={},n={},t)=>{let r=[];const o=["sheet","doc","presentation"],a=a=>{e=a.AppConfig;const i=(n=a.ApiConfig).onlyOffice&&n.onlyOffice.availableVersions.includes(t.currentVersion);r=e.availablePadTypes.filter((e=>i||!o.includes(e)))};Object.keys(e).length&&a({AppConfig:e,ApiConfig:n});const i={OO_APPS:o,setCustomize:a};return i.__defineGetter__("availableTypes",(function(){return n.appsToDisable?r.filter((e=>!n.appsToDisable.includes(e))):r})),i.__defineGetter__("appsToSelect",(function(){return r.filter((e=>!["drive","teams","file","contacts","convert"].includes(e)))})),i.isAvailable=e=>Array.isArray(i.availableTypes)&&i.availableTypes.includes(e),i})(void 0,void 0,(Xe||(Xe=1,function(e){e.exports&&(e.exports={currentVersionNumber:8,currentVersion:"v8"})}(on)),on.exports)))}(rn)),rn.exports}var cn,sn,un=an(),ln=n({__proto__:null,default:r(un)},[un]),fn={exports:{}},dn={exports:{}};function hn(){return cn||(cn=1,function(e){(()=>{const n=(e,n,t={},r,o)=>{const a=function(){if(Object.keys(t).length){var e,n=new URL(t.httpUnsafeOrigin);try{return(e=new URL(t.websocketPath,t.httpUnsafeOrigin)).protocol=n.protocol,e.origin}catch(e){return console.error(e),t.httpUnsafeOrigin}}};var i=a();var c=e=>JSON.parse(JSON.stringify(e)),s=function(e,t,r){var o=n.once(n.mkAsync(r));fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then((e=>{e.ok?e.text().then((e=>{o(void 0,n.tryParse(e))})):e.json().then().then((n=>{o(e.status,n)}))})).catch((e=>{o(e)}))},u=function(t,r,a){var u=c(r);u.publicKey=n.encodeBase64(t.publicKey),u.nonce=n.encodeBase64(o.CryptoAgility.bytes(24));var l,f,d=new URL("/api/auth/",i);e((function(e){s(d,u,e(((n,t)=>n?(e.abort(),console.error(n),t&&console.error(t),void a(n)):t.date&&t.txid?(l=t.txid,void(f=t.date)):(e.abort(),void a("REQUEST_REJECTED")))))})).nThen((function(e){var r=c(u);r.txid=l,r.date=f;var i=n.decodeUTF8(JSON.stringify(r)),h=o.CryptoAgility.signDetached(i,t.secretKey),p=n.encodeBase64(h);s(d,{sig:p,txid:l},e(((n,t)=>{if(n)return e.abort(),console.error(n),t&&console.error(t),void a("RESPONSE_REJECTED",t);a(void 0,t)})))}))};return u.setCustomize=e=>{t=e.ApiConfig,i=a()},u};e.exports&&(e.exports=n(We(),ee(),void 0,h(),K()))})()}(dn)),dn.exports}function pn(){return sn||(sn=1,function(e){e.exports&&(e.exports=((e,n={},t,r,o)=>{var a={setCustomize:e=>{n=e.ApiConfig,t.setCustomize(e)}};a.join=e.uint8ArrayJoin,a.seed=function(){return o.CryptoAgility.createHash(e.decodeUTF8("pewpewpew"))},a.genkeys=function(e){if(!(e instanceof Uint8Array))throw new Error("INVALID_SEED_FORMAT");if(!e||"number"!=typeof e.length||e.length<64)throw new Error("INVALID_SEED_LENGTH");var n=e.subarray(0,o.CryptoAgility.signSeedLength()),t=e.subarray(o.CryptoAgility.signSeedLength(),o.CryptoAgility.signSeedLength()+o.CryptoAgility.secretboxKeyLength()),a=o.CryptoAgility.signKeyPairFromSeed(n),i=null;if(o.PQC&&o.PQC.ml_dsa)try{var c=r.hash(e).subarray(0,32);i=o.PQC.ml_dsa.ml_dsa44.internal.keygen(c)}catch(e){console.error("Failed to generate post-quantum keys:",e),i=null}return{sign:a,pqSignPair:i,symmetric:t,hasPQ:null!==i}},a.keysToRPCFormat=function(n){try{var t=n.sign,r=n.pqSignPair;return{edPrivate:e.encodeBase64(t.secretKey),edPublic:e.encodeBase64(t.publicKey),dsaPrivate:e.encodeBase64(r.secretKey),dsaPublic:e.encodeBase64(r.publicKey)}}catch(e){return void console.error(e)}},a.encrypt=function(n,t,r){var i=e.decodeUTF8(t),c=o.CryptoAgility.bytes(o.CryptoAgility.secretboxNonceLength());return a.join([[0],c,o.CryptoAgility.secretbox(i,c,r.symmetric)])},a.decrypt=function(n,t){var r=n.subarray(1,1+o.CryptoAgility.secretboxNonceLength()),a=n.subarray(1+o.CryptoAgility.secretboxNonceLength()),i=o.CryptoAgility.secretboxOpen(a,r,t.symmetric);try{return JSON.parse(e.encodeUTF8(i))}catch(e){return void console.error(e)}},a.sign=function(e,n){var t=o.CryptoAgility.createHash(e);if(n.hasPQ&&n.pqSignPair)try{var r=o.CryptoAgility.signDetached(t,n.sign.secretKey),a=o.PQC.ml_dsa.ml_dsa44.internal.sign(n.pqSignPair.secretKey,t);console.log("Hybrid signature created successfully:");var i=new Uint8Array(1+r.length+4+a.length);return i[0]=1,i.set(r,1),new DataView(i.buffer).setUint32(1+r.length,a.length,!1),i.set(a,1+r.length+4),i}catch(e){console.error("PQ signing failed, falling back to classical:",e)}r=o.CryptoAgility.signDetached(t,n.sign.secretKey);var c=new Uint8Array(r.length+1);return c[0]=0,c.set(r,1),c},a.serialize=function(n,t){var r=a.encrypt(0,n,t),o=a.sign(r,t);return{publicKey:e.encodeBase64(t.sign.publicKey),pqPublicKey:e.encodeBase64(t.pqSignPair.publicKey),signature:e.encodeBase64(o),ciphertext:e.encodeBase64(r)}},a.proveAncestor=function(n){var t=e.find(n,["sign","publicKey"]);try{let r=[t,a.sign(t,n)].map(e.encodeBase64);return n.pqSignPair&&n.pqSignPair.publicKey&&r.push(e.encodeBase64(n.pqSignPair.publicKey)),JSON.stringify(r)}catch(e){return void console.error(e)}};var i=function(n){return e.encodeBase64(n).replace(/\//g,"-")};a.getBlockUrl=function(e){var t=i(e.sign.publicKey);return(n.fileHost||n.httpUnsafeOrigin||window.location.origin)+"/block/"+t.slice(0,2)+"/"+t},a.getBlockHash=function(e){return a.getBlockUrl(e)+"#"+i(e.symmetric)};var c=function(n){try{return e.decodeBase64(n.replace(/\-/g,"/"))}catch(e){return void console.error(e)}};return a.parseBlockHash=function(e){if("string"==typeof e){var n=e.split("#");if(2===n.length)try{return{href:n[0],keys:{symmetric:c(n[1])}}}catch(e){return void console.error(e)}}},a.checkRights=function(n,r){const o=e.mkAsync(r),{blockKeys:a,auth:i}=n;var c="MFA_CHECK";i&&i.type&&(c=`${i.type.toUpperCase()}_`+c),t(a.sign,{command:c,auth:i&&i.data},o)},a.writeLoginBlock=function(e,n){const{content:r,blockKeys:o,oldBlockKeys:i,auth:c,pw:s,session:u,token:l,userData:f}=e;var d="WRITE_BLOCK";c&&c.type&&(d=`${c.type.toUpperCase()}_`+d);var h=a.serialize(JSON.stringify(r),o);h.auth=c&&c.data,h.hasPassword=s,h.registrationProof=i&&a.proveAncestor(i),l&&(h.inviteToken=l),f&&(h.userData=f),t(o.sign,{command:d,content:h,session:u},n)},a.removeLoginBlock=function(e,n){const{reason:r,blockKeys:o,auth:a,edPublic:i}=e;var c="REMOVE_BLOCK";a&&a.type&&(c=`${a.type.toUpperCase()}_`+c),t(o.sign,{command:c,auth:a&&a.data,edPublic:i,reason:r},n)},a.updateSSOBlock=function(e,n){const{blockKeys:r,oldBlockKeys:o}=e;var i=o&&a.proveAncestor(o);t(r.sign,{command:"SSO_UPDATE_BLOCK",ancestorProof:i},n)},a})(ee(),void 0,hn(),h(),K()))}(fn)),fn.exports}var vn,yn,mn,gn=pn(),En=n({__proto__:null,default:r(gn)},[gn]),bn={exports:{}};function An(){return vn||(vn=1,function(e){var n;n=function(){var e=function(n){if(Array.isArray(n))return n.map(e);if(n instanceof Object){var t=[],r=[];return Object.keys(n).forEach((function(e){/^(0|[1-9][0-9]*)$/.test(e)?t.push(+e):r.push(e)})),t.sort((function(e,n){return e-n})).concat(r.sort()).reduce((function(t,r){return t[r]=e(n[r]),t}),{})}return n},n=JSON.stringify.bind(JSON);return function(t,r,o){var a=n(t,r,0);if(!a||"{"!==a[0]&&"["!==a[0])return a;var i=JSON.parse(a);return n(e(i),null,o)}},e.exports?e.exports=n():JSON.sortify=n()}(bn)),bn.exports}function _n(){if(mn)return yn;mn=1;var e,n,t,r,o,a,i,c;return K(),e=ae(),n=ee(),q(),t=je(),o=(r={}).createData=function(t,r){var o={channel:r||e.createChannelId(),displayName:t["cryptpad.username"],profile:t.profile&&t.profile.view,edPublic:t.edPublic,curvePublic:t.curvePublic,dsaPublic:t.dsaPublic,kemPublic:t.kemPublic,notifications:n.find(t,["mailboxes","notifications","channel"]),avatar:t.profile&&t.profile.avatar,badge:t.profile&&t.profile.badge,uid:t.uid};return!1===r&&delete o.channel,o},a=r.getFriend=function(e,n){if(n){if(n===e.curvePublic){var t=o(e);return delete t.channel,t}return e.friends?e.friends[n]:void 0}},i=r.getFriendList=function(e){return e.friends||(e.friends={}),e.friends},c=function(e,n){Object.keys(e).forEach((function(t){"me"!==t&&n(e[t],t,e)}))},r.getFriendChannelsList=function(e){var n=[];return c(e.friends,(function(e){n.push(e.channel)})),n},r.declineFriendRequest=function(e,n,t){e.mailbox.sendTo("DECLINE_FRIEND_REQUEST",{},{channel:n.notifications,curvePublic:n.curvePublic},(function(e){t(e)}))},r.acceptFriendRequest=function(e,n,t){var r=a(e.proxy,n.curvePublic)||{},i=o(e.proxy,r.channel||n.channel);e.mailbox.sendTo("ACCEPT_FRIEND_REQUEST",{user:i},{channel:n.notifications,curvePublic:n.curvePublic},(function(e){t(e)}))},r.addToFriendList=function(e,n,r){var o=e.proxy,a=i(o),c=n.curvePublic;c!==o.curvePublic?(a[c]=n,t.whenRealtimeSyncs(e.realtime,(function(){r(),e.pinPads([n.channel],(function(e){e.error&&console.error(e.error)}))}))):r("E_MYKEY")},r.updateMyData=function(e,t){var r=o(e.proxy,!1);e.proxy.friends&&(e.proxy.friends.me=n.clone(r),delete e.proxy.friends.me.channel),e.modules.team&&e.modules.team.updateMyData(r);var i=function(n){n&&n.notifications&&(delete n.user,r.channel=n.channel,e.mailbox.sendTo("UPDATE_DATA",r,{channel:n.notifications,curvePublic:n.curvePublic},(function(e){e&&e.error&&console.error(e)})))};t?i(a(e.proxy,t)):c(e.proxy.friends||{},i)},r.removeFriend=function(e,n,r){var o=e.proxy,a=o.friends[n];a?a.notifications?e.mailbox.sendTo("UNFRIEND",{curvePublic:o.curvePublic},{channel:a.notifications,curvePublic:a.curvePublic},(function(i){i&&i.error?r(i):(e.messenger.onFriendRemoved(n,a.channel),delete o.friends[n],t.whenRealtimeSyncs(e.realtime,(function(){r(i)})))})):r({error:"EINVAL"}):r({error:"ENOENT"})},yn=r}var wn,On,Dn,Sn={exports:{}},Tn={exports:{}},xn={exports:{}};function Cn(){return wn||(wn=1,function(e){var n,t,r,o,a,i,c,s,u,l,f,d;e.exports&&(e.exports=(n=ee(),h(),t=K(),r=n.uid,o=n.tryParse,a=function(e,r){var o=n.decodeUTF8(JSON.stringify(e));return n.encodeBase64(t.CryptoAgility.signDetached(o,r))},i=function(e,n,t){if("function"!=typeof t)throw new Error("expected callback");var o=e.network,a=o.historyKeeper;if("string"==typeof a){var i=r(),c=e.pending[i]=function(e,n){t(e,n)};return c.data=n,c.called=0,o.sendto(a,JSON.stringify([i,n]))}t("NO_HISTORY_KEEPER")},c=[],s=[],u=function(e){var n={network:e,connected:!0,anon:void 0,authenticated:[]};return c.push(e),s.push(n),e.on("message",(function(t,r){r===e.historyKeeper&&function(e,n){"string"!=typeof n&&console.error("received non-string message [%s]",n);var t=o(n);if(t){if(Array.isArray(t)&&!/(FULL_HISTORY|HISTORY_RANGE)/.test(t[0])){var r=t[0];"string"==typeof r&&(function(e,n){return!!e.anon&&"function"==typeof e.anon.pending[n]}(e,r)?function(e,n,t){var r=e.pending[n];"ERROR"===t[0]?r(t[1]):r(void 0,t.slice(1)),delete e.pending[n]}(e.anon,r,t.slice(1)):e.authenticated.some((function(e){var n=e.pending[r];return"function"==typeof n&&("ERROR"!==t[1]?(/\|/.test(t[1])&&e.cookie!==t[1]&&(e.cookie=t[1]),n(void 0,t.slice(2)),delete e.pending[r],!0):"NO_COOKIE"===t[2]?(e.send("COOKIE","",(function(t){if(t)return console.error(t),void n(t);e.resend(r)&&delete e.pending[r]})),!0):(n(t[2]),delete e.pending[r],!0))}))||console.error("UNHANDLED RPC MESSAGE",n))}}else console.error(new Error("could not parse message: %s",n))}(n,t)})),e.on("disconnect",(function(){n.connected=!1,n.anon&&(n.anon.connected=!1),n.authenticated.forEach((function(e){e.connected=!1}))})),e.on("reconnect",(function(){n.anon&&(n.anon.connected=!0),n.authenticated.forEach((function(e){e.connected=!0}))})),n},l=function(e){var n;return c.some((function(t,r){return e===t&&(n=r,!0)})),s[n]?s[n]:u(e)},f=function(e,t){if(!e)throw new Error("expected network context");var o,c=t.publicKeyString;return e.authenticated.some((function(e,n){return e.publicKey===c&&(o=n,!0)})),e.authenticated[o]?e.authenticated[o]:function(e,t){var o={network:e.network,publicKey:t.publicKeyString,timeouts:{},pending:{},cookie:null,connected:!0},c=o.send=function(e,r,c){var s=n.mkAsync(c);if(o.connected||"COOKIE"===e){var u=[e,r];o.cookie&&o.cookie.join?u.unshift(o.cookie.join("|")):u.unshift(o.cookie);var l=a(u,t.signKey);return u.unshift(t.publicKeyString),u.unshift(l),i(o,u,s)}s("DISCONNECTED")};return o.resend=function(e){var n=o.pending[e];if(n.called)return console.error("[%s] called too many times",e),!0;n.called++,n.data[2]=o.cookie,n.data[0]=a(n.data.slice(2),t.signKey);var i=r();o.pending[i]=n,delete o.pending[e];try{return o.network.sendto(o.network.historyKeeper,JSON.stringify([i,n.data]))}catch(e){console.log("failed to resend"),console.error(e)}},c.unauthenticated=function(e,r,a){var c=n.mkAsync(a);if(o.connected){var s=[null,t.publicKeyString,null,e,r];return o.cookie&&o.cookie.join?s[2]=o.cookie.join("|"):s[2]=o.cookie,i(o,s,c)}c("DISCONNECTED")},o.destroy=function(){Object.keys(o.timeouts).forEach((function(e){clearTimeout(e)}));var n=e.authenticated.indexOf(o);-1!==n&&e.authenticated.splice(n,1)},e.authenticated.push(o),o}(e,t)},d=function(e){return e.anon||function(e){var t={network:e.network,timeouts:{},pending:{},connected:!0};return e.anon=t,t.send=function(e,r,o){var a=n.mkAsync(o);if(t.connected)return i(t,[e,r],a);a("DISCONNECTED")},t.resend=function(e){var n=t.pending[e];if(n.called)return console.error("[%s] called too many times",e),!0;n.called++;try{return t.network.sendto(t.network.historyKeeper,JSON.stringify([e,n.data]))}catch(e){console.log("failed to resend"),console.error(e)}},t.destroy=function(){Object.keys(t.timeouts).forEach((function(e){clearTimeout(e)})),e.anon=void 0},t}(e)},{create:function(e,t,r,o){if("function"!=typeof o)throw new Error("expected callback");var a,i=n.mkAsync(o);try{if(64!==(a=n.decodeBase64(t)).length)throw new Error("private key did not match expected length of 64")}catch(e){return void i(e)}try{if(32!==n.decodeBase64(r).length)return void i("expected public key to be 32 uint")}catch(e){return void i(e)}if(e){var c=l(e),s=f(c,{publicKeyString:r,signKey:a});s.send("COOKIE","",(function(e){e?i(e):i(void 0,{send:s.send,destroy:s.destroy})}))}else i("NO_NETWORK")},createAnonymous:function(e,t){var r=n.mkAsync(t);if("function"!=typeof r)throw new Error("expected callback");if(e){var o=d(l(e));r(void 0,{send:o.send,destroy:o.destroy})}else r("NO_NETWORK")}}))}(xn)),xn.exports}function Nn(){return On||(On=1,function(e){var n,t;e.exports&&(e.exports=(n=ee(),t=Cn(),{create:function(e,r,o,a){if("function"!=typeof o)throw new Error("Expected callback");var i=n.once(n.mkAsync(o));if(e)if(r){var c=r.edPrivate,s=r.edPublic;c&&s?t.create(e,c,s,(function(e,t){if(e)i(e);else{var r={};r.destroy=t.destroy,r.publicKey=s,r.send=t.send,r.pin=function(e,r){var o=n.once(n.mkAsync(r));Array.isArray(e)?t.send("PIN",e,o):o("[TypeError] pin expects an array")},r.unpin=function(e,r){var o=n.once(n.mkAsync(r));Array.isArray(e)?t.send("UNPIN",e,o):o("[TypeError] pin expects an array")},r.adminRpc=function(e,n){if(e.cmd){var r=[e.cmd,e.data];t.send("ADMIN",r,n)}else setTimeout((function(){n("[TypeError] admin rpc expects a command")}))},r.getServerHash=function(e){t.send("GET_HASH",s,(function(n,t){t&&t[0]?e(n,Array.isArray(t)&&t[0]||void 0):e("NO_HASH_RETURNED")}))},r.reset=function(e,r){var o=n.once(n.mkAsync(r));Array.isArray(e)?t.send("RESET",e,o):o("[TypeError] pin expects an array")},r.getFileListSize=function(e){t.send("GET_TOTAL_SIZE",void 0,(function(n,t){n?e(n):t&&t.length&&"number"==typeof t[0]?e(void 0,t[0]):e("INVALID_RESPONSE")}))},r.updatePinLimits=function(e){t.send("UPDATE_LIMITS",void 0,(function(n,t){n?e(n):t&&t.length&&"number"==typeof t[0]?e(void 0,t[0],t[1],t[2]):e("INVALID_RESPONSE")}))},r.getLimit=function(e){t.send("GET_LIMIT",void 0,(function(n,t){n?e(n):t&&t.length&&"number"==typeof t[0]?e(void 0,t[0],t[1],t[2]):e("INVALID_RESPONSE")}))},r.trimHistory=function(e,r){var o=n.once(n.mkAsync(r));"object"==typeof e&&e.channel&&e.hash?t.send("TRIM_HISTORY",e,(function(e){if(e)return o(e);o()})):o("INVALID_ARGUMENTS")},r.clearOwnedChannel=function(e,n){"string"==typeof e&&32===e.length?t.send("CLEAR_OWNED_CHANNEL",e,(function(e){if(e)return n(e);n()})):n("INVALID_ARGUMENTS")},r.removeOwnedChannel=function(e,n,r){if("string"!=typeof e||-1===[32,48].indexOf(e.length))return console.error("invalid channel to remove",e),void n("INVALID_ARGUMENTS");t.send("REMOVE_OWNED_CHANNEL",{channel:e,reason:r},(function(t,r){t?n(t):r&&r.length&&"OK"===r[0]?(n(),a&&a.clearChannel&&a.clearChannel(e)):n("INVALID_RESPONSE")}))},r.removePins=function(e){t.send("REMOVE_PINS",void 0,(function(n,t){n?e(n):t&&t.length&&"OK"===t[0]?e():e("INVALID_RESPONSE")}))},r.uploadComplete=function(e,n){t.send("UPLOAD_COMPLETE",e,(function(e,t){if(e)n(e);else{var r=t[0];"string"==typeof r?n(void 0,r):n("INVALID_ID")}}))},r.ownedUploadComplete=function(e,n){t.send("OWNED_UPLOAD_COMPLETE",e,(function(e,t){if(e)n(e);else{var r=t[0];"string"==typeof r?n(void 0,r):n("INVALID_ID")}}))},r.uploadStatus=function(e,n){"number"==typeof e?t.send("UPLOAD_STATUS",e,(function(e,t){if(e)n(e);else{var r=t[0];"boolean"==typeof r?n(void 0,r):n("INVALID_RESPONSE")}})):setTimeout((function(){n("INVALID_SIZE")}))},r.uploadCancel=function(e,n){t.send("UPLOAD_CANCEL",e,(function(e){e?n(e):n()}))},r.setMetadata=function(e,n){t.send("SET_METADATA",{channel:e.channel,command:e.command,value:e.value},n)},i(e,r)}})):i("INVALID_KEYS")}else i("INVALID_PROXY");else i("INVALID_NETWORK")}}))}(Tn)),Tn.exports}function In(){return Dn||(Dn=1,function(e){(()=>{const n=(e,n,t,r,o,a,i,c,s,u)=>{var l=function(e,n,t){if(!e.done){if(e.cb(n&&n.error,t,n),e.done=!0,!e.hasNetwork){var o=r.find(e,["network","disconnect"]);"function"==typeof o&&o()}if(e.realtime&&e.realtime.stop)try{e.realtime.stop()}catch(e){console.error(e)}var a=r.find(e,["session","realtime","abort"]);"function"==typeof a&&(e.session.realtime.sync(),a())}},f=function(e,r){u((function(n){var o,a;e.hasNetwork||(o=n((function(e,n){e||(r.network=n)})),a=i.getWebsocketURL(),t.connect(a).then((function(e){o(null,e)}),(function(e){o(e)})))})).nThen((function(){e.realtime=n.start(r)}))},d=function(e,n,t,r){Array.isArray(t)&&t.length&&16===t[0].length&&Array.isArray(n.accessKeys)?(e.network.historyKeeper=t[0],u((function(t){n.accessKeys.forEach((function(n){s.create(e.network,n,t((function(e){console.log("done",n),e&&console.error(e)})))}))})).nThen((function(){r()}))):r(!0)},h=function(n,t){var r;return"string"==typeof n?r=o.getSecrets("pad",n,t.password):"object"==typeof n&&(r=n),r.keys||(r.keys=r.key),{websocketURL:i.getWebsocketURL(t.origin),channel:r.channel,validateKey:r.keys.validateKey||void 0,crypto:e.createEncryptor(r.keys),logLevel:0,initialState:t.initialState,Cache:c}},p=function(e){return"object"==typeof e},v=function(e,n){p(e)&&p(n)&&Object.keys(n).forEach((function(t){e[t]=n[t]}))};return{get:function(e,n,t,r){if("function"!=typeof n)throw new Error("Cryptget expects a callback");r=r||function(){};var o=h(e,t=t||{}),a={cb:n,accessKeys:t.accessKeys,hasNetwork:Boolean(t.network)};o.onRejected=function(e,n){d(o,a,e,n)},o.onReady=function(e){var n=a.session=e.realtime;a.network=e.network,r(1),l(a,void 0,n.getUserDoc())},o.onError=function(e){console.warn(e),l(a,e)},o.onChannelError=function(e){console.error(e),l(a,e)},o.onCacheReady=t.onCacheReady;var i=0;o.onMessage=function(){i++,r(Math.min(.99,i/100))},v(o,t),f(a,o)},put:function(e,n,t,r){if("function"!=typeof t)throw new Error("Cryptput expects a callback");var o=h(e,r=r||{}),i={cb:t,accessKeys:r.accessKeys,hasNetwork:Boolean(r.network)};o.onRejected=function(e,n){d(o,i,e,n)},o.onReady=function(e){var r=i.session=e.realtime;i.network=e.network,r.contentUpdate(n);var o=setTimeout((function(){t(new Error("Timeout"))}),15e3);a.whenRealtimeSyncs(r,(function(){clearTimeout(o);var e=r.getAuthDoc();r.abort(),l(i,void 0,e)}))},o.onChannelError=function(e){l(i,e)},v(o,r),f(i,o)}}};e.exports&&(e.exports=n(K(),O(),u(),ee(),ae(),je(),B(),he(),Nn(),We(),N()))})()}(Sn)),Sn.exports}var Rn,Pn,kn,Mn,Fn,Ln,Kn,Hn={exports:{}};function jn(){if(Fn)return Mn;Fn=1;return Mn=((e,n,t,r,o,a,i,c)=>{const s={};let u={};s.setCustomize=e=>{u=e.Broadcast};var l=["notifications","supportteam","broadcast"],f=[],d="000000000000000000000000000000000",h=function(e,n,t,r,o){e.emit("MESSAGE",{type:n,content:t},r?[r]:e.clients,o)},p=function(e,n,t,r){e.emit("VIEWED",{type:n,hash:t},r||e.clients)},v=function(e){var n=e.store&&e.store.proxy;if(n.curvePrivate&&n.curvePublic&&n.kemPublic&&n.kemPrivate)return{curvePrivate:n.curvePrivate,curvePublic:n.curvePublic,kemPrivate:n.kemPrivate,kemPublic:n.kemPublic}},y=s.sendTo=function(n,t,o,a,i){a=a||{};var s=i||function(e){e&&e.error&&console.error(e.error)};if(c.Mailbox){var u=e.find(n,["store","anon_rpc"]);if(u){var l={encrypt:function(e){return e}},f=d,h={uid:e.uid(),type:t,content:o};if(!/^BROADCAST/.test(t)){var p=v(n);if(!p)return void s({error:"missing asymmetric encryption keys"});if(!a||!a.channel||!a.curvePublic)return void s({error:"no notification channel"});if(f=a.channel,l=c.Mailbox.createEncryptor(p),"object"==typeof o&&!o.user){var y=r.createData(n.store.proxy,!1);o.user=y}h={type:t,content:o}}var m=JSON.stringify(h),g=l.encrypt(m,a.curvePublic);if(a.viewed){var E=e.find(n,["store","proxy","teams",a.viewed]);if(E){var b=g.slice(0,64),A=e.find(E,["keys","mailbox","viewed"]);Array.isArray(A)&&A.push(b)}}u.send("WRITE_PRIVATE_MESSAGE",[f,g],(function(e){s(e?{error:e}:{hash:g.slice(0,64)})}))}else s({error:"anonymous rpc session not ready"})}else s({error:"chainpad-crypto is outdated and doesn't support mailboxes."})};s.sendToAnon=function(n,t,r,o,a){var i,s,u=c.CryptoAgility.bytes(32),l=c.CryptoAgility.boxKeyPairFromSecretKey(new Uint8Array(u)),f=e.encodeBase64(l.secretKey),d=e.encodeBase64(l.publicKey);if(c.PQC&&c.PQC.ml_kem&&c.PQC.ml_kem.ml_kem512)try{var h=c.CryptoAgility.bytes(64),p=c.PQC.ml_kem.ml_kem512.keygen(new Uint8Array(h));i=e.encodeBase64(p.secretKey),s=e.encodeBase64(p.publicKey)}catch(e){console.warn("Failed to generate ephemeral PQC keys:",e)}y({store:{anon_rpc:n,proxy:{curvePrivate:f,curvePublic:d,kemPrivate:i,kemPublic:s}}},t,r,o,a)};var m=function(n,r,o,i){var c=r.type,s=r.hash;if(/^REMINDER\|/.test(s)){i(),delete n.boxes.reminders.content[s],p(n,c,s,n.clients.filter((function(e){return e!==o})));var u=s.slice(9).split("-")[0],l=e.find(n,["store","proxy","hideReminders",u]);if(!l){var f=n.store.proxy.hideReminders=n.store.proxy.hideReminders||{};l=f[u]=f[u]||[]}var d=s.split("-")[1];d&&!l.includes(d)&&l.push(Number(d))}else{var h=n.boxes[c];if(h){var v,y,m=h.data||{},g=h.history.indexOf(s);-1!==g&&(0===g?(m.lastKnownHash=s,h.history.shift()):-1===m.viewed.indexOf(s)&&m.viewed.push(s));var E=[];h.history.some((function(e,n){if(-1===m.viewed.indexOf(e))return!0;v=n+1,E.push(e),y=e})),m.viewed=m.viewed.filter((function(e){return-1===E.indexOf(e)})),v&&(h.history=h.history.slice(v),m.lastKnownHash=y),Object.keys(h.content).forEach((function(e){-1!==h.history.indexOf(e)&&-1===m.viewed.indexOf(e)||(a.remove(n,h,h.content[e],e),delete h.content[e])})),t.whenRealtimeSyncs(n.store.realtime,(function(){i(),p(n,c,s,n.clients.filter((function(e){return e!==o})))}))}else i({error:"NOT_LOADED"})}},g=function(e,n,t,s,u){u=u||{};var l=e.boxes[n]={channel:t.channel,type:n,queue:[],history:[],content:{},sendMessage:function(n){if("object"==typeof n&&!n.user){var t=r.createData(e.store.proxy,!1);n.user=t}try{n=JSON.stringify(n)}catch(e){console.error(e)}l.queue.push(n)},data:t};if(c.Mailbox){var f=t.keys||v(e);if(f||t.decrypted){var d=t.decrypted?{encrypt:function(e){return e},decrypt:function(e){return e}}:c.Mailbox.createEncryptor(f);l.encryptor=d;var y,g={network:e.store.network,channel:t.channel,noChainPad:!0,crypto:d,owners:"broadcast"===n?[]:u.owners||[e.store.proxy.edPublic],lastKnownHash:t.lastKnownHash};g.onConnectionChange=function(){},g.onConnect=function(t,r){l.sendMessage=function(t,o){var a;o=o||function(){};try{a=JSON.stringify(t)}catch(e){console.error(e)}r(a,(function(r,a){r?console.error(r):(l.history.push(a),t.ctime=+new Date,l.content[a]=t,h(e,n,{msg:t,hash:a}),o(a))}),f.curvePublic)},l.queue.forEach((function(e){l.sendMessage(e)})),l.queue=[]},l.onMessage=g.onMessage=function(r,i,c,s,f,d,p){if(f!==t.lastKnownHash&&f!==y){var v=p&&p.time;y=f;try{r=JSON.parse(r)}catch(e){console.error(e)}if(d&&(r.author=d),l.history.push(f),function(e,n){return-1===(n.viewed||[]).indexOf(e)&&e!==n.lastKnownHash}(f,t)){var g={msg:r,hash:f,time:v},E=l.ready;a.add(e,l,g,(function(t,a,i){a&&m(e,a,"",(function(){console.log("Notification handled automatically")})),i||t?m(e,{type:n,hash:f},"",(function(){console.log("Notification handled automatically")})):(r.ctime=v||0,l.content[f]=r,u.dump||h(e,n,g,null,(function(e){e&&e.msg&&E&&o.system(void 0,e.msg)})))}))}else if(0===Object.keys(l.content).length){t.lastKnownHash=f,l.history=[];var b=t.viewed.indexOf(f);-1!==b&&t.viewed.splice(b,1)}}},g.onReady=function(){var r=[];t.viewed.forEach((function(e,n){-1===l.history.indexOf(e)&&r.push(n)}));for(var o=r.length-1;o>=0;o--)t.viewed.splice(r[o],1);var i=function(t){a.remove(e,l,l.content[t],t),delete l.content[t],p(e,n,t)};e.store.proxy.on("change",["mailboxes",n],(function(e,n,t){var r;"lastKnownHash"===t[2]&&(l.history.some((function(e,t){if(r=t+1,i(e),e===n)return!0})),l.history=l.history.slice(r));"viewed"===t[2]&&i(n)})),l.ready=!0,s(l.content)},l.cpNf=i.start(g)}else console.error("missing asymmetric encryption keys")}else console.error("chainpad-crypto is outdated and doesn't support mailboxes.")};return s.init=function(t,r,i){var c={},s=t.store,v=s.proxy.mailboxes=s.proxy.mailboxes||{},E={Store:t.Store,store:s,pinPads:t.pinPads,updateMetadata:t.updateMetadata,updateDrive:t.updateDrive,mailboxes:v,emit:i,clients:[],boxes:{},req:{},loggedIn:s.loggedIn&&s.proxy.edPublic};return function(e,t){!t.notifications&&e.loggedIn&&(t.notifications={channel:n.createChannelId(),lastKnownHash:"",viewed:[]},e.pinPads([t.notifications.channel],(function(e){e.error&&console.error(e)}))),t.support&&delete t.support,t.broadcast||(t.broadcast={channel:d,lastKnownHash:u.lastBroadcastHash,decrypted:!0,viewed:[]})}(E,v),E.loggedIn&&function(n){var t=n.store.network;t.on("message",(function(r,o){if(o===t.historyKeeper){var a=JSON.parse(r);if(/HISTORY_RANGE/.test(a[0])){var i=a[1],c=n.req[i];if(c){var s=a[0],u=a[2],l=c.box;if("HISTORY_RANGE"===s){if(!Array.isArray(u))return;var f;if("broadcast"===c.box.type)f=e.tryParse(u[4]);else try{var d=l.encryptor.decrypt(u[4]);(f=JSON.parse(d.content)).author=d.author}catch(e){console.log(e)}var h=u[4].slice(0,64);n.emit("HISTORY",{txid:i,time:u[5],message:f,hash:h},[c.cId])}else"HISTORY_RANGE_END"===s&&(n.emit("HISTORY",{txid:i,complete:!0},[c.cId]),delete n.req[i])}}}}))}(E),E.boxes.reminders={content:{}},Object.keys(v).forEach((function(e){if(-1!==l.indexOf(e)){var n=v[e];-1===f.indexOf(e)?g(E,e,n,(function(){})):g(E,e,n,r((function(){})))}})),E.loggedIn&&Object.keys(s.proxy.teams||{}).forEach((function(n){var t=s.proxy.teams[n];if(t){var r=t.keys.mailbox||{};if(r.channel){var o={owners:[e.find(t,["keys","drive","edPublic"])]};g(E,"team-"+n,r,(function(){}),o)}}})),c.post=function(e,n,t){var r=E.boxes[e];r&&r.sendMessage({type:n,content:t,sender:s.proxy.curvePublic})},c.hideMessage=function(e,n){p(E,e,n.hash,E.clients)},c.showMessage=function(e,n,t,r){"reminders"===e&&n&&(E.boxes.reminders.content[n.hash]=n.msg,E.clients.length||(E.boxes.reminders.content[n.hash].requiresNotif=!0),p(E,e,n.hash,E.clients)),h(E,e,n,t,(function(e){o.system(void 0,e.msg),r&&r()}))},c.open=function(e,n,t,r,o){(-1!==l.indexOf(e)||r)&&g(E,e,n,t,o)},c.close=function(e,n){!function(e,n,t){t=t||function(){};var r=e.boxes[n];r?r.cpNf&&"function"==typeof r.cpNf.stop?(r.cpNf.stop(),Object.keys(r.content).forEach((function(t){a.remove(e,r,r.content[t],t),p(e,n,t,e.clients)})),delete e.boxes[n]):t("EINVAL"):t()}(E,e,n)},c.dismiss=function(e,n){m(E,e,"",n)},c.sendTo=function(e,n,t,r){E.loggedIn?y(E,e,n,t,r):r({error:"NOT_LOGGED_IN"})},c.removeClient=function(e){!function(e,n){var t=e.clients.indexOf(n);e.clients.splice(t,1)}(E,e)},c.execCommand=function(e,n,t){var r=n.cmd,a=n.data;"SUBSCRIBE"!==r?"DISMISS"!==r?"SENDTO"!==r?"LOAD_HISTORY"!==r||function(e,n,t,r){var o=e.boxes[t.type];if(o){var a=["GET_HISTORY_RANGE",o.channel,{from:t.lastKnownHash,count:t.count,txid:t.txid}];"broadcast"===t.type&&(a=["GET_HISTORY_RANGE",o.channel,{to:t.lastKnownHash,txid:t.txid}]),e.req[t.txid]={cId:n,box:o};var i=e.store.network;i.sendto(i.historyKeeper,JSON.stringify(a)).then((function(){}),(function(e){console.error(e)}))}else r({error:"ENOENT"})}(E,e,a,t):y(E,a.type,a.msg,a.user,t):m(E,a,e,t):function(e,n,t,r){Object.keys(e.boxes).forEach((function(n){Object.keys(e.boxes[n].content).forEach((function(r){var a={msg:e.boxes[n].content[r],hash:r};h(e,n,a,t,(function(e){e.error||a.msg&&a.msg.requiresNotif&&(o.system(void 0,e.msg),delete a.msg.requiresNotif)}))}))})),-1===e.clients.indexOf(t)&&e.clients.push(t),r()}(E,0,e,t)},c},s})(ee(),ae(),je(),_n(),(Rn||(Rn=1,function(e){(()=>{const n=(e={})=>{let n=globalThis;var t={};e.requireConf=e.requireConf||{},t.setCustomize=n=>{e=n.ApiConfig};var r=n.location&&n.location.pathname.slice(1,-1),o=-1!==["code","slide","pad","kanban","whiteboard","diagram","sheet","poll","teams","form","doc","presentation"].indexOf(r)?"-"+r:"",a="/customize/favicon/main-favicon"+o+".png?"+e.requireConf.urlArgs,i="/customize/favicon/alt-favicon"+o+".png?"+e.requireConf.urlArgs,c="/customize/favicon/main-favicon"+o+".ico?"+e.requireConf.urlArgs,s="/customize/favicon/alt-favicon"+o+".ico?"+e.requireConf.urlArgs,u=n.document,l=t.isSupported=function(){return"function"==typeof n.Notification&&n.isSecureContext},f=t.hasPermission=function(){return"granted"===Notification.permission},d=t.getPermission=function(e){e=e||function(){},Notification&&"function"==typeof Notification.requestPermission?Notification.requestPermission((function(n){e("granted"===n)})):e(!1)},h=t.create=function(e,t,r){u&&!r?r=u.getElementById("favicon").getAttribute("data-main-favicon")||i:r||(r=i);var o=new Notification(t,{icon:r,body:e});return o.onclick=function(){if(u)try{parent.focus(),n.focus(),this.close()}catch(e){}},o};return t.system=function(e,n,t){if(l())return f()?h(e,n,t):void("denied"!==Notification.permission&&d((function(r){r&&h(e,n,t)})))},u&&!u.getElementById("favicon")&&function(){if(u){console.debug("creating favicon");var e={id:"favicon",type:"image/png",rel:"icon","data-main-favicon":a,"data-alt-favicon":i,href:a};if(!u.getElementById("favicon")){var n=u.createElement("link");Object.keys(e).forEach((function(t){n.setAttribute(t,e[t])})),u.head.appendChild(n)}if(!u.getElementById("favicon-ico")){var t=u.createElement("link");e.href=e.href.replace(/\.png/g,".ico"),e.id="favicon-ico",e.type="image/x-icon",Object.keys(e).forEach((function(n){t.setAttribute(n,e[n])})),u.head.appendChild(t)}}else console.error("document is not available in this context")}(),t.tab=function(e,r){if(u){var o="_pendingTabNotification",l=u.getElementById("favicon"),f=u.getElementById("favicon-ico"),d=a,h=i,p=c,v=s;l&&(d=l.getAttribute("data-main-favicon")||a,h=l.getAttribute("data-alt-favicon")||i,l.setAttribute("href",d)),f&&(p=f.getAttribute("data-main-favicon")||c,v=f.getAttribute("data-alt-favicon")||s,f.setAttribute("href",p));var y=function(e){return!!t[o]&&(n.clearInterval(t[o]),l&&l.setAttribute("href",e?h:d),f&&f.setAttribute("href",e?v:p),!0)};y();var m=function(){l&&l.setAttribute("href",l.getAttribute("href")===d?h:d),f&&f.setAttribute("href",f.getAttribute("href")===p?v:p),--r};return t[o]=n.setInterval((function(){if(r>0)return m();y(!0)}),e),m(),{cancel:y}}console.error("document is not available in this context")},t};e.exports&&(e.exports=n(void 0))})()}(Hn)),Hn.exports),(kn||(kn=1,Pn=((e,n,t,r,o)=>{var a=function(e){var n=e.store.realtime.getLag().lag||0;return 20*(Math.max(0,n)+300)*(.5+Math.random())},i={},c={},s=function(e,n){var r=e.store.proxy.mutedUsers||{},o=t.find(n,["msg","author"]);return!!o&&Boolean(r[o])},u={};i.FRIEND_REQUEST=function(n,t,r,o){var a=r.msg.content.user||r.msg.content;if(s(n,r))o(!0);else if(u[r.msg.author])o(!0);else{if(u[r.msg.author]={type:t.type,hash:r.hash},e.getFriend(n.store.proxy,r.msg.author)||n.store.proxy.friends_pending[r.msg.author])return delete n.store.proxy.friends_pending[r.msg.author],void e.acceptFriendRequest(n.store,a,(function(t){t&&t.error?o():e.addToFriendList({proxy:n.store.proxy,realtime:n.store.realtime,pinPads:n.pinPads},a,(function(e){if(e)return console.error(e),void o(!0);n.store.messenger&&n.store.messenger.onFriendAdded(a),n.updateMetadata(),o(!0)}))}));o()}},c.FRIEND_REQUEST=function(e,n,t){var r=t.content.user||t.content;u[r.curvePublic]&&delete u[r.curvePublic]};var l={},f={};i.DECLINE_FRIEND_REQUEST=function(e,n,t,r){var o=t.msg.content.user||t.msg.content;o.curvePublic||(o.curvePublic=t.msg.author),setTimeout((function(){r(!0),e.store.proxy.friends_pending[t.msg.author]&&(delete e.store.proxy.friends_pending[t.msg.author],e.updateMetadata(),l[t.msg.author]||n.sendMessage({type:"FRIEND_REQUEST_DECLINED",content:{user:o}},(function(e){l[t.msg.author]={type:n.type,hash:e}})))}),a(e))},i.FRIEND_REQUEST_DECLINED=function(e,n,t,r){e.updateMetadata();var o=t.msg.content.user.curvePublic||t.msg.content.user,a=f[o];delete f[o],l[o]?r(!0,a):(l[o]={type:n.type,hash:t.hash},r(!1,a))},c.FRIEND_REQUEST_DECLINED=function(e,n,t){var r=t.content.user.curvePublic||t.content.user;l[r]&&delete l[r]},i.ACCEPT_FRIEND_REQUEST=function(n,t,r,o){var i=r.msg.content.user||r.msg.content;setTimeout((function(){o(!0),n.store.proxy.friends_pending[r.msg.author]&&(delete n.store.proxy.friends_pending[r.msg.author],e.addToFriendList({proxy:n.store.proxy,realtime:n.store.realtime,pinPads:n.pinPads},i,(function(e){e?console.error(e):(n.store.messenger&&n.store.messenger.onFriendAdded(i),n.updateMetadata(),n.store.modules.profile&&n.store.modules.profile.update(),f[r.msg.author]||t.sendMessage({type:"FRIEND_REQUEST_ACCEPTED",content:{user:i}},(function(e){f[r.msg.author]={type:t.type,hash:e}})))})))}),a(n))},i.FRIEND_REQUEST_ACCEPTED=function(e,n,t,r){e.updateMetadata();var o=t.msg.content.user.curvePublic||t.msg.content.user,a=l[o];delete l[o],f[o]?r(!0,a):(f[o]={type:n.type,hash:t.hash},r(!1,a))},c.FRIEND_REQUEST_ACCEPTED=function(e,n,t){var r=t.content.user.curvePublic||t.content.user;f[r]&&delete f[r]},i.CANCEL_FRIEND_REQUEST=function(e,n,t,r){var o=u[t.msg.author];o?r(!0,o):r(!0)},i.UNFRIEND=function(n,t,r,o){var a=r.msg.author,i=e.getFriend(n.store.proxy,a);i?(delete n.store.proxy.friends[a],delete n.store.proxy.friends_pending[a],n.store.messenger&&n.store.messenger.onFriendRemoved(a,i.channel),n.updateMetadata(),o(!0)):o(!0)},i.UPDATE_DATA=function(e,n,t,r){var o=t.msg,a=o.author,i=e.store.proxy.friends&&e.store.proxy.friends[a];i&&"object"==typeof o.content?(Object.keys(o.content).forEach((function(e){i[e]=o.content[e]})),e.store.messenger&&e.store.messenger.onFriendUpdate(a),e.updateMetadata(),r(!0)):r(!0)};var d=function(e,n){let t=e.store.data.blockHash,a=o.parseBlockHash(t).keys.symmetric;return r.encrypt(n,a)},h={};i.SHARE_PAD=function(e,t,r,o){var a=r.msg,i=r.hash,c=a.content;if(s(e,r))o(!0);else{var u,l=c.isStatic?c.href:n.hrefToHexChannelId(c.href,c.password),f=n.parsePadUrl(c.href),p=f.hashData&&f.hashData.mode||"n/a",v=h[l];if(v){if("edit"===v.mode&&"view"===p)return void o(!0);u=v.data}c.password&&(c.password=d(e,c.password)),h[l]={mode:p,data:{type:t.type,hash:i}},o(!1,u)}},c.SHARE_PAD=function(e,t,r,o){var a=r.content,i=n.hrefToHexChannelId(a.href,a.password),c=h[i];c&&c.data&&c.data.hash===o&&delete h[i]};var p=!1;i.SUPPORT_MESSAGE=function(e,n,t,r){p?r(!0):(p=!0,r())},c.SUPPORT_MESSAGE=function(){p=!1},i.REQUEST_PAD_ACCESS=function(e,n,t,r){var o=t.msg.content;if(s(e,t))r(!0);else{var a=o.channel,i=e.store.manager.findChannel(a);if(i.length){var c,u,l=e.store.proxy.edPublic;i.some((function(e){if(e.data&&Array.isArray(e.data.owners)&&-1!==e.data.owners.indexOf(l)&&e.data.href)return u=e.data.href,c=e.data.filename||e.data.title,!0}))?(o.title=c,o.href=u,r(!1)):r(!0)}else r(!0)}},i.GIVE_PAD_ACCESS=function(e,n,t,r){var o,a=t.msg.content,i=a.channel;e.store.manager.findChannel(i,!0).forEach((function(e){e.data&&!e.data.href&&(o||(o=e.data.filename||e.data.title),e.userObject.setHref(i,null,a.href))})),a.title=o||a.title,r(!1)},i.ADD_TO_ACCESS_LIST=function(e,n,t,r){var o=t.msg.content.channel;e.Store.getAllStores().forEach((function(n){var t=n.manager.findChannel(o);if(t.length){var r=t[0].data,a=t[0].id,i=n.id;e.Store.loadSharedFolder(i,a,r,(function(){}),!1)}})),r(!0)};var v={};i.ADD_OWNER=function(e,n,t,r){var o=t.msg.content;if(s(e,t))r(!0);else{if(!(o.teamChannel||o.href&&o.title&&o.channel))return console.log("Remove invalid notification"),void r(!0);var a=o.channel||o.teamChannel;o.password&&(o.pw=o.password,o.password=d(e,o.password)),v[a]?r(!0):(v[a]={type:n.type,hash:t.hash},r(!1))}},c.ADD_OWNER=function(e,n,t){var r=t.content.channel||t.content.teamChannel;v[r]&&delete v[r]},i.RM_OWNER=function(e,n,t,r){var o=t.msg.content;if(!o.channel&&!o.teamChannel)return console.log("Remove invalid notification"),void r(!0);var a=o.channel||o.teamChannel;if(o.teamChannel){var i=e.store.proxy.teams||{};Object.keys(i).some((function(e){if(i[e].channel===a)return i[e].owner=!1,!0}))}v[a]&&o.pending?r(!1,v[a]):r(!1)};var y={};i.INVITE_TO_TEAM=function(e,n,r,o){var a=r.msg.content;if(s(e,r))o(!0);else{if(!a.team)return console.log("Remove invalid notification"),void o(!0);var i=y[a.team.channel];if(i)return console.log("removing old invitation"),o(!1,i),void(y[a.team.channel]={type:n.type,hash:r.hash});var c=t.find(e,["store","proxy","teams"])||{};Object.keys(c).some((function(e){return c[e].channel===a.team.channel}))?o(!0):(y[a.team.channel]={type:n.type,hash:r.hash},o(!1))}},c.INVITE_TO_TEAM=function(e,n,r){var o=t.find(r,["content","team","channel"]);delete y[o]},i.KICKED_FROM_TEAM=function(e,n,t,r){var o=t.msg.content;if(!o.teamChannel)return console.log("Remove invalid notification"),void r(!0);y[o.teamChannel]&&o.pending?r(!0,y[o.teamChannel]):r(!1)},i.INVITE_TO_TEAM_ANSWER=function(e,n,r,o){var a=r.msg,i=a.content;if(!i.teamChannel)return console.log("Remove invalid notification"),void o(!0);var c,s,u=t.find(e,["store","proxy","teams"])||{};if(Object.keys(u).some((function(e){var n=u[e];if(n.channel===i.teamChannel)return c=e,s=n,!0})),c){if(i.team=s,!i.answer)try{e.store.modules.team.removeFromTeam(c,a.author,!0)}catch(e){console.error(e)}var l=i.user||i;n.sendMessage({type:"INVITE_TO_TEAM_ANSWERED",content:{user:l,team:s,answer:i.answer}},(function(){})),o(!0)}else o(!0)},i.TEAM_EDIT_RIGHTS=function(e,n,r,o){var a=r.msg.content;if(!a.teamData)return console.log("Remove invalid notification"),void o(!0);var i,c=t.find(e,["store","proxy","teams"])||{};if(Object.keys(c).some((function(e){if(c[e].channel===a.teamData.channel)return i=e,!0})),i)try{e.store.modules.team.changeMyRights(i,a.state,a.teamData,(function(e){e||console.error("Can't update team rights"),o(!0)}))}catch(e){console.error(e)}else o(!0)},i.OWNED_PAD_REMOVED=function(e,n,t,r){var o=t.msg.content;if(!o.channel)return console.log("Remove invalid notification"),void r(!0);var a=o.channel;e.store.manager.findChannel(a).forEach((function(n){var t=e.store.manager.findFile(n.id);e.store.manager.delete({paths:t},(function(){e.updateDrive()}))})),r(!0)},i.MOVE_TODO=function(e,n,t,r){var o=e.store.proxy.curvePublic;t.msg.author===o?r():r(!0)},i.SAFE_LINKS_DEFAULT=function(e,n,t,r){var o=e.store.proxy.curvePublic;t.msg.author===o?r():r(!0)};var m={};i.FORM_RESPONSE=function(e,n,t,r){var o,a,i=t.msg,c=t.hash,s=i.content,u=s.channel;if(u)if(function(e,n){return(e.store.proxy.mutedChannels||[]).includes(n)}(e,u))r(!0);else if(e.Store.getAllStores().some((function(e){return e.manager.findChannel(u).some((function(e){if(e.data&&(!a||e.data.href))return a=e.data.href||e.data.roHref,o=e.data.filename||e.data.title,!!e.data.href||void 0}))})),a){s.href=a,s.title=o;var l=m[u],f=l?l.data:void 0;m[u]={data:{type:n.type,hash:c}},r(!1,f)}else r(!0);else r(!0)},c.FORM_RESPONSE=function(e,n,t,r){var o=t.content.channel,a=m[o];a&&a.data&&a.data.hash===r&&delete m[o]};var g={};i.COMMENT_REPLY=function(e,n,r,o){var a=r.msg,i=r.hash,c=a.content;if(t.find(e.store.proxy,["settings","pad","disableNotif"]))o(!0);else{var s,u,l=c.channel;if(l)if(e.Store.getAllStores().some((function(e){return e.manager.findChannel(l).some((function(e){if(e.data&&(!u||e.data.href))return u=e.data.href||e.data.roHref,s=e.data.filename||e.data.title,!!e.data.href||void 0}))})),u){c.href=u,c.title=s;var f=g[l],d=f?f.data:void 0;g[l]={data:{type:n.type,hash:i}},o(!1,d)}else o(!0);else o(!0)}},c.COMMENT_REPLY=function(e,n,t,r){var o=t.content.channel,a=g[o];a&&a.data&&a.data.hash===r&&delete g[o]};var E,b,A={};i.MENTION=function(e,n,t,r){var o=t.msg,a=t.hash,i=o.content;if(s(e,t))r(!0);else{var c=i.channel;if(c){var u,l;e.Store.getAllStores().some((function(e){return e.manager.findChannel(c).some((function(e){if(e.data&&(!l||e.data.href))return l=e.data.href||e.data.roHref,u=e.data.filename||e.data.title,!!e.data.href||void 0}))})),i.href=l,i.title=u;var f=A[c],d=f?f.data:void 0;A[c]={data:{type:n.type,hash:a}},r(!1,d)}else r(!0)}},c.MENTION=function(e,n,t,r){var o=t.content.channel,a=A[o];a&&a.data&&a.data.hash===r&&delete A[o]},i.BROADCAST_MAINTENANCE=function(e,n,t,r){var o=t.msg.uid;e.Store.onMaintenanceUpdate(o),r(!0)},i.BROADCAST_SURVEY=function(e,n,t,r){var o=t.msg,a=o.content,i=o.uid,c=E;E={type:n.type,hash:t.hash},e.Store.onSurveyUpdate(i),r(!a.url,c)},i.BROADCAST_CUSTOM=function(e,n,t,r){var o=t.msg.uid,a=b;b={uid:o,type:n.type,hash:t.hash},r(!1,a)},i.BROADCAST_DELETE=function(e,n,t,r){var o=t.msg.content.uid;if(b&&b.uid===o)return r(!0,b),void(b=void 0);r(!0)};var _,w,O={};return i.SF_DELETED=function(e,n,t,r){var o=t.msg.content,a=o.team,i=o.sfId;if(O[i])r(!0);else if(O[i]=1,a){var c=e.store.proxy.teams[a];o.teamName=c.metadata&&c.metadata.name,r(!1)}else r(!1)},c.SF_DELETED=function(e,n,t){var r=t.content.sfId;delete O[r]},i.NEW_TICKET=function(e,n,r,o){var a=r.msg.content;a.time||(a.time=r.time);var i=t.find(e,["store","modules","support"]);a.isAdmin&&i.addUserTicket(a,o),i.addAdminTicket(a,o)},i.NOTIF_TICKET=function(e,n,r,o){var a=r.msg.content;a.time||(a.time=r.time);var i=t.find(e,["store","modules","support"]);if(a.isAdmin)return t.find(e,["store","proxy","support",a.channel])?(i.updateUserTicket(a),_?void o(!1,_):(_={channel:a.channel,type:n.type,hash:r.hash},void o(!1))):void o(!0);i.checkAdminTicket(a,(c=>{c?(i.updateAdminTicket(a),t.find(e.store.proxy,["settings","general","disableSupportNotif"])?o(!0):w?o(!1,w):(w={channel:a.channel,type:n.type,hash:r.hash},o(!1))):o(!0)}))},c.NOTIF_TICKET=function(e,n,t){var r=t.content.channel;_&&_.channel===r&&(_=void 0),w&&w.channel===r&&(w=void 0)},i.ADD_MODERATOR=function(e,n,r,o){var a=r.msg.content;t.find(e,["store","modules","support"]).updateAdminKey(a,o)},i.MODERATOR_NEW_KEY=function(e,n,r,o){var a=r.msg.content;t.find(e,["store","modules","support"]).updateAdminKey(a,(function(){o(!0)}))},{add:function(e,n,r,o){if(r.msg){var a=t.find(e,["store","proxy","curvePublic"]),c=t.find(r,["msg","content","user","curvePublic"])||t.find(r,["msg","content","curvePublic"]);if(c&&r.msg.author!==c&&r.msg.author!==a)return console.error("blocked"),void o(null,null,!0);var s=r.msg.type;if(i[s])try{i[s](e,n,r,o)}catch(e){console.error(e),o()}else o()}else o(null,null,!0)},remove:function(e,n,t,r){if(t){var o=t.type;if(c[o])try{c[o](e,n,t,r)}catch(e){console.error(e)}}}}})(_n(),ae(),ee(),K(),pn())),Pn),O(),K()),Mn}function Un(){if(Kn)return Ln;Kn=1;return Ln=((e,n,t,r,o,a,i,c,s)=>{let u={};let l=function(l,f,d,h){var p=l.version||0;c((function(){})).nThen((function(){var n,t,r,o,a;p<2&&(n="cryptpad.userlist-drawer",t="cryptpad.hide_poll_text",r="cryptpad.indentUnit",o="cryptpad.indentWithTabs",a=l.settings=l.settings||{},void 0!==l[r]&&(a.codemirror=a.codemirror||{},a.codemirror.indentUnit=l[r],delete l[r]),void 0!==l[o]&&(a.codemirror=a.codemirror||{},a.codemirror.indentWithTabs=l[o],delete l[o]),void 0!==l[n]&&(a.toolbar=a.toolbar||{},a.toolbar["userlist-drawer"]=l[n],delete l[n]),void 0!==l[t]&&(a.poll=a.poll||{},a.poll["hide-text"]=l[t],delete l[t]),e.send("Migrate-2",!0),l.version=p=2)})).nThen((function(){p<3&&(!function(){if(localStorage.CRYPTPAD_LANG){var e=localStorage.CRYPTPAD_LANG;l.settings.language=e}}(),e.send("Migrate-3",!0),l.version=p=3)})).nThen((function(){var n;p<4&&(n=l.settings=l.settings||{},void 0!==l.allowUserFeedback&&(n.general=n.general||{},n.general.allowUserFeedback=l.allowUserFeedback,delete l.allowUserFeedback),e.send("Migrate-4",!0),l.version=p=4)})).nThen((function(){p<5&&(!function(){var e=l.drive&&l.drive.filesData;if(e)for(var n in e)"number"!=typeof e[n].ctime&&(e[n].ctime=+new Date(e[n].ctime)),"number"!=typeof e[n].atime&&(e[n].atime=+new Date(e[n].atime))}(),e.send("Migrate-5",!0),l.version=p=5)})).nThen((function(t){var r,o,a,i,s;p<6&&(a=l.drive.filesData||{},i=c((function(){})),s=Object.keys(a).length,Object.keys(a).forEach((function(e,t){i=i.nThen((function(i){setTimeout(i((function(){if(r=a[e],o=n.parsePadUrl(r.href),r.href&&!r.channel){var i=n.getSecrets(o.type,o.hash,r.password);r.channel=i.channel,d(6,Math.round(100*t/s)),console.log("Adding missing channel in filesData ",r.channel)}})))}))})),i.nThen(t((function(){e.send("Migrate-6",!0),l.version=p=6}))))})).nThen((function(t){var r,o,a,i,s;p<7&&(a=l.drive.filesData,i=c((function(){})),s=Object.keys(a).length,Object.keys(a).forEach((function(e,t){i=i.nThen((function(i){setTimeout(i((function(){if((r=a[e]).href)if(-1!==r.href.indexOf("#"))if("pad"===(o=n.parsePadUrl(r.href)).hashData.type){if("view"===o.hashData.mode)r.roHref=r.href,delete r.href,console.log("Move href to roHref in filesData ",r.roHref);else{var i=n.getSecrets(o.type,o.hash,r.password),c=n.getViewHashFromKeys(i);c&&(r.roHref="/"+o.type+"/#"+c,console.log("Adding missing roHref in filesData ",r.href))}d(6,Math.round(100*t/s))}else d(7,Math.round(100*t/s));else d(7,Math.round(100*t/s));else d(7,Math.round(100*t/s))})))}))})),i.nThen(t((function(){e.send("Migrate-7",!0),l.version=p=7}))))})).nThen((function(){p<8&&(l.FS_hashes=t.deduplicateString(l.FS_hashes||[]),e.send("Migrate-8",!0),l.version=p=8)})).nThen((function(){p<9&&(!function(){var e=h.network,n={},t={store:h},o=r.createData(l),i=function(e){var t=n[e];if(t){try{t.wc.leave()}catch(e){}delete n[e]}};e.on("message",(function(r,c){try{!function(r,c){if(c===e.historyKeeper){var s=JSON.parse(r);if(!s.validateKey&&!s.owners||!s.channel){if(s.channel&&n[s.channel]){if(s.error&&"EINVAL"===s.error){var u=["GET_HISTORY",s.channel,{}];return void e.sendto(e.historyKeeper,JSON.stringify(u)).then((function(){}),(function(){}))}if(s.state&&1===s.state){o.channel=s.channel;var l=["UPDATE",o.curvePublic,+new Date,o],f=n[s.channel].encrypt(JSON.stringify(l));return n[s.channel].wc.bcast(f).then((function(){}),(function(e){console.error("Can't migrate this friend",n[s.channel].friend,e)})),void i(s.channel)}}else if(s.channel)return;var d=s[3];if(d&&n[d]){var h=n[d],p=h.decrypt(s[4]),v=JSON.parse(p);if("UPDATE"===v[0]){if(v[1]===o.curvePublic)return;var y=v[3];if(!y.notifications)return;h.friend.notifications=y.notifications,o.channel=d,a.sendTo(t,"UPDATE_DATA",o,{channel:y.notifications,curvePublic:y.curvePublic},(function(e){e&&e.error?console.error(e):console.log("friend migrated",h.friend)})),i(d)}}}}}(r,c)}catch(e){console.error(e)}}));var c=l.friends||{};Object.keys(c).forEach((function(t){if(44===t.length){var r=c[t];r.notifications||e.join(r.channel).then((function(t){var o=s.Curve.deriveKeys(r.curvePublic,l.curvePrivate),a=s.Curve.createEncryptor(o);n[r.channel]={wc:t,friend:r,decrypt:a.decrypt,encrypt:a.encrypt};var i={lastKnownHash:r.lastKnownHash},c=["GET_HISTORY",r.channel,i];e.sendto(e.historyKeeper,JSON.stringify(c)).then((function(){}),(function(e){console.error("Can't migrate this friend",r,e)}))}),(function(e){console.error("Can't migrate this friend",r,e)}))}}))}(),e.send("Migrate-9",!0),l.version=p=9)})).nThen((function(t){p<10&&function(){var i=h.proxy.todo;if(i){var s,f=t((function(){e.send("Migrate-10",!0),l.version=p=10})),d={network:h.network,initialState:"{}",metadata:{owners:h.proxy.edPublic?[h.proxy.edPublic]:[]}};c((function(e){o.get(i,e((function(n,t){if(n||!t)return e.abort(),void f();try{s=JSON.parse(t)}catch(e){}})),d)})).nThen((function(e){if(!s||"object"!=typeof s)return e.abort(),void f();var t={content:{data:{1:{id:"1",color:"color6",item:[],title:u.kanban_todo},2:{id:"2",color:"color3",item:[],title:u.kanban_working},3:{id:"3",color:"color5",item:[],title:u.kanban_done}},items:{},list:[1,2,3]},metadata:{title:u.type.todo,defaultTitle:u.type.todo,type:"kanban"}},c=4,p=!1;if((s.order||[]).forEach((function(e){var n=s.data[e];if(n&&n.task){p=!0;var r=n.state?"3":"1";t.content.data[r].item.push(c),t.content.items[c]={id:c,title:n.task},c++}})),!p)return e.abort(),void f();var v=n.createRandomHash("kanban"),y=n.getSecrets("kanban",v),m=n.getSecrets("todo",i);o.put(v,JSON.stringify(t),e((function(t){if(t)return e.abort(),void f();h.rpc&&(h.rpc.pin([y.channel],(function(){})),h.rpc.unpin([m.channel],(function(){})));var o=n.hashToHref(v,"kanban");h.manager.addPad(["root"],{title:u.type.todo,owners:d.metadata.owners,channel:y.channel,href:o,roHref:n.hashToHref(n.getViewHashFromKeys(y),"kanban"),atime:+new Date,ctime:+new Date},e((function(e){if(e)console.error(e);else{delete h.proxy.todo;var n=r.createData(l),t={store:h};a.sendTo(t,"MOVE_TODO",{user:n,href:o},{channel:n.notifications,curvePublic:n.curvePublic},(function(e){e&&e.error&&console.error(e)}))}})))})),d)})).nThen((function(){f()}))}}()})).nThen((function(n){if(!(p>=11)){var o=function(){e.send("Migrate-11",!0),l.version=p=11};if(void 0===t.find(l,["settings","security","unsafeLinks"])){var i={store:h},c=r.createData(l);c.curvePublic?a.sendTo(i,"SAFE_LINKS_DEFAULT",{user:c},{channel:c.notifications,curvePublic:c.curvePublic},n((function(e){e&&e.error?console.error(e):o()}))):o()}else o()}})).nThen((function(){i.whenRealtimeSyncs(h.realtime,t.mkAsync(t.bake(f)))}))};return l.setCustomize=e=>{u=e.Messages},l})(De(),ae(),ee(),_n(),In(),jn(),je(),We(),K()),Ln}var Bn,Vn,Yn=o(we);var Gn,Jn,qn,Wn,zn=Vn?Bn:(Vn=1,Gn=In(),Jn=Be(),ae(),qn=je(),Wn={anonDriveIntoUser:function(e,n,t){n&&e.loggedIn||"function"!=typeof t?Gn.get(n,(function(r,o){var a;if(r)console.error("Cannot migrate recent pads",r);else if(o){try{a=JSON.parse(o)}catch(e){return"function"==typeof t&&t(),void console.error("Cannot parsed recent pads",e)}if(a){var i=e.proxy,c=Jn.init(a.drive,{readOnly:!1,loggedIn:!0,outer:!0}),s=function(){c.fixFiles(!0);var r=e.manager;c.getFiles([c.FILES_DATA]).forEach((function(e){var n=c.getFileData(e),t=n.channel,o=r.findChannel(t);if(0===o.length)n&&r.addPad(null,n,(function(e){e&&console.error("Cannot import file:",n,e)}));else{if(!n.href)return;o.forEach((function(e){e.data&&!e.data.href&&e.userObject.setHref(t,null,n.href)}))}})),i.FS_hashes&&Array.isArray(i.FS_hashes)||(i.FS_hashes=[]),-1===i.FS_hashes.indexOf(n)&&i.FS_hashes.push(n),"function"==typeof t&&qn.whenRealtimeSyncs(e.realtime,t)};c&&"function"==typeof c.migrate?c.migrate(s):(console.log("oldFo.migrate is not a function"),s())}else"function"==typeof t&&t()}else"function"==typeof t&&t()})):t()}},Bn=Wn);const Qn=ue.mkEvent(!0),Xn=ue.mkEvent(!0),Zn=ue.mkEvent(),$n=ue.mkEvent(),et=(e,n)=>{var t,r;const o=e.store,a=e.Store;let i;if(n){const e=a.getStore(n);i=null===(r=null==e?void 0:e.proxy)||void 0===r?void 0:r.drive}else i=null===(t=o.drive)||void 0===t?void 0:t.proxy;return i},nt={init:e=>{var n;const{broadcast:t,store:r,Store:o,account:a}=e,i=r.drive||(r.drive={});let c=null===(n=r.proxy)||void 0===n?void 0:n.drive;if((null==c?void 0:c.hash)||se.createRandomHash("drive"),!c.hash)return i.proxy=c,a.onAccountCacheReady((()=>{Qn.fire()})),a.onAccountReady((()=>{Xn.fire()})),{channel:"",onDriveCacheReady:Qn.reg,onDriveReady:Xn.reg,onDisconnect:Zn.reg,onReconnect:$n.reg};throw new Error("NOT IMPLEMENTED")},initAPI:e=>{const{broadcast:n,store:t,Store:r,account:o}=e,a={store:t,Store:r};return{exists:(e,n,r)=>{r({state:Boolean(t.proxy)})},get:(e,n,t)=>{let r=et(a,n.teamId);t(r?{drive:r}:{error:"ENOTFOUND"})},set:(e,n,t)=>{let o=et(a,n.teamId);var i,c;o?(i=o,c=n.value,Object.keys(i).forEach((e=>{delete i[e]})),Object.keys(c).forEach((e=>{i[e]=ue.clone(c[e])})),r.onSync(n.teamId,t)):t({error:"ENOTFOUND"})},migrateAnon:(e,n,r)=>{zn.anonDriveIntoUser(t,n.anonHash,r)}}}};var tt=o(Object.freeze({__proto__:null,Drive:nt})),rt=O(),ot=r(We()),at=r(An()),it=ze();const ct=ue.mkEvent(!0),st=(e,n,t,r)=>{const o=ue.once(ue.mkAsync(r)),{store:a,Store:i}=e;!a.offline&&a.anon_rpc?t.channel?32===t.channel.length&&se.isValidChannel(t.channel)?a.anon_rpc.send("GET_METADATA",t.channel,((e,n)=>{if(e)return void o({error:e});const r=n&&n[0]||{};o(r),r.rejected||i.getAllStores().forEach((e=>{const n=e.manager.findChannel(t.channel,!0);let o=!1;(n.forEach((e=>{at(e.data.owners)!==at(r.owners)&&(o=!0),e.data.owners=r.owners,e.data.atime=+new Date,r.expire&&(e.data.expire=+r.expire)})),o)&&(e.sendEvent||a.sendDriveEvent)("DRIVE_CHANGE",{path:["drive",nn.FILES_DATA]})}))})):o({error:"EINVAL"}):o({error:"ENOTFOUND"}):o({error:"OFFLINE"})},ut=(e,n,t)=>{if(t.versionHash)return((e,n,t)=>{let r;const{Store:o,store:a,postMessage:i}=e,c=t.channel,s=t.versionHash,u=se.createChannelId();ot((t=>{st(e,0,{channel:c},t((e=>{if(e&&e.rejected)return i(n,"PAD_ERROR",{type:"ERESTRICTED"}),void t.abort();r=e.validateKey})))})).nThen((()=>{o.getHistoryRange(n,{cpCount:1,channel:c,lastKnownHash:s},(e=>{var t,o;if(e&&e.error)return i(n,"PAD_ERROR",e.error);const l=e.messages||[];if((null===(t=l[l.length-1])||void 0===t?void 0:t.serverHash)!==s)return i(n,"PAD_ERROR",{type:"HASH_NOT_FOUND"});i(n,"PAD_CONNECT",{myID:u,id:c,members:[u]}),(e.messages||[]).forEach((e=>{i(n,"PAD_MESSAGE",{msg:e.msg,time:e.time,user:u.slice(0,16)})})),r&&(null===(o=null==a?void 0:a.messenger)||void 0===o||o.storeValidateKey(c,r)),i(n,"PAD_READY")}))}))})(e,n,t);const{channels:r,store:o,Store:a,myDeletions:i,postMessage:c}=e,s=t.channel;if(!se.isValidChannel(s))return c(n,"PAD_ERROR","INVALID_CHAN");const u=void 0===r[s],l=r[s]||(r[s]={queue:[],data:{},clients:[],bcast:(e,n,t)=>{l.clients.forEach((function(r){r!==t&&c(r,e,n)}))},history:[],pushHistory:(e,n)=>{if(n){let n;for(l.history.push("cp|"+e),n=l.history.length-101;n>0&&!/^cp\|/.test(l.history[n]);n--);l.history=l.history.slice(n)}else l.history.push(e)}});if(-1===l.clients.indexOf(n)&&l.clients.push(n),!u&&l.wc)return c(n,"PAD_CONNECT",{myID:l.wc.myID,id:l.wc.id,members:l.wc.members}),l.wc.members.forEach((e=>{c(n,"PAD_JOIN",e)})),l.history.forEach((e=>{c(n,"PAD_MESSAGE",{msg:rt.removeCp(e),user:l.wc.myID,validateKey:l.data.validateKey})})),void c(n,"PAD_READY");const f=e=>{const n=null==e?void 0:e.type;"EDELETED"===n&&i[s]&&(delete i[s],e.ownDeletion=!0),l.bcast("PAD_ERROR",e),"EDELETED"===n&&(null==ve?void 0:pe.clearChannel)&&pe.clearChannel(s),["EDELETED","EEXPIRED","ERESTRICTED"].includes(n)&&a.leavePad(null,t,(function(){}))},d={Cache:o.neverCache?void 0:ve,priority:1,onCacheStart:()=>{c(n,"PAD_CACHE")},onCacheReady:()=>{c(n,"PAD_CACHE_READY")},onReady:e=>{const t=e.metadata||{};l.data=t,(null==t?void 0:t.validateKey)&&o.messenger&&o.messenger.storeValidateKey(s,t.validateKey),c(n,"PAD_READY",e.noCache)},onMessage:function(e,n,t,r,o){l.lastHash=o,l.pushHistory(e,r),l.bcast("PAD_MESSAGE",{user:n,msg:e,validateKey:t})},onJoin:function(e){l.bcast("PAD_JOIN",e)},onLeave:function(e){l.bcast("PAD_LEAVE",e)},onError:f,onChannelError:f,onRejected:a.onRejected,onConnectionChange:e=>{e.state||l.bcast("PAD_DISCONNECT")},onMetadataUpdate:e=>{l.data=e||{},a.getAllStores().forEach((n=>{n.manager.findChannel(s,!0).forEach((n=>{n.data.owners=e.owners,n.data.atime=+new Date,e.expire&&(n.data.expire=+e.expire)}));(n.sendEvent||o.sendDriveEvent)("DRIVE_CHANGE",{path:["drive",nn.FILES_DATA]})})),l.bcast("PAD_METADATA",e)},crypto:{encrypt:function(e){return e},decrypt:function(e){return e}},noChainPad:!0,channel:s,metadata:t.metadata,network:o.network||o.networkPromise,websocketURL:Y.getWebsocketURL(),onInit:function(){ct.fire()},onConnect:(e,t)=>{l.sendMessage=(n,r,o)=>{t(n,(t=>{t?o({error:t}):(l.lastHash=n.slice(0,64),l.pushHistory(rt.removeCp(n),/^cp\|/.test(n)),l.bcast("PAD_MESSAGE",{user:e.myID,msg:rt.removeCp(n),validateKey:l.data.validateKey},r),o())}))},l.wc=e,l.queue.forEach((function(e){l.sendMessage(e.message,n)})),l.queue=[],l.bcast("PAD_CONNECT",{myID:e.myID,id:e.id,members:e.members})}};l.cpNf=rt.start(d)},lt=(e,n)=>{var t,r,o,a,i,c;const s=e.store;if(null===(r=null===(t=s.messenger)||void 0===t?void 0:t.leavePad)||void 0===r||r.call(t,n),null===(a=null===(o=s.onlyoffice)||void 0===o?void 0:o.leavePad)||void 0===a||a.call(o,n),Object.keys(s.modules).forEach((e=>{var t,r;null===(r=null===(t=s.modules[e])||void 0===t?void 0:t.leavePad)||void 0===r||r.call(t,n)})),!((e,n)=>{const{store:t}=e;if(!t)return!1;if(t.driveChannel===n)return!0;if(it.isSharedFolderChannel(n))return!0;if(ue.find(t,["proxy","teams"])){var r=ue.find(t,["proxy","teams"])||{};return Object.keys(r).some((e=>r[e].channel===n))}if(ue.find(t,["proxy","profile","href"])){let e=ue.find(t,["proxy","profile","href"]);return se.hrefToHexChannelId(e)===n}})(e,n)){try{pe.leaveChannel(n)}catch(e){console.error(e)}null===(c=null===(i=e.channels[n])||void 0===i?void 0:i.cpNf)||void 0===c||c.stop()}delete e.channels[n]},ft={init:e=>{const{broadcast:n,postMessage:t,store:r,Store:o}=e,a={channels:[],postMessage:t,store:r,Store:o,myDeletions:[]};return{join:(e,n,t)=>{ut(a,e,n)},destroy:(e,n,t)=>{((e,n,t,r)=>{const{store:o,Store:a,channels:i,myDeletions:c}=e;let s,u,l=t,f=!1;if(t&&"object"==typeof t&&({channel:l,force:f,teamId:s,reason:u}=t),l===o.driveChannel&&!f)return void r({error:"User drive removal blocked!"});const d=a.getStore(s);d?d.rpc?(i[l]&&(c[l]=!0),d.rpc.removeOwnedChannel(l,(e=>{e&&delete c[l],r({error:e})}),u)):r({error:"RPC_NOT_READY"}):r({error:"ENOTFOUND"})})(a,0,n,t)},clear:(e,n,t)=>{((e,n,t,r)=>{const{Store:o}=e,a=o.getStore(t&&t.teamId);a.rpc?a.rpc.clearOwnedChannel(t.channel,(e=>{r({error:e})})):r({error:"RPC_NOT_READY"})})(a,0,n,t)},setMetadata:(e,n,t)=>{((e,n,t,r)=>{if(!t.channel)return void r({error:"ENOTFOUND"});if(!t.command)return void r({error:"EINVAL"});const{Store:o}=e,a=o.getStore(t.teamId);if(!a)return void r({error:"ENOTFOUND"});const i=t.channels;delete t.channels,a.rpc.setMetadata(t,((e,n)=>{e?r({error:e}):Array.isArray(n)&&n.length?r(n[0]):r({})})),Array.isArray(i)&&i.forEach((e=>{var r=ue.clone(t);r.channel=e,o.setPadMetadata(n,r,(()=>{}))}))})(a,e,n,t)},getMetadata:(e,n,t)=>{st(a,0,n,t)},sendMessage:(e,n,t)=>{((e,n,t,r)=>{var o=t.msg,a=e.channels[t.channel];if(a)a.wc?a.sendMessage(o,n,r):(a.queue.push(o),r())})(a,e,n,t)},onCorruptedCache:(e,n,t)=>{((e,n,t)=>{var r=e.channels[t];r&&r.cpNf&&(pe.clearChannel(t),r.cpNf.resetCache&&r.cpNf.resetCache())})(a,0,n)},getLastHash:(e,n,t)=>{((e,n,t,r)=>{var o=e.channels[t.channel];o?o.lastHash?r({hash:o.lastHash}):r({error:"EINVAL"}):r({error:"ENOCHAN"})})(a,0,n,t)},leave:(e,n,t)=>{const r=a.channels[n.channel];(null==r?void 0:r.cpNf)?(lt(a,n.channel),t()):t({error:"EINVAL"})},removeClient:e=>{Object.keys(a.channels).forEach((n=>{let t=a.channels[n].clients.indexOf(e);-1!==t&&a.channels[n].clients.splice(t,1),0===a.channels[n].clients.length&&lt(a,n)}))},onJoined:ct.reg,getChannels:()=>a.channels}}};var dt,ht,pt,vt,yt,mt,gt,Et,bt,At,_t,wt,Ot,Dt,St,Tt,xt,Ct,Nt,It,Rt=o(Object.freeze({__proto__:null,Pad:ft}));function Pt(){if(ht)return dt;ht=1;return dt=((e,n,t)=>{const r={};let o={},a={};r.setCustomize=e=>{o=e.Messages,a=e.AppConfig};var i=function(e,n){n.degraded||n.clients.forEach((function(t){var r=e.clients[t];if(r){var o={id:r.id,cursor:r.cursor};n.sendMsg(JSON.stringify(o))}}))},c=function(e,n,t){var r=n.members,o=a.degradedLimit||8;t.degraded=r.length-1>=o,e.emit("DEGRADED",{degraded:t.degraded},t.clients)},s=function(e,n,r,o){var a=n.channel,s=n.secret;s.keys.cryptKey&&(s.keys.cryptKey=function(e){for(var n=Object.keys(e).length,t=new Uint8Array(n),r=0;r<n;r++)t[r]=e[r];return t}(s.keys.cryptKey));var u=s.channel,l=e.store.network,f=!0,d=e.clients[r];if(d)o();else{d=e.clients[r]={channel:a,cursor:{}};var h=e.channels[a];if(h)return d.id||(d.id=h.wc.myID+"-"+r),h.clients.forEach((function(n){var t=e.clients[n];h.degraded||t&&e.emit("MESSAGE",{id:t.id,cursor:t.cursor},[r])})),h.sendMsg(JSON.stringify({join:!0,id:d.id})),h.clients.push(r),c(e,h.wc,h),void o();var p=function(n){e.channels[a]=e.channels[a]||{};var l=e.channels[a];l.padChan=u,d.id||(d.id=n.myID+"-"+r),l.clients&&l.clients.forEach((function(t){e.clients[t]&&!e.clients[t].id&&(e.clients[t].id=n.myID+"-"+t)})),l.encryptor||(l.encryptor=t.createEncryptor(s.keys)),n.on("join",(function(){i(e,l),c(e,n,l)})),n.on("leave",(function(t){e.emit("MESSAGE",{leave:!0,id:t},l.clients),c(e,n,l)})),n.on("message",(function(n){if(!l.degraded){var t,r=l.encryptor.decrypt(n,s.keys&&s.keys.validateKey);try{if((t=JSON.parse(r))&&t.join)return void i(e,l);e.emit("MESSAGE",t,l.clients)}catch(e){console.error(e)}}})),l.wc=n,l.sendMsg=function(e,t){t=t||function(){};var r=l.encryptor.encrypt(e);n.bcast(r).then((function(){t()}),(function(e){t({error:e})}))},f&&(l.clients=[r],f=!1,o(),c(e,n,l))};l.join(a).then(p,(function(e){o({error:e})}));var v=function(){e.channels[a]?l.join(a).then(p,(function(e){console.error(e)})):console.log("cant reconnect",a)};e.channels[a]=e.channels[a]||{},e.channels[a].onReconnect=v,l.on("reconnect",v)}},u=function(t,r,a,i){var c=t.clients[a];if(c){var s=t.store.proxy||{};r.color=e.find(s,["settings","general","cursor","color"]),r.name=s[n.displayNameKey]||t.store.noDriveName||o.anonymous,r.avatar=e.find(s,["profile","avatar"]),r.uid=e.find(s,["uid"])||t.store.noDriveUid,c.cursor=r,function(e,n){var t=e.clients[n];if(t&&t.cursor){var r=e.channels[t.channel];if(r&&!r.degraded&&r.sendMsg){var o={id:t.id,cursor:t.cursor};r.sendMsg(JSON.stringify(o)),e.emit("MESSAGE",o,r.clients.filter((function(e){return e!==n})))}}}(t,a),i()}else i({error:"NO_CLIENT"})};return r.init=function(e,n,t){var r={};if(e.store&&e.store.modules&&e.store.modules.cursor)return e.store.modules.cursor;var o={store:e.store,emit:t,channels:{},clients:{}};return r.removeClient=function(e){!function(e,n){var t,r=function(e){return e!==n};for(var o in e.channels)(t=e.channels[o]).clients=t.clients.filter(r),0===t.clients.length&&(t.wc&&t.wc.leave(),t.onReconnect&&e.store.network.off("reconnect",t.onReconnect),delete e.channels[o]);if(e.clients[n]){var a={leave:!0,id:e.clients[n].id};(t=e.channels[e.clients[n].channel])&&(t.sendMsg(JSON.stringify(a)),e.emit("MESSAGE",a,t.clients))}delete e.clients[n]}(o,e)},r.leavePad=function(e){!function(e,n){Object.keys(e.channels).some((function(t){var r=e.channels[t];if(r.padChan===n)return r.wc&&r.wc.leave(),r.onReconnect&&e.store.network.off("reconnect",r.onReconnect),delete e.channels[t],!0}))}(o,e)},r.execCommand=function(e,n,t){var r=n.cmd,a=n.data;"INIT_CURSOR"!==r?"UPDATE"!==r||u(o,a,e,t):s(o,a,e,t)},r},r})(ee(),q(),K()),dt}function kt(){if(vt)return pt;vt=1;return pt=((e,n,t,r,o,a,i,c,s,u)=>{const l={};let f={};l.setCustomize=e=>{f=e.ApiConfig};var d=function(e,n,t,r){let o=Object.keys(e.clients).filter((t=>Boolean(e.clients[t].admin)===n));o.length&&e.emit(t,{channel:r},[o])},h=function(n,t,r,o){var a=e.mkAsync(o);if(t&&!n.adminRdyEvt)return void a("EFORBIDDEN");let i=f.httpUnsafeOrigin;e.fetchApi(i,"config",!0,(o=>{n.moderatorKeys=o.moderatorKeys,n.adminKeys=o.adminKeys;var i=o.supportMailboxKey;if(i){if(!t||e.find(n.store.proxy,["mailboxes","supportteam","keys","curvePublic"])===i)return t?n.adminRdyEvt.reg((()=>{a(null,{supportKey:i,myCurve:r.adminCurvePrivate||e.find(n.store.proxy,["mailboxes","supportteam","keys","curvePrivate"]),theirPublic:r.curvePublic,notifKey:r.curvePublic})})):void a(null,{supportKey:i,myCurve:n.store.proxy.curvePrivate,theirPublic:r.curvePublic||i,notifKey:i});a("EFORBIDDEN")}else a("E_NOT_INIT")}))},p=function(n,t,r,o){var c,s,l=e.once(e.mkAsync(o));a((e=>{h(n,r,t,e(((n,t)=>{if(n)return e.abort(),void l({error:n});c=t.theirPublic,s=t.myCurve})))})).nThen((()=>{var r,o=i.Curve.deriveKeys(c,s),a=i.Curve.createEncryptor(o),f={network:n.store.network,channel:t.channel,noChainPad:!0,crypto:a,owners:[]},d=[];l=e.both((function(){r&&"function"==typeof r.stop&&r.stop()}),l),f.onMessage=function(e,n,t,r,o,a,i){var c=i&&i.time;try{e=JSON.parse(e)}catch(e){return void console.error(e)}e.time=c,a&&(e.author=a),d.push(e)},f.onError=l,f.onChannelError=l,f.onReady=function(){l(null,d)},r=u.start(f)}))},v=function(t,r,o,c){var s=e.find(t,["store","mailbox"]),u=e.find(t,["store","anon_rpc"]);if(s)if(u){var l,f,d,p=r.channel,v=r.title,y=r.ticket,m=+new Date;a((e=>{h(t,o,r,e(((n,t)=>{if(n)return e.abort(),void c({error:n});l=t.supportKey,f=t.theirPublic,d=t.myCurve})))})).nThen((e=>{var n=i.Curve.deriveKeys(f,d),t=i.Curve.createEncryptor(n),r=JSON.stringify(y),o=t.encrypt(r);u.send("WRITE_PRIVATE_MESSAGE",[p,o],e(((n,t)=>{if(n)return e.abort(),void c({error:n});m=t&&t[0]})))})).nThen((e=>{if(o){var n=t.adminDoc.proxy.tickets.active;if(n[p])return e.abort(),void c({error:"EEXISTS"});n[p]={title:y.title,restored:y.legacy,premium:!1,time:m,author:r.name,supportKey:l,lastAdmin:!0,authorKey:r.curvePublic,notifications:r.notifications}}})).nThen((e=>{o||(t.supportData[p]={time:+new Date,title:v,curvePublic:l},t.Store.onSync(null,e()))})).nThen((()=>{var a=o?r.notifications:n.getChannelIdFromKey(l);s.sendTo("NEW_TICKET",{title:v,channel:p,time:m,isAdmin:o,supportKey:l,premium:o?"":e.find(t,["store","account","plan"]),user:e.find(r.ticket,["sender","curvePublic"])?void 0:{supportTeam:!0}},{channel:a,curvePublic:f},(e=>{console.error(e),e&&e.error&&delete t.supportData[p],c(e)})),s.sendTo("NOTIF_TICKET",{title:v,channel:p,time:m,isAdmin:o,isNewTicket:!0,user:e.find(r.ticket,["sender","curvePublic"])?void 0:{supportTeam:!0}},{channel:a,curvePublic:f},(()=>{}))}))}else c({error:"anonymous rpc session not ready"});else c({error:"E_NOT_READY"})},y=function(t,r,o,c){var s,u,l,f,d=e.find(t,["store","mailbox"]),p=e.find(t,["store","anon_rpc"]);d?p?r?.ticket?a((e=>{h(t,o,r,e(((n,t)=>{if(n)return e.abort(),void c(n);s=t.theirPublic,u=t.myCurve,l=t.notifKey})))})).nThen((e=>{var n=i.Curve.deriveKeys(s,u),t=i.Curve.createEncryptor(n),o=JSON.stringify(r.ticket),a=t.encrypt(o);p.send("WRITE_PRIVATE_MESSAGE",[r.channel,a],e(((n,t)=>{if(n)return e.abort(),void c(n);f=t&&t[0],c(void 0,f)})))})).nThen((()=>{var t=o?r.notifChannel:n.getChannelIdFromKey(l);t&&d.sendTo("NOTIF_TICKET",{isAdmin:o,title:r.ticket.title,isClose:r.ticket.close,channel:r.channel,time:f,user:e.find(r.ticket,["sender","curvePublic"])?void 0:{supportTeam:!0}},{channel:t,curvePublic:l},(()=>{}))})):c("E_NO_DATA"):c("anonymous rpc session not ready"):c("E_NOT_READY")},m=function(t,r,o){var a=n.getSecrets("support",r),u={data:{},channel:a.channel,crypto:i.createEncryptor(a.keys),userName:"support",ChainPad:s,classic:!0,network:t.store.network,metadata:{validateKey:a.keys.validateKey||void 0}},l=t.adminDoc=c.create(u);l.proxy.on("ready",(function(){var r=l.proxy;if(r.tickets=r.tickets||{},r.tickets.active=r.tickets.active||{},r.tickets.closed=r.tickets.closed||{},r.tickets.pending=r.tickets.pending||{},t.adminRdyEvt.fire(),o(),!t.supportRpc)return;let a=function(n){if(!n.adminDoc||!n.supportRpc)return;let t=n.adminDoc.metadata&&n.adminDoc.metadata.channel,r=n.adminDoc.proxy.tickets,o=[t,...Object.keys(r.active),...Object.keys(r.pending),...Object.keys(r.closed)];return e.deduplicateString(o).sort()}(t),i=n.hashChannelList(a);t.supportRpc.getServerHash((function(e,n){e?console.warn(e):n!==i&&t.supportRpc.reset(a,(function(e){e&&console.warn(e)}))}))})),l.proxy.on("change",["recorded"],(function(){d(t,!0,"RECORDED_CHANGE","")})),l.proxy.on("remove",["recorded"],(function(){d(t,!0,"RECORDED_CHANGE","")}))},g=function(t,o,c){let s=c(),u=t.store.proxy,l=e.find(u,["mailboxes","supportteam","keys","curvePublic"]),f=e.find(u,["mailboxes","supportteam","keys","curvePrivate"]);o||(t.adminRdyEvt=e.mkEvent(!0)),a((e=>{h(t,!1,{},e(((n,r)=>{if(setTimeout(s),n)e.abort();else if(r.theirPublic!==l){try{delete u.mailboxes.supportteam,t.store.mailbox.close("supportteam")}catch(e){}return delete t.adminRdyEvt,void e.abort()}})))})).nThen((n=>{!function(n,t){let o,a,c=e.mkAsync(t),s=n.store.proxy,u=e.find(s,["mailboxes","supportteam","keys","curvePrivate"]);if(u){try{let n=i.CryptoAgility.signKeyPairFromSeed(e.decodeBase64(u));o=e.encodeBase64(n.secretKey),a=e.encodeBase64(n.publicKey)}catch(e){return void c(e)}r.create(n.store.network,{edPublic:a,edPrivate:o},((e,t)=>{e?c(e):(console.log("Support RPC ready, public key is ",a),n.supportRpc=t,c())}))}else c("EFORBIDDEN")}(t,n((e=>{e&&console.error("Support RPC not ready",e)})))})).nThen((e=>{let r=f.slice(0,24),o=n.getEditHashFromKeys({version:2,type:"support",keys:{editKeyStr:r}});m(t,o,e())})).nThen((()=>{console.log("Support admin loaded")}))};var E=function(n,t,r,o){let a=n.store.proxy,i=e.find(a,["mailboxes","supportadmin"]);i?n.store.mailbox.open("supportadmin",i,(function(t){n.store.mailbox.close("supportadmin",(function(){}));let r=e.clone(t||{}),a=[];Object.keys(r).forEach((e=>{let t=r[e];if("CLOSE"===t.type)return void(a.includes(t.content.id)||a.push(t.content.id));let o=t.author,i=t.content&&t.content.title;((e,n,t)=>{let r=e.adminDoc.proxy;return["active","pending","closed"].some((e=>{let o=r.tickets[e];return Object.keys(o).some((e=>{let r=o[e];return r.authorKey===n&&r.title===t&&r.restored}))}))})(n,o,i)&&(a.includes(t.content.id)||a.push(t.content.id))})),Object.keys(r).forEach((e=>{let n=r[e];n.content&&a.includes(n.content.id)&&delete r[e]})),o(r)}),!0,{dump:!0}):o({error:"ENOENT"})};let b=(n,t,r,o)=>{let a;try{let n=i.CryptoAgility.signKeyPairFromSeed(e.decodeBase64(r));a=e.encodeBase64(n.publicKey)}catch(e){return void o(e)}n.Store.adminRpc(null,{cmd:"ADMIN_DECREE",data:["SET_SUPPORT_KEYS",[t,a]]},o)},A=(e,n,t,r)=>{e.Store.adminRpc(null,{cmd:"GET_MODERATORS",data:{}},r)};return l.init=function(r,c,s){var u={};if(r.store&&r.store.modules&&r.store.modules.support)return r.store.modules.support;var l=r.store,m=l.proxy.support=l.proxy.support||{},_={moderatorKeys:f.moderatorKeys,adminKeys:f.adminKeys,supportData:m,store:r.store,Store:r.Store,emit:s,clients:{}};return e.find(l,["proxy","mailboxes","supportteam"])&&g(_,!1,c),u.ctx=_,u.removeClient=function(e){delete _.clients[e]},u.leavePad=function(){},u.addAdminTicket=function(e,n){!function(e,n,r){e.adminRdyEvt?e.adminRdyEvt.reg((()=>{let o;a((t=>{h(e,!0,n,t(((e,n)=>{if(e)return t.abort(),void r(!0);o=n.supportKey})))})).nThen((()=>{var a=Math.floor(2e3*Math.random());setTimeout((()=>{var a=e.adminDoc.proxy;a.tickets.active[n.channel]||a.tickets.closed[n.channel]||a.tickets.pending[n.channel]?r(!0):(a.tickets.active[n.channel]={title:n.title,premium:n.premium,time:n.time,author:n.user&&n.user.displayName,supportKey:n.supportKey||o,authorKey:n.user&&n.user.curvePublic},t.whenRealtimeSyncs(e.adminDoc.realtime,(function(){r(!0)})),d(e,!0,"NEW_TICKET",n.channel),e.supportRpc&&e.supportRpc.pin([n.channel],(()=>{})))}),a)}))})):r(!0)}(_,e,n)},u.updateAdminTicket=function(e){!function(e,n){e.adminRdyEvt&&e.adminRdyEvt.reg((()=>{var t=Math.floor(2e3*Math.random());setTimeout((()=>{var t=e.adminDoc.proxy;let r=t.tickets.active[n.channel]||t.tickets.pending[n.channel];r&&(n.time<=r.time||(n.isClose&&(t.tickets.closed[n.channel]=r,delete t.tickets.active[n.channel],delete t.tickets.pending[n.channel]),r.time=n.time,r.lastAdmin=!1,d(e,!0,"UPDATE_TICKET",n.channel)))}),t)}))}(_,e)},u.updateAdminKey=function(t,r){((t,r,o)=>{let i=r.supportKey,c=n.getBoxPublicFromSecret(i),s=t.store.proxy;const u=e.find(s,["mailboxes","supportteam","keys","curvePrivate"]),l=e.find(s,["mailboxes","supportteam","keys","curvePublic"]);h(t,!1,{},((n,r)=>{if(n)return void o(!0);if(c!==r.theirPublic)return void o(!0);if(u===i||l===c)return void o(!0);let s=e.find(t,["store","mailbox"]);try{t.adminDoc&&t.adminDoc.stop(),s&&s.close("supportteam"),t.supportRpc&&t.supportRpc.destroy(),t.adminRdyEvt=e.mkEvent(!0)}catch(e){console.error(e)}t.Store.addAdminMailbox(null,{version:2,priv:i},(e=>{e&&e.error?o(!0):a((e=>{g(t,!0,e),t.adminRdyEvt.reg((()=>{d(t,!0,"UPDATE_RIGHTS"),o(!1)}))}))}))}))})(_,t,r)},u.checkAdminTicket=function(e,n){!function(e,n,t){e.adminRdyEvt?e.adminRdyEvt.reg((()=>{let r=e.adminDoc.proxy,o=r.tickets.active[n.channel]||r.tickets.pending[n.channel];t(o)})):t(!0)}(_,e,n)},u.addUserTicket=function(e,n){!function(e,n,t){if(!e.supportData)return void t(!0);let r=n.channel;e.supportData[r]={time:n.time,title:n.title,curvePublic:n.supportKey},e.Store.onSync(null,(function(){t(!0)}))}(_,e,n)},u.updateUserTicket=function(e){!function(e,n){if(d(e,!1,"UPDATE_TICKET",n.channel),n.isClose){let t=e.supportData[n.channel];if(!t)return;t.closed=!0}}(_,e)},u.execCommand=function(r,c,s){var u=c.cmd,l=c.data;"MAKE_TICKET"!==u?"GET_MY_TICKETS"!==u?"REPLY_TICKET"!==u?"CLOSE_TICKET"!==u?"DELETE_TICKET"!==u?"MAKE_TICKET_ADMIN"!==u?"LIST_TICKETS_ADMIN"!==u?"LOAD_TICKET_ADMIN"!==u?"REPLY_TICKET_ADMIN"!==u?"CLOSE_TICKET_ADMIN"!==u?"MOVE_TICKET_ADMIN"!==u?"GET_RECORDED"!==u?"SET_RECORDED"!==u?"USE_RECORDED"!==u?"SEARCH_ADMIN"!==u?"FILTER_TAGS_ADMIN"!==u?"SET_TAGS_ADMIN"!==u?"GET_LEGACY"!==u?"DUMP_LEGACY"!==u?"CLEAR_LEGACY"!==u?"RESTORE_LEGACY"!==u?"GET_PRIVATE_KEY"!==u?"DISABLE_SUPPORT"!==u?"ROTATE_KEYS"!==u?"ADD_MODERATOR"!==u?s({error:"NOT_SUPPORTED"}):function(n,t,r,o){let a=n.store.proxy;var i=e.find(n,["store","mailbox"]);let c=e.find(a,["mailboxes","supportteam","keys","curvePublic"]),s=e.find(a,["mailboxes","supportteam","keys","curvePrivate"]),u=e.find(a,["mailboxes","supportteam","lastKnownHash"]),l=a.edPublic;h(n,!1,{},((e,r)=>{e?o({error:e}):r.theirPublic===c&&n.moderatorKeys.includes(l)?i.sendTo("ADD_MODERATOR",{supportKey:s,lastKnownHash:u},{channel:t.mailbox,curvePublic:t.curvePublic},(()=>{o()})):o({error:"EFORBIDDEN"})}))}(_,l,0,s):function(t,r,c,s){let u,l=e.once(e.mkAsync(s)),f=t.store.proxy,d=f.edPublic;const p=i.CryptoAgility.curveKeyPair(),v=e.encodeBase64(p.publicKey),y=e.encodeBase64(p.secretKey),m=e.find(f,["mailboxes","supportteam","keys","curvePrivate"]),E=e.find(f,["mailboxes","supportteam","keys","curvePublic"]);if(!y||!v)return void l({error:"INVALID_KEY"});let _;a((e=>{h(t,!1,{},e(((n,t)=>{if("E_NOT_INIT"!==n)return n?(l({error:n}),void e.abort()):void(u=t.theirPublic)})))})).nThen((e=>{if(!t.adminKeys.includes(d))return e.abort(),void l({error:"EFORBIDDEN"})})).nThen((e=>{if(u)return t.moderatorKeys.includes(d)?E!==u?(e.abort(),void l({error:"EFORBIDDEN"})):void 0:(e.abort(),void l({error:"EINVAL"}))})).nThen((e=>{u&&t.adminRdyEvt.reg((()=>{let r=t.adminDoc.proxy;_=t.adminDoc.metadata&&t.adminDoc.metadata.channel;let a=y.slice(0,24),i=n.getEditHashFromKeys({version:2,type:"support",keys:{editKeyStr:a}}),c={network:t.store.network,initialState:"{}"};(r.oldKeys=r.oldKeys||{})[E]={curvePrivate:m,rotatedOn:+new Date,rotatedBy:d},o.put(i,JSON.stringify(r),e((n=>{if(n)return e.abort(),void l({error:n})})),c)}))})).nThen((e=>{b(t,v,y,e((n=>{if(n&&n.error)return e.abort(),void l(n)})))})).nThen((()=>{if(!u)return;t.adminDoc&&t.adminDoc.stop();let n=e.find(t,["store","mailbox"]);n&&n.close("supportteam"),t.supportRpc&&t.supportRpc.destroy(),t.adminRdyEvt=e.mkEvent(!0)})).nThen((e=>{t.Store.addAdminMailbox(null,{version:2,priv:y},e((n=>{if(n&&n.error)return e.abort(),u?b(t,E,m,(()=>{l(n)})):void l(n)})))})).nThen((n=>{if(!u)return;let r=e.find(t,["store","mailbox"]);A(t,0,0,n((e=>{if(e&&e.error)return void l({success:!0,noNotify:!0});let n=e&&e[0];Object.keys(n||{}).forEach((e=>{let t=n[e];r.sendTo("MODERATOR_NEW_KEY",{supportKey:y},{channel:t.mailbox,curvePublic:t.curvePublic},(()=>{}))}))})))})).nThen((e=>{g(t,!0,e)})).nThen((e=>{_&&t.Store.adminRpc(null,{cmd:"ARCHIVE_DOCUMENT",data:{id:_,reason:"Deprecated support pad"}},e())})).nThen((()=>{l({success:!0})}))}(_,0,0,s):function(n,t,r,o){let i,c=e.once(e.mkAsync(o)),s=n.store.proxy.edPublic;a((e=>{h(n,!1,{},e((n=>{if(n)return c({error:n}),void e.abort()})))})).nThen((e=>{if(!n.adminKeys.includes(s))return e.abort(),void c({error:"EFORBIDDEN"})})).nThen((e=>{n.Store.adminRpc(null,{cmd:"ARCHIVE_SUPPORT",data:{}},e((n=>{if(n&&n.error)return e.abort(),void c(n)})))})).nThen((e=>{n.Store.adminRpc(null,{cmd:"ADMIN_DECREE",data:["SET_SUPPORT_KEYS",["",""]]},e((function(n){if(n&&n.error)return e.abort(),void c(n)})))})).nThen((e=>{A(n,0,0,e((n=>{if(!n||n.error)return e.abort(),void c();i=n[0]||{}})))})).nThen((()=>{let e=a;Object.keys(i).forEach((t=>{e=e((e=>{n.Store.adminRpc(null,{cmd:"REMOVE_MODERATOR",data:t},e((e=>{e&&e.error&&console.error("Error removing moderator data",t,e.error)})))})).nThen})),e((()=>{c()}))}))}(_,0,0,s):function(n,t,r,o){let a=n.store.proxy,i=e.find(a,["mailboxes","supportteam","keys","curvePublic"]),c=e.find(a,["mailboxes","supportteam","keys","curvePrivate"]);h(n,!1,{},((e,n)=>{e?o({error:e}):(i&&n.theirPublic!==i&&(c=void 0),o({curvePrivate:c,curvePublic:n.theirPublic}))}))}(_,0,0,s):function(t,r,o,a){let i=t.store.proxy,c=e.find(i,["mailboxes","supportadmin"]);if(!c)return void a({error:"ENOENT"});if(!t.adminRdyEvt)return void a({error:"EFORBIDDEN"});let s=r.messages,u=r.hashes,l=s[0],f=s[s.length-1];l?t.adminRdyEvt.reg((()=>{let r={name:e.find(l,["sender","name"]),notifications:e.find(l,["sender","notifications"]),curvePublic:e.find(l,["sender","curvePublic"]),channel:n.createChannelId(),title:l.title,time:f.time,ticket:{legacy:!0,title:l.title,sender:l.sender,messages:s}};v(t,r,!0,(e=>{e&&e.error?a(e):(u.forEach((e=>{c.viewed.push(e)})),t.Store.onSync(null,(function(){a({done:!0})})))}))})):a({error:"EINVAL"})}(_,l,0,s):function(e,n,t,r){let o=e.store.proxy;e.store.mailbox.close("supportadmin",(function(){delete o.mailboxes.supportadmin,e.Store.onSync(null,(function(){r({done:!0})}))}))}(_,0,0,s):function(n,t,r,o){let a=n.store.proxy,i=e.find(a,["mailboxes","supportadmin"]);if(!i)return void o({error:"ENOENT"});let c=e.clone(i);c.lastKnownHash=void 0,c.viewed=[],n.store.mailbox.open("supportadmin",c,(function(e){n.store.mailbox.close("supportadmin",(function(){})),o(e)}),!0,{dump:!0})}(_,0,0,s):E(_,0,0,s):((e,n,r,o)=>{e.adminRdyEvt?e.adminRdyEvt.reg((()=>{let r=e.adminDoc.proxy.tickets,a=n.channel;(r.active[a]||r.pending[a]||r.closed[a]).tags=n.tags||[],t.whenRealtimeSyncs(e.adminDoc.realtime,(function(){let e=[];["active","pending","closed"].forEach((n=>{let t=r[n];Object.keys(t).forEach((n=>{(t[n].tags||[]).forEach((n=>{e.includes(n)||e.push(n)}))}))})),o({done:!0,allTags:e})}))})):o({error:"EFORBIDDEN"})})(_,l,0,s):((e,n,t,r)=>{if(!e.adminRdyEvt)return void r({error:"EFORBIDDEN"});let o=n.tags||[];e.adminRdyEvt.reg((()=>{let n=e.adminDoc.proxy.tickets;if(!o.length)return void r({all:!0});let t=[];["active","pending","closed"].forEach((e=>{let r=n[e];Object.keys(r).forEach((e=>{(r[e].tags||[]).some((e=>o.includes(e)))||t.push(e)}))})),r({tickets:t})}))})(_,l,0,s):((n,t,r,o)=>{if(!n.adminRdyEvt)return void o({error:"EFORBIDDEN"});let a=t.tags||[],i=(t.text||"").toLowerCase();n.adminRdyEvt.reg((()=>{let t=n.adminDoc.proxy.tickets,r={},c=(n,t,o)=>{let a=e.clone(t);a.category=o,r[n]=a};["active","pending","closed"].some((n=>{let o=t[n];return Object.keys(o).some((t=>{let s=o[t];if(a.length&&!(s.tags||[]).some((e=>a.includes(e))))return;let u=e.hexToBase64(t).slice(0,10);if(i===u)return r={},c(t,s,n),!0;(!i||s.title.toLowerCase().includes(i))&&c(t,s,n)}))})),o({tickets:r})}))})(_,l,0,s):function(e,n,t,r){if(!e.adminRdyEvt)return void r({error:"EFORBIDDEN"});let o=n.id;e.adminRdyEvt.reg((()=>{let n=e.adminDoc.proxy,t=(n.recorded=n.recorded||{})[o];t&&(t.count=(t.count||0)+1),r()}))}(_,l,0,s):function(e,n,r,o){if(!e.adminRdyEvt)return void o({error:"EFORBIDDEN"});let a=n.id,i=n.content,c=Boolean(n.remove);e.adminRdyEvt.reg((()=>{let n=e.adminDoc.proxy,r=n.recorded=n.recorded||{};c?delete r[a]:r[a]={content:i,count:0},t.whenRealtimeSyncs(e.adminDoc.realtime,(function(){o({done:!0})}))}))}(_,l,0,s):function(n,t,r,o){n.adminRdyEvt?n.adminRdyEvt.reg((()=>{let t=n.adminDoc.proxy,r=t.recorded=t.recorded||{};o({messages:e.clone(r)})})):o({error:"EFORBIDDEN"})}(_,0,0,s):function(e,n,r,o){if(!e.adminRdyEvt)return void o({error:"EFORBIDDEN"});let a=n.channel,i=n.from,c=n.to;e.adminRdyEvt.reg((()=>{let n=e.adminDoc.proxy,r=n.tickets[i],s=n.tickets[c];if(!i||!c)return void o({error:"EINVAL"});let u=r[a];u&&!s[a]?(s[a]=u,delete r[a],t.whenRealtimeSyncs(e.adminDoc.realtime,(function(){o({moved:!0})}))):o({error:"CANT_MOVE"})}))}(_,l,0,s):function(e,n,r,o){if(!e.adminRdyEvt)return void o({error:"EFORBIDDEN"});let a=n.supportKey;e.adminRdyEvt.reg((()=>{let r=e.adminDoc.proxy;r.oldKeys&&r.oldKeys[a]&&(n.adminCurvePrivate=r.oldKeys[a].curvePrivate),y(e,n,!0,(r=>{if(r)o({error:r});else{var a=e.adminDoc.proxy,i=a.tickets.active[n.channel]||a.tickets.pending[n.channel];i.time=+new Date,i.lastAdmin=!0,a.tickets.closed[n.channel]=i,delete a.tickets.active[n.channel],delete a.tickets.pending[n.channel],t.whenRealtimeSyncs(e.adminDoc.realtime,(function(){o({closed:!0})}))}}))}))}(_,l,0,s):function(e,n,t,r){if(!e.adminRdyEvt)return void r({error:"EFORBIDDEN"});let o=n.supportKey;e.adminRdyEvt.reg((()=>{let t=e.adminDoc.proxy;t.oldKeys&&t.oldKeys[o]&&(n.adminCurvePrivate=t.oldKeys[o].curvePrivate),y(e,n,!0,((t,o)=>{if(t)r({error:t});else{var a=e.adminDoc.proxy,i=a.tickets.active[n.channel]||a.tickets.pending[n.channel];i.time=o,i.lastAdmin=!0,r({sent:!0})}}))}))}(_,l,0,s):function(n,t,r,o){let a=t.supportKey;n.adminRdyEvt.reg((()=>{let r=n.adminDoc.proxy;r.oldKeys&&r.oldKeys[a]&&(t.adminCurvePrivate=r.oldKeys[a].curvePrivate),p(n,t,!0,(function(r,a){if(r)return void o({error:r});var i=n.adminDoc.proxy;if(!Array.isArray(a)||!a.length)return void o(a);a.sort(((e,n)=>e.time-n.time));let c=a[a.length-1],s=a.some((n=>{let r=e.find(n,["sender","curvePublic"]);if(t.curvePublic===r)return e.find(n,["sender","quota","plan"])}));var u=i.tickets.active[t.channel];u&&(c.legacy&&(c=Array.isArray(c.messages)&&c.messages[c.messages.length-1]),u.time=c.time,u.premium=s,c.sender&&(u.lastAdmin=!c.sender.blockLocation),c.close&&(i.tickets.closed[t.channel]=u,delete i.tickets.active[t.channel],d(n,!0,"UPDATE_TICKET",t.channel))),o(a)}))}))}(_,l,0,s):function(n,t,r,o){n.adminRdyEvt?(n.clients[r]||(n.clients[r]={admin:!0}),n.adminRdyEvt.reg((()=>{var r=n.adminDoc.proxy;return"pending"===t.type?o(e.clone(r.tickets.pending)):"closed"===t.type?o(e.clone(r.tickets.closed)):void o(e.clone(r.tickets.active))}))):o({error:"EFORBIDDEN"})}(_,l,r,s):function(e,n,t,r){e.adminRdyEvt?e.adminRdyEvt.reg((()=>{v(e,n,!0,r)})):r({error:"EFORBIDDEN"})}(_,l,0,s):function(e,n,t,r){let o=e.supportData,a=n.channel;o[a]&&o[a].closed?(delete o[a],r({deleted:!0})):r({error:"ENOTCLOSED"})}(_,l,0,s):function(e,n,t,r){y(e,n,!1,(e=>{r(e?{error:e}:{closed:!0})}))}(_,l,0,s):function(e,n,t,r){y(e,n,!1,(e=>{r(e?{error:e}:{sent:!0})}))}(_,l,0,s):function(n,t,r,o){var i=[],c=a;n.clients[r]||(n.clients[r]={admin:!1}),Object.keys(n.supportData).forEach((function(t){c=c((r=>{var o=e.clone(n.supportData[t]);p(n,{channel:t,curvePublic:o.curvePublic},!1,r(((e,r)=>{if(e){if("EDELETED"===e.type)return void delete n.supportData[t];o.error=e}else o.messages=r,r.length&&r[r.length-1].close&&(n.supportData[t].closed=!0,o.closed=!0);o.id=t,i.push(o)})))})).nThen})),c((()=>{i.sort(((e,n)=>e.closed&&n.closed?e.time-n.time:e.closed?1:n.closed?-1:e.time-n.time)),o({tickets:i})}))}(_,0,r,s):function(e,n,t,r){v(e,n,!1,r)}(_,l,0,s)},u},l})(ee(),ae(),je(),Nn(),In(),We(),K(),S(),N(),O()),pt}function Mt(){if(mt)return yt;mt=1;var e,n,t;return e=K(),t=function(n,t,r,o){var a=t.channel,i=t.secret;i.keys.cryptKey&&(i.keys.cryptKey=function(e){for(var n=Object.keys(e).length,t=new Uint8Array(n),r=0;r<n;r++)t[r]=e[r];return t}(i.keys.cryptKey));var c=i.channel,s=n.store.network,u=!0,l=n.clients[r];if(l)o();else{l=n.clients[r]={channel:a};var f=n.channels[a];if(f)return l.id||(l.id=f.wc.myID+"-"+r),f.clients.push(r),void o();var d=function(t){n.channels[a]=n.channels[a]||{};var s=n.channels[a];s.padChan=c,l.id||(l.id=t.myID+"-"+r),s.clients&&s.clients.forEach((function(e){n.clients[e]&&!n.clients[e].id&&(n.clients[e].id=t.myID+"-"+e)})),s.encryptor||(s.encryptor=e.createEncryptor(i.keys)),t.on("message",(function(e){var t,r=s.encryptor.decrypt(e,i.keys&&i.keys.validateKey);try{t=JSON.parse(r),n.emit("MESSAGE",t,s.clients)}catch(e){console.error(e)}})),s.wc=t,s.sendMsg=function(e,n){n=n||function(){};var r=s.encryptor.encrypt(e);t.bcast(r).then((function(){n()}),(function(e){n({error:e})}))},u&&(s.clients=[r],u=!1,o())};s.join(a).then(d,(function(e){o({error:e})}));var h=function(){n.channels[a]?s.join(a).then(d,(function(e){console.error(e)})):console.log("cant reconnect",a)};n.channels[a]=n.channels[a]||{},n.channels[a].onReconnect=h,s.on("reconnect",h)}},(n={}).init=function(e,n,r){var o={};if(e.store&&e.store.modules&&e.store.modules.integration)return e.store.modules.integration;var a={store:e.store,emit:r,channels:{},clients:{}};return o.removeClient=function(e){!function(e,n){var t,r=function(e){return e!==n};for(var o in e.channels)(t=e.channels[o]).clients=t.clients.filter(r),0===t.clients.length&&(t.wc&&t.wc.leave(),t.onReconnect&&e.store.network.off("reconnect",t.onReconnect),delete e.channels[o]);delete e.clients[n]}(a,e)},o.leavePad=function(e){!function(e,n){Object.keys(e.channels).some((function(t){var r=e.channels[t];if(r.padChan===n)return r.wc&&r.wc.leave(),r.onReconnect&&e.store.network.off("reconnect",r.onReconnect),delete e.channels[t],!0}))}(a,e)},o.execCommand=function(e,n,r){var o=n.cmd,i=n.data;"INIT"!==o?"SEND"!==o||function(e,n,t,r){var o=e.clients[t];if(o){var a=e.channels[o.channel];if(a){var i={id:t,msg:n.msg,uid:n.uid};a.sendMsg(JSON.stringify(i),r),e.emit("MESSAGE",i,a.clients.filter((function(e){return e!==t})))}else r({error:"NO_CHAN"})}else r({error:"NO_CLIENT"})}(a,i,e,r):t(a,i,e,r)},o},yt=n}function Ft(){if(Et)return gt;Et=1;var e,n;return n=function(e,n,t){var r=e.clients[n];if(r){var o=e.channels[r.channel];o?(t(),o.history.forEach((function(t){e.emit("MESSAGE",{msg:t,validateKey:o.validateKey},[n])})),e.emit("HISTORY_SYNCED",{},[n])):t({error:"ENOCHAN"})}else t({error:"ENOENT"})},(e={}).init=function(e,t){var r={},o={store:e,emit:t,channels:{},clients:{}};return r.removeClient=function(e){!function(e,n){var t,r=function(e){return e!==n};for(var o in e.channels)(t=e.channels[o]).clients=t.clients.filter(r),0===t.clients.length&&(t.wc&&t.wc.leave(),delete e.channels[o]);if(e.clients[n]){var a=e.clients[n].channel,i=e.channels[a];i&&e.emit("LEAVE",{id:n},[i.clients[0]]),delete e.clients[n]}}(o,e)},r.leavePad=function(e){!function(e,n){Object.keys(e.channels).some((function(t){var r=e.channels[t];if(r.padChan===n)return r.wc&&r.wc.leave(),delete e.channels[t],!0}))}(o,e)},r.execCommand=function(e,t,r){var a=t.cmd,i=t.data;"SEND_MESSAGE"!==a?"UPDATE_HASH"!==a?"OPEN_CHANNEL"!==a?"GET_HISTORY"!==a?"REENCRYPT"!==a||function(e,n,t,r){var o=n.channel,a=e.store.network,i=function(e){var t=a.historyKeeper,o={metadata:n.metadata},i=["GET_HISTORY",e.id,o];a.sendto(t,JSON.stringify(i)),n.msgs.forEach((function(n){e.bcast(n)})),e.leave(),r()};e.store.anon_rpc.send("IS_NEW_CHANNEL",o,(function(e,n){var t;e?r({error:e}):(n&&n.length&&"object"==typeof n[0]?t=n[0].isNew:r({error:"INVALID_RESPONSE"}),t?a.join(o).then(i,(function(e){r({error:e})})):r({error:"EEXISTS"}))}))}(o,i,0,r):n(o,e,r):function(e,t,r,o){var a=t.channel,i=t.padChan,c=e.store.network,s=!0,u=e.clients[r];if(u)o();else{u=e.clients[r]={channel:a};var l=e.channels[a];if(l)return u.id||(u.id=l.wc.myID+"-"+r),n(e,r,(function(){e.emit("READY",l.clients,[r])})),l.clients.push(r),void o();var f=Math.floor(1e6*Math.random()),d=function(n){e.channels[a]=e.channels[a]||{history:[],validateKey:t.validateKey},(l=e.channels[a]).padChan=i,u.id||(u.id=n.myID+"-"+r),l.clients&&l.clients.forEach((function(t){e.clients[t]&&(e.clients[t].id=n.myID+"-"+t)})),n.on("join",(function(){})),n.on("leave",(function(){})),n.on("message",(function(n){l.history.push(n),e.emit("MESSAGE",{msg:n,validateKey:l.validateKey},l.clients)})),l.wc=n,l.sendMsg=function(e,t){t=t||function(){};var r=e.slice(0,64);n.bcast(e).then((function(){l.history.push(e),l.lastKnownHash=r,t()}),(function(e){t({error:e})}))},s&&(l.clients=[r],l.lastCpHash=t.lastCpHash,s=!1,o());var d=c.historyKeeper,h={txid:f,lastKnownHash:l.lastKnownHash||l.lastCpHash,metadata:{forcePlaceholder:!0,validateKey:t.validateKey,owners:t.owners,expire:t.expire}},p=["GET_HISTORY",n.id,h];d&&c.sendto(d,JSON.stringify(p)).then((function(){}),(function(e){console.error(e)}))};c.on("message",(function(n,t){if(e.channels[a]&&t===c.historyKeeper){var r;try{r=JSON.parse(n)}catch(e){}if(r&&!(r.txid&&r.txid!==f||r.channel&&r.channel!==a))if(r.validateKey&&r.channel)l.validateKey||(l.validateKey=r.validateKey);else if(r.state&&1===r.state&&r.channel)e.emit("READY",l.clients,l.clients);else if(r.error&&r.channel)e.emit("READY",l.clients,l.clients);else if(!(Array.isArray(r)&&r[0]&&r[0]!==f||(n=r[4],r[3]!==a))){var o=n.slice(0,64);o!==l.lastKnownHash&&o!==l.lastCpHash&&(l.lastKnownHash=o,e.emit("MESSAGE",{msg:n},l.clients),l.history.push(n))}}})),c.join(a).then(d,(function(e){o({error:e})})),c.on("reconnect",(function(){e.channels[a]&&c.join(a).then(d,(function(e){console.error(e)}))}))}}(o,i,e,r):function(e,n,t,r){var o=e.clients[t];if(o){var a=e.channels[o.channel];if(a){var i=n,c=-1;a.history.some((function(e,n){if(e.slice(0,64)===i)return c=n+1,!0})),-1!==c&&(a.history=a.history.slice(c)),r()}else r({error:"INVALID_CHANNEL"})}else r({error:"NOT_IN_CHANNEL"})}(o,i,e,r):function(e,n,t,r){var o=e.clients[t];if(o){var a=e.channels[o.channel];if(a){var i=function(o){o&&o.error?r(o):(e.emit("MESSAGE",{msg:n.msg},a.clients.filter((function(e){return e!==t}))),r())};n.isCp?a.sendMsg(n.isCp,i):a.sendMsg(n.msg,i)}else r({error:"INVALID_CHANNEL"})}else r({error:"NOT_IN_CHANNEL"})}(o,i,e,r)},r},gt=e}function Lt(){if(At)return bt;At=1;return bt=((e,n,t,r,o,a,i)=>{var c={};return c.init=function(c,s,u){var l={},f=c.store;if(f.loggedIn&&f.proxy.edPublic){var d={Store:c.Store,store:f,pinPads:c.pinPads,updateMetadata:c.updateMetadata,emit:u,onReadyHandlers:[],clients:[]};return d.profile=f.proxy.profile=f.proxy.profile||{},function(e,t){var r=e.profile;if(r.edit&&r.view)setTimeout(t);else{var o=n.createRandomHash("profile"),a=n.getSecrets("profile",o);e.pinPads([a.channel],(function(e){e.error?t(e.error):(r.edit=n.getEditHashFromKeys(a),r.view=n.getViewHashFromKeys(a),setTimeout(t))}))}}(d,s((function(r){r||function(r){var c=r.profile,s=n.getSecrets("profile",c.edit),u=a.createEncryptor(s.keys),l={data:{},network:r.store.network,channel:s.channel,crypto:u,owners:[r.store.proxy.edPublic],ChainPad:i,validateKey:s.keys.validateKey||void 0,userName:"profile",classic:!0},f=o.create(l);f.proxy.on("create",(function(){})).on("ready",(function(){f.proxy.name=r.store.proxy[t.displayNameKey]||"",r.listmap=f,f.proxy.curvePublic||(f.proxy.curvePublic=r.store.proxy.curvePublic),f.proxy.notifications||(f.proxy.notifications=e.find(r.store.proxy,["mailboxes","notifications","channel"])),f.proxy.edPublic||(f.proxy.edPublic=r.store.proxy.edPublic),r.onReadyHandlers.length&&(r.onReadyHandlers.forEach((function(e){try{e(f.proxy)}catch(e){console.error(e)}})),r.onReadyHandlers=[])})).on("change",[],(function(){r.emit("UPDATE",f.proxy,r.clients)}))}(d)}))),l.setName=function(e){!function(e,n){e.listmap.proxy.name=n,r.whenRealtimeSyncs(e.listmap.realtime,(function(){e.listmap&&e.emit("UPDATE",e.listmap.proxy,e.clients)}))}(d,e)},l.removeClient=function(e){!function(e,n){var t=e.clients.indexOf(n);-1!==t&&e.clients.splice(t,1)}(d,e)},l.update=function(){d.listmap&&d.emit("UPDATE",d.listmap.proxy,d.clients)},l.execCommand=function(e,n,t){console.log(n);var o=n.cmd,a=n.data;"SUBSCRIBE"!==o?"SET"!==o||function(e,n,t,o){var a=n.key,i=n.value;a&&(e.listmap.proxy[a]=i,r.whenRealtimeSyncs(e.listmap.realtime,(function(){e.emit("UPDATE",e.listmap.proxy,e.clients.filter((function(e){return e!==t}))),"badge"===a&&e.Store.set(null,{key:["profile","badge"],value:i||void 0},(()=>{})),o(e.listmap.proxy)})))}(d,a,e,t):function(e,n,t,r){-1===e.clients.indexOf(t)&&e.clients.push(t),e.listmap?r(e.listmap.proxy):e.onReadyHandlers.push((function(e){r(e)}))}(d,0,e,t)},l}},c})(ee(),ae(),q(),je(),S(),K(),N()),bt}function Kt(){if(wt)return _t;wt=1;return _t=function(e,n,t,r,o,a){var i={},c=function(e){return Boolean(e&&"object"==typeof e&&!Array.isArray(e))},s=function(e){return e.slice(0,64)},u=function(n,t){var r=e.find(t,[n,"role"]);return-1!==["OWNER","ADMIN"].indexOf(r)},l=function(n,t,r){var o=e.find(r,[n,"role"]);return!!o&&(!!function(e){return-1!==["OWNER","ADMIN","MEMBER","VIEWER"].indexOf(e)}(t)&&("OWNER"===o||"ADMIN"===o&&-1!==["ADMIN","MEMBER","VIEWER"].indexOf(t)))},f=function(e){return"string"==typeof e&&44===e.length},d=i.commands={};d.ADD=function(e,n,t){if(!c(e))throw new Error("INVALID ARGS");if(!t.internal.initialized)throw new Error("UNITIALIZED");if(void 0===t.state.members)throw new Error("CANNOT_ADD_TO_UNITIALIZED_ROSTER");var r=t.state.members;Object.keys(e).forEach((function(t){if(!f(t))throw console.log(t,t.length),new Error("INVALID_CURVE_KEY");if(!c(e[t]))throw new Error("INVALID_CONTENT");if(r[t])throw new Error("ALREADY_PRESENT");var o=e[t];if("string"!=typeof o.role&&(o.role="MEMBER"),!l(n,o.role,r))throw new Error("INSUFFICIENT_PERMISSIONS");if("string"!=typeof o.displayName)throw new Error("DISPLAYNAME_REQUIRED");if("string"!=typeof o.notifications)throw new Error("NOTIFICATIONS_REQUIRED")}));var o=!1;return Object.keys(e).forEach((function(n){o=!0,r[n]=e[n]})),o},d.RM=function(n,t,r){if(!Array.isArray(n))throw new Error("INVALID_ARGS");if(void 0===r.state.members)throw new Error("CANNOT_RM_FROM_UNITIALIZED_ROSTER");var o=r.state.members;n.forEach((function(n){if(!f(n))throw new Error("INVALID_CURVE_KEY");if(n!==t){var r=o[n].role;if(!function(n,t,r){var o=e.find(r,[n,"role"]);return!!o&&("OWNER"===o||"ADMIN"===o&&-1!==["ADMIN","MEMBER","VIEWER"].indexOf(t))}(t,r,o))throw new Error("INSUFFICIENT_PERMISSIONS")}}));var a=!1;return n.forEach((function(e){o[e]&&(a=!0,delete o[e])})),a},d.DESCRIBE=function(n,t,o){if(!n||"object"!=typeof n||Array.isArray(n))throw new Error("INVALID_ARGUMENTS");if(void 0===o.state.members)throw new Error("NOT_READY");var a=o.state.members;Object.keys(n).forEach((function(r){if(!f(r))throw new Error("INVALID_ID");if(!a[r])throw new Error("NOT_PRESENT");if(!function(n,t,r){if(!r[t])return!1;if(n===t&&r[t])return!0;var o=e.find(r,[n,"role"]),a=e.find(r,[t,"role"]);return!!o&&("OWNER"===o||"ADMIN"===o&&"OWNER"!==a)}(t,r,a))throw new Error("INSUFFICIENT_PERMISSIONS");var o=n[r];if(!c(o))throw new Error("INVALID_ARGUMENTS");var i=e.clone(a[r]);if("string"==typeof o.role&&!function(n,t,r,o){return!(n!==t||!o[t])&&("MEMBER"===e.find(o,[n,"role"])?"VIEWER"===r:void 0)}(t,r,o.role,a)&&!l(t,o.role,a))throw new Error("INSUFFICIENT_PERMISSIONS");if("string"!=typeof i.displayName&&"string"!=typeof o.displayName)throw new Error("DISPLAYNAME_REQUIRED");if(-1===["undefined","string"].indexOf(typeof o.displayName))throw new Error("INVALID_DISPLAYNAME");if("string"!=typeof i.notifications&&"string"!=typeof o.notifications)throw new Error("NOTIFICATIONS_REQUIRED");if(-1===["undefined","string"].indexOf(typeof o.notifications))throw new Error("INVALID_NOTIFICATIONS")}));var i=!1;return Object.keys(n).forEach((function(t){var o=e.clone(a[t]),c=n[t];Object.keys(c).forEach((function(e){void 0===o[e]||null!==c[e]?o[e]=c[e]:delete o[e]})),r(o)!==r(a[t])&&(i=!0,a[t]=o)})),i},d.CHECKPOINT=function(e,n,t){if(!c(e))throw new Error("INVALID_CHECKPOINT_STATE");if(!t.internal.initialized){t.state=e;var o=t.state.metadata=t.state.metadata||{};return o.topic=o.topic||"",o.name=o.name||"",o.avatar=o.avatar||"",t.internal.initialized=!0,!0}if(r(e)!==r(t.state))throw new Error("CHECKPOINT_DOES_NOT_MATCH_PREVIOUS_STATE");if(!u(n,t.state.members))throw new Error("INSUFFICIENT_PERMISSIONS");return t.state=e,!0};var h=["avatar","name","topic"];d.METADATA=function(n,t,r){if(!c(n))throw new Error("INVALID_ARGS");if(!function(n,t){var r=e.find(t,[n,"role"]);return Boolean(r&&-1!==["OWNER","ADMIN"].indexOf(r))}(t,r.state.members))throw new Error("INSUFFICIENT_PERMISSIONS");Object.keys(n).forEach((function(e){if(null===n[e]){if(-1===h.indexOf(e))return;throw new Error("CANNOT_REMOVE_MANDATORY_METADATA")}if("string"!=typeof n[e])throw new Error("INVALID_ARGUMENTS")}));var o=!1;return Object.keys(n).forEach((function(e){void 0!==r.state.metadata[e]&&null===n[e]&&(o=!0,delete r.state.metadata[e]),n[e]!==r.state.metadata[e]&&(o=!0,r.state.metadata[e]=n[e])})),o},d.INVITE=function(e,n,t){if(!c(e))throw new Error("INVALID_ARGS");if(!t.internal.initialized)throw new Error("UNINITIALIED");if(void 0===t.state.members)throw new Error("CANNOT+INVITE_TO_UNINITIALIED_ROSTER");var r=t.state.members;Object.keys(e).forEach((function(t){if(!f(t))throw console.log(t,t.length),new Error("INVALID_CURVE_KEY");if(!c(e[t]))throw new Error("INVALID_CONTENT");if(r[t])throw new Error("ARLEADY_PRESENT");var o=e[t];if("string"!=typeof o.role&&(o.role="VIEWER"),void 0===o.pending&&(o.pending=!0),!l(n,o.role,r))throw new Error("INSUFFICIENT_PERMISSIONS");if("string"!=typeof o.displayName||!o.displayName)throw new Error("DISPLAYNAME_REQUIRED")}));var o=!1;return Object.keys(e).forEach((function(n){o=!0,r[n]=e[n]})),o},d.ACCEPT=function(n,t,r){if(!r.internal.initialized)throw new Error("UNINITIALIED");if(void 0===r.state.members)throw new Error("CANNOT_ADD_TO_UNINITIALIED_ROSTER");var o=r.state.members;if(!c(o[t]))throw new Error("INSUFFICIENT_PERMISSIONS");if(!o[t].pending)throw new Error("ALREADY_PRESENT");if("string"!=typeof n)throw new Error("INVALID_ARGS");if(!f(n))throw new Error("INVALID_CURVE_KEY");var a=n;if(void 0!==o[a])throw new Error("MEMBER_ALREADY_PRESENT");var i=e.clone(o[t]);delete i.remaining,delete i.totalUses,delete i.inviteChannel,delete i.previewChannel,o[a]=i;var s=o[t].remaining||1;return-1===s||(s>1?o[t].remaining=s-1:delete o[t]),!0};var p=function(e,n,t){if(!Array.isArray(e)||"string"!=typeof n)throw new Error("INVALID ARGUMENTS");var r=e[0];if("function"!=typeof d[r])throw new Error("INVALID_COMMAND");return d[r](e[1],n,t)},v=function(n,t,r){return p(n,t,e.clone(r))};return i.create=function(n,i){if("function"!=typeof i)throw new Error("EXPECTED_CALLBACK");var l=e.once(e.mkAsync(i));if(n.network)if(n.channel&&"string"==typeof n.channel&&32===n.channel.length)if(n.keys&&"object"==typeof n.keys)if(n.store){var d=e.response((function(e,n){console.error("ROSTER_RESPONSE__"+e,n)})),h=n.store,y=n.keys,m=y.myCurvePublic,g=n.channel,E=n.lastKnownHash||-1;n.newTeam&&(E=void 0);var b={state:{members:{},metadata:{}},internal:{initialized:!1,sinceLastCheckpoint:0,lastCheckpointHash:E}},A={},_={change:e.mkEvent(),checkpoint:e.mkEvent()};A.on=function(e,n){if("object"!=typeof _[e])throw new Error("unsupported event");return _[e].reg(n),A},A.off=function(e,n){if("object"!=typeof _[e])throw new Error("unsupported event");return _[e].unreg(n),A},A.once=function(e,n){if("object"!=typeof _[e])throw new Error("unsupported event");var t=function(){n.apply(null,Array.prototype.slice.call(arguments)),_[e].unreg(t)};return _[e].reg(t),A},A.getState=function(){return e.clone(b.state)},A.getLastCheckpointHash=function(){return b.internal.lastCheckpointHash||-1};var w=function(){b.internal.pendingCheckpointId&&(d.clear(b.internal.pendingCheckpointId),delete b.internal.pendingCheckpointId),clearTimeout(b.internal.checkpointTimeout),delete b.internal.checkpointTimeout};A.stop=function(){b.internal.cpNetflux&&"function"==typeof b.internal.cpNetflux.stop?(b.internal.cpNetflux.stop(),w()):console.log("FAILED TO LEAVE")};var O,D,S,T=!1,x=function(){if(n.onCacheReady){var e=b.state;if(Object.keys(e.members||{}).length)n.onCacheReady(A);else{try{b.internal.cpNetflux.resetCache()}catch(e){console.error(e)}n.onCacheReady({error:"CORRUPTED"})}}},C=function(){T=!0,l(void 0,A)},N=function(e){e&&"EUNKNOWN"===e.type||(T?console.error("CHANNEL_ERROR",e):l(e))},I=function(e){e.state||(T=!1)},R=function(){console.log("ROSTER CONNECTED")},P=function(){return Boolean(T&&m)},k=function(n,t,r,o,a,i){O!==a&&b.internal.sinceLastCheckpoint++,O=a;var c=e.tryParse(n);if(c){var l,f;try{l=p(c,i,b)}catch(e){f=e.message}var h=s(a);if(d.expected(h)){if(f)return void d.handle(h,[f]);try{l?d.handle(h,[void 0,A.getState()]):(d.handle(h,["NO_CHANGE"]),console.log(n))}catch(e){console.log("CAUGHT",e)}}if("CHECKPOINT"===c[0]&&l?(P()&&_.checkpoint.fire(a),b.internal.sinceLastCheckpoint=0,b.internal.lastCheckpointHash=a):l&&P()&&_.change.fire(),w(),P()&&function(e,n){if(!u(e,n.state.members))return!1;var t=n.internal.sinceLastCheckpoint;return!(!t||"number"!=typeof t||t<25)}(m,b)){var v=1e3*Math.floor(20*Math.random())+5e3;b.internal.checkpointTimeout=setTimeout((function(){b.internal.pendingCheckpointId=A.checkpoint((function(e){e&&console.error(e)}))}),v)}}else console.error("could not parse")},M=function(n,t){var r=e.tryParse(n);return"CHECKPOINT"===r[0]&&v(r,t,b)},F=function(e,n){if(P()){var t=h.anon_rpc;if(t){var o=!1;try{o=v(e,y.myCurvePublic,b)}catch(e){return void n(e.message)}if(o){var a=S.encrypt(r(e)),i=s(a);return d.expect(i,(function(e,t){e?n(e):n(void 0,t,i)}),3e4),t.send("WRITE_PRIVATE_MESSAGE",[g,a],(function(e){if(e)return d.handle(i,[e.message||e])})),i}n("NO_CHANGE")}else n("ANON_RPC_NOT_READY")}else n("NOT_READY")};A.init=function(n,t){var r=e.once(e.mkAsync(t));if(b.internal.initialized)r("ALREADY_INITIALIZED");else if(c(n)){var o=e.clone(n);o.role="OWNER";var a={};a[m]=o,F(["CHECKPOINT",{members:a}],r)}else r("INVALID_ARGUMENTS")},A.checkpoint=function(n){var t=e.once(e.mkAsync(n));F(["CHECKPOINT",e.clone(b.state)],t)},A.add=function(n,t){var r=e.once(e.mkAsync(t));if(!b.internal.initialized)return r("UNINITIALIZED");if(c(n)){var o=e.clone(n);Object.keys(o).forEach((function(e){if(!f(e)||c(b.state.members[e]))return delete o[e]})),F(["ADD",o],r)}else r("INVALID_ARGUMENTS")},A.remove=function(n,t){var r=e.once(e.mkAsync(t)),o=b.state;if(!o)return r("UNINITIALIZED");if(Array.isArray(n)){var a=e.clone(n),i=[],c=Object.keys(o.members);a.forEach((function(e){-1!==c.indexOf(e)&&i.push(e)})),F(["RM",i],r)}else r("INVALID_ARGUMENTS")},A.describe=function(n,t){var r=e.once(e.mkAsync(t)),o=b.state;if(!o)return r("UNINITIALIZED");if(c(n)){var a=e.clone(n);Object.keys(a).some((function(e){var n=a[e];if(c(n)||delete a[e],!c(o.members[e]))return!0;Object.keys(n).forEach((function(t){n[t]===o.members[e][t]&&delete n[t]}))}))?r("INVALID_ARGUMENTS"):F(["DESCRIBE",a],r)}else r("INVALID_ARGUMENTS")},A.metadata=function(n,t){var r=e.once(e.mkAsync(t)),o=b.state.metadata;if(c(n)){var a=e.clone(n);Object.keys(a).forEach((function(e){a[e]===o[e]&&delete a[e]})),F(["METADATA",a],r)}else r("INVALID_ARGUMENTS")},A.invite=function(n,t){var r=e.once(e.mkAsync(t));if(!b.state)return r("UNINITIALIZED");if(!b.internal.initialized)return r("UNINITIALIZED");if(c(n)){var o=e.clone(n);Object.keys(o).forEach((function(e){if(!f(e)||c(b.state.members[e]))return delete o[e]})),F(["INVITE",o],r)}else r("INVALID_ARGUMENTS")},A.accept=function(n,t){var r=e.once(e.mkAsync(t));"string"==typeof n&&f(n)?F(["ACCEPT",n],r):r("INVALID_ARGUMENTS")},o((function(e){h.anon_rpc&&h.anon_rpc.send("GET_METADATA",g,(function(n,t){if(n)return e.abort(),void console.error(n);D=b.internal.metadata=t&&t[0]||void 0}))})).nThen((function(e){if(!n.keys.teamEdPublic&&D&&D.validateKey&&(n.keys.teamEdPublic=D.validateKey),!n.keys.teamEdPublic)return e.abort(),void l("NO_VALIDATE_KEY");try{S=a.Team.createEncryptor(n.keys)}catch(n){return e.abort(),void l(n)}})).nThen((function(){"string"==typeof E&&console.log("Synchronizing from checkpoint"),b.internal.cpNetflux=t.start({lastKnownHash:E,network:n.network,channel:n.channel,crypto:S,validateKey:n.keys.teamEdPublic,owners:n.owners,Cache:n.Cache,isCacheCheckpoint:M,onCacheReady:x,onChannelError:N,onReady:C,onConnect:R,onConnectionChange:I,onMessage:k,noChainPad:!0})}))}else l("EXPECTED_STORE");else l("EXPECTED_CRYPTO_KEYS");else l("EXPECTED_CHANNEL");else l("EXPECTED_NETWORK")},i}(ee(),ae(),O(),An(),We(),K()),_t}function Ht(){if(Tt)return St;Tt=1;return St=((e,n,t,r,o,a,i,c,s,u,l,f,d,h,p,v,y,m,g)=>{const E={};var b=e.mkEvent(!0),A=function(){},_=function(e,t,r,o){t&&(o||(r.on("change",["drive",a.SHARED_FOLDERS],(function(o,c,s){if(s.length>3&&"password"===s[3]){var u=s[2],l=r.drive[a.SHARED_FOLDERS][u],f=t.manager.user.userObject.getHref?t.manager.user.userObject.getHref(l):l.href,d=n.parsePadUrl(f),h=n.getSecrets(d.type,d.hash,o);return setTimeout((function(){i.updatePassword(e.Store,{oldChannel:h.channel,password:c,href:f},e.store.network,(function(){console.log("Shared folder password changed")}))})),!1}})),r.on("disconnect",(function(){t.offline=!0,t.sendEvent("NETWORK_DISCONNECT",t.id)})),r.on("reconnect",(function(){t.offline=!1,t.sendEvent("NETWORK_RECONNECT",t.id)}))),r.on("change",[],(function(n,r,i){if(o){if(i[0]===a.FILES_DATA&&"object"==typeof r&&r.channel&&!r.owners){var c=[r.channel];r.rtChannel&&c.push(r.rtChannel),r.lastVersion&&c.push(r.lastVersion),t.pin(c,(function(e){e&&e.error&&console.error(e.error)}))}if(i[0]===a.FILES_DATA&&"object"==typeof n&&n.channel&&!r){var s=[n.channel];t.manager.findChannel(n.channel).some((function(e){return e.fId!==o}))||(n.rtChannel&&s.push(n.rtChannel),n.lastVersion&&s.push(n.lastVersion),t.unpin(s,(function(e){e&&e.error&&console.error(e)})))}}n&&!r&&Array.isArray(i)&&(i[0]===a.FILES_DATA||"drive"===i[0]&&i[1]===a.FILES_DATA)&&setTimeout((function(){e.Store.checkDeletedPad(n&&n.channel)})),t.sendEvent("DRIVE_CHANGE",{id:o,old:n,new:r,path:i})})),r.on("remove",[],(function(e,n){t.sendEvent("DRIVE_REMOVE",{id:o,old:e,path:n})})))},w=function(e,n){var t=e.teams[n];if(t){try{t.listmap.stop()}catch(e){}try{t.roster.stop()}catch(e){}t.proxy={},t.stopped=!0,delete e.teams[n],delete e.cache[n],delete e.store.proxy.teams[n],e.emit("LEAVE_TEAM",n,t.clients),e.updateMetadata(),e.store.calendar&&e.store.calendar.closeTeam(n),e.store.mailbox&&e.store.mailbox.close("team-"+n,(function(){}))}},O=function(e,n,t,r){n.rpc?r():t.edPrivate&&t.edPublic?h.create(e.store.network,t,(function(e,t){e?r(e):(n.rpc=t,n&&n.onRpcReadyEvt&&n.onRpcReadyEvt.fire(),r())}),d):r("EFORBIDDEN")},D=function(t,r,a,c,s,u,l){var f=e.once(e.mkAsync(l));if(t.cache[r])f();else{var d=a.proxy,h={id:r,proxy:d,listmap:a,clients:[],realtime:a.realtime,handleSharedFolder:function(e,n){!function(e,n,t,r){var o=e.teams[n];o&&(r?(o.sharedFolders[t]=r,_(e,o,r.proxy,t)):delete o.sharedFolders[t])}(t,r,e,n)},sharedFolders:{},roster:c,onRpcReadyEvt:e.mkEvent(!0),offline:!0};t.cache[r]=h,u&&h.clients.push(u),c.on("change",(function(){var n=c.getState(),o=e.find(t,["store","proxy","curvePublic"]);if(n.members&&Object.keys(n.members).length)if(n.members[o]){var a=e.find(t,["store","proxy","teams",r]);a&&(a.metadata=n.metadata),t.updateMetadata(),t.emit("ROSTER_CHANGE",r,h.clients)}else w(t,r);else console.error(JSON.stringify(n))})),c.on("checkpoint",(function(n){e.find(t,["store","proxy","teams",r,"keys","roster"]).lastKnownHash=n})),h.sendEvent=function(e,n,r){t.emit(e,n,h.clients.filter((function(e){return e!==r})))},h.getChatData=function(){var e=s.chat||{},t=e.edit||e.view;if(!t)return{};var o=n.getSecrets("chat",t);return{teamId:r,channel:o.channel,secret:o,validateKey:e.validateKey}},h.pin=function(e,n){s.drive.edPrivate?h.rpc?("function"!=typeof n&&console.error("expected a callback"),h.rpc.pin(e,(function(e,t){n(e?{error:e}:{hash:t})}))):n({error:"TEAM_RPC_NOT_READY"}):n({error:"EFORBIDDEN"})},h.unpin=function(e,n){s.drive.edPrivate?h.rpc?("function"!=typeof n&&console.error("expected a callback"),h.rpc.unpin(e,(function(e,t){n(e?{error:e}:{hash:t})}))):n({error:"TEAM_RPC_NOT_READY"}):n({error:"EFORBIDDEN"})};var p=t.store.proxy.teams[h.id],v=p.hash||p.roHash,y=n.getSecrets("team",v,p.password),m=h.manager=o.create(d.drive,{onSync:function(e){t.Store.onSync(r,e)},edPublic:s.drive.edPublic,pin:h.pin,unpin:h.unpin,loadSharedFolder:function(e,n,r,o){i.load({isNew:o,network:t.store.network||t.store.networkPromise,store:h,isNewChannel:t.Store.isNewChannel,Store:t.Store},e,n,r)},settings:{drive:e.find(t.store,["proxy","settings","drive"])},removeOwnedChannel:function(e,n){var o;"object"==typeof e?(e.teamId=r,o=e):o={channel:e,teamId:r},t.Store.pad.destroy("",o,n)},Store:t.Store,store:t.store},{teamId:h.id,outer:!0,edPublic:s.drive.edPublic,loggedIn:!0,log:function(e){h.sendEvent("DRIVE_LOG",e)},rt:h.realtime,editKey:y.keys.secondaryKey,readOnly:Boolean(!y.keys.secondaryKey)});h.secondaryKey=y&&y.keys.secondaryKey,h.userObject=m.user.userObject,g((function(e){t.teams[r]=h,_(t,h,d);var n=t.store.network||t.store.networkPromise;i.loadSharedFolders(t.Store,n,h,h.proxy.drive,h.userObject,e,(function(e){t.progress+=70/(t.numberOfTeams*e.max),t.updateProgress({progress:t.progress})}),!0)})).nThen((function(){t.store.modules.calendar&&t.store.modules.calendar.openTeam(r),f()}))}},S=function(t,r,o,a,c,s,u){var l,f=a.getState(),d=e.find(t,["store","proxy","teams",r]);d&&(d.metadata=f.metadata),delete t.nocache[r],t.store.proxy.teams[r]&&g((function(e){D(t,r,o,a,c,s,e()),l=t.teams[r]||t.cache[r],c.drive.edPrivate&&O(t,l,c.drive,e((function(){})))})).nThen((function(e){l.userObject.fixFiles(),i.checkMigration(l.secondaryKey,l.proxy?.drive,l.userObject,e()),i.loadSharedFolders(t.Store,t.store.network,l,l.proxy?.drive,l.userObject,e,(function(e){t.progress+=70/(t.numberOfTeams*e.max),t.updateProgress({progress:t.progress})}))})).nThen((function(){if(l.rpc){var o=function(n,t){var r=n.teams[t];if(!r)return null;var o=r.manager.getChannelsList("pin"),a=n.store.proxy.teams[t];o.push(`${a.channel}#drive`);var i=e.find(a,["keys","chat","channel"]),c=e.find(a,["keys","roster","channel"]),s=e.find(a,["keys","mailbox","channel"]);if(i&&o.push(i),c&&o.push(c),s&&o.push(s),r.proxy.calendars){var u=Object.keys(r.proxy.calendars).map((function(e){return r.proxy.calendars[e].channel}));o=o.concat(u)}var l=r.roster.getState();return l.members&&Object.keys(l.members).forEach((function(e){var n=l.members[e];n.inviteChannel&&n.pending&&o.push(n.inviteChannel),n.previewChannel&&n.pending&&o.push(n.previewChannel)})),o.sort(),o}(t,r),a=n.hashChannelList(o);l.rpc.getServerHash((function(e,n){e?console.warn(e):n!==a&&l.rpc.reset(o,(function(e){e&&console.warn(e)}))}))}})).nThen((function(){l.offline=!1,t.onReadyHandlers[r]&&t.onReadyHandlers[r].forEach((function(e){("function"==typeof e.cb&&e.cb(),e.cId)&&(-1===l.clients.indexOf(e.cId)&&l.clients.push(e.cId))})),delete t.onReadyHandlers[r],t.store.modules.calendar&&t.store.modules.calendar.openTeam(r),u()}))},T=function(e,n,t,r,o,a){var i=function(){(e.cache[n]||e.teams[n])&&w(e,n),delete e.store.proxy.teams[n],delete e.onReadyHandlers[n],o.abort(),a({error:"ENOENT"})};t&&e.store.anon_rpc.send("IS_NEW_CHANNEL",t,o((function(e,n){n&&n.length&&"object"==typeof n[0]&&n[0].isNew&&i()}))),r&&e.store.anon_rpc.send("IS_NEW_CHANNEL",r,o((function(e,n){n&&n.length&&"object"==typeof n[0]&&n[0].isNew&&i()})))},x=function(t,r,o,a,i){var l=e.once(e.mkAsync(a)),f=r.hash||r.roHash,h=n.getSecrets("team",f,r.password),y=v.createEncryptor(h.keys);r.roHash||(r.roHash=n.getViewHashFromKeys(h));var E,A,_=r.keys;if(!_.chat.validateKey&&_.chat.edit){var O=n.getSecrets("chat",_.chat.edit);_.chat.validateKey=O.keys.validateKey}var x={curvePublic:t.store.proxy.curvePublic,curvePrivate:t.store.proxy.curvePrivate},C=_.roster||{},N=C.edit?v.Team.deriveMemberKeys(C.edit,x):v.Team.deriveGuestKeys(C.view||"");g((function(e){if(i)return d.getChannelCache(h.channel,e((function(n,t){t&&t.c||(e.abort(),l({error:"NOCACHE"}))}))),void d.getChannelCache(N.channel,e((function(n,t){var r=t&&t.c,o=t&&t.k;o&&!N.teamEdPublic&&(N.teamEdPublic=o),r||(e.abort(),l({error:"NOCACHE"}))})));t.Store.onReadyEvt.reg((()=>{T(t,o,h.channel,N.channel,e,l)}))})).nThen((function(n){var a={lm:!1,roster:!1,check:function(){this.lm&&this.roster&&i&&(t.progress+=30/t.numberOfTeams,t.updateProgress({progress:t.progress}),D(t,o,A,E,_,null,n(l)),this.check=function(){})}},u={data:{},readOnly:!Boolean(h.keys.signKey),network:t.store.network||t.store.networkPromise,channel:h.channel,crypto:y,ChainPad:m,Cache:d,metadata:{validateKey:h.keys.validateKey||void 0},userName:"team",classic:!0,onMetadataUpdate:function(){var e=t.teams[o];e&&t.emit("ROSTER_CHANGE",o,e.clients)}};(A=p.create(u)).proxy.on("cacheready",(function(){a.lm=!0,a.check()})),A.proxy.on("ready",n()),A.proxy.on("error",(function(e){e&&void 0!==e.loaded&&!e.loaded&&l({error:"ECONNECT"}),e&&e.error&&"EDELETED"===e.error&&w(t,o)})),c.create({network:t.store.network||t.store.networkPromise,channel:N.channel,keys:N,store:t.store,lastKnownHash:C.lastKnownHash,onCacheReady:function(e){if(i){if(e&&"CORRUPTED"===e.error)return console.error("Corrupted roster cache, cant load this team offline",r),A&&"function"==typeof A.stop&&A.stop(),n.abort(),void l({error:"CACHE_CORRUPTED_ROSTER"});E=e,a.roster=!0,a.check()}},Cache:d},n((function(r,o){if(r)return n.abort(),console.error(r),void l({error:"ROSTER_ERROR"});E=o,C.lastKnownHash=E.getLastCheckpointHash();var a=E.getState(),i=e.find(t,["store","proxy","curvePublic"]);a.members[i]&&b.reg((function(){if(C.edit){var e={},n=s.createData(t.store.proxy,!1);n.pending=!1,e[t.store.proxy.curvePublic]=n,E.describe(e,(function(e){e&&"NO_CHANGE"!==e&&console.error(e)}))}}))})))})).nThen((function(n){var a=E.getState(),i=e.find(t,["store","proxy","curvePublic"]);if(!a.members||!Object.keys(a.members).length)return A.stop(),E.stop(),A.proxy={},l({error:"EINVAL"}),n.abort(),console.error(JSON.stringify(a)),void u.send("ROSTER_CORRUPTED");if(!a.members[i])return A.stop(),E.stop(),A.proxy={},delete t.store.proxy.teams[o],t.updateMetadata(),l({error:"EFORBIDDEN"}),void n.abort();var c=a.members[i],s=e.find(r,["keys","drive","edPrivate"]);if(r.hash&&s||-1===["ADMIN","MEMBER"].indexOf(c.role))r.hash&&s||"OWNER"!==c.role||u.send("TEAM_RIGHTS_OWNER");else{console.warn("Missing edit rights: demote to viewer");var f={};f[t.store.proxy.curvePublic]={role:"VIEWER"},E.describe(f,(function(e){u.send("TEAM_RIGHTS_FIXED"),delete r.hash,delete r.keys.drive.edPrivate,delete r.keys.chat.edit,e&&"NO_CHANGE"!==e&&console.error(e)}))}})).nThen((function(){i||(t.progress+=30/t.numberOfTeams,t.updateProgress({progress:t.progress})),S(t,o,A,E,_,null,l)}))},C=function(n,t,r,o){var a=t.team;if(!((a.hash||a.roHash)&&a.channel&&a.password&&a.keys&&a.metadata))return void o({error:"EINVAL"});let i=n.store.proxy.teams;if(Object.values(i).some((e=>e.channel===a.channel)))o({error:"EEXISTS"});else{var c=e.createRandomInteger();n.store.proxy.teams[c]=a,n.onReadyHandlers[c]=[],x(n,a,c,(function(e){e&&e.error||console.debug("Team joined:"+c);var t=n.store.proxy.teams[c];n.store.mailbox.open("team-"+c,t.keys.mailbox,(function(){}),!0,{owners:t.keys.drive.edPublic}),n.updateMetadata(),o(e)}))}},N=function(n,t,r){var o=e.find(n,["store","proxy","teams",t]);if(!o)return{};var a=e.clone(o);return r||(delete a.hash,delete a.keys.drive.edPrivate,delete a.keys.chat.edit),delete a.owner,a},I=function(t,r,o){if(!r)return!0;var a=e.find(t,["store","proxy","teams",r]);if(!a)return!0;var c=t.teams[r];if(!c)return!0;var s=n.getSecrets("team",o||a.roHash,a.password);if(i.upgrade(a.channel,s),c.userObject&&c.userObject.setReadOnly(!s.keys.secondaryKey,s.keys.secondaryKey),s.keys.secondaryKey)try{t.store.modules.calendar.upgradeTeam(r)}catch(e){console.error(e)}!s.keys.secondaryKey&&c.rpc&&c.rpc.destroy();var u=e.find(c,["proxy","drive","sharedFolders"]);Object.keys(u||{}).forEach((function(t){var r=c.manager.getSharedFolderData(t),o=n.parsePadUrl(r.href||r.roHref),a=n.getSecrets(o.type,o.hash,r.password);i.upgrade(a.channel,a);var s=e.find(c,["manager","folders",t,"userObject"]);s&&s.setReadOnly(!a.keys.secondaryKey,a.keys.secondaryKey)})),t.updateMetadata(),t.emit("ROSTER_CHANGE_RIGHTS",r,c.clients)},R=function(t,r,o,a,i){if(r){var c=e.find(t,["store","proxy","teams",r]);if(c){var s=t.onReadyHandlers[r],u=t.teams[r];if(c.channel===a.channel&&c.password===a.password)if(o?(c.hash=a.hash,c.keys.drive.edPrivate=a.keys.drive.edPrivate,c.keys.chat.edit=a.keys.chat.edit):(delete c.hash,delete c.keys.drive.edPrivate,delete c.keys.chat.edit),u||!Array.isArray(s))if(u){if(o){O(t,u,c.keys.drive,(function(){u.manager.addPin(u.pin,u.unpin)}));var l=n.getSecrets("team",a.hash,c.password);u.secondaryKey=l&&l.keys.secondaryKey;var f=v.createEncryptor(l.keys);u.listmap.setReadOnly(!1,f)}else delete u.secondaryKey,u.rpc&&u.rpc.destroy&&u.rpc.destroy(),u.manager.removePin(),u.listmap.setReadOnly(!0);I(t,r,a.hash),i(!0)}else i(!1);else s.push({cb:function(){R(t,r,o,a,i)}});else i(!1)}else i(!1)}else i(!1)},P=function(n,t,r,o,a){t?e.find(n,["store","proxy","teams",t])&&n.teams[t]?n.store.mailbox.sendTo("TEAM_EDIT_RIGHTS",{state:o,teamData:N(n,t,o)},{channel:r.notifications,curvePublic:r.curvePublic},a):a({error:"ENOENT"}):a({error:"EINVAL"})},k=function(n,t,r,o){var a=t.teamId;if(a){var i=e.find(n,["store","proxy","teams",a]),c=n.teams[a];if(i&&c)if(c.roster)if(t.curvePublic&&t.data){var s,u=c.roster.getState().members[t.curvePublic];g((function(e){n.Store.pad.getMetadata(null,{channel:i.channel},e((function(e){s=e&&e.error?c.listmap.metadata||{}:e})))})).nThen((function(){if(u.pendingOwner=Array.isArray(s.pending_owners)&&-1!==s.pending_owners.indexOf(u.edPublic),"OWNER"!==u.role||"OWNER"===t.data.role){"VIEWER"===u.role&&"VIEWER"!==t.data.role&&P(n,a,u,!0,(function(e){o(e)})),"VIEWER"!==u.role&&"VIEWER"===t.data.role&&P(n,a,u,!1,(function(e){o(e)}));var r={};r[t.curvePublic]=t.data,c.roster.describe(r,(function(e){e?o({error:e}):o()}))}else!function(n,t,r,o){var a=e.once(o);if(t){var i=e.find(n,["store","proxy","teams",t]);if(i){var c=n.teams[t];if(c){var s=r.pendingOwner;g((function(t){var o=s?"RM_PENDING_OWNERS":"RM_OWNERS",c=function(e){var n=e&&e.error;if(n)return console.error(n),t.abort(),void a(n)},u=function(e){n.Store.pad.setMetadata(null,{channel:e,command:o,value:[r.edPublic]},t(c))};u(i.channel),u(e.find(i,["keys","roster","channel"])),u(e.find(i,["keys","chat","channel"]))})).nThen((function(e){var n={};n[r.curvePublic]={role:"ADMIN",pendingOwner:!1},c.roster.describe(n,e((function(e){e&&console.error(e)})))})).nThen((function(e){n.store.mailbox.sendTo("RM_OWNER",{teamChannel:i.channel,title:i.metadata.name,pending:s},{channel:r.notifications,curvePublic:r.curvePublic},e())})).nThen((function(){a()}))}else a({error:"ENOENT"})}else a({error:"ENOENT"})}else a({error:"EINVAL"})}(n,a,u,(function(e){e?(console.error(e),o({error:e})):o()}))}))}else o({error:"MISSING_DATA"});else o({error:"NO_ROSTER"});else o({error:"ENOENT"})}else o({error:"EINVAL"})},M=function(e,n){Object.keys(e.onReadyHandlers).forEach((function(t){var r=-1;e.onReadyHandlers[t].some((function(e,t){if(e.cId===n)return r=t,!0})),-1!==r&&e.onReadyHandlers[t].splice(r,1)})),Object.keys(e.teams).forEach((function(t){var r=e.teams[t].clients,o=r.indexOf(n);-1!==o&&r.splice(o,1)}))},F=function(n,t,r,o){var a,i=t.seeds;try{a=l.derivePreviewKeys(i.preview)}catch(e){return void o({error:"INVALID_SEEDS"})}f.get({channel:a.channel,type:"pad",version:2,keys:{cryptKey:a.cryptKey}},(function(n,t){if(n)o({error:n});else if(t){var r=e.tryParse(t);o(r||{error:"parseError"})}else o({error:"DELETED"})}),{network:n.store.network,initialState:"{}"})},L=function(n,t,r,o){var a,i;g((function(r){!function(n,t,r,o){var a,i=t.bytes64;try{a=l.deriveInviteKeys(i)}catch(e){return void o({error:"INVALID_SEEDS"})}f.get({channel:a.channel,type:"pad",version:2,keys:{cryptKey:a.cryptKey}},(function(n,t){if(n)o({error:n});else if(t){var r=e.tryParse(t);o(r||{error:"parseError"})}else o({error:"DELETED"})}),{network:n.store.network,initialState:"{}"})}(n,t,0,r((function(e){if(e&&e.error)return r.abort(),void o(e);a=e})))})).nThen((function(t){var r=e.find(a,["teamData","channel"]),u=n.store.proxy.teams||{};if(Object.keys(u).some((function(e){return u[e].channel===r})))return t.abort(),void o({error:"ALREADY_MEMBER"});var l=e.find(a,["teamData","keys","roster"]),f=a.ephemeral;if(!l||!f)return t.abort(),void o({error:"INVALID_INVITE_CONTENT"});var h=v.Team.deriveMemberKeys(l.edit,f);c.create({network:n.store.network||n.store.networkPromise,channel:l.channel,keys:h,store:n.store,Cache:d},t((function(e,r){if(e)return t.abort(),console.error(e),void o({error:"ROSTER_ERROR"});var a=s.createData(n.store.proxy,!1),c=r.getState();i=c.members[f.curvePublic],r.accept(a.curvePublic,t((function(e){if(r.stop(),e)return t.abort(),console.error(e),void o({error:"ACCEPT_ERROR"})})))})))})).nThen((function(){var e={};i.remaining&&1!==i.remaining||O(n,e,a.ephemeral,(function(n){if(!n){var t=e.rpc;i.inviteChannel&&t.removeOwnedChannel(i.inviteChannel,(function(e){e&&console.error(e)})),i.previewChannel&&t.removeOwnedChannel(i.previewChannel,(function(e){e&&console.error(e)}))}})),C(n,{team:a.teamData},0,o)}))},K=function(n){if(n){if(n.keys&&n.keys.mailbox)return n.keys.mailbox;var t=e.find(n,["keys","roster","edit"]);if(t){var r=v.CryptoAgility.createHash(e.decodeUTF8(t)),o=r.slice(0,32),a=e.uint8ArrayToHex(r.slice(32,48)),i=v.CryptoAgility.boxKeyPairFromSecretKey(o);return{channel:a,viewed:[],keys:{curvePrivate:e.encodeBase64(i.secretKey),curvePublic:e.encodeBase64(i.publicKey)}}}}};return E.init=function(t,r,o){var a={},i=t.store;if(i.loggedIn&&i.proxy.edPublic&&!i.modules?.team){var h={store:i,Store:t.Store,pinPads:t.pinPads,emit:o,onReadyHandlers:{},teams:{},cache:{},nocache:{},updateMetadata:t.updateMetadata,updateProgress:t.updateLoadingProgress,progress:0};i.proxy.teams||(i.proxy.teams={});var E=i.proxy.teams;h.numberOfTeams=Object.keys(E).length,h.store.proxy.on("change",["teams"],(function(e,n,t){"hash"===t[2]&&I(h,t[1],n)})),h.store.proxy.on("remove",["teams"],(function(e,n){"hash"===n[2]&&I(h,n[1])}));var _=function(n,t){if(!n||!t)return!0;try{var r=e.decodeBase64(n),o=v.CryptoAgility.signKeyPairFromSecretKey(r);return e.encodeBase64(o.publicKey)===t}catch(e){return!1}};Object.keys(E).forEach((function(n){h.onReadyHandlers[n]=[],e.find(E,[n,"keys","mailbox"])||(E[n].keys.mailbox=K(E[n])),x(h,E[n],n,r((function(e){if(e){delete h.onReadyHandlers[n],delete h.cache[n],"NOCACHE"===e?.error&&(h.nocache[n]=!0);var t="string"==typeof e?e:e.type||e.message;return u.send("TEAM_LOADING_ERROR="+t),void console.error(e)}console.debug("Team "+n+" cache ready")})),d.isEnabled())})),a.onReady=function(t){var r;r={},Object.keys(E).forEach((function(t){try{var o=E[t],a=r[o.channel],i=e.find(o,["keys","drive","edPrivate"]),c=e.find(o,["keys","drive","edPublic"]);if(c?i&&c&&!_(i,c)&&(u.send("TEAM_CORRUPTED_EDPRIVATE"),delete E[t].keys.drive.edPrivate,i=void 0):u.send("TEAM_CORRUPTED_EDPUBLIC"),o.hash&&2===n.parseTypeHash("drive",o.hash).version&&40!==o.hash.length&&u.send("TEAM_CORRUPTED_HASH"),!a)return void(r[o.channel]=t);var s=E[a],l=e.find(s,["keys","drive","edPrivate"]),f=e.find(s,["keys","chat","edit"]),d=e.find(o,["keys","chat","edit"]);!s.hash&&o.hash&&(s.hash=o.hash),!l&&i&&(s.keys.drive.edPrivate=i),!f&&d&&(s.keys.chat.edit=d),h.store.proxy.duplicateTeams=h.store.proxy.duplicateTeams||{},h.store.proxy.duplicateTeams[t]=E[t],delete E[t]}catch(e){console.error(e)}}));var o=function(e){return!E[e]&&(w(h,e),delete h.onReadyHandlers[e],!0)};Object.keys(h.teams).forEach(o),Object.keys(h.onReadyHandlers).forEach((function(n){if(!o(n)){var r=h.store.proxy.teams[n],a=e.find(r,["keys","roster","channel"]),i=e.once(e.mkAsync(t()));g((function(e){T(h,n,r.channel,a,e,i)})),h.onReadyHandlers[n].push({cb:i})}})),Object.keys(E).forEach((function(n){h.onReadyHandlers[n]||h.teams[n]||(h.onReadyHandlers[n]=[],e.find(E,[n,"keys","mailbox"])||(E[n].keys.mailbox=K(E[n])),x(h,E[n],n,t((function(e){if(e){var t="string"==typeof e?e:e.type||e.message;return u.send("TEAM_LOADING_ERROR="+t),void console.error(e)}console.debug("Team "+n+" ready")}))))})),A(),b.fire()},a.getTeam=function(e){return h.teams[e]},a.getTeamsData=function(n){var t={},r=!1;return-1!==["drive","teams","settings"].indexOf(n)&&(r=!0),Object.keys(E).forEach((function(n){if(h.teams[n]){var o=h.teams[n].proxy||{},a=o.drive&&Object.keys(o.drive.filesData||{}).length,i=o.drive&&Object.keys(o.drive.sharedFolders||{}).length;t[n]={owner:E[n].owner,name:E[n].metadata.name,channel:E[n].channel,numberPads:a,numberSf:i,roster:e.find(E[n],["keys","roster","channel"]),edPublic:e.find(E[n],["keys","drive","edPublic"]),avatar:e.find(E[n],["metadata","avatar"]),viewer:!e.find(E[n],["keys","drive","edPrivate"]),notifications:e.find(E[n],["keys","mailbox","channel"]),curvePublic:e.find(E[n],["keys","mailbox","keys","curvePublic"]),validKeys:_(e.find(E[n],["keys","drive","edPrivate"]),e.find(E[n],["keys","drive","edPublic"]))},r&&h.teams[n]&&(t[n].secondaryKey=h.teams[n].secondaryKey),h.teams[n]&&(t[n].hasSecondaryKey=Boolean(h.teams[n].secondaryKey))}})),t},a.getTeams=function(){return Object.keys(h.teams)};a.removeFromTeam=function(e,n,t){if(E[e]&&(!t||function(e,n){var t=h.teams[e];if(t){var r=t.roster&&t.roster.getState();if(r.members)return(r.members[n]||{}).pending}}(e,n)))if(h.onReadyHandlers[e])h.onReadyHandlers[e].push({cb:function(){h.teams[e].roster.remove([n],(function(e){e&&"NO_CHANGE"!==e&&console.error(e)}))}});else{var r=h.teams[e];r?r.roster.remove([n],(function(e){e&&"NO_CHANGE"!==e&&console.error(e)})):console.error("TEAM MODULE ERROR")}},a.changeMyRights=function(e,n,t,r){R(h,e,n,t,r)},a.updateMyData=function(e){Object.keys(h.teams).forEach((function(n){var t=h.teams[n];if(t.roster){var r={};r[e.curvePublic]=e,t.roster.describe(r,(function(e){e&&console.error(e)}))}}))},a.removeClient=function(e){M(h,e)};return a.execCommand=function(t,r,o){var a=r.cmd,i=r.data;if("SUBSCRIBE"!==a)if("LIST_TEAMS"!==a)if("OPEN_TEAM_CHAT"!==a)if("GET_TEAM_ROSTER"!==a)if("GET_TEAM_METADATA"!==a)if("SET_TEAM_METADATA"!==a){if("OFFER_OWNERSHIP"===a)return h.store.offline?void o({error:"OFFLINE"}):void function(n,t,r,o){var a=e.once(o),i=t.teamId;if(i){var c=e.find(n,["store","proxy","teams",i]);if(c){var s=n.teams[i];if(s)if(s.roster)if(t.curvePublic){var u=s.roster.getState().members[t.curvePublic];g((function(t){var r=function(e){var n=e&&e.error;if(n)return console.error(n),t.abort(),void a({error:n})},o=function(e){n.Store.pad.setMetadata(null,{channel:e,command:"ADD_PENDING_OWNERS",value:[u.edPublic]},t(r))};o(c.channel),o(e.find(c,["keys","roster","channel"])),o(e.find(c,["keys","chat","channel"]))})).nThen((function(e){var n={};n[u.curvePublic]={role:"OWNER"},s.roster.describe(n,e((function(e){e&&console.error(e)})))})).nThen((function(t){n.store.mailbox.sendTo("ADD_OWNER",{teamChannel:c.channel,chatChannel:e.find(c,["keys","chat","channel"]),rosterChannel:e.find(c,["keys","roster","channel"]),title:c.metadata.name},{channel:u.notifications,curvePublic:u.curvePublic},t())})).nThen((function(){a()}))}else a({error:"MISSING_DATA"});else a({error:"NO_ROSTER"});else a({error:"ENOENT"})}else a({error:"ENOENT"})}else a({error:"EINVAL"})}(h,i,0,o);if("ANSWER_OWNERSHIP"===a)return h.store.offline?void o({error:"OFFLINE"}):void function(n,t,r,o){var a,i=n.store.proxy.teams;if(Object.keys(i).forEach((function(e){if(i[e].channel===t.teamChannel)return a=e,!0})),a){var c=e.find(n,["store","proxy","teams",a]);if(c){var s=n.teams[a];if(s)if(s.roster){var u={};t.answer?c.owner=!0:(u[n.store.proxy.curvePublic]={role:"ADMIN"},s.roster.describe(u,(function(e){e?o({error:e}):o()})))}else o({error:"NO_ROSTER"});else o({error:"ENOENT"})}else o({error:"ENOENT"})}else o({error:"EINVAL"})}(h,i,0,o);if("DESCRIBE_USER"!==a){if("INVITE_TO_TEAM"===a)return h.store.offline?void o({error:"OFFLINE"}):void function(e,n,t,r){var o=n.teamId;if(o){var a=e.teams[o];if(a)if(a.roster){var i=n.user;if(i&&i.curvePublic&&i.notifications){delete i.channel,delete i.lastKnownHash,i.pending=!0;var c={};c[i.curvePublic]=i,c[i.curvePublic].role="VIEWER",a.roster.add(c,(function(n){n&&"NO_CHANGE"!==n?r({error:n}):e.store.mailbox.sendTo("INVITE_TO_TEAM",{team:N(e,o)},{channel:i.notifications,curvePublic:i.curvePublic},(function(e){r(e)}))}))}else r({error:"MISSING_DATA"})}else r({error:"NO_ROSTER"});else r({error:"ENOENT"})}else r({error:"EINVAL"})}(h,i,0,o);if("LEAVE_TEAM"!==a){if("JOIN_TEAM"===a)return h.store.offline?void o({error:"OFFLINE"}):void C(h,i,0,o);if("REMOVE_USER"!==a){if("DELETE_TEAM"===a)return h.store.offline?void o({error:"OFFLINE"}):void function(n,t,r,o){var a=t.teamId;if(a){var i=n.teams[a],c=e.find(n,["store","proxy","teams",a]);if(i&&c){var s=i.roster.getState(),l=e.find(n,["store","proxy","curvePublic"]),f=s.members[l];if(!f||"OWNER"!==f.role)return o({error:"EFORBIDDEN"});var d=e.find(n,["store","proxy","edPublic"]),h=e.find(c,["keys","drive","edPublic"]);g((function(e){n.Store.anonRpcMsg(null,{msg:"GET_METADATA",data:c.channel},e((function(n){if(n&&n.error)return e.abort(),o({error:n.error});var t=n[0];t&&Array.isArray(t.owners)&&-1!==t.owners.indexOf(d)||(e.abort(),o({error:"EFORBIDDEN"}))})))})).nThen((function(t){i.proxy.delete=!0;var r=i.manager.getChannelsList("owned"),o=e.Saferphore.create(10);r.forEach((function(e){var r=t();o.take((function(t){var o=!1;g((function(r){32===e.length&&n.Store.anonRpcMsg(null,{msg:"GET_METADATA",data:e},r((function(e){if(e&&e.error)return t(),void r.abort();var n=e[0];if(!n||!Array.isArray(n.owners)||-1===n.owners.indexOf(h))return t(),void r.abort();o=n.owners.some((function(e){return e!==h}))})))})).nThen((function(t){o?n.Store.pad.setMetadata(null,{channel:e,command:"RM_OWNERS",value:[h]},t()):i.rpc.removeOwnedChannel(e,t((function(e){e&&console.error(e)})))})).nThen((function(){t(),r()}))}))}))})).nThen((function(t){i.rpc.removePins(t((function(e){e&&console.error(e)})));var r=e.find(c,["keys","mailbox","channel"]);i.rpc.removeOwnedChannel(r,t((function(e){e&&console.error(e)})));var o=e.find(c,["keys","roster","channel"]);n.store.rpc.removeOwnedChannel(o,t((function(e){e&&console.error(e)})));var a=e.find(c,["keys","chat","channel"]);n.store.rpc.removeOwnedChannel(a,t((function(e){e&&console.error(e)}))),n.store.rpc.removeOwnedChannel(c.channel,t((function(e){e&&console.error(e)})))})).nThen((function(){u.send("TEAM_DELETION"),w(n,a),o()}))}else o({error:"ENOENT"})}else o({error:"EINVAL"})}(h,i,0,o);if("CREATE_TEAM"===a)return h.store.offline?void o({error:"OFFLINE"}):void function(t,r,o,a){var i,l=e.once(a),f=n.createChannelId(),h=n.createRandomHash("team",f),E=n.getSecrets("team",h,f),b=n.getViewHashFromKeys(E),A=v.CryptoAgility.signKeyPair(),_=v.CryptoAgility.curveKeyPair(),O=v.Team.createSeed(),D=v.Team.deriveMemberKeys(O,{curvePublic:t.store.proxy.curvePublic,curvePrivate:t.store.proxy.curvePrivate}),T=n.getSecrets("chat"),x=n.getHashes(T),C={network:t.store.network,channel:E.channel,data:{},validateKey:E.keys.validateKey,crypto:v.createEncryptor(E.keys),logLevel:1,classic:!0,ChainPad:m,Cache:d,owners:[t.store.proxy.edPublic]};g((function(e){c.create({network:t.store.network||t.store.networkPromise,channel:D.channel,owners:[t.store.proxy.edPublic],keys:D,store:t.store,lastKnownHash:void 0,newTeam:!0,Cache:d},e((function(n,r){if(n)return e.abort(),console.error(n),void l({error:"ROSTER_ERROR"});i=r;var o=s.createData(t.store.proxy);delete o.channel,i.init(o,e((function(n){if(n)return e.abort(),void l({error:"ROSTER_INIT_ERROR"})})))})));var n,r=v.createEncryptor(T.keys),o={network:t.store.network,channel:T.channel,noChainPad:!0,crypto:r,metadata:{validateKey:T.keys.validateKey,owners:[t.store.proxy.edPublic]}},a=e();o.onReady=function(){n&&n.stop(),a()},o.onError=function(){e.abort(),l({error:"CHAT_INIT_ERROR"})},n=y.start(o)})).nThen((function(e){i.metadata({name:r.name},e((function(n){if(n)return e.abort(),void l({error:"ROSTER_INIT_ERROR"})})))})).nThen((function(){var a=e.createRandomInteger();C.onMetadataUpdate=function(){var e=t.teams[a];e&&t.emit("ROSTER_CHANGE",a,e.clients)};var c=p.create(C),s=c.proxy;s.version=2,s.on("ready",(function(){var d={mailbox:{channel:n.createChannelId(),viewed:[],keys:{curvePrivate:e.encodeBase64(_.secretKey),curvePublic:e.encodeBase64(_.publicKey)}},drive:{edPrivate:e.encodeBase64(A.secretKey),edPublic:e.encodeBase64(A.publicKey)},chat:{edit:x.editHash,view:x.viewHash,validateKey:T.keys.validateKey,channel:T.channel},roster:{channel:D.channel,edit:O,view:D.viewKeyStr}},p=t.store.proxy.teams[a]={owner:!0,channel:E.channel,hash:h,roHash:b,password:f,keys:d,metadata:{name:r.name}};s.drive={},S(t,a,c,i,d,o,(function(){u.send("TEAM_CREATION"),t.store.mailbox.open("team-"+a,p.keys.mailbox,(function(){}),!0,{owners:p.keys.drive.edPublic}),t.updateMetadata(),l()}))})).on("error",(function(e){e&&void 0!==e.loaded&&!e.loaded&&l({error:"ECONNECT"}),e&&e.error&&"EDELETED"===e.error&&w(t,a)}))}))}(h,i,t,o);if("GET_EDITABLE_FOLDERS"!==a)if("CREATE_INVITE_LINK"!==a){if("GET_PREVIEW_CONTENT"!==a)return"ACCEPT_LINK_INVITATION"===a?h.store.offline?void o({error:"OFFLINE"}):void L(h,i,0,o):void 0;F(h,i,0,o)}else!function(n,t,r,o){var a=e.mkAsync(e.once(o)),i=t.teamId,c=n.teams[t.teamId],u=t.seeds,d=t.bytes64;if(i&&c){var h,p=c.roster;try{h=p.getState().metadata.name}catch(e){return void a({error:"TEAM_NAME_ERR"})}var v=t.message,y=t.name,m=t.hash,E=e.find(n,["store","proxy","teams",i]);try{var b=l.encryptHash(m,E.hash)}catch(e){console.error(e)}var A=l.derivePreviewKeys(u.preview),_=l.deriveInviteKeys(d),w=l.generateKeys(),O=t.role||"VIEWER",D=t.uses||1;g((function(e){!function(){var t=l.generateSignPair(),r={initialState:"{}",network:n.store.network,metadata:{owners:[n.store.proxy.edPublic,w.edPublic]}};r.metadata.validateKey=t.validateKey;var o={teamName:h,message:v,author:s.createData(n.store.proxy,!1),displayName:y},i={channel:A.channel,type:"pad",version:2,keys:{cryptKey:A.cryptKey,validateKey:t.validateKey,signKey:t.signKey}};f.put(i,JSON.stringify(o),e((function(n){if(n)return console.error("CRYPTPUT_ERR",n),e.abort(),void a({error:"SET_PREVIEW_CONTENT"})})),r)}(),function(){var t=l.generateSignPair(),r={initialState:"{}",network:n.store.network,metadata:{owners:[n.store.proxy.edPublic,w.edPublic]}};r.metadata.validateKey=t.validateKey;var o={teamData:N(n,i,"MEMBER"===O),ephemeral:{edPublic:w.edPublic,edPrivate:w.edPrivate,curvePublic:w.curvePublic,curvePrivate:w.curvePrivate}},c={channel:_.channel,type:"pad",version:2,keys:{cryptKey:_.cryptKey,validateKey:t.validateKey,signKey:t.signKey}};f.put(c,JSON.stringify(o),e((function(n){if(n)return console.error("CRYPTPUT_ERR",n),e.abort(),void a({error:"SET_PREVIEW_CONTENT"})})),r)}()})).nThen((function(e){c.pin([_.channel,A.channel],(function(e){e&&e.error&&console.error(e.error)})),l.createRosterEntry(c.roster,{curvePublic:w.curvePublic,content:{curvePublic:w.curvePublic,displayName:t.name,pending:!0,remaining:D,totalUses:D,role:O,hash:b,inviteChannel:_.channel,previewChannel:A.channel}},e((function(n){n&&(e.abort(),a(n))})))})).nThen((function(){a()}))}else a({error:"EINVAL"})}(h,i,0,o);else!function(n,t,r,o){var a=t.teamId;if(a){var i=n.teams[a];if(i){var c=i.manager.folders||{};o(Object.keys(c).filter((function(e){return!c[e].proxy.version})).map((function(n){var t=e.find(i,["user","userObject"]);return{name:e.find(c,[n,"proxy","metadata","title"]),path:t?t.findFile(n)[0]:[]}})))}else o({error:"ENOENT"})}else o({error:"EINVAL"})}(h,i,0,o)}else!function(e,n,t,r){var o=n.teamId;if(o){var a=e.teams[o];if(a)if(a.roster)if(n.curvePublic){var i=a.roster.getState().members[n.curvePublic];a.roster.remove([n.curvePublic],(function(t){if(!t)return i&&i.notifications?void e.store.mailbox.sendTo("KICKED_FROM_TEAM",{pending:n.pending,teamChannel:N(e,o).channel,teamName:N(e,o).metadata.name},{channel:i.notifications,curvePublic:i.curvePublic},(function(e){r(e)})):r();r({error:t})}))}else r({error:"MISSING_DATA"});else r({error:"NO_ROSTER"});else r({error:"ENOENT"})}else r({error:"EINVAL"})}(h,i,0,o)}else!function(e,n,t,r){var o=n.teamId;if(o){var a=e.teams[o];if(a)if(a.roster){var i=e.store.proxy.curvePublic;a.roster.remove([i],(function(n){n?r({error:n}):(w(e,o),r())}))}else r({error:"NO_ROSTER"});else r({error:"ENOENT"})}else r({error:"EINVAL"})}(h,i,0,o)}else k(h,i,0,o)}else!function(e,n,t,r){var o=n.teamId;if(o){var a=e.teams[o];a?a.offline?r({error:"OFFLINE"}):a.roster?(n.metadata&&delete n.metadata.offline,a.roster.metadata(n.metadata,(function(t){if(t)r({error:t});else{var a=e.store.proxy.teams[o];a&&(a.metadata=n.metadata),r()}}))):r({error:"NO_ROSTER"}):r({error:"ENOENT"})}else r({error:"EINVAL"})}(h,i,0,o);else!function(e,n,t,r){var o=n.teamId;if(o){var a=e.teams[o];if(a)if(a.roster){var i=(a.roster.getState()||{}).metadata||{};i.offline=a.offline,r(i)}else r({error:"NO_ROSTER"});else r({error:"ENOENT"})}else r({error:"EINVAL"})}(h,i,0,o);else!function(n,t,r,o){var a=t.teamId;if(a){var i=e.find(n,["store","proxy","teams",a]);if(i){var c=n.teams[a];if(c)if(c.roster){var s,u=(c.roster.getState()||{}).members||{};g((function(e){n.Store.pad.getMetadata(null,{channel:i.channel},e((function(e){s=e&&e.error?c.listmap.metadata||{}:e})))})).nThen((function(){if(n.pending_owners=s.pending_owners,Array.isArray(s.pending_owners)&&s.pending_owners.forEach((function(t){var r;if(Object.keys(u).some((function(e){if(u[e].edPublic===t)return r=u[e],!0})),!r&&i.owner){var o=function(e){n.Store.pad.setMetadata(null,{channel:e,command:"RM_PENDING_OWNERS",value:[t]},(function(){}))};return o(i.channel),o(e.find(i,["keys","roster","channel"])),void o(e.find(i,["keys","chat","channel"]))}r.pendingOwner=!0})),n.store.messenger){var t=c.getChatData();(n.store.messenger.getOnlineList(t.channel)||[]).forEach((function(e){u[e]&&(u[e].online=!0)}))}Object.keys(u).forEach((function(e){var n=u[e];if(n.inviteChannel&&n.hash)if(i.hash)try{n.hash=l.decryptHash(n.hash,i.hash)}catch(e){console.error(e)}else delete n.hash})),o(u)}))}else o({error:"NO_ROSTER"});else o({error:"ENOENT"})}else o({error:"ENOENT"})}else o({error:"EINVAL"})}(h,i,0,o);else!function(e,n,t,r){var o=e.teams[n.teamId];if(o){var a=function(){e.emit("ROSTER_CHANGE",n.teamId,o.clients)};e.store.messenger?e.store.messenger.openTeamChat(o.getChatData(),a,t,r):A=function(){e.store.messenger.openTeamChat(o.getChatData(),a,t,r)}}else r({error:"ENOENT"})}(h,i,t,o);else!function(n){var t=e.clone(E);Object.keys(t).forEach((function(e){h.teams[e]?t[e].offline=h.teams[e].offline:(t[e].error=!0,h.nocache[e]&&(t[e].offline=!0))})),n(t)}(o);else!function(e,n,t,r){M(e,t);try{e.store.messenger.removeClient(t)}catch(e){}if(A=function(){},n)if(!e.onReadyHandlers[n]||e.teams[n])if(e.teams[n]){var o=e.teams[n].clients;-1===o.indexOf(t)&&o.push(t),r()}else r({error:"EINVAL"});else-1===e.onReadyHandlers[n].indexOf(t)&&e.onReadyHandlers[n].push({cId:t,cb:r});else r()}(h,i,t,o)},a}},E.anonGetPreviewContent=function(e,n,t){F(e,n,0,t)},E})(ee(),ae(),q(),je(),Qe(),Be(),ze(),Kt(),_n(),De(),(Dt||(Dt=1,Ot=function(e,n,t,r){var o={},a=e.encodeBase64,i=e.decodeBase64;o.generateKeys=function(){var e=r.CryptoAgility.signKeyPair(),n=r.CryptoAgility.curveKeyPair(),t=r.PQC.ml_dsa.ml_kem512().keygen(),o=r.PQC.ml_dsa.ml_dsa44.keygen();return{edPublic:a(e.publicKey),edPrivate:a(e.secretKey),curvePublic:a(n.publicKey),curvePrivate:a(n.secretKey),kemPublic:a(t.publicKey),kemPrivate:a(t.secretKey),dsaPublic:a(o.publicKey),dsaPrivate:a(o.secretKey)}},o.generateSignPair=function(){var e=r.CryptoAgility.signKeyPair(),n=r.PQC.ml_dsa.ml_dsa44.keygen();return{validateKey:a(e.publicKey),signKey:a(e.secretKey),dsaPublic:a(n.publicKey),dsaPrivate:a(n.secretKey)}};var c=function(t){var o=n.dispenser(i(t));return{channel:e.uint8ArrayToHex(o(16)),cryptKey:o(r.CryptoAgility.secretboxKeyLength())}};o.deriveInviteKeys=c,o.derivePreviewKeys=c,o.createRosterEntry=function(e,n,t){var r={};r[n.curvePublic]=n.content,e.invite(r,t)};var s=e.decodeUTF8;return o.encryptHash=function(e,n){var t=s(n),o=r.CryptoAgility.createHash(t).subarray(0,32);return r.encrypt(e,o)},o.decryptHash=function(e,n){var t=s(n),o=r.CryptoAgility.createHash(t).subarray(0,32);return r.decrypt(e,o)},o}(ee(),Ne(),h(),K())),Ot),In(),he(),Nn(),S(),K(),O(),N(),We(),h()),St}function jt(){if(Ct)return xt;Ct=1;return xt=((e,n,t,r,o,a,i,c)=>{var s=e.Curve;const u={};let l={};u.setCustomize=e=>{l=e.Messages};var f="MSG",d="UNFRIEND",h="MAP_ID",p="MAP_ID_ACK",v=function(e){return JSON.parse(JSON.stringify(e))},y=function(e){for(var n=Object.keys(e).length,t=new Uint8Array(n),r=0;r<n;r++)t[r]=e[r];return t},m=o.createData,g=function(e,n){if(n===e.curvePublic){var t=m(e);return delete t.channel,t}return e.friends?e.friends[n]:void 0},E=u.getFriendList=function(e){return e.friends||(e.friends={}),e.friends},b=function(e,n){return e.messages.some((function(e){return e.sig===n}))},A=function(e,n){var t,r=e.store.proxy,o=E(r);for(var a in o)if(o[a].channel===n){t=o[a];break}return t},_=function(e,n,t,r){e.range_requests||(e.range_requests={}),e.range_requests[n]={messages:[],cb:r,chanId:t}},w=function(e,n){delete e.range_requests[n]},O=function(e,n,r,o){var a=e.store.network;if(console.log("Fetching [%s] messages since [%s]",n.id,r.lastKnownHash||""),n.isPadChat||n.isTeamChat){var i=t.uid();_(e,i,n.id,void 0);var c=["GET_HISTORY_RANGE",n.id,{count:10,txid:i}];a.sendto(a.historyKeeper,JSON.stringify(c)).then((function(){}),(function(e){console.error(e)}))}else{var s=e.store.proxy,u=A(e,n.id)||{},l={metadata:{validateKey:o?o.validateKey:void 0,owners:[s.edPublic,u.edPublic]},lastKnownHash:r.lastKnownHash},f=["GET_HISTORY",n.id,l];a.sendto(a.historyKeeper,JSON.stringify(f)).then((function(){}),(function(e){console.error(e)}))}},D=function(e,n,t,r){var o=e.channels[n];if(o.isFriendChat){var a=A(e,n);if(!a)return void r({error:"NO_SUCH_FRIEND"});a.lastKnownHash=t}else if(o.isPadChat);else if(!o.isTeamChat)return void r({error:"NOT_IMPLEMENTED"});r()},S=function(e,n){var t=e.channels[n];t&&(t.ready=!0,t.onReady.fire())},T=function(e,n,t){var o=e.store.proxy.friends;o&&(delete o[n],r.whenRealtimeSyncs(e.store.realtime,(function(){e.updateMetadata(),t()})))},x=function(e,n,t){var r=t.slice(0,64);if(!b(n,r)){var o,a=n.decrypt(t),i=JSON.parse(a);if(i[0]===f){var c={type:i[0],sig:r,author:i[1],time:i[2],text:i[3],channel:n.id,name:i[4]};return n.messages.push(c),n.ready&&e.emit("MESSAGE",c,n.clients),!0}var s=e.store.proxy;if(i[0]!==d);else{if((o=i[1])===s.curvePublic)return;T(e,o,(function(){n.wc.leave(d);var t=e.store.network;n.onReconnect&&t.off("reconnect",n.onReconnect),delete e.channels[n.id],e.emit("UNFRIEND",{curvePublic:o,fromMe:!1},n.clients)}))}}},C=function(e,n,r){if(r===e.store.network.historyKeeper){var o,a=JSON.parse(n);if(!a.validateKey&&!a.owners||!a.channel)if(/HISTORY_RANGE/.test(a[0])){var i=a[1],c=function(e,n){return e.range_requests[n]}(e,i),s=a[0];if(!c)return;if(!(o=e.channels[c.chanId]))return;if(!c.cb){if("HISTORY_RANGE"===s){if(!Array.isArray(a[2]))return;x(e,o,a[2][4])}else if("HISTORY_RANGE_END"===s)return S(e,c.chanId),w(e,i);return}if("HISTORY_RANGE"===s)c.messages.push(a[2]);else{if("HISTORY_RANGE_END"===s){var u=c.messages.map((function(e){if("MSG"===e[2])try{return{d:JSON.parse(o.decrypt(e[4])),sig:e[4].slice(0,64)}}catch(e){return void console.log("failed to decrypt")}})).filter((function(e){if(e&&e.d&&e.d[0]===f&&!b(o,e.sig))return e})).map((function(e){return{type:e.d[0],sig:e.sig,author:e.d[1],time:e.d[2],text:e.d[3],channel:c.chanId,name:e.d[4]}}));return function(e,n){var t=e.messages;n.reverse().forEach((function(e){t.unshift(e)}))}(o,u),c.cb(u),w(e,i)}console.log(a)}}else{if(a.channel&&e.channels[a.channel]){if(o=e.channels[a.channel],"ECLEARED"===a.error)return D(e,a.channel,"",(function(){})),o.messages=[],void e.emit("CLEAR_CHANNEL",a.channel,o.clients);if(a.error&&("EINVAL"===a.error||"EUNKNOWN"===a.error))return void D(e,a.channel,"",(function(){O(e,o,{},{})}));if(a.state&&1===a.state&&a.channel)return void S(e,a.channel)}(o=e.channels[a[3]])&&x(e,o,a[4])}}else!function(e,n,r){var o,a;try{if(a=JSON.parse(n),!(o=e.channels[a.channel])||-1===o.wc.members.indexOf(r))return}catch(e){return void console.error(e,n)}var i=o.decrypt(a.msg);if(i){var c=t.tryParse(i);if(c){if((c[0]===h||c[0]===p)&&c[2]===r&&c[1]&&(o.mapId[r]=c[1],e.emit("JOIN",{info:c[1],id:o.id},o.clients),!o.readOnly&&c[0]===h)){var s=e.store.proxy||{},u=m(s);delete u.channel;var l=[p,u,o.wc.myID],f=JSON.stringify(l),d=o.encrypt(f),v={channel:o.id,msg:d};e.store.network.sendto(r,JSON.stringify(v))}}else console.error(i)}else console.error("Failed to decrypt message")}(e,n,r)},N=function(e,n,t){var r=e.channels[t];if(r){r.wc&&r.wc.leave(d);var o=e.store.network;r.onReconnect&&o.off("reconnect",r.onReconnect),delete e.channels[r.id],e.emit("UNFRIEND",{curvePublic:n,fromMe:!0},e.friendsClients)}},I=function(e){var n=[];return Array.prototype.push.apply(n,e.friendsClients),Object.keys(e.channels).forEach((function(t){Array.prototype.push.apply(n,e.channels[t].clients)})),t.deduplicateString(n)},R=function(e,n){var r=e.store.proxy,o=e.store.network,a=o.historyKeeper,i=n.keys,c=n.encryptor||s.createEncryptor(i),u={id:n.channel,isFriendChat:n.isFriendChat,isPadChat:n.isPadChat,isTeamChat:n.isTeamChat,padChan:n.padChan,readOnly:n.readOnly,ready:!1,onReady:t.mkEvent(!0),sending:!1,messages:[],clients:n.clients||[],onUserlistUpdate:n.onUserlistUpdate||function(){},mapId:{}};n.onReady&&u.onReady.reg(n.onReady),u.encrypt=function(e){if(!u.readOnly)return c.encrypt(e)},u.decrypt=n.decrypt||function(e){return c.decrypt(e)};var l=function(e){if(e!==a&&!u.readOnly&&!u.isPadChat){var n=m(r);delete n.channel;var t=[h,n,u.wc.myID],i=JSON.stringify(t),c=u.encrypt(i),s={channel:u.id,msg:c};o.sendto(e,JSON.stringify(s))}},f=function(n){if(n!==a){var t=u.mapId[n];t&&(u.wc.members.some((function(e){return u.mapId[e]&&u.mapId[e].curvePublic===t.curvePublic}))||e.emit("LEAVE",{info:t,id:u.id},u.clients))}},d=function(t){u.wc=t,e.channels[n.channel]=u,t.on("message",(function(n,r){!function(e,n,t,r){var o=e.channels[r.id];o&&x(e,o,n)}(e,n,0,t)})),t.on("join",l),t.on("leave",f),O(e,u,n,i)};o.join(n.channel).then(d,(function(e){console.error(e)})),u.onReconnect=function(){u&&u.stopped||e.channels[n.channel]&&o.join(n.channel).then(d,(function(e){console.error(e)}))},o.on("reconnect",u.onReconnect)},P=function(e,n,r,o){var a=t.once(t.mkAsync(o)),i=r.channel,c=e.channels[i];if(c)c.onReady.reg((function(){-1===c.clients.indexOf(n)&&c.clients.push(n),a()}));else{var u=e.store.proxy,l={keys:s.deriveKeys(r.curvePublic,u.curvePrivate),channel:r.channel,lastKnownHash:r.lastKnownHash,owners:[u.edPublic,r.edPublic],isFriendChat:!0,clients:n?[n]:e.friendsClients,onReady:a};R(e,l)}};return u.init=function(n,r,s){var u={},h=n.store;if(h.messenger)return h.messenger.addListener(),h.messenger;if(!i.isAvailable("contacts"))return;var p={store:h,Store:n.Store,updateMetadata:n.updateMetadata,pinPads:n.pinPads,emit:s,friendsClients:[],channels:{},validateKeys:{},range_requests:{}};u.addListener=function(){h.proxy&&h.proxy.on("change",["mutedUsers"],(function(){p.emit("UPDATE_MUTED",null,I(p))}))},u.addListener();let b=t.once((e=>{const n=p.store.network||e;n.on("message",(function(e,n){C(p,e,n)})),n.on("disconnect",(function(){p.emit("DISCONNECT",null,I(p))})),n.on("reconnect",(function(){p.emit("RECONNECT",null,I(p))}))}));return h.networkPromise?.then(b),p.store.network&&b(),u.onFriendUpdate=function(e){var n=g(h.proxy,e);if(n&&n.channel){var t=p.channels[n.channel];t&&p.emit("UPDATE_DATA",{info:v(n),channel:n.channel},t.clients)}},u.onFriendAdded=function(e){if(p.friendsClients.length){var n=g(p.store.proxy,e.curvePublic);if("object"==typeof n)if(n.channel){var t=n.channel;p.channels[t]||P(p,null,n,(function(){s("FRIEND",{curvePublic:n.curvePublic},p.friendsClients)}))}}},u.onFriendRemoved=function(e,n){N(p,e,n)},u.getOnlineList=function(e){return function(e,n){var t=e.channels[n];if(t){var r=[],o=m(e.store.proxy,!1);return r.push(o.curvePublic),t.wc.members.forEach((function(n){if(n!==e.store.network.historyKeeper){var o=t.mapId[n]||{};o.curvePublic&&-1===r.indexOf(o.curvePublic)&&r.push(o.curvePublic)}})),r}}(p,e)},u.storeValidateKey=function(e,n){p.validateKeys[e]=n},u.leavePad=function(e){delete p.validateKeys[e],Object.keys(p.channels).some((function(n){var t=p.channels[n];if(t.padChan===e){t.wc&&t.wc.leave();var r=p.store.network;return t.onReconnect&&r.off("reconnect",t.onReconnect),t.stopped=!0,delete p.channels[n],!0}}))},u.openTeamChat=function(n,r,o,a){!function(n,r,o,a,i){var c=o,s=c.channel,u=c.secret;if(s&&u){var l=t.once(t.mkAsync((function(){n.emit("TEAMCHAT_READY",s,[r]),i({readOnly:"object"==typeof u.keys&&!u.keys.validateKey,channel:s})}))),f=n.channels[s];if(f)f.onReady.reg((function(){-1===f.clients.indexOf(r)&&f.clients.push(r),l()}));else{u.keys.cryptKey&&(u.keys.cryptKey=y(u.keys.cryptKey));var d=e.createEncryptor(u.keys),h=u.keys&&u.keys.validateKey||c.validateKey,p={teamId:o.teamId,readOnly:"object"==typeof u.keys&&!u.keys.validateKey,encryptor:d,channel:s,isTeamChat:!0,decrypt:function(e){return d.decrypt(e,h)},clients:[r],onUserlistUpdate:a,onReady:l};R(n,p)}}else i({error:"EINVAL"})}(p,o,n,r,a)},u.removeClient=function(e){!function(e,n){var t=e.friendsClients.indexOf(n);-1!==t&&e.friendsClients.splice(t,1),Object.keys(e.channels).forEach((function(t){var r=e.channels[t],o=r.clients,a=o.indexOf(n);if(-1!==a&&o.splice(a,1),0===o.length){r.wc&&r.wc.leave();var i=e.store.network;return r.onReconnect&&i.off("reconnect",r.onReconnect),r.stopped=!0,delete e.channels[t],!0}}))}(p,e)},u.execCommand=function(n,r,i){var s=r.cmd,u=r.data;"INIT_FRIENDS"!==s?"GET_ROOMS"!==s?"GET_MUTED_USERS"!==s?"GET_USERLIST"!==s?"OPEN_PAD_CHAT"!==s?"GET_MY_INFO"!==s?"REMOVE_FRIEND"!==s?"CANCEL_FRIEND"!==s?"MUTE_USER"!==s?"UNMUTE_USER"!==s?"GET_STATUS"!==s?"GET_MORE_HISTORY"!==s?"SEND_MESSAGE"!==s?"SET_CHANNEL_HEAD"!==s?"CLEAR_OWNED_CHANNEL"!==s||function(e,n,t){var r=e.channels[n];r?e.store.rpc?e.store.rpc.clearOwnedChannel(n,(function(o){t({error:o}),o||(r.messages=[],e.emit("CLEAR_CHANNEL",n,r.clients))})):t({error:"RPC_NOT_READY"}):t({error:"NO_CHANNEL"})}(p,u,i):D(p,u.id,u.sig,i):function(e,n,t,r){var o=e.channels[n];if(o)if(o.readOnly)r({error:"FORBIDDEN"});else if(e.store.network.webChannels.some((function(e){if(e.id===o.wc.id)return!0}))){var i=e.store.proxy||{},c=[f,i.curvePublic,+new Date,t];if(!o.isFriendChat){var s=i[a.displayNameKey]||l.anonymous+"#"+(i.uid||e.store.noDriveUid).slice(0,5);c.push(s)}var u=JSON.stringify(c),d=o.encrypt(u);o.wc.bcast(d).then((function(){x(e,o,d),r()}),(function(e){r({error:e})}))}else r({error:"NO_SUCH_CHANNEL"});else r({error:"NO_CHANNEL"})}(p,u.id,u.content,i):function(e,n,r,o,a){if("function"==typeof a)if("string"==typeof r){var i=e.channels[n];if(void 0!==i){var c=t.uid();_(e,c,n,a);var s=["GET_HISTORY_RANGE",i.id,{from:r,count:o,txid:c}],u=e.store.network;u.sendto(u.historyKeeper,JSON.stringify(s)).then((function(){}),(function(e){console.error(e)}))}else console.error("chan is undefined. we're going to have a problem here")}else a([])}(p,u.id,u.sig,u.count,i):function(e,n,t){var r=e.channels[n];if(r){r.onUserlistUpdate&&r.onUserlistUpdate();var o=e.store.proxy||{};t(r.wc.members.some((function(n){if(n!==e.store.network.historyKeeper){var t=r.mapId[n]||void 0;return!!t&&t.curvePublic!==o.curvePublic}})))}else t("NO_SUCH_CHANNEL")}(p,u,i):function(e,n,r){var o=t.once(t.mkAsync(r)),a=e.store.proxy,i=a.mutedUsers=a.mutedUsers||{};delete i[n],e.emit("UPDATE_MUTED",null,I(e)),o(Object.keys(i).length)}(p,u,i):function(e,n,r){var o=t.once(t.mkAsync(r)),a=e.store.proxy,i=a.mutedUsers=a.mutedUsers||{};i[n.curvePublic]||(i[n.curvePublic]=n,e.emit("UPDATE_MUTED",null,I(e))),o()}(p,u,i):function(e,n,r){var o=t.once(r);"function"==typeof o?e.Store.cancelFriendRequest(n,o):console.error("NO_CALLBACK")}(p,u,i):function(e,n,r){var a=t.once(r);if("function"==typeof a){var i=e.store.proxy,c=g(i,n);if(!c)return console.error("friend is not valid"),void a({error:"INVALID_FRIEND"});var s=e.channels[c.channel];if(e.store.mailbox&&c.curvePublic&&c.notifications)o.removeFriend(e.store,n,(function(n){n&&n.error?a({error:n.error}):(e.updateMetadata(),a(n))}));else if(s)try{var u=[d,i.curvePublic,+new Date],l=JSON.stringify(u),f=s.encrypt(l);s.wc.bcast(f).then((function(){N(e,n,c.channel),T(e,n,(function(){a()}))}),(function(t){t?a({error:t}):(N(e,n,c.channel),T(e,n,(function(){a()})))}))}catch(e){a({error:e})}else a({error:"NO_SUCH_CHANNEL"})}else console.error("NO_CALLBACK")}(p,u,i):function(e,n){var t=e.store.proxy||{};n({curvePublic:t.curvePublic,displayName:t[a.displayNameKey]})}(p,i):function(n,r,o,a){var i=o.channel,c=t.once(t.mkAsync((function(){n.emit("PADCHAT_READY",i,[r]),a()}))),s=n.channels[i];if(s)s.onReady.reg((function(){-1===s.clients.indexOf(r)&&s.clients.push(r),c()}));else{var u=o.secret;u.keys.cryptKey&&(u.keys.cryptKey=y(u.keys.cryptKey));var l=e.createEncryptor(u.keys),f=u.keys&&u.keys.validateKey||n.validateKeys[u.channel],d={padChan:o.secret&&o.secret.channel,readOnly:"object"==typeof u.keys&&!u.keys.validateKey,encryptor:l,channel:o.channel,isPadChat:!0,decrypt:function(e){return l.decrypt(e,f)},clients:[r],onReady:c};R(n,d)}}(p,n,u,i):function(e,n,t){var r=e.channels[n.id];if(r)if(r.isFriendChat){var o=A(e,n.id);if(!o)return void t({error:"NO_SUCH_FRIEND"});t([o])}else t([]);else t({error:"NO_SUCH_CHANNEL"})}(p,u,i):function(e,n){var t=e.store.proxy;if(!n)return t.mutedUsers||{};n(t.mutedUsers||{})}(p,i):function(e,n,t){var r=e.store.proxy;if(n&&n.curvePublic){var o=n.curvePublic,a=g(r,o);if(!a)return void t({error:"NO_SUCH_FRIEND"});var i=e.channels[a.channel];return i?void t([{id:i.id,isFriendChat:!0,name:a.displayName,lastKnownHash:a.lastKnownHash,curvePublic:a.curvePublic,messages:i.messages}]):void t({error:"NO_SUCH_CHANNEL"})}if(n&&n.padChat){var c=e.channels[n.padChat];return c?void t([{id:c.id,isPadChat:!0,messages:c.messages}]):void t({error:"NO_SUCH_CHANNEL"})}if(n&&n.teamChat){var s=e.channels[n.teamChat];return s?void t([{id:s.id,isTeamChat:!0,messages:s.messages}]):void t({error:"NO_SUCH_CHANNEL"})}var u=Object.keys(e.channels).map((function(n){var t,r,o,a=e.channels[n];if(a.isFriendChat){var i=A(e,n);if(!i)return null;t=i.displayName,r=i.lastKnownHash,o=i.curvePublic}else{if(a.isPadChat)return;if(a.isTeamChat)return}return{id:a.id,isFriendChat:a.isFriendChat,name:t,lastKnownHash:r,curvePublic:o,messages:a.messages}})).filter((function(e){return e}));t(u)}(p,u,i):function(e,n,t){var r=E(e.store.proxy);c((function(t){Object.keys(r).forEach((function(o){if("me"!==o){var a=v(r[o]);"object"==typeof a&&a.channel&&P(e,n,a,t())}else delete r.me.channel}))})).nThen((function(){-1===e.friendsClients.indexOf(n)&&e.friendsClients.push(n),t()}))}(p,n,i)},u},u})(K(),ae(),ee(),je(),_n(),q(),an(),We()),xt}function Ut(){if(It)return Nt;It=1;return Nt=((e,n,t,r)=>{const o={},a={};var i=function(n,t,o,a,i){var c,s=e.once(e.mkAsync(i)),u=function(n,t){if(!t)return e.find(n.store,["proxy","edPublic"]);var r=e.find(n,["store","proxy","teams",t]);return e.find(r,["keys","drive","edPublic"])}(n,a),l=n.Store,f=0,d=0,h=0;r((function(e){l.getFileSize(null,{channel:t},e((function(n){return n&&n.error?(e.abort(),void s(n)):void 0===n.size?(e.abort(),void s({error:"ENOENT"})):void(f=n.size)}))),l.getHistory(null,{channel:t,lastKnownHash:o},e((function(n){if(n&&n.error)return e.abort(),void s(n);if(!Array.isArray(n))return e.abort(),void s({error:"EINVAL"});if(n.length){c=n[0].hash;var t=n.map((function(e){return e.msg}));d=t.join("\n").length}})),!0),l.pad.getMetadata(null,{channel:t},e((function(n){if((!n||!n.error)&&n&&"object"==typeof n)return h=JSON.stringify(n).length,n&&Array.isArray(n.owners)&&-1!==n.owners.indexOf(u)?void 0:(e.abort(),void s({error:"INSUFFICIENT_PERMISSIONS"}))})))})).nThen((function(){s({size:f-h-d,hash:c})}))};return a.GET_HISTORY_SIZE=function(o,a,c,s){if(o.store.loggedIn&&o.store.rpc){var u=a.channels;if(Array.isArray(u)){var l=[];a.account?u=function(r){var o=[],a=e.find(r.store,["proxy","edPublic"]);-1!==(e.find(r.store,["driveMetadata","owners"])||[]).indexOf(a)&&o.push(r.store.driveChannel);var i=r.store.proxy.profile;if(i){var c=i.edit?n.hrefToHexChannelId("/profile/#"+i.edit,null):null;c&&o.push(c)}r.store.proxy.todo&&o.push(n.hrefToHexChannelId("/todo/#"+r.store.proxy.todo,null));var s=r.store.proxy.mailboxes;if(s){var u=Object.keys(s).map((function(e){return{lastKnownHash:s[e].lastKnownHash,channel:s[e].channel}}));Array.prototype.push.apply(o,u)}var l=r.store.proxy[t.SHARED_FOLDERS];if(l){var f=Object.keys(l).map((function(e){var n=l[e];if(n&&n.owners&&Array.isArray(n.owners)&&-1!==n.owners.indexOf(a))return n.channel})).filter(Boolean);Array.prototype.push.apply(o,f)}return o}(o):a.team&&(u=function(n,t){let r=e.find(n.store,["proxy","teams",t]);if(!r)return[];let o=[r.channel],a=r.keys.roster;return o.push({channel:a.channel,lastKnownHash:a.lastKnownHash}),o}(o,a.team));var f=0,d=[];r((function(e){u.forEach((function(n){var t,r=n;"object"==typeof n&&n.channel&&(r=n.channel,t=n.lastKnownHash),i(o,r,t,a.teamId,e((function(e){e&&e.error?l.push(e.error):(f+=e.size,e.hash&&d.push({channel:r,hash:e.hash}))})))}))})).nThen((function(){s({warning:l.length?l:void 0,channels:d,size:f})}))}else s({error:"EINVAL"})}else s({error:"INSUFFICIENT_PERMISSIONS"})},a.TRIM_HISTORY=function(e,n,t,o){if(e.store.loggedIn&&e.store.rpc){var a=n.channels;if(Array.isArray(a)){var i=function(e,n){if(!n)return e.store.rpc;var t=e.store.modules.team;if(t){var r=t.getTeam(n);if(r)return r.rpc}}(e,n.teamId);if(i){var c=[];r((function(e){a.forEach((function(n){i.trimHistory(n,e((function(e){e&&c.push(e)})))}))})).nThen((function(){1===a.length&&c.length?o({error:c[0]}):o({warning:c.length?c:void 0})}))}else o({error:"ENORPC"})}else o({error:"EINVAL"})}else o({error:"INSUFFICIENT_PERMISSIONS"})},o.init=function(e,n,t){var r={};if(e.store){var o={store:e.store,Store:e.Store,pinPads:e.pinPads,updateMetadata:e.updateMetadata,emit:t};return r.execCommand=function(e,n,t){var r=n.cmd,i=n.data;try{a[r](o,i,e,t)}catch(e){console.error(e)}},r}},o})(ee(),ae(),Be(),We()),Nt}var Bt,Vt={exports:{}};function Yt(){return Bt||(Bt=1,function(e){(()=>{const n=e=>{var n={};const t=globalThis;var r=function(){},o=n.getWeekNo=function(e,n){"number"!=typeof n&&(n=1);var t=new Date(e.getFullYear(),0,1),r=t.getDay()-n;r=r>=0?r:r+7;var o,a=Math.floor((e.getTime()-t.getTime())/864e5)+1;if(r<4){if((o=Math.floor((a+r-1)/7)+1)>52){var i=new Date(e.getFullYear()+1,0,1).getDay()-n;o=(i=i>=0?i:i+7)<4?1:53}}else o=Math.floor((a+r-1)/7);return o},a=function(e){var n=new Date(e.getFullYear(),0,0),t=e-n+60*(n.getTimezoneOffset()-e.getTimezoneOffset())*1e3;return Math.floor(t/864e5)},i=n.DAYORDER=["SU","MO","TU","WE","TH","FR","SA"],c=function(e){var n=Number(e.slice(0,-2)),t=i.indexOf(e.slice(-2));return n?[n,t]:t},s=function(e,n){var t=e.getDay();t>=(n="number"==typeof n?n:1)?e.setDate(e.getDate()-(t-n)):e.setDate(e.getDate()-(7+t-n))},u=function(e){return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()},l={daily:function(e,n){e.setDate(e.getDate()+n)},weekly:function(e,n){e.setDate(e.getDate()+7*n)},monthly:function(e,n){e.setMonth(e.getMonth()+n)},yearly:function(e,n){e.setFullYear(e.getFullYear()+n)}},f={month:function(e,n,t){var r=new Date(n.start),o=(t-(e.getMonth()+1)+12)%12,a=e.getMonth()+o;if(e.setMonth(a),e.setDate(r.getDate()),e.getMonth()===a)return!0},weekno:function(e,n,t,r){var a=r&&r.wkst;"number"!=typeof a&&(a=1);var i=new Date(n.start),c=new Date(e.getFullYear(),11,31),u=o(c,a),l=1===u;1===u&&(u=52);var f=o(e,a);if(!t||t>u)return!1;t<0&&(t=u+t+1);var d=t-f,h=new Date(+e);h.setDate(h.getDate()+7*d),s(h,a);var p="aaaaaaa".split("").map((function(n,t){var r=new Date(+h);if(r.setDate(r.getDate()+t),r.getFullYear()===e.getFullYear())return r.toLocaleDateString()!==i.toLocaleDateString()&&r})).filter(Boolean);return 1===t&&l&&(s(c,a),"aaaaaaa".split("").some((function(n,t){var r=new Date(+c);if(r.setDate(r.getDate()+t),r.toLocaleDateString()!==i.toLocaleDateString())return r.getFullYear()>e.getFullYear()||void p.push(r)}))),p.length?p:void 0}};f.yearday=function(e,n,t){var r=e.getFullYear();if(function(e,n){if(!("number"!=typeof n||Math.abs(n)<1||Math.abs(n)>366))return n<0&&(n=a(new Date(e.getFullYear(),11,31))+n+1),e.setMonth(0),e.setDate(n),!0}(e,t)&&e.getFullYear()===r)return!0},f.monthday=function(e,n,t,r){if("number"!=typeof t||Math.abs(t)<1||Math.abs(t)>31)return!1;var o=function(e,n){var t=e.getMonth();n<0&&(n=new Date(e.getFullYear(),e.getMonth()+1,0).getDate()+n+1);return e.setDate(n),e.getMonth()===t};if("monthly"===r.freq)return o(e,t);var a="aaaaaaaaaaaa".split("").map((function(n,r){var a=new Date(e.getFullYear(),r,1);return o(a,t)?a:void 0})).filter(Boolean);return a.length?a:void 0},f.day=function(e,n,t,r){var o,a=c(t);Array.isArray(a)&&(o=a[0],a=a[1]);var i=[];if(![0,1,2,3,4,5,6].includes(a))return!1;var s,u=function(e){if(o){var n=[];"aaaaaaaaaaaa".split("").some((function(t,r){if(void 0===e||r===e){var a,c=i.filter((function(e){return e.getMonth()===r}));return a=o<0?c.length+o:o-1,n.push(c[a]),void 0!==e&&r===e}})),i=n.filter(Boolean)}};if("yearly"===r.freq){s=new Date(+e);for(var l=e.getFullYear();s.getDay()!==a;)s.setDate(s.getDate()+1);for(;s.getFullYear()===l;)i.push(new Date(+s)),s.setDate(s.getDate()+7);return u(),i}if("monthly"===r.freq){s=new Date(+e);for(var f=e.getMonth();s.getDay()!==a;)s.setDate(s.getDate()+1);for(;s.getMonth()===f;)i.push(new Date(+s)),s.setDate(s.getDate()+7);return u(f),i}if("weekly"===r.freq)for(;e.getDay()!==a;)e.setDate(e.getDate()+1);return!0};var d={month:function(e,n){return e.filter((function(e){return n.includes(e.getMonth()+1)}))},weekno:function(e,n,t){return e.filter((function(e){var r=t&&t.wkst;"number"!=typeof r&&(r=1);var a=new Date(e.getFullYear(),11,31),i=o(a,r);1===i&&(i=52);var c=o(e,r);return n.some((function(e){return e>0?e===c:c===i+e+1}))}))},yearday:function(e,n){return e.filter((function(e){var t=a(e),r=a(new Date(e.getFullYear(),11,31));return n.some((function(e){return e>0?e===t:t===r+e+1}))}))},monthday:function(n,t){return n.filter((function(n){var r=e.clone(t);return(r=r.map((function(e){e<0&&(e=new Date(n.getFullYear(),n.getMonth()+1,0).getDate()+e+1);return e}))).includes(n.getDate())}))},day:function(e,n,t){return e.filter((function(e){var r=e.toLocaleDateString(),o="yearly";return("monthly"===t.freq||"yearly"===t.freq&&t.by&&t.by.month)&&(o="monthly"),n.some((function(n){var t,a=c(n);if(Array.isArray(a)&&(t=a[0],a=a[1]),!t)return e.getDay()===a;var i=new Date(e.getFullYear(),e.getMonth(),1);return"yearly"===o&&i.setMonth(0),f.day(i,{},n,{freq:o}).some((function(e){return e.toLocaleDateString()===r}))}))}))},setpos:function(n,t){var r=n.slice(),o=e.deduplicateString(t.slice().map((function(e){return e>0?e-1:0!==e?r.length+e:void 0})));return n.filter((function(e){var n=r.indexOf(e);return o.includes(n)}))}},h=["month","weekno","yearday","monthday","day"],p=["month","monthday","day"];n.getMonthId=function(e){return e.getFullYear()+"-"+e.getMonth()};var v=t.CP_calendar_cache={},y={};n.resetCache=function(){v=t.CP_calendar_cache={},y={}};var m=function(n){if(!n.recUpdate)return[];var t={},r=n.recUpdate.from;return Object.keys(r||{}).forEach((function(e){var n=r[e];n.recurrenceRule&&(t[e]=n.recurrenceRule)})),Object.keys(t).sort((function(e,n){return Number(e)-Number(n)})).map((function(n){var r=e.clone(t[n]);if(l[r.freq]&&!(r.interval&&r.interval<1))return r._start=Number(n),r})).filter(Boolean)};n.getRecurring=function(n,o){t.CP_DEV_MODE&&(r=console.warn);var i=[];return n.forEach((function(n){var t=n.split("-"),c=new Date(t[0],t[1]),g=new Date(+c);g.setMonth(g.getMonth()+1),g.setMilliseconds(-1),r("Compute month",c.toLocaleDateString()),(o||[]).forEach((function(n){var t=new Date(n.start),o=new Date(n.end),E=n,b=n.recurrenceRule;if(b){var A=m(n),_=A.shift();if(!(t>=g)){for(var w=b.until,O=A.slice(),D=_;D&&D._start&&D._start<c;)w=_.until,D=O.shift();if(!(w<c)){var S=function(e,n){if(!(e>n)){var t;if(n.getFullYear()===e.getFullYear())t=a(n)-a(e);else{var r=new Date(e.getFullYear(),11,31);for(t=a(r)-a(e)+a(n);r.getFullYear()+1<n.getFullYear();)r.setFullYear(r.getFullYear()+1),t+=a(r)}return{h:n.getHours(),m:n.getMinutes(),days:t}}console.error("Wrong data")}(t,o);if(!(b.interval&&b.interval<1)&&l[b.freq]){r("Iterate over",n.title,n),r("Use rule",b);var T=b.count,x=1,C=function(o){var a=new Date(+o);if(!(T&&x>=T)){r("Start iteration",a.toLocaleDateString());var m=function(n,t,o){var a=e.clone(t),i=new Date(a.start),c=a.id.split("|")[0],u=o.toLocaleDateString();v[c]=v[c]||{};var y=n.interval||1,m=n.freq,g=[],E=function(e,t){g=d[e](g,t,n)},b=function(e){return function(t){var r=new Date(+o);"yearly"===n.freq?(r.setMonth(0),r.setDate(1)):"monthly"===n.freq?r.setDate(1):"weekly"===n.freq?s(r,n.wkst):n.freq;var c=f[e](r,a,t,n);if(c)if(Array.isArray(c))c=c.filter((function(e){return e.toLocaleDateString()!==i.toLocaleDateString()})),Array.prototype.push.apply(g,c);else{if(r.toLocaleDateString()===i.toLocaleDateString())return;g.push(r)}}},A=e.once((function(){l[m](o,y)})),_=function(){"monthly"===m?o.setDate(15):"yearly"===m&&1===i.getMonth()&&29===i.getDate()&&o.setDate(28),A();var e=new Date(+o);if("monthly"===m||"yearly"===m){if(e.setDate(i.getDate()),e.getDate()!==i.getDate())return;if("yearly"===m&&e.getMonth()!==i.getMonth())return}g.push(e)};if(Array.isArray(v[c][u]))return r("Get cache",c,u),"monthly"===m?o.setDate(15):"yearly"===m&&1===i.getMonth()&&29===i.getDate()&&o.setDate(28),A(),v[c][u];if(n.by&&"yearly"===m){var w=h.slice(),O=!1;(n.by.weekno||n.by.yearday||n.by.monthday||n.by.day)&&(w.shift(),O=!0);var D=!0;w.forEach((function(e){var t=n.by[e];t&&(D?(t.forEach(b(e)),D=!1):"day"===e?n.by.yearday||n.by.monthday||n.by.weekno?E("day",n.by.day):n.by.day.forEach(b("day")):E(e,t))})),n.by.month&&O&&E("month",n.by.month)}n.by&&"monthly"===m&&(n.by.monthday||n.by.day?n.by.monthday?n.by.monthday.forEach(b("monthday")):n.by.day&&n.by.day.forEach(b("day")):_(),n.by.month&&E("month",n.by.month),n.by.day&&n.by.monthday&&E("day",n.by.day)),n.by&&"weekly"===m&&(n.by.day?n.by.day.forEach(b("day")):_(),n.by.month&&E("month",n.by.month)),n.by&&"daily"===m&&(_(),p.forEach((function(e){var t=n.by[e];t&&E(e,t)}))),g.sort((function(e,n){return e-n})),n.by&&n.by.setpos&&E("setpos",n.by.setpos),n.by&&Object.keys(n.by).length?A():_();var S=[];return g=g.filter((function(e){var n=new Date(+e).toLocaleDateString();return!S.includes(n)&&(S.push(n),!0)})),r("Set cache",c,u),v[c][u]=g,g}(b,n,a);if(r("Iteration results",JSON.stringify(m.map((function(e){return new Date(e).toLocaleDateString()})))),!m.length)return a.getFullYear()<c.getFullYear()||a<g?void C(a):void 0;var w=!1,O=!1;m.some((function(o){var s=e.clone(n);s.id=E.id+"|"+ +o;var l,f,d,h=new Date(+o),p=new Date(+o);l=h,d=S,(f=p).setTime(+l),d&&(f.setHours(d.h),f.setMinutes(d.m),f.setSeconds(0),f.setDate(l.getDate()+d.days)),s.start=+h,s.end=+p,s._count=x,s.isAllDay&&s.startDay&&(s.startDay=u(h)),s.isAllDay&&s.endDay&&(s.endDay=u(p)),_&&s.start===_._start&&(O=!0);var v=function(){O&&(r("Use new rule",_),s._count=x,T=_.count,x=1,a=+h,n=s,b=_,_=A.shift())};if(x>=T)return r(h.toLocaleDateString(),"count"),w=!0,!0;if(h>=g)return r(h.toLocaleDateString(),"endMonth"),w=!0,!0;if(b.until&&h>b.until)return r(h.toLocaleDateString(),"until"),w=!0,!0;if(!(h<t)){if(x++,p<c)return r(h.toLocaleDateString(),"startMonth"),void(O&&v());if(h<g&&p>=g||h<c&&p>=c){if(y[s.id]&&y[s.id].includes(s.start))return;y[s.id]=y[s.id]||[],y[s.id].push(s.start)}if(E.timeZone&&!s.isAllDay){var m=function(e,n,t){var r=function(e,n){let t=e.toLocaleString("en-CA",{timeZone:n,hour12:!1}).replace(", ","T");return t+="."+e.getMilliseconds().toString().padStart(3,"0"),-(new Date(t+"Z")-e)},o=Intl.DateTimeFormat().resolvedOptions().timeZone,a=r(n,e)-r(t,e);return r(n,o)-r(t,o)-a}(E.timeZone,t,h);s.start+=m,s.end+=m}return i.push(s),O?(v(),!0):void 0}r(h.toLocaleDateString(),"start")})),w||C(a)}};C(t),r("Added this month (all events)",i.map((function(e){return new Date(e.start).toLocaleDateString()})))}}}}}))})),i},n.getAllOccurrences=function(e){if(!e.recurrenceRule)return[e.start];var t=e.recurrenceRule;if(!t.until&&!t.count)return!1;var r=[e.start],o=new Date(e.start);o.setDate(15);for(var a=[],i=0;(a=n.getRecurring([n.getMonthId(o)],[e]))&&(t.count?r.length<t.count:+o<=t.until)&&i<12*t.count;)Array.prototype.push.apply(r,a.map((function(e){return e.start}))),o.setMonth(o.getMonth()+1),i++;return r},n.diffDate=function(e,n){for(var t=new Date(n),r=new Date(e),o=0,a=t<r?-1:1;t.toLocaleDateString()!==r.toLocaleDateString()||a>=1e4;)t.setDate(t.getDate()-a),o++;return{d:o*=a,h:(t=new Date(n)).getHours()-r.getHours(),m:t.getMinutes()-r.getMinutes()}};return n.applyUpdates=function(e){return e.forEach((function(e){if(e.raw={start:e.start,end:e.end},e.recUpdate){var n,t=e.recUpdate.from||{},r=e.recUpdate.one||{},o=e.start,a=m(e).filter((function(e){return e._start>o})).shift(),i=function(n,t){var r=n[t],o=new Date(e.raw[t]);o.setDate(o.getDate()+r.d),o.setHours(o.getHours()+r.h),o.setMinutes(o.getMinutes()+r.m),e[t]=+o};(n=t,Object.keys(n).sort((function(e,n){return Number(e)-Number(n)}))).forEach((function(n){o<Number(n)||Object.keys(t[n]).forEach((function(r){"start"!==r&&"end"!==r?("recurrenceRule"!==r||t[n][r])&&(e[r]=t[n][r]):i(t[n],r)}))})),Object.keys(r[o]||{}).forEach((function(n){"start"!==n&&"end"!==n?("recurrenceRule"!==n||r[o][n])&&(e[n]=r[o][n]):i(r[o],n)})),e.deleted&&Object.keys(e).forEach((function(n){delete e[n]})),a&&e.recurrenceRule&&(e.recurrenceRule._next=a._start-1),e.reminders&&(e.raw.reminders=e.reminders)}})),e},n};e.exports&&(e.exports=n(ee()))})()}(Vt)),Vt.exports}var Gt,Jt,qt,Wt={exports:{}};function zt(){return Gt||(Gt=1,function(e){e.exports=function(){var e=function(){return(e=Object.assign||function(e){for(var n,t=1,r=arguments.length;t<r;t++)for(var o in n=arguments[t])Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o]);return e}).apply(this,arguments)};function n(){for(var e=0,n=0,t=arguments.length;n<t;n++)e+=arguments[n].length;var r=Array(e),o=0;for(n=0;n<t;n++)for(var a=arguments[n],i=0,c=a.length;i<c;i++,o++)r[o]=a[i];return r}var t=["onChange","onClose","onDayCreate","onDestroy","onKeyDown","onMonthChange","onOpen","onParseConfig","onReady","onValueUpdate","onYearChange","onPreCalendarPosition"],r={_disable:[],allowInput:!1,allowInvalidPreload:!1,altFormat:"F j, Y",altInput:!1,altInputClass:"form-control input",animate:"object"==typeof window&&-1===window.navigator.userAgent.indexOf("MSIE"),ariaDateFormat:"F j, Y",autoFillDefaultTime:!0,clickOpens:!0,closeOnSelect:!0,conjunction:", ",dateFormat:"Y-m-d",defaultHour:12,defaultMinute:0,defaultSeconds:0,disable:[],disableMobile:!1,enableSeconds:!1,enableTime:!1,errorHandler:function(e){return"undefined"!=typeof console&&console.warn(e)},getWeek:function(e){var n=new Date(e.getTime());n.setHours(0,0,0,0),n.setDate(n.getDate()+3-(n.getDay()+6)%7);var t=new Date(n.getFullYear(),0,4);return 1+Math.round(((n.getTime()-t.getTime())/864e5-3+(t.getDay()+6)%7)/7)},hourIncrement:1,ignoredFocusElements:[],inline:!1,locale:"default",minuteIncrement:5,mode:"single",monthSelectorType:"dropdown",nextArrow:"<svg version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' viewBox='0 0 17 17'><g></g><path d='M13.207 8.472l-7.854 7.854-0.707-0.707 7.146-7.146-7.146-7.148 0.707-0.707 7.854 7.854z' /></svg>",noCalendar:!1,now:new Date,onChange:[],onClose:[],onDayCreate:[],onDestroy:[],onKeyDown:[],onMonthChange:[],onOpen:[],onParseConfig:[],onReady:[],onValueUpdate:[],onYearChange:[],onPreCalendarPosition:[],plugins:[],position:"auto",positionElement:void 0,prevArrow:"<svg version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' viewBox='0 0 17 17'><g></g><path d='M5.207 8.471l7.146 7.147-0.707 0.707-7.853-7.854 7.854-7.853 0.707 0.707-7.147 7.146z' /></svg>",shorthandCurrentMonth:!1,showMonths:1,static:!1,time_24hr:!1,weekNumbers:!1,wrap:!1},o={weekdays:{shorthand:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],longhand:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},months:{shorthand:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],longhand:["January","February","March","April","May","June","July","August","September","October","November","December"]},daysInMonth:[31,28,31,30,31,30,31,31,30,31,30,31],firstDayOfWeek:0,ordinal:function(e){var n=e%100;if(n>3&&n<21)return"th";switch(n%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}},rangeSeparator:" to ",weekAbbreviation:"Wk",scrollTitle:"Scroll to increment",toggleTitle:"Click to toggle",amPM:["AM","PM"],yearAriaLabel:"Year",monthAriaLabel:"Month",hourAriaLabel:"Hour",minuteAriaLabel:"Minute",time_24hr:!1},a=function(e,n){return void 0===n&&(n=2),("000"+e).slice(-1*n)},i=function(e){return!0===e?1:0};function c(e,n){var t;return function(){var r=this;clearTimeout(t),t=setTimeout((function(){return e.apply(r,arguments)}),n)}}var s=function(e){return e instanceof Array?e:[e]};function u(e,n,t){if(!0===t)return e.classList.add(n);e.classList.remove(n)}function l(e,n,t){var r=window.document.createElement(e);return n=n||"",t=t||"",r.className=n,void 0!==t&&(r.textContent=t),r}function f(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function d(e,n){return n(e)?e:e.parentNode?d(e.parentNode,n):void 0}function h(e,n){var t=l("div","numInputWrapper"),r=l("input","numInput "+e),o=l("span","arrowUp"),a=l("span","arrowDown");if(-1===navigator.userAgent.indexOf("MSIE 9.0")?r.type="number":(r.type="text",r.pattern="\\d*"),void 0!==n)for(var i in n)r.setAttribute(i,n[i]);return t.appendChild(r),t.appendChild(o),t.appendChild(a),t}function p(e){try{return"function"==typeof e.composedPath?e.composedPath()[0]:e.target}catch(n){return e.target}}var v=function(){},y=function(e,n,t){return t.months[n?"shorthand":"longhand"][e]},m={D:v,F:function(e,n,t){e.setMonth(t.months.longhand.indexOf(n))},G:function(e,n){e.setHours(parseFloat(n))},H:function(e,n){e.setHours(parseFloat(n))},J:function(e,n){e.setDate(parseFloat(n))},K:function(e,n,t){e.setHours(e.getHours()%12+12*i(new RegExp(t.amPM[1],"i").test(n)))},M:function(e,n,t){e.setMonth(t.months.shorthand.indexOf(n))},S:function(e,n){e.setSeconds(parseFloat(n))},U:function(e,n){return new Date(1e3*parseFloat(n))},W:function(e,n,t){var r=parseInt(n),o=new Date(e.getFullYear(),0,2+7*(r-1),0,0,0,0);return o.setDate(o.getDate()-o.getDay()+t.firstDayOfWeek),o},Y:function(e,n){e.setFullYear(parseFloat(n))},Z:function(e,n){return new Date(n)},d:function(e,n){e.setDate(parseFloat(n))},h:function(e,n){e.setHours(parseFloat(n))},i:function(e,n){e.setMinutes(parseFloat(n))},j:function(e,n){e.setDate(parseFloat(n))},l:v,m:function(e,n){e.setMonth(parseFloat(n)-1)},n:function(e,n){e.setMonth(parseFloat(n)-1)},s:function(e,n){e.setSeconds(parseFloat(n))},u:function(e,n){return new Date(parseFloat(n))},w:v,y:function(e,n){e.setFullYear(2e3+parseFloat(n))}},g={D:"(\\w+)",F:"(\\w+)",G:"(\\d\\d|\\d)",H:"(\\d\\d|\\d)",J:"(\\d\\d|\\d)\\w+",K:"",M:"(\\w+)",S:"(\\d\\d|\\d)",U:"(.+)",W:"(\\d\\d|\\d)",Y:"(\\d{4})",Z:"(.+)",d:"(\\d\\d|\\d)",h:"(\\d\\d|\\d)",i:"(\\d\\d|\\d)",j:"(\\d\\d|\\d)",l:"(\\w+)",m:"(\\d\\d|\\d)",n:"(\\d\\d|\\d)",s:"(\\d\\d|\\d)",u:"(.+)",w:"(\\d\\d|\\d)",y:"(\\d{2})"},E={Z:function(e){return e.toISOString()},D:function(e,n,t){return n.weekdays.shorthand[E.w(e,n,t)]},F:function(e,n,t){return y(E.n(e,n,t)-1,!1,n)},G:function(e,n,t){return a(E.h(e,n,t))},H:function(e){return a(e.getHours())},J:function(e,n){return void 0!==n.ordinal?e.getDate()+n.ordinal(e.getDate()):e.getDate()},K:function(e,n){return n.amPM[i(e.getHours()>11)]},M:function(e,n){return y(e.getMonth(),!0,n)},S:function(e){return a(e.getSeconds())},U:function(e){return e.getTime()/1e3},W:function(e,n,t){return t.getWeek(e)},Y:function(e){return a(e.getFullYear(),4)},d:function(e){return a(e.getDate())},h:function(e){return e.getHours()%12?e.getHours()%12:12},i:function(e){return a(e.getMinutes())},j:function(e){return e.getDate()},l:function(e,n){return n.weekdays.longhand[e.getDay()]},m:function(e){return a(e.getMonth()+1)},n:function(e){return e.getMonth()+1},s:function(e){return e.getSeconds()},u:function(e){return e.getTime()},w:function(e){return e.getDay()},y:function(e){return String(e.getFullYear()).substring(2)}},b=function(e){var n=e.config,t=void 0===n?r:n,a=e.l10n,i=void 0===a?o:a,c=e.isMobile,s=void 0!==c&&c;return function(e,n,r){var o=r||i;return void 0===t.formatDate||s?n.split("").map((function(n,r,a){return E[n]&&"\\"!==a[r-1]?E[n](e,o,t):"\\"!==n?n:""})).join(""):t.formatDate(e,n,o)}},A=function(e){var n=e.config,t=void 0===n?r:n,a=e.l10n,i=void 0===a?o:a;return function(e,n,o,a){if(0===e||e){var c,s=a||i,u=e;if(e instanceof Date)c=new Date(e.getTime());else if("string"!=typeof e&&void 0!==e.toFixed)c=new Date(e);else if("string"==typeof e){var l=n||(t||r).dateFormat,f=String(e).trim();if("today"===f)c=new Date,o=!0;else if(/Z$/.test(f)||/GMT$/.test(f))c=new Date(e);else if(t&&t.parseDate)c=t.parseDate(e,l);else{c=t&&t.noCalendar?new Date((new Date).setHours(0,0,0,0)):new Date((new Date).getFullYear(),0,1,0,0,0,0);for(var d=void 0,h=[],p=0,v=0,y="";p<l.length;p++){var E=l[p],b="\\"===E,A="\\"===l[p-1]||b;if(g[E]&&!A){y+=g[E];var _=new RegExp(y).exec(e);_&&(d=!0)&&h["Y"!==E?"push":"unshift"]({fn:m[E],val:_[++v]})}else b||(y+=".");h.forEach((function(e){var n=e.fn,t=e.val;return c=n(c,t,s)||c}))}c=d?c:void 0}}if(c instanceof Date&&!isNaN(c.getTime()))return!0===o&&c.setHours(0,0,0,0),c;t.errorHandler(new Error("Invalid date provided: "+u))}}};function _(e,n,t){return void 0===t&&(t=!0),!1!==t?new Date(e.getTime()).setHours(0,0,0,0)-new Date(n.getTime()).setHours(0,0,0,0):e.getTime()-n.getTime()}var w=864e5;function O(e){var n=e.defaultHour,t=e.defaultMinute,r=e.defaultSeconds;if(void 0!==e.minDate){var o=e.minDate.getHours(),a=e.minDate.getMinutes(),i=e.minDate.getSeconds();n<o&&(n=o),n===o&&t<a&&(t=a),n===o&&t===a&&r<i&&(r=e.minDate.getSeconds())}if(void 0!==e.maxDate){var c=e.maxDate.getHours(),s=e.maxDate.getMinutes();(n=Math.min(n,c))===c&&(t=Math.min(s,t)),n===c&&t===s&&(r=e.maxDate.getSeconds())}return{hours:n,minutes:t,seconds:r}}function D(v,m){var E={config:e(e({},r),T.defaultConfig),l10n:o};function D(e){return e.bind(E)}function S(){var e=E.config;!1===e.weekNumbers&&1===e.showMonths||!0!==e.noCalendar&&window.requestAnimationFrame((function(){if(void 0!==E.calendarContainer&&(E.calendarContainer.style.visibility="hidden",E.calendarContainer.style.display="block"),void 0!==E.daysContainer){var n=(E.days.offsetWidth+1)*e.showMonths;E.daysContainer.style.width=n+"px",E.calendarContainer.style.width=n+(void 0!==E.weekWrapper?E.weekWrapper.offsetWidth:0)+"px",E.calendarContainer.style.removeProperty("visibility"),E.calendarContainer.style.removeProperty("display")}}))}function x(e){if(0===E.selectedDates.length){var n=void 0===E.config.minDate||_(new Date,E.config.minDate)>=0?new Date:new Date(E.config.minDate.getTime()),t=O(E.config);n.setHours(t.hours,t.minutes,t.seconds,n.getMilliseconds()),E.selectedDates=[n],E.latestSelectedDateObj=n}void 0!==e&&"blur"!==e.type&&function(e){e.preventDefault();var n="keydown"===e.type,t=p(e),r=t;void 0!==E.amPM&&t===E.amPM&&(E.amPM.textContent=E.l10n.amPM[i(E.amPM.textContent===E.l10n.amPM[0])]);var o=parseFloat(r.getAttribute("min")),c=parseFloat(r.getAttribute("max")),s=parseFloat(r.getAttribute("step")),u=parseInt(r.value,10),l=u+s*(e.delta||(n?38===e.which?1:-1:0));if(void 0!==r.value&&2===r.value.length){var f=r===E.hourElement,d=r===E.minuteElement;l<o?(l=c+l+i(!f)+(i(f)&&i(!E.amPM)),d&&L(void 0,-1,E.hourElement)):l>c&&(l=r===E.hourElement?l-c-i(!E.amPM):o,d&&L(void 0,1,E.hourElement)),E.amPM&&f&&(1===s?l+u===23:Math.abs(l-u)>s)&&(E.amPM.textContent=E.l10n.amPM[i(E.amPM.textContent===E.l10n.amPM[0])]),r.value=a(l)}}(e);var r=E._input.value;C(),be(),E._input.value!==r&&E._debouncedChange()}function C(){if(void 0!==E.hourElement&&void 0!==E.minuteElement){var e,n,t=(parseInt(E.hourElement.value.slice(-2),10)||0)%24,r=(parseInt(E.minuteElement.value,10)||0)%60,o=void 0!==E.secondElement?(parseInt(E.secondElement.value,10)||0)%60:0;void 0!==E.amPM&&(e=t,n=E.amPM.textContent,t=e%12+12*i(n===E.l10n.amPM[1]));var a=void 0!==E.config.minTime||E.config.minDate&&E.minDateHasTime&&E.latestSelectedDateObj&&0===_(E.latestSelectedDateObj,E.config.minDate,!0);if(void 0!==E.config.maxTime||E.config.maxDate&&E.maxDateHasTime&&E.latestSelectedDateObj&&0===_(E.latestSelectedDateObj,E.config.maxDate,!0)){var c=void 0!==E.config.maxTime?E.config.maxTime:E.config.maxDate;(t=Math.min(t,c.getHours()))===c.getHours()&&(r=Math.min(r,c.getMinutes())),r===c.getMinutes()&&(o=Math.min(o,c.getSeconds()))}if(a){var s=void 0!==E.config.minTime?E.config.minTime:E.config.minDate;(t=Math.max(t,s.getHours()))===s.getHours()&&r<s.getMinutes()&&(r=s.getMinutes()),r===s.getMinutes()&&(o=Math.max(o,s.getSeconds()))}I(t,r,o)}}function N(e){var n=e||E.latestSelectedDateObj;n&&I(n.getHours(),n.getMinutes(),n.getSeconds())}function I(e,n,t){void 0!==E.latestSelectedDateObj&&E.latestSelectedDateObj.setHours(e%24,n,t||0,0),E.hourElement&&E.minuteElement&&!E.isMobile&&(E.hourElement.value=a(E.config.time_24hr?e:(12+e)%12+12*i(e%12==0)),E.minuteElement.value=a(n),void 0!==E.amPM&&(E.amPM.textContent=E.l10n.amPM[i(e>=12)]),void 0!==E.secondElement&&(E.secondElement.value=a(t)))}function R(e){var n=p(e),t=parseInt(n.value)+(e.delta||0);(t/1e3>1||"Enter"===e.key&&!/[^\d]/.test(t.toString()))&&Z(t)}function P(e,n,t,r){return n instanceof Array?n.forEach((function(n){return P(e,n,t,r)})):e instanceof Array?e.forEach((function(e){return P(e,n,t,r)})):(e.addEventListener(n,t,r),void E._handlers.push({remove:function(){return e.removeEventListener(n,t)}}))}function k(){ve("onChange")}function M(e,n){var t=void 0!==e?E.parseDate(e):E.latestSelectedDateObj||(E.config.minDate&&E.config.minDate>E.now?E.config.minDate:E.config.maxDate&&E.config.maxDate<E.now?E.config.maxDate:E.now),r=E.currentYear,o=E.currentMonth;try{void 0!==t&&(E.currentYear=t.getFullYear(),E.currentMonth=t.getMonth())}catch(e){e.message="Invalid date supplied: "+t,E.config.errorHandler(e)}n&&E.currentYear!==r&&(ve("onYearChange"),Y()),!n||E.currentYear===r&&E.currentMonth===o||ve("onMonthChange"),E.redraw()}function F(e){var n=p(e);~n.className.indexOf("arrow")&&L(e,n.classList.contains("arrowUp")?1:-1)}function L(e,n,t){var r=e&&p(e),o=t||r&&r.parentNode&&r.parentNode.firstChild,a=ye("increment");a.delta=n,o&&o.dispatchEvent(a)}function K(e,n,t,r){var o=$(n,!0),a=l("span","flatpickr-day "+e,n.getDate().toString());return a.dateObj=n,a.$i=r,a.setAttribute("aria-label",E.formatDate(n,E.config.ariaDateFormat)),-1===e.indexOf("hidden")&&0===_(n,E.now)&&(E.todayDateElem=a,a.classList.add("today"),a.setAttribute("aria-current","date")),o?(a.tabIndex=-1,me(n)&&(a.classList.add("selected"),E.selectedDateElem=a,"range"===E.config.mode&&(u(a,"startRange",E.selectedDates[0]&&0===_(n,E.selectedDates[0],!0)),u(a,"endRange",E.selectedDates[1]&&0===_(n,E.selectedDates[1],!0)),"nextMonthDay"===e&&a.classList.add("inRange")))):a.classList.add("flatpickr-disabled"),"range"===E.config.mode&&function(e){return!("range"!==E.config.mode||E.selectedDates.length<2)&&_(e,E.selectedDates[0])>=0&&_(e,E.selectedDates[1])<=0}(n)&&!me(n)&&a.classList.add("inRange"),E.weekNumbers&&1===E.config.showMonths&&"prevMonthDay"!==e&&t%7==1&&E.weekNumbers.insertAdjacentHTML("beforeend","<span class='flatpickr-day'>"+E.config.getWeek(n)+"</span>"),ve("onDayCreate",a),a}function H(e){e.focus(),"range"===E.config.mode&&re(e)}function j(e){for(var n=e>0?0:E.config.showMonths-1,t=e>0?E.config.showMonths:-1,r=n;r!=t;r+=e)for(var o=E.daysContainer.children[r],a=e>0?0:o.children.length-1,i=e>0?o.children.length:-1,c=a;c!=i;c+=e){var s=o.children[c];if(-1===s.className.indexOf("hidden")&&$(s.dateObj))return s}}function U(e,n){var t=ee(document.activeElement||document.body),r=void 0!==e?e:t?document.activeElement:void 0!==E.selectedDateElem&&ee(E.selectedDateElem)?E.selectedDateElem:void 0!==E.todayDateElem&&ee(E.todayDateElem)?E.todayDateElem:j(n>0?1:-1);void 0===r?E._input.focus():t?function(e,n){for(var t=-1===e.className.indexOf("Month")?e.dateObj.getMonth():E.currentMonth,r=n>0?E.config.showMonths:-1,o=n>0?1:-1,a=t-E.currentMonth;a!=r;a+=o)for(var i=E.daysContainer.children[a],c=t-E.currentMonth===a?e.$i+n:n<0?i.children.length-1:0,s=i.children.length,u=c;u>=0&&u<s&&u!=(n>0?s:-1);u+=o){var l=i.children[u];if(-1===l.className.indexOf("hidden")&&$(l.dateObj)&&Math.abs(e.$i-u)>=Math.abs(n))return H(l)}E.changeMonth(o),U(j(o),0)}(r,n):H(r)}function B(e,n){for(var t=(new Date(e,n,1).getDay()-E.l10n.firstDayOfWeek+7)%7,r=E.utils.getDaysInMonth((n-1+12)%12,e),o=E.utils.getDaysInMonth(n,e),a=window.document.createDocumentFragment(),i=E.config.showMonths>1,c=i?"prevMonthDay hidden":"prevMonthDay",s=i?"nextMonthDay hidden":"nextMonthDay",u=r+1-t,f=0;u<=r;u++,f++)a.appendChild(K(c,new Date(e,n-1,u),u,f));for(u=1;u<=o;u++,f++)a.appendChild(K("",new Date(e,n,u),u,f));for(var d=o+1;d<=42-t&&(1===E.config.showMonths||f%7!=0);d++,f++)a.appendChild(K(s,new Date(e,n+1,d%o),d,f));var h=l("div","dayContainer");return h.appendChild(a),h}function V(){if(void 0!==E.daysContainer){f(E.daysContainer),E.weekNumbers&&f(E.weekNumbers);for(var e=document.createDocumentFragment(),n=0;n<E.config.showMonths;n++){var t=new Date(E.currentYear,E.currentMonth,1);t.setMonth(E.currentMonth+n),e.appendChild(B(t.getFullYear(),t.getMonth()))}E.daysContainer.appendChild(e),E.days=E.daysContainer.firstChild,"range"===E.config.mode&&1===E.selectedDates.length&&re()}}function Y(){if(!(E.config.showMonths>1||"dropdown"!==E.config.monthSelectorType)){var e=function(e){return!(void 0!==E.config.minDate&&E.currentYear===E.config.minDate.getFullYear()&&e<E.config.minDate.getMonth()||void 0!==E.config.maxDate&&E.currentYear===E.config.maxDate.getFullYear()&&e>E.config.maxDate.getMonth())};E.monthsDropdownContainer.tabIndex=-1,E.monthsDropdownContainer.innerHTML="";for(var n=0;n<12;n++)if(e(n)){var t=l("option","flatpickr-monthDropdown-month");t.value=new Date(E.currentYear,n).getMonth().toString(),t.textContent=y(n,E.config.shorthandCurrentMonth,E.l10n),t.tabIndex=-1,E.currentMonth===n&&(t.selected=!0),E.monthsDropdownContainer.appendChild(t)}}}function G(){var e,n=l("div","flatpickr-month"),t=window.document.createDocumentFragment();E.config.showMonths>1||"static"===E.config.monthSelectorType?e=l("span","cur-month"):(E.monthsDropdownContainer=l("select","flatpickr-monthDropdown-months"),E.monthsDropdownContainer.setAttribute("aria-label",E.l10n.monthAriaLabel),P(E.monthsDropdownContainer,"change",(function(e){var n=p(e),t=parseInt(n.value,10);E.changeMonth(t-E.currentMonth),ve("onMonthChange")})),Y(),e=E.monthsDropdownContainer);var r=h("cur-year",{tabindex:"-1"}),o=r.getElementsByTagName("input")[0];o.setAttribute("aria-label",E.l10n.yearAriaLabel),E.config.minDate&&o.setAttribute("min",E.config.minDate.getFullYear().toString()),E.config.maxDate&&(o.setAttribute("max",E.config.maxDate.getFullYear().toString()),o.disabled=!!E.config.minDate&&E.config.minDate.getFullYear()===E.config.maxDate.getFullYear());var a=l("div","flatpickr-current-month");return a.appendChild(e),a.appendChild(r),t.appendChild(a),n.appendChild(t),{container:n,yearElement:o,monthElement:e}}function J(){f(E.monthNav),E.monthNav.appendChild(E.prevMonthNav),E.config.showMonths&&(E.yearElements=[],E.monthElements=[]);for(var e=E.config.showMonths;e--;){var n=G();E.yearElements.push(n.yearElement),E.monthElements.push(n.monthElement),E.monthNav.appendChild(n.container)}E.monthNav.appendChild(E.nextMonthNav)}function q(){E.weekdayContainer?f(E.weekdayContainer):E.weekdayContainer=l("div","flatpickr-weekdays");for(var e=E.config.showMonths;e--;){var n=l("div","flatpickr-weekdaycontainer");E.weekdayContainer.appendChild(n)}return W(),E.weekdayContainer}function W(){if(E.weekdayContainer){var e=E.l10n.firstDayOfWeek,t=n(E.l10n.weekdays.shorthand);e>0&&e<t.length&&(t=n(t.splice(e,t.length),t.splice(0,e)));for(var r=E.config.showMonths;r--;)E.weekdayContainer.children[r].innerHTML="\n      <span class='flatpickr-weekday'>\n        "+t.join("</span><span class='flatpickr-weekday'>")+"\n      </span>\n      "}}function z(e,n){void 0===n&&(n=!0);var t=n?e:e-E.currentMonth;t<0&&!0===E._hidePrevMonthArrow||t>0&&!0===E._hideNextMonthArrow||(E.currentMonth+=t,(E.currentMonth<0||E.currentMonth>11)&&(E.currentYear+=E.currentMonth>11?1:-1,E.currentMonth=(E.currentMonth+12)%12,ve("onYearChange"),Y()),V(),ve("onMonthChange"),ge())}function Q(e){return!(!E.config.appendTo||!E.config.appendTo.contains(e))||E.calendarContainer.contains(e)}function X(e){if(E.isOpen&&!E.config.inline){var n=p(e),t=Q(n),r=n===E.input||n===E.altInput||E.element.contains(n)||e.path&&e.path.indexOf&&(~e.path.indexOf(E.input)||~e.path.indexOf(E.altInput)),o="blur"===e.type?r&&e.relatedTarget&&!Q(e.relatedTarget):!r&&!t&&!Q(e.relatedTarget),a=!E.config.ignoredFocusElements.some((function(e){return e.contains(n)}));o&&a&&(void 0!==E.timeContainer&&void 0!==E.minuteElement&&void 0!==E.hourElement&&""!==E.input.value&&void 0!==E.input.value&&x(),E.close(),E.config&&"range"===E.config.mode&&1===E.selectedDates.length&&(E.clear(!1),E.redraw()))}}function Z(e){if(!(!e||E.config.minDate&&e<E.config.minDate.getFullYear()||E.config.maxDate&&e>E.config.maxDate.getFullYear())){var n=e,t=E.currentYear!==n;E.currentYear=n||E.currentYear,E.config.maxDate&&E.currentYear===E.config.maxDate.getFullYear()?E.currentMonth=Math.min(E.config.maxDate.getMonth(),E.currentMonth):E.config.minDate&&E.currentYear===E.config.minDate.getFullYear()&&(E.currentMonth=Math.max(E.config.minDate.getMonth(),E.currentMonth)),t&&(E.redraw(),ve("onYearChange"),Y())}}function $(e,n){var t;void 0===n&&(n=!0);var r=E.parseDate(e,void 0,n);if(E.config.minDate&&r&&_(r,E.config.minDate,void 0!==n?n:!E.minDateHasTime)<0||E.config.maxDate&&r&&_(r,E.config.maxDate,void 0!==n?n:!E.maxDateHasTime)>0)return!1;if(!E.config.enable&&0===E.config.disable.length)return!0;if(void 0===r)return!1;for(var o=!!E.config.enable,a=null!==(t=E.config.enable)&&void 0!==t?t:E.config.disable,i=0,c=void 0;i<a.length;i++){if("function"==typeof(c=a[i])&&c(r))return o;if(c instanceof Date&&void 0!==r&&c.getTime()===r.getTime())return o;if("string"==typeof c){var s=E.parseDate(c,void 0,!0);return s&&s.getTime()===r.getTime()?o:!o}if("object"==typeof c&&void 0!==r&&c.from&&c.to&&r.getTime()>=c.from.getTime()&&r.getTime()<=c.to.getTime())return o}return!o}function ee(e){return void 0!==E.daysContainer&&-1===e.className.indexOf("hidden")&&-1===e.className.indexOf("flatpickr-disabled")&&E.daysContainer.contains(e)}function ne(e){e.target!==E._input||!(E.selectedDates.length>0||E._input.value.length>0)||e.relatedTarget&&Q(e.relatedTarget)||E.setDate(E._input.value,!0,e.target===E.altInput?E.config.altFormat:E.config.dateFormat)}function te(e){var n=p(e),t=E.config.wrap?v.contains(n):n===E._input,r=E.config.allowInput,o=E.isOpen&&(!r||!t),a=E.config.inline&&t&&!r;if(13===e.keyCode&&t){if(r)return E.setDate(E._input.value,!0,n===E.altInput?E.config.altFormat:E.config.dateFormat),n.blur();E.open()}else if(Q(n)||o||a){var i=!!E.timeContainer&&E.timeContainer.contains(n);switch(e.keyCode){case 13:i?(e.preventDefault(),x(),le()):fe(e);break;case 27:e.preventDefault(),le();break;case 8:case 46:t&&!E.config.allowInput&&(e.preventDefault(),E.clear());break;case 37:case 39:if(i||t)E.hourElement&&E.hourElement.focus();else if(e.preventDefault(),void 0!==E.daysContainer&&(!1===r||document.activeElement&&ee(document.activeElement))){var c=39===e.keyCode?1:-1;e.ctrlKey?(e.stopPropagation(),z(c),U(j(1),0)):U(void 0,c)}break;case 38:case 40:e.preventDefault();var s=40===e.keyCode?1:-1;E.daysContainer&&void 0!==n.$i||n===E.input||n===E.altInput?e.ctrlKey?(e.stopPropagation(),Z(E.currentYear-s),U(j(1),0)):i||U(void 0,7*s):n===E.currentYearElement?Z(E.currentYear-s):E.config.enableTime&&(!i&&E.hourElement&&E.hourElement.focus(),x(e),E._debouncedChange());break;case 9:if(i){var u=[E.hourElement,E.minuteElement,E.secondElement,E.amPM].concat(E.pluginElements).filter((function(e){return e})),l=u.indexOf(n);if(-1!==l){var f=u[l+(e.shiftKey?-1:1)];e.preventDefault(),(f||E._input).focus()}}else!E.config.noCalendar&&E.daysContainer&&E.daysContainer.contains(n)&&e.shiftKey&&(e.preventDefault(),E._input.focus())}}if(void 0!==E.amPM&&n===E.amPM)switch(e.key){case E.l10n.amPM[0].charAt(0):case E.l10n.amPM[0].charAt(0).toLowerCase():E.amPM.textContent=E.l10n.amPM[0],C(),be();break;case E.l10n.amPM[1].charAt(0):case E.l10n.amPM[1].charAt(0).toLowerCase():E.amPM.textContent=E.l10n.amPM[1],C(),be()}(t||Q(n))&&ve("onKeyDown",e)}function re(e){if(1===E.selectedDates.length&&(!e||e.classList.contains("flatpickr-day")&&!e.classList.contains("flatpickr-disabled"))){for(var n=e?e.dateObj.getTime():E.days.firstElementChild.dateObj.getTime(),t=E.parseDate(E.selectedDates[0],void 0,!0).getTime(),r=Math.min(n,E.selectedDates[0].getTime()),o=Math.max(n,E.selectedDates[0].getTime()),a=!1,i=0,c=0,s=r;s<o;s+=w)$(new Date(s),!0)||(a=a||s>r&&s<o,s<t&&(!i||s>i)?i=s:s>t&&(!c||s<c)&&(c=s));for(var u=0;u<E.config.showMonths;u++)for(var l=E.daysContainer.children[u],f=function(r,o){var s,u,f,d=l.children[r],h=d.dateObj.getTime(),p=i>0&&h<i||c>0&&h>c;return p?(d.classList.add("notAllowed"),["inRange","startRange","endRange"].forEach((function(e){d.classList.remove(e)})),"continue"):a&&!p?"continue":(["startRange","inRange","endRange","notAllowed"].forEach((function(e){d.classList.remove(e)})),void(void 0!==e&&(e.classList.add(n<=E.selectedDates[0].getTime()?"startRange":"endRange"),t<n&&h===t?d.classList.add("startRange"):t>n&&h===t&&d.classList.add("endRange"),h>=i&&(0===c||h<=c)&&(u=t,f=n,(s=h)>Math.min(u,f)&&s<Math.max(u,f))&&d.classList.add("inRange"))))},d=0,h=l.children.length;d<h;d++)f(d)}}function oe(){!E.isOpen||E.config.static||E.config.inline||se()}function ae(e){return function(n){var t=E.config["_"+e+"Date"]=E.parseDate(n,E.config.dateFormat),r=E.config["_"+("min"===e?"max":"min")+"Date"];void 0!==t&&(E["min"===e?"minDateHasTime":"maxDateHasTime"]=t.getHours()>0||t.getMinutes()>0||t.getSeconds()>0),E.selectedDates&&(E.selectedDates=E.selectedDates.filter((function(e){return $(e)})),E.selectedDates.length||"min"!==e||N(t),be()),E.daysContainer&&(ue(),void 0!==t?E.currentYearElement[e]=t.getFullYear().toString():E.currentYearElement.removeAttribute(e),E.currentYearElement.disabled=!!r&&void 0!==t&&r.getFullYear()===t.getFullYear())}}function ie(){return E.config.wrap?v.querySelector("[data-input]"):v}function ce(){"object"!=typeof E.config.locale&&void 0===T.l10ns[E.config.locale]&&E.config.errorHandler(new Error("flatpickr: invalid locale "+E.config.locale)),E.l10n=e(e({},T.l10ns.default),"object"==typeof E.config.locale?E.config.locale:"default"!==E.config.locale?T.l10ns[E.config.locale]:void 0),g.K="("+E.l10n.amPM[0]+"|"+E.l10n.amPM[1]+"|"+E.l10n.amPM[0].toLowerCase()+"|"+E.l10n.amPM[1].toLowerCase()+")",void 0===e(e({},m),JSON.parse(JSON.stringify(v.dataset||{}))).time_24hr&&void 0===T.defaultConfig.time_24hr&&(E.config.time_24hr=E.l10n.time_24hr),E.formatDate=b(E),E.parseDate=A({config:E.config,l10n:E.l10n})}function se(e){if("function"!=typeof E.config.position){if(void 0!==E.calendarContainer){ve("onPreCalendarPosition");var n=e||E._positionElement,t=Array.prototype.reduce.call(E.calendarContainer.children,(function(e,n){return e+n.offsetHeight}),0),r=E.calendarContainer.offsetWidth,o=E.config.position.split(" "),a=o[0],i=o.length>1?o[1]:null,c=n.getBoundingClientRect(),s=window.innerHeight-c.bottom,l="above"===a||"below"!==a&&s<t&&c.top>t,f=window.pageYOffset+c.top+(l?-t-2:n.offsetHeight+2);if(u(E.calendarContainer,"arrowTop",!l),u(E.calendarContainer,"arrowBottom",l),!E.config.inline){var d=window.pageXOffset+c.left,h=!1,p=!1;"center"===i?(d-=(r-c.width)/2,h=!0):"right"===i&&(d-=r-c.width,p=!0),u(E.calendarContainer,"arrowLeft",!h&&!p),u(E.calendarContainer,"arrowCenter",h),u(E.calendarContainer,"arrowRight",p);var v=window.document.body.offsetWidth-(window.pageXOffset+c.right),y=d+r>window.document.body.offsetWidth,m=v+r>window.document.body.offsetWidth;if(u(E.calendarContainer,"rightMost",y),!E.config.static)if(E.calendarContainer.style.top=f+"px",y)if(m){var g=function(){for(var e=null,n=0;n<document.styleSheets.length;n++){var t=document.styleSheets[n];try{t.cssRules}catch(e){continue}e=t;break}return null!=e?e:(r=document.createElement("style"),document.head.appendChild(r),r.sheet);var r}();if(void 0===g)return;var b=window.document.body.offsetWidth,A=Math.max(0,b/2-r/2),_=g.cssRules.length,w="{left:"+c.left+"px;right:auto;}";u(E.calendarContainer,"rightMost",!1),u(E.calendarContainer,"centerMost",!0),g.insertRule(".flatpickr-calendar.centerMost:before,.flatpickr-calendar.centerMost:after"+w,_),E.calendarContainer.style.left=A+"px",E.calendarContainer.style.right="auto"}else E.calendarContainer.style.left="auto",E.calendarContainer.style.right=v+"px";else E.calendarContainer.style.left=d+"px",E.calendarContainer.style.right="auto"}}}else E.config.position(E,e)}function ue(){E.config.noCalendar||E.isMobile||(Y(),ge(),V())}function le(){E._input.focus(),-1!==window.navigator.userAgent.indexOf("MSIE")||void 0!==navigator.msMaxTouchPoints?setTimeout(E.close,0):E.close()}function fe(e){e.preventDefault(),e.stopPropagation();var n=d(p(e),(function(e){return e.classList&&e.classList.contains("flatpickr-day")&&!e.classList.contains("flatpickr-disabled")&&!e.classList.contains("notAllowed")}));if(void 0!==n){var t=n,r=E.latestSelectedDateObj=new Date(t.dateObj.getTime()),o=(r.getMonth()<E.currentMonth||r.getMonth()>E.currentMonth+E.config.showMonths-1)&&"range"!==E.config.mode;if(E.selectedDateElem=t,"single"===E.config.mode)E.selectedDates=[r];else if("multiple"===E.config.mode){var a=me(r);a?E.selectedDates.splice(parseInt(a),1):E.selectedDates.push(r)}else"range"===E.config.mode&&(2===E.selectedDates.length&&E.clear(!1,!1),E.latestSelectedDateObj=r,E.selectedDates.push(r),0!==_(r,E.selectedDates[0],!0)&&E.selectedDates.sort((function(e,n){return e.getTime()-n.getTime()})));if(C(),o){var i=E.currentYear!==r.getFullYear();E.currentYear=r.getFullYear(),E.currentMonth=r.getMonth(),i&&(ve("onYearChange"),Y()),ve("onMonthChange")}if(ge(),V(),be(),o||"range"===E.config.mode||1!==E.config.showMonths?void 0!==E.selectedDateElem&&void 0===E.hourElement&&E.selectedDateElem&&E.selectedDateElem.focus():H(t),void 0!==E.hourElement&&void 0!==E.hourElement&&E.hourElement.focus(),E.config.closeOnSelect){var c="single"===E.config.mode&&!E.config.enableTime,s="range"===E.config.mode&&2===E.selectedDates.length&&!E.config.enableTime;(c||s)&&le()}k()}}E.parseDate=A({config:E.config,l10n:E.l10n}),E._handlers=[],E.pluginElements=[],E.loadedPlugins=[],E._bind=P,E._setHoursFromDate=N,E._positionCalendar=se,E.changeMonth=z,E.changeYear=Z,E.clear=function(e,n){if(void 0===e&&(e=!0),void 0===n&&(n=!0),E.input.value="",void 0!==E.altInput&&(E.altInput.value=""),void 0!==E.mobileInput&&(E.mobileInput.value=""),E.selectedDates=[],E.latestSelectedDateObj=void 0,!0===n&&(E.currentYear=E._initialDate.getFullYear(),E.currentMonth=E._initialDate.getMonth()),!0===E.config.enableTime){var t=O(E.config);I(t.hours,t.minutes,t.seconds)}E.redraw(),e&&ve("onChange")},E.close=function(){E.isOpen=!1,E.isMobile||(void 0!==E.calendarContainer&&E.calendarContainer.classList.remove("open"),void 0!==E._input&&E._input.classList.remove("active")),ve("onClose")},E._createElement=l,E.destroy=function(){void 0!==E.config&&ve("onDestroy");for(var e=E._handlers.length;e--;)E._handlers[e].remove();if(E._handlers=[],E.mobileInput)E.mobileInput.parentNode&&E.mobileInput.parentNode.removeChild(E.mobileInput),E.mobileInput=void 0;else if(E.calendarContainer&&E.calendarContainer.parentNode)if(E.config.static&&E.calendarContainer.parentNode){var n=E.calendarContainer.parentNode;if(n.lastChild&&n.removeChild(n.lastChild),n.parentNode){for(;n.firstChild;)n.parentNode.insertBefore(n.firstChild,n);n.parentNode.removeChild(n)}}else E.calendarContainer.parentNode.removeChild(E.calendarContainer);E.altInput&&(E.input.type="text",E.altInput.parentNode&&E.altInput.parentNode.removeChild(E.altInput),delete E.altInput),E.input&&(E.input.type=E.input._type,E.input.classList.remove("flatpickr-input"),E.input.removeAttribute("readonly")),["_showTimeInput","latestSelectedDateObj","_hideNextMonthArrow","_hidePrevMonthArrow","__hideNextMonthArrow","__hidePrevMonthArrow","isMobile","isOpen","selectedDateElem","minDateHasTime","maxDateHasTime","days","daysContainer","_input","_positionElement","innerContainer","rContainer","monthNav","todayDateElem","calendarContainer","weekdayContainer","prevMonthNav","nextMonthNav","monthsDropdownContainer","currentMonthElement","currentYearElement","navigationCurrentMonth","selectedDateElem","config"].forEach((function(e){try{delete E[e]}catch(e){}}))},E.isEnabled=$,E.jumpToDate=M,E.open=function(e,n){if(void 0===n&&(n=E._positionElement),!0===E.isMobile){if(e){e.preventDefault();var t=p(e);t&&t.blur()}return void 0!==E.mobileInput&&(E.mobileInput.focus(),E.mobileInput.click()),void ve("onOpen")}if(!E._input.disabled&&!E.config.inline){var r=E.isOpen;E.isOpen=!0,r||(E.calendarContainer.classList.add("open"),E._input.classList.add("active"),ve("onOpen"),se(n)),!0===E.config.enableTime&&!0===E.config.noCalendar&&(!1!==E.config.allowInput||void 0!==e&&E.timeContainer.contains(e.relatedTarget)||setTimeout((function(){return E.hourElement.select()}),50))}},E.redraw=ue,E.set=function(e,n){if(null!==e&&"object"==typeof e)for(var r in Object.assign(E.config,e),e)void 0!==de[r]&&de[r].forEach((function(e){return e()}));else E.config[e]=n,void 0!==de[e]?de[e].forEach((function(e){return e()})):t.indexOf(e)>-1&&(E.config[e]=s(n));E.redraw(),be(!0)},E.setDate=function(e,n,t){if(void 0===n&&(n=!1),void 0===t&&(t=E.config.dateFormat),0!==e&&!e||e instanceof Array&&0===e.length)return E.clear(n);he(e,t),E.latestSelectedDateObj=E.selectedDates[E.selectedDates.length-1],E.redraw(),M(void 0,n),N(),0===E.selectedDates.length&&E.clear(!1),be(n),n&&ve("onChange")},E.toggle=function(e){if(!0===E.isOpen)return E.close();E.open(e)};var de={locale:[ce,W],showMonths:[J,S,q],minDate:[M],maxDate:[M],clickOpens:[function(){!0===E.config.clickOpens?(P(E._input,"focus",E.open),P(E._input,"click",E.open)):(E._input.removeEventListener("focus",E.open),E._input.removeEventListener("click",E.open))}]};function he(e,n){var t=[];if(e instanceof Array)t=e.map((function(e){return E.parseDate(e,n)}));else if(e instanceof Date||"number"==typeof e)t=[E.parseDate(e,n)];else if("string"==typeof e)switch(E.config.mode){case"single":case"time":t=[E.parseDate(e,n)];break;case"multiple":t=e.split(E.config.conjunction).map((function(e){return E.parseDate(e,n)}));break;case"range":t=e.split(E.l10n.rangeSeparator).map((function(e){return E.parseDate(e,n)}))}else E.config.errorHandler(new Error("Invalid date supplied: "+JSON.stringify(e)));E.selectedDates=E.config.allowInvalidPreload?t:t.filter((function(e){return e instanceof Date&&$(e,!1)})),"range"===E.config.mode&&E.selectedDates.sort((function(e,n){return e.getTime()-n.getTime()}))}function pe(e){return e.slice().map((function(e){return"string"==typeof e||"number"==typeof e||e instanceof Date?E.parseDate(e,void 0,!0):e&&"object"==typeof e&&e.from&&e.to?{from:E.parseDate(e.from,void 0),to:E.parseDate(e.to,void 0)}:e})).filter((function(e){return e}))}function ve(e,n){if(void 0!==E.config){var t=E.config[e];if(void 0!==t&&t.length>0)for(var r=0;t[r]&&r<t.length;r++)t[r](E.selectedDates,E.input.value,E,n);"onChange"===e&&(E.input.dispatchEvent(ye("change")),E.input.dispatchEvent(ye("input")))}}function ye(e){var n=document.createEvent("Event");return n.initEvent(e,!0,!0),n}function me(e){for(var n=0;n<E.selectedDates.length;n++)if(0===_(E.selectedDates[n],e))return""+n;return!1}function ge(){E.config.noCalendar||E.isMobile||!E.monthNav||(E.yearElements.forEach((function(e,n){var t=new Date(E.currentYear,E.currentMonth,1);t.setMonth(E.currentMonth+n),E.config.showMonths>1||"static"===E.config.monthSelectorType?E.monthElements[n].textContent=y(t.getMonth(),E.config.shorthandCurrentMonth,E.l10n)+" ":E.monthsDropdownContainer.value=t.getMonth().toString(),e.value=t.getFullYear().toString()})),E._hidePrevMonthArrow=void 0!==E.config.minDate&&(E.currentYear===E.config.minDate.getFullYear()?E.currentMonth<=E.config.minDate.getMonth():E.currentYear<E.config.minDate.getFullYear()),E._hideNextMonthArrow=void 0!==E.config.maxDate&&(E.currentYear===E.config.maxDate.getFullYear()?E.currentMonth+1>E.config.maxDate.getMonth():E.currentYear>E.config.maxDate.getFullYear()))}function Ee(e){return E.selectedDates.map((function(n){return E.formatDate(n,e)})).filter((function(e,n,t){return"range"!==E.config.mode||E.config.enableTime||t.indexOf(e)===n})).join("range"!==E.config.mode?E.config.conjunction:E.l10n.rangeSeparator)}function be(e){void 0===e&&(e=!0),void 0!==E.mobileInput&&E.mobileFormatStr&&(E.mobileInput.value=void 0!==E.latestSelectedDateObj?E.formatDate(E.latestSelectedDateObj,E.mobileFormatStr):""),E.input.value=Ee(E.config.dateFormat),void 0!==E.altInput&&(E.altInput.value=Ee(E.config.altFormat)),!1!==e&&ve("onValueUpdate")}function Ae(e){var n=p(e),t=E.prevMonthNav.contains(n),r=E.nextMonthNav.contains(n);t||r?z(t?-1:1):E.yearElements.indexOf(n)>=0?n.select():n.classList.contains("arrowUp")?E.changeYear(E.currentYear+1):n.classList.contains("arrowDown")&&E.changeYear(E.currentYear-1)}return function(){E.element=E.input=v,E.isOpen=!1,function(){var n=["wrap","weekNumbers","allowInput","allowInvalidPreload","clickOpens","time_24hr","enableTime","noCalendar","altInput","shorthandCurrentMonth","inline","static","enableSeconds","disableMobile"],o=e(e({},JSON.parse(JSON.stringify(v.dataset||{}))),m),a={};E.config.parseDate=o.parseDate,E.config.formatDate=o.formatDate,Object.defineProperty(E.config,"enable",{get:function(){return E.config._enable},set:function(e){E.config._enable=pe(e)}}),Object.defineProperty(E.config,"disable",{get:function(){return E.config._disable},set:function(e){E.config._disable=pe(e)}});var i="time"===o.mode;if(!o.dateFormat&&(o.enableTime||i)){var c=T.defaultConfig.dateFormat||r.dateFormat;a.dateFormat=o.noCalendar||i?"H:i"+(o.enableSeconds?":S":""):c+" H:i"+(o.enableSeconds?":S":"")}if(o.altInput&&(o.enableTime||i)&&!o.altFormat){var u=T.defaultConfig.altFormat||r.altFormat;a.altFormat=o.noCalendar||i?"h:i"+(o.enableSeconds?":S K":" K"):u+" h:i"+(o.enableSeconds?":S":"")+" K"}Object.defineProperty(E.config,"minDate",{get:function(){return E.config._minDate},set:ae("min")}),Object.defineProperty(E.config,"maxDate",{get:function(){return E.config._maxDate},set:ae("max")});var l=function(e){return function(n){E.config["min"===e?"_minTime":"_maxTime"]=E.parseDate(n,"H:i:S")}};Object.defineProperty(E.config,"minTime",{get:function(){return E.config._minTime},set:l("min")}),Object.defineProperty(E.config,"maxTime",{get:function(){return E.config._maxTime},set:l("max")}),"time"===o.mode&&(E.config.noCalendar=!0,E.config.enableTime=!0),Object.assign(E.config,a,o);for(var f=0;f<n.length;f++)E.config[n[f]]=!0===E.config[n[f]]||"true"===E.config[n[f]];for(t.filter((function(e){return void 0!==E.config[e]})).forEach((function(e){E.config[e]=s(E.config[e]||[]).map(D)})),E.isMobile=!E.config.disableMobile&&!E.config.inline&&"single"===E.config.mode&&!E.config.disable.length&&!E.config.enable&&!E.config.weekNumbers&&/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),f=0;f<E.config.plugins.length;f++){var d=E.config.plugins[f](E)||{};for(var h in d)t.indexOf(h)>-1?E.config[h]=s(d[h]).map(D).concat(E.config[h]):void 0===o[h]&&(E.config[h]=d[h])}o.altInputClass||(E.config.altInputClass=ie().className+" "+E.config.altInputClass),ve("onParseConfig")}(),ce(),E.input=ie(),E.input?(E.input._type=E.input.type,E.input.type="text",E.input.classList.add("flatpickr-input"),E._input=E.input,E.config.altInput&&(E.altInput=l(E.input.nodeName,E.config.altInputClass),E._input=E.altInput,E.altInput.placeholder=E.input.placeholder,E.altInput.disabled=E.input.disabled,E.altInput.required=E.input.required,E.altInput.tabIndex=E.input.tabIndex,E.altInput.type="text",E.input.setAttribute("type","hidden"),!E.config.static&&E.input.parentNode&&E.input.parentNode.insertBefore(E.altInput,E.input.nextSibling)),E.config.allowInput||E._input.setAttribute("readonly","readonly"),E._positionElement=E.config.positionElement||E._input):E.config.errorHandler(new Error("Invalid input element specified")),function(){E.selectedDates=[],E.now=E.parseDate(E.config.now)||new Date;var e=E.config.defaultDate||("INPUT"!==E.input.nodeName&&"TEXTAREA"!==E.input.nodeName||!E.input.placeholder||E.input.value!==E.input.placeholder?E.input.value:null);e&&he(e,E.config.dateFormat),E._initialDate=E.selectedDates.length>0?E.selectedDates[0]:E.config.minDate&&E.config.minDate.getTime()>E.now.getTime()?E.config.minDate:E.config.maxDate&&E.config.maxDate.getTime()<E.now.getTime()?E.config.maxDate:E.now,E.currentYear=E._initialDate.getFullYear(),E.currentMonth=E._initialDate.getMonth(),E.selectedDates.length>0&&(E.latestSelectedDateObj=E.selectedDates[0]),void 0!==E.config.minTime&&(E.config.minTime=E.parseDate(E.config.minTime,"H:i")),void 0!==E.config.maxTime&&(E.config.maxTime=E.parseDate(E.config.maxTime,"H:i")),E.minDateHasTime=!!E.config.minDate&&(E.config.minDate.getHours()>0||E.config.minDate.getMinutes()>0||E.config.minDate.getSeconds()>0),E.maxDateHasTime=!!E.config.maxDate&&(E.config.maxDate.getHours()>0||E.config.maxDate.getMinutes()>0||E.config.maxDate.getSeconds()>0)}(),E.utils={getDaysInMonth:function(e,n){return void 0===e&&(e=E.currentMonth),void 0===n&&(n=E.currentYear),1===e&&(n%4==0&&n%100!=0||n%400==0)?29:E.l10n.daysInMonth[e]}},E.isMobile||function(){var e=window.document.createDocumentFragment();if(E.calendarContainer=l("div","flatpickr-calendar"),E.calendarContainer.tabIndex=-1,!E.config.noCalendar){if(e.appendChild((E.monthNav=l("div","flatpickr-months"),E.yearElements=[],E.monthElements=[],E.prevMonthNav=l("span","flatpickr-prev-month"),E.prevMonthNav.innerHTML=E.config.prevArrow,E.nextMonthNav=l("span","flatpickr-next-month"),E.nextMonthNav.innerHTML=E.config.nextArrow,J(),Object.defineProperty(E,"_hidePrevMonthArrow",{get:function(){return E.__hidePrevMonthArrow},set:function(e){E.__hidePrevMonthArrow!==e&&(u(E.prevMonthNav,"flatpickr-disabled",e),E.__hidePrevMonthArrow=e)}}),Object.defineProperty(E,"_hideNextMonthArrow",{get:function(){return E.__hideNextMonthArrow},set:function(e){E.__hideNextMonthArrow!==e&&(u(E.nextMonthNav,"flatpickr-disabled",e),E.__hideNextMonthArrow=e)}}),E.currentYearElement=E.yearElements[0],ge(),E.monthNav)),E.innerContainer=l("div","flatpickr-innerContainer"),E.config.weekNumbers){var n=function(){E.calendarContainer.classList.add("hasWeeks");var e=l("div","flatpickr-weekwrapper");e.appendChild(l("span","flatpickr-weekday",E.l10n.weekAbbreviation));var n=l("div","flatpickr-weeks");return e.appendChild(n),{weekWrapper:e,weekNumbers:n}}(),t=n.weekWrapper,r=n.weekNumbers;E.innerContainer.appendChild(t),E.weekNumbers=r,E.weekWrapper=t}E.rContainer=l("div","flatpickr-rContainer"),E.rContainer.appendChild(q()),E.daysContainer||(E.daysContainer=l("div","flatpickr-days"),E.daysContainer.tabIndex=-1),V(),E.rContainer.appendChild(E.daysContainer),E.innerContainer.appendChild(E.rContainer),e.appendChild(E.innerContainer)}E.config.enableTime&&e.appendChild(function(){E.calendarContainer.classList.add("hasTime"),E.config.noCalendar&&E.calendarContainer.classList.add("noCalendar");var e=O(E.config);E.timeContainer=l("div","flatpickr-time"),E.timeContainer.tabIndex=-1;var n=l("span","flatpickr-time-separator",":"),t=h("flatpickr-hour",{"aria-label":E.l10n.hourAriaLabel});E.hourElement=t.getElementsByTagName("input")[0];var r=h("flatpickr-minute",{"aria-label":E.l10n.minuteAriaLabel});if(E.minuteElement=r.getElementsByTagName("input")[0],E.hourElement.tabIndex=E.minuteElement.tabIndex=-1,E.hourElement.value=a(E.latestSelectedDateObj?E.latestSelectedDateObj.getHours():E.config.time_24hr?e.hours:function(e){switch(e%24){case 0:case 12:return 12;default:return e%12}}(e.hours)),E.minuteElement.value=a(E.latestSelectedDateObj?E.latestSelectedDateObj.getMinutes():e.minutes),E.hourElement.setAttribute("step",E.config.hourIncrement.toString()),E.minuteElement.setAttribute("step",E.config.minuteIncrement.toString()),E.hourElement.setAttribute("min",E.config.time_24hr?"0":"1"),E.hourElement.setAttribute("max",E.config.time_24hr?"23":"12"),E.hourElement.setAttribute("maxlength","2"),E.minuteElement.setAttribute("min","0"),E.minuteElement.setAttribute("max","59"),E.minuteElement.setAttribute("maxlength","2"),E.timeContainer.appendChild(t),E.timeContainer.appendChild(n),E.timeContainer.appendChild(r),E.config.time_24hr&&E.timeContainer.classList.add("time24hr"),E.config.enableSeconds){E.timeContainer.classList.add("hasSeconds");var o=h("flatpickr-second");E.secondElement=o.getElementsByTagName("input")[0],E.secondElement.value=a(E.latestSelectedDateObj?E.latestSelectedDateObj.getSeconds():e.seconds),E.secondElement.setAttribute("step",E.minuteElement.getAttribute("step")),E.secondElement.setAttribute("min","0"),E.secondElement.setAttribute("max","59"),E.secondElement.setAttribute("maxlength","2"),E.timeContainer.appendChild(l("span","flatpickr-time-separator",":")),E.timeContainer.appendChild(o)}return E.config.time_24hr||(E.amPM=l("span","flatpickr-am-pm",E.l10n.amPM[i((E.latestSelectedDateObj?E.hourElement.value:E.config.defaultHour)>11)]),E.amPM.title=E.l10n.toggleTitle,E.amPM.tabIndex=-1,E.timeContainer.appendChild(E.amPM)),E.timeContainer}()),u(E.calendarContainer,"rangeMode","range"===E.config.mode),u(E.calendarContainer,"animate",!0===E.config.animate),u(E.calendarContainer,"multiMonth",E.config.showMonths>1),E.calendarContainer.appendChild(e);var o=void 0!==E.config.appendTo&&void 0!==E.config.appendTo.nodeType;if((E.config.inline||E.config.static)&&(E.calendarContainer.classList.add(E.config.inline?"inline":"static"),E.config.inline&&(!o&&E.element.parentNode?E.element.parentNode.insertBefore(E.calendarContainer,E._input.nextSibling):void 0!==E.config.appendTo&&E.config.appendTo.appendChild(E.calendarContainer)),E.config.static)){var c=l("div","flatpickr-wrapper");E.element.parentNode&&E.element.parentNode.insertBefore(c,E.element),c.appendChild(E.element),E.altInput&&c.appendChild(E.altInput),c.appendChild(E.calendarContainer)}E.config.static||E.config.inline||(void 0!==E.config.appendTo?E.config.appendTo:window.document.body).appendChild(E.calendarContainer)}(),function(){if(E.config.wrap&&["open","close","toggle","clear"].forEach((function(e){Array.prototype.forEach.call(E.element.querySelectorAll("[data-"+e+"]"),(function(n){return P(n,"click",E[e])}))})),E.isMobile)!function(){var e=E.config.enableTime?E.config.noCalendar?"time":"datetime-local":"date";E.mobileInput=l("input",E.input.className+" flatpickr-mobile"),E.mobileInput.tabIndex=1,E.mobileInput.type=e,E.mobileInput.disabled=E.input.disabled,E.mobileInput.required=E.input.required,E.mobileInput.placeholder=E.input.placeholder,E.mobileFormatStr="datetime-local"===e?"Y-m-d\\TH:i:S":"date"===e?"Y-m-d":"H:i:S",E.selectedDates.length>0&&(E.mobileInput.defaultValue=E.mobileInput.value=E.formatDate(E.selectedDates[0],E.mobileFormatStr)),E.config.minDate&&(E.mobileInput.min=E.formatDate(E.config.minDate,"Y-m-d")),E.config.maxDate&&(E.mobileInput.max=E.formatDate(E.config.maxDate,"Y-m-d")),E.input.getAttribute("step")&&(E.mobileInput.step=String(E.input.getAttribute("step"))),E.input.type="hidden",void 0!==E.altInput&&(E.altInput.type="hidden");try{E.input.parentNode&&E.input.parentNode.insertBefore(E.mobileInput,E.input.nextSibling)}catch(e){}P(E.mobileInput,"change",(function(e){E.setDate(p(e).value,!1,E.mobileFormatStr),ve("onChange"),ve("onClose")}))}();else{var e=c(oe,50);if(E._debouncedChange=c(k,300),E.daysContainer&&!/iPhone|iPad|iPod/i.test(navigator.userAgent)&&P(E.daysContainer,"mouseover",(function(e){"range"===E.config.mode&&re(p(e))})),P(window.document.body,"keydown",te),E.config.inline||E.config.static||P(window,"resize",e),void 0!==window.ontouchstart?P(window.document,"touchstart",X):P(window.document,"mousedown",X),P(window.document,"focus",X,{capture:!0}),!0===E.config.clickOpens&&(P(E._input,"focus",E.open),P(E._input,"click",E.open)),void 0!==E.daysContainer&&(P(E.monthNav,"click",Ae),P(E.monthNav,["keyup","increment"],R),P(E.daysContainer,"click",fe)),void 0!==E.timeContainer&&void 0!==E.minuteElement&&void 0!==E.hourElement){var n=function(e){return p(e).select()};P(E.timeContainer,["increment"],x),P(E.timeContainer,"blur",x,{capture:!0}),P(E.timeContainer,"click",F),P([E.hourElement,E.minuteElement],["focus","click"],n),void 0!==E.secondElement&&P(E.secondElement,"focus",(function(){return E.secondElement&&E.secondElement.select()})),void 0!==E.amPM&&P(E.amPM,"click",(function(e){x(e),k()}))}E.config.allowInput&&P(E._input,"blur",ne)}}(),(E.selectedDates.length||E.config.noCalendar)&&(E.config.enableTime&&N(E.config.noCalendar?E.latestSelectedDateObj:void 0),be(!1)),S();var n=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);!E.isMobile&&n&&se(),ve("onReady")}(),E}function S(e,n){for(var t=Array.prototype.slice.call(e).filter((function(e){return e instanceof HTMLElement})),r=[],o=0;o<t.length;o++){var a=t[o];try{if(null!==a.getAttribute("data-fp-omit"))continue;void 0!==a._flatpickr&&(a._flatpickr.destroy(),a._flatpickr=void 0),a._flatpickr=D(a,n||{}),r.push(a._flatpickr)}catch(e){console.error(e)}}return 1===r.length?r[0]:r}"function"!=typeof Object.assign&&(Object.assign=function(e){for(var n=[],t=1;t<arguments.length;t++)n[t-1]=arguments[t];if(!e)throw TypeError("Cannot convert undefined or null to object");for(var r=function(n){n&&Object.keys(n).forEach((function(t){return e[t]=n[t]}))},o=0,a=n;o<a.length;o++)r(a[o]);return e}),"undefined"!=typeof HTMLElement&&"undefined"!=typeof HTMLCollection&&"undefined"!=typeof NodeList&&(HTMLCollection.prototype.flatpickr=NodeList.prototype.flatpickr=function(e){return S(this,e)},HTMLElement.prototype.flatpickr=function(e){return S([this],e)});var T=function(e,n){return"string"==typeof e?S(window.document.querySelectorAll(e),n):e instanceof Node?S([e],n):S(e,n)};return T.defaultConfig={},T.l10ns={en:e({},o),default:e({},o)},T.localize=function(n){T.l10ns.default=e(e({},T.l10ns.default),n)},T.setDefaults=function(n){T.defaultConfig=e(e({},T.defaultConfig),n)},T.parseDate=A({}),T.formatDate=b({}),T.compareDates=_,"undefined"!=typeof jQuery&&void 0!==jQuery.fn&&(jQuery.fn.flatpickr=function(e){return S(this,e)}),Date.prototype.fp_incr=function(e){return new Date(this.getFullYear(),this.getMonth(),this.getDate()+("string"==typeof e?parseInt(e,10):e))},"undefined"!=typeof window&&(window.flatpickr=T),T}()}(Wt)),Wt.exports}function Qt(){if(qt)return Jt;qt=1;return Jt=((e,n,t,r,o,a,i,c,s,u,l)=>{var f={setCustomize:()=>{}},d=function(e,n){if(!n||1===n)return e.store;var t=e.store.modules&&e.store.modules.team;return t?t.getTeam(n):void 0},h=function(n,t){n.emit("UPDATE",{teams:t.stores,roTeams:t.roStores,id:t.channel,loading:!t.ready&&!t.cacheready,readOnly:t.readOnly||!t.ready&&t.cacheready||t.offline,offline:t.offline,deleted:!t.stores.length,restricted:t.restricted,owned:n.Store.isOwned(t.owners),content:e.clone(t.proxy),hashes:t.hashes},n.clients)},p=function(e,n){var t=e.calendars[n];t&&t.reminders&&Object.keys(t.reminders).forEach((function(e){Array.isArray(t.reminders[e])&&t.reminders[e].forEach((function(e){clearTimeout(e)}))}))},v=function(e,n){var t=e.calendars[n];t&&(t.stores.length||(t.lm.stop(),p(e,n),delete e.calendars[n]))},y=function(e,n,t){n.stores.forEach((function(r){var o=d(e,r);if(o&&o.proxy&&o.rpc&&o.proxy.calendars){var a=o.proxy.calendars[n.channel];a&&(a.color!==t.color&&(a.color=t.color),a.title!==t.title&&(a.title=t.title))}}))},m=function(n,t,r,o){var a=+new Date,i=e.clone(r),c=i.id;if(Array.isArray(t[c])&&t[c].forEach((function(e){clearTimeout(e)})),t[c]=[],!r.deleted){var u=e.find(n,["store","proxy","hideReminders",c])||[],l=n.store.data.lastVisit;if(i.isAllDay&&(i.startDay&&(i.start=+s.parseDate(i.startDay)),i.endDay)){var f=s.parseDate(i.endDay);f.setHours(23),f.setMinutes(59),f.setSeconds(59),i.end=+f}var d=a-6048e5,h=o&&i.start>l&&i.end<=a&&i.end>d;if(i.end<=a&&!h)return delete t[c],void function(n,t){var r=e.find(n,["store","proxy","hideReminders"])||{};Object.keys(r).filter((function(e){return e===t})).forEach((function(e){delete r[e]}))}(n,c);var p=!1,v=function(t){p=!0,n.Store.onReadyEvt.reg((function(){!function(t){if(!e.find(n,["store","proxy","settings","general","calendar","hideNotif"])){var r=i.start<=a?i.start:+new Date;n.store.mailbox.showMessage("reminders",{msg:{ctime:r,type:"REMINDER",missed:Boolean(h),content:i},hash:"REMINDER|"+c+"-"+t},null,(function(){}))}}(t)}))},y=i.reminders||[];y.sort((function(e,n){return e-n})),y.some((function(e){var n=a+6e4*e;if(!u.some((function(n){return e>=n})))return i.start-n>=2147483647||(i.start<=n?(v(e),!0):void t[c].push(setTimeout((function(){v(e)}),i.start-n)))})),p||n.Store.onReadyEvt.reg((function(){n.store.mailbox.hideMessage("reminders",{hash:"REMINDER|"+c},null,(function(){}))}))}},g=function(n,t,r,o){var i=function(e){var n=new Date,t=new Date(n.getFullYear(),n.getMonth()-1,15),r=new Date(n.getFullYear(),n.getMonth()+1,15),o=a.getMonthId(t),i=a.getMonthId(n),c=a.getMonthId(r),s=a.getRecurring([o,i,c],[e]),u=[e];return Array.prototype.push.apply(u,s),a.applyUpdates(u)}(e.clone(r));i.forEach((function(e){m(n,t,e,o)}))},E=function(e,n,t){var r=e.calendars[n];t&&r&&r.reminders&&(1===r.stores.length&&0===r.stores[0]||g(e,r.reminders,t))},b=function(n,t,r){var o=n.calendars[t];if(o&&o.reminders&&!Object.keys(o.reminders).length&&(1!==o.stores.length||0!==o.stores[0])){var a=e.find(o,["proxy","content"]);a&&Object.keys(a).forEach((function(e){g(n,o.reminders,a[e],r)}))}},A=function(t,r,a){var s=e.once(e.mkAsync(a||function(){})),f=r.storeId,v=r.data,m=v.channel;if(m){var g=t.calendars[m],A=function(){h(t,g)};if(g){if(g.readOnly&&v.href){var _=n.parsePadUrl(v.href),w=n.getSecrets("calendar",_.hash,v.password),O=u.createEncryptor(w.keys);g.hashes.editHash=n.getEditHashFromKeys(w),g.lm.setReadOnly(!1,O),g.readOnly=!1}else if(0===f)return 1===g.stores.length&&0===g.stores[0]&&g.tempId.length&&r.cId&&g.tempId.push(r.cId),void s();return-1!==g.roStores.indexOf(f)&&v.href&&(g.roStores.splice(g.roStores.indexOf(f),1),-1!==g.stores.indexOf(0)&&g.stores.splice(g.stores.indexOf(0),1),A()),g.stores&&-1!==g.stores.indexOf(f)?void s():(-1!==g.stores.indexOf(0)&&(g.stores.splice(g.stores.indexOf(0),1),g.tempId=[]),g.stores.push(f),v.href||g.roStores.push(f),A(),void s())}g=t.calendars[m]={ready:!1,channel:m,readOnly:!v.href,tempId:[],stores:[f],roStores:v.href?[]:[f],reminders:{},hashes:{}},0===f&&g.tempId.push(r.cId);var D=n.parsePadUrl(v.href||v.roHref),S=n.getSecrets("calendar",D.hash,v.password),T=u.createEncryptor(S.keys);g.hashes.viewHash=n.getViewHashFromKeys(S),v.href&&(g.hashes.editHash=n.getEditHashFromKeys(S)),g.proxy={metadata:{color:v.color,title:v.title}},A();var x=function(){g.stores.forEach((function(e){var n=d(t,e);n&&n.rpc&&n.proxy.calendars&&(delete n.proxy.calendars[m],(n.unpin||t.unpinPads)([m],(function(e){e&&e.error&&console.error(e.error)})))})),g.lm&&g.lm.stop(),g.stores=[],h(t,g),p(t,m),delete t.calendars[m]};i((function(e){t.store.network&&!r.isNew&&t.Store.isNewChannel(null,m,e((function(n){if(!n||!n.error)return n&&"boolean"==typeof n.isNew&&n.isNew?(x(),s({error:"EDELETED"}),void e.abort()):void 0})))})).nThen((function(){var e;if(1!==f&&f){var n=t.store.modules.team&&t.store.modules.team.getTeamsData(),a=n&&n[f];e=a?a.edPublic:void 0}else e=t.store.proxy.edPublic;var i={data:{},network:t.store.network||t.store.networkPromise,channel:S.channel,crypto:T,owners:[e],ChainPad:l,validateKey:S.keys.validateKey||void 0,userName:"calendar",Cache:o,classic:!0,onRejected:t.Store&&t.Store.onRejected},u=c.create(i);g.lm=u;var d=g.proxy=u.proxy,h=!1,p=function(){h||(h=!0,setTimeout((function(){h=!1,A()})))};u.proxy.on("cacheready",(function(){d.metadata&&(g.cacheready=!0,p(),s&&s(null,u.proxy),b(t,m,r.lastVisitNotif))})).on("ready",(function(e){var n=e.metadata;if(g.owners=n.owners||[],g.ready=!0,!d.metadata){if(!r.isNew)return void x();d.metadata={color:v.color,title:v.title}}p(),s&&s(null,u.proxy),b(t,m,r.lastVisitNotif)})).on("change",[],(function(){g.ready&&p()})).on("change",["content"],(function(e,n,r){2!==r.length||!n||e?2!==r.length||n||!e?(r.length>=3&&["start","reminders","isAllDay"].includes(r[2])||r.length>=6&&["start","reminders","isAllDay"].includes(r[5]))&&setTimeout((function(){E(t,m,d.content[r[1]])})):E(t,m,{id:r[1],start:0}):E(t,m,n)})).on("remove",["content"],(function(e,n){p(),(n.length>=3&&"reminders"===n[2]||n.length>=6&&"reminders"===n[5])&&setTimeout((function(){E(t,m,d.content[n[1]])}))})).on("change",["metadata"],(function(){var e=d.metadata;e&&e.title&&e.color&&y(t,g,e)})).on("disconnect",(function(){g.offline=!0,p()})).on("reconnect",(function(){g.offline=!1,p()})).on("error",(function(e){e&&e.error&&("EDELETED"!==e.error?("ERESTRICTED"===e.error&&(g.restricted=!0,p()),s(e)):x())}))}))}},_=function(e,n){if(n.href&&-1===n.href.indexOf("#"))if(e.secondaryKey)try{n.href=e.userObject.cryptor.decrypt(n.href)}catch(e){console.error(e),delete n.href}else delete n.href},w=function(n,t){var r=t.proxy.calendars,o=t.id||1;t.proxy.on("change",["calendars"],(function(r,a,i){i.length<2||(r&&!a&&function(){var e=i[1],t=n.calendars[e];if(t){var r=t.stores.indexOf(o);if(-1!==r){t.stores.splice(r,1);var a=t.roStores.indexOf(o);-1!==a&&t.roStores.splice(a,1),v(n,e),h(n,t)}}}(),!r&&a&&function(){var r=i[1],a=t.proxy.calendars[r];if(a){var c=e.clone(a);_(t,c),A(n,{storeId:o,data:c})}}())})),Object.keys(r||{}).forEach((function(a){var i=e.clone(r[a]);_(t,i),A(n,{storeId:o,lastVisitNotif:!0,data:i})}))},O=function(e,t,o,a){var i=d(e,t.teamId);if(i)if(i.rpc){var c,s,u,l=i.proxy.calendars=i.proxy.calendars||{},f=(c=n.createRandomHash("calendar"),s=n.getSecrets("calendar",c),u=n.getViewHashFromKeys(s),{href:n.hashToHref(c,"calendar"),roHref:n.hashToHref(u,"calendar"),channel:s.channel});f.color=t.color,f.title=t.title,A(e,{storeId:i.id||1,data:f,isNew:!0},(function(n){if(n)return console.error(n),void a({error:n.error});var t=e.calendars[f.channel];r.whenRealtimeSyncs(t.lm.realtime,(function(){l[f.channel]=f,(i.pin||e.pinPads)([f.channel],(function(e){e&&e.error&&console.error(e.error)})),e.Store.onSync(i.id,a)}))}))}else a({error:"EFORBIDDEN"});else a({error:"NO_STORE"})};return f.init=function(t,o,a){var c={},s=t.store,u={loggedIn:s.loggedIn&&s.proxy.edPublic,store:s,Store:t.Store,pinPads:t.pinPads,unpinPads:t.unpinPads,updateMetadata:t.updateMetadata,emit:a,onReady:e.mkEvent(!0),calendars:{},clients:[]};return function(e,n){var t=e.store.proxy;t.calendars=t.calendars||{},setTimeout(n)}(u,o((function(e){e||function(e){w(e,e.store);var n=e.store.modules.team&&e.store.modules.team.getTeamsData();n&&Object.keys(n).forEach((function(n){var t=d(e,n);w(e,t)}))}(u)}))),u.store.proxy.on("change",["hideReminders"],(function(e,n,t){var r=t[1].split("|")[0];Object.keys(u.calendars).some((function(e){var n=u.calendars[e];if(n&&n.proxy&&n.proxy.content)return n.proxy.content[r]?(setTimeout((function(){E(u,e,n.proxy.content[r])})),!0):void 0}))})),c.closeTeam=function(e){Object.keys(u.calendars).forEach((function(n){var t=u.calendars[n],r=t.stores.indexOf(e);if(-1!==r){t.stores.splice(r,1);var o=t.roStores.indexOf(e);-1!==o&&t.roStores.splice(o,1),v(u,n),h(u,t)}}))},c.openTeam=function(e){var n=d(u,e);n&&w(u,n)},c.upgradeTeam=function(n){if(n){var t=d(u,n);t&&Object.keys(u.calendars).forEach((function(r){var o=u.calendars[r];if(-1!==o.stores.indexOf(n)){var a=t.proxy.calendars[r],i=e.clone(a);_(t,i),A(u,{storeId:n,data:i}),h(u,o)}}))}},c.removeClient=function(e){!function(e,n){var t=e.clients.indexOf(n);-1!==t&&e.clients.splice(t,1),Object.keys(e.calendars).forEach((function(t){var r=e.calendars[t];if(1===r.stores.length&&0===r.stores[0]&&r.tempId.length){var o=r.tempId.indexOf(n);-1!==o&&r.tempId.splice(o,1),r.tempId.length||(r.stores=[],v(e,t))}}))}(u,e)},c.execCommand=function(t,o,a){var c=o.cmd,s=o.data;if("SUBSCRIBE"!==c){if("OPEN"!==c)return"IMPORT"===c?u.store.offline?void a({error:"OFFLINE"}):u.loggedIn?void function(t,r,o,a){var i=r.id,c=t.calendars[i];if(c)if(Array.isArray(c.stores)&&-1!==c.stores.indexOf(r.teamId)){var s=t.store,u=s.proxy.calendars=s.proxy.calendars||{},l=c.hashes.editHash,f=c.hashes.viewHash;u[i]={href:l&&n.hashToHref(l,"calendar"),roHref:f&&n.hashToHref(f,"calendar"),channel:i,color:e.find(c,["proxy","metadata","color"])||e.getRandomColor(),title:e.find(c,["proxy","metadata","title"])||"..."},t.Store.onSync(null,a),A(t,{storeId:1,data:{href:u[i].href,toHref:u[i].roHref,channel:i}})}else a({error:"EINVAL"});else a({error:"ENOENT"})}(u,s,0,a):void a({error:"NOT_LOGGED_IN"}):"IMPORT_ICS"===c?u.store.offline?void a({error:"OFFLINE"}):void function(e,n,t,o){var a=n.id,i=e.calendars[a];if(i&&i.proxy){var c=n.json;i.proxy.content=i.proxy.content||{},Object.keys(c).forEach((function(n){i.proxy.content[n]=c[n],E(e,a,c[n])})),r.whenRealtimeSyncs(i.lm.realtime,(function(){h(e,i),o()}))}else o({error:"ENOENT"})}(u,s,0,a):"ADD"===c?u.store.offline?void a({error:"OFFLINE"}):u.loggedIn?void function(t,r,o,a){var i=d(t,r.teamId);if(i)if(i.rpc){var c=i.proxy.calendars=i.proxy.calendars||{},s=n.parsePadUrl(r.href),u=n.getSecrets(s.type,s.hash,r.password);if(u.channel===r.channel){var l=n.getEditHashFromKeys(u),f=n.getViewHashFromKeys(u),h=l&&n.hashToHref(l,"calendar"),p={href:h,roHref:f&&n.hashToHref(f,"calendar"),color:r.color,title:r.title,channel:r.channel};!c[r.channel]||!c[r.channel].href&&p.href?(p.color=r.color,p.title=r.title,A(t,{storeId:i.id||1,data:e.clone(p)},(function(e){if(e)return console.error(e),void a({error:e.error});if(h&&i.id&&i.secondaryKey)try{p.href=i.userObject.cryptor.encrypt(h)}catch(e){console.error(e)}c[p.channel]=p,(i.pin||t.pinPads)([p.channel],(function(e){e&&e.error&&console.error(e.error)})),t.Store.onSync(i.id,a)}))):a()}else a({error:"EINVAL"})}else a({error:"EFORBIDDEN"});else a({error:"NO_STORE"})}(u,s,0,a):void a({error:"NOT_LOGGED_IN"}):"CREATE"===c?u.loggedIn?s.initialCalendar?void u.Store.onReadyEvt.reg((function(){O(u,s,0,a)})):u.store.offline?void a({error:"OFFLINE"}):void O(u,s,0,a):void a({error:"NOT_LOGGED_IN"}):"UPDATE"===c?u.store.offline?void a({error:"OFFLINE"}):void function(n,t,o,a){var i=t.id,c=n.calendars[i];if(c){var s=e.find(c,["proxy","metadata"]);s?(s.title=t.title,s.color=t.color,r.whenRealtimeSyncs(c.lm.realtime,a),h(n,c),y(n,c,t)):a({error:"EINVAL"})}else a({error:"ENOENT"})}(u,s,0,a):"DELETE"===c?u.store.offline?void a({error:"OFFLINE"}):u.loggedIn?void function(e,n,t,r){var o=d(e,n.teamId);if(o)if(o.rpc){if(o.proxy.calendars){var a=n.id;if(o.proxy.calendars[a]){delete o.proxy.calendars[a],(o.unpin||e.unpinPads)([a],(function(e){e&&e.error&&console.error(e.error)}));var i=e.calendars[a],c=i.stores.indexOf(o.id||1);i.stores.splice(c,1),v(e,a),e.Store.onSync(o.id,(function(){h(e,i),r()}))}else r()}}else r({error:"EFORBIDDEN"});else r({error:"NO_STORE"})}(u,s,0,a):void a({error:"NOT_LOGGED_IN"}):"CREATE_EVENT"===c?u.store.offline?void a({error:"OFFLINE"}):void function(e,n,t,o){var a=n.calendarId,i=e.calendars[a];if(i){var c=new Date(n.start),s=new Date(n.end);n.isAllDay?(n.startDay=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),n.endDay=s.getFullYear()+"-"+(s.getMonth()+1)+"-"+s.getDate()):(delete n.startDay,delete n.endDay),i.proxy.content=i.proxy.content||{},i.proxy.content[n.id]=n,r.whenRealtimeSyncs(i.lm.realtime,(function(){E(e,a,n),h(e,i),o()}))}else o({error:"ENOENT"})}(u,s,0,a):"UPDATE_EVENT"===c?u.store.offline?void a({error:"OFFLINE"}):void function(n,t,o,a){if(t&&t.ev){var c=t.ev.calendarId,s=n.calendars[c];if(s&&s.proxy&&s.proxy.content){var u=s.proxy.content[t.ev.id];if(u){t.rawData=t.rawData||{};var l,f=t.changes||{},d=t.type||{};if(f.calendarId){if(!(l=n.calendars[f.calendarId])||!l.proxy)return void a({error:"ENOENT"});l.proxy.content=l.proxy.content||{}}var p={one:{},from:{}};["one","from","all"].includes(d.which)&&(u.recUpdate=u.recUpdate||p,u.recUpdate.one||(u.recUpdate.one={}),u.recUpdate.from||(u.recUpdate.from={}));var v=u.recUpdate,y=["calendarId"],m=Object.keys(f).filter((function(e){return!y.includes(e)})),g=function(e){[v.from,v.one].forEach((function(n){Object.keys(n).forEach((function(t){Number(t)<e||delete n[t]}))}))},b=function(e,n){Object.keys(e).forEach((function(t){n&&Number(t)<n||m.forEach((function(n){delete e[t][n]}))}))};if(void 0!==f.recurrenceRule&&("all"===d.which&&f.recurrenceRule.until?g(f.recurrenceRule.until):["one","from"].includes(d.which)&&!t.rawData.isOrigin?g(d.when+1):v=u.recUpdate=p),"one"===d.which?v.one[d.when]=v.one[d.when]||{}:"from"===d.which?(v.from[d.when]=v.from[d.when]||{},b(v.from,d.when),b(v.one,d.when)):"all"===d.which&&(b(v.from),b(v.one)),f.start&&v&&(!d.which||"all"===d.which)){var A=f.start-u.start,_={},w={};Object.keys(v.one||{}).forEach((function(e){_[Number(e)+A]=v.one[e]})),Object.keys(v.from||{}).forEach((function(e){w[Number(e)+A]=v.from[e]})),v.one=_,v.from=w}var O=e.find(n,["store","proxy","hideReminders"])||{};f.reminders&&("one"===d.which?d.when&&d.when!==u.start?delete O[t.ev.id+"|"+d.when]:delete O[t.ev.id]:"from"===d.which?Object.keys(O).filter((function(e){return 0===e.indexOf(t.ev.id)})).forEach((function(e){var n=Number(e.split("|")[1]);n&&(n<d.when||delete O[e])})):Object.keys(O).filter((function(e){return 0===e.indexOf(t.ev.id)})).forEach((function(e){delete O[e]}))),Object.keys(f).forEach((function(e){if(!y.includes(e)&&"one"===d.which)return"recurrenceRule"===e?t.rawData&&t.rawData.isOrigin?u[e]=f[e]:(v.from[d.when]=v.from[d.when]||{},v.from[d.when][e]=f[e]):void(v.one[d.when][e]=f[e]);y.includes(e)||"from"!==d.which?u[e]=f[e]:v.from[d.when][e]=f[e]}));var D=new Date(u.start),S=new Date(u.end);u.isAllDay?(u.startDay=D.getFullYear()+"-"+(D.getMonth()+1)+"-"+D.getDate(),u.endDay=S.getFullYear()+"-"+(S.getMonth()+1)+"-"+S.getDate()):(delete u.startDay,delete u.endDay),f.calendarId&&l&&(l.proxy.content[t.ev.id]=e.clone(u),delete s.proxy.content[t.ev.id]),i((function(e){r.whenRealtimeSyncs(s.lm.realtime,e()),l&&r.whenRealtimeSyncs(l.lm.realtime,e())})).nThen((function(){l?(E(n,c,{id:u.id,start:0}),E(n,u.calendarId,u)):(f.start||f.reminders||f.isAllDay)&&E(n,c,u),h(n,s),l&&h(n,l),a()}))}else a({error:"EINVAL"})}else a({error:"ENOENT"})}else a({error:"EINVAL"})}(u,s,0,a):"DELETE_EVENT"===c?u.store.offline?void a({error:"OFFLINE"}):void function(e,n,t,o){var a=n.calendarId,i=e.calendars[a];if(i){i.proxy.content=i.proxy.content||{};var c=n.id.split("|")[0];if(n.id===c)delete i.proxy.content[n.id];else{var s=i.proxy.content[c],u=n.raw&&n.raw.start;u&&(s.recUpdate=s.recUpdate||{one:{},from:{}},s.recUpdate.one[u]={deleted:!0})}r.whenRealtimeSyncs(i.lm.realtime,(function(){E(e,a,{id:n.id,start:0}),h(e,i),o()}))}else o({error:"ENOENT"})}(u,s,0,a):void 0;u.Store.onReadyEvt.reg((function(){!function(t,r,o,a){var i=n.getSecrets("calendar",r.hash,r.password),c=n.getEditHashFromKeys(i),s=n.getViewHashFromKeys(i),u={href:c&&n.hashToHref(c,"calendar"),roHref:s&&n.hashToHref(s,"calendar"),channel:i.channel,color:e.getRandomColor(),title:"..."};A(t,{cId:o,storeId:0,data:u},a)}(u,s,t,a)}))}else!function(e,n,t,r){-1===e.clients.indexOf(t)&&e.clients.push(t),r({length:Object.keys(e.calendars).length}),Object.keys(e.calendars).forEach((function(n){var t=e.calendars[n]||{};h(e,t)}))}(u,0,t,a)},c},f})(ee(),ae(),q(),je(),he(),Yt(),We(),S(),zt(),K(),N()),Jt}var Xt=r(h());let Zt={};const $t=(e,n,t)=>{const r=[],o=null==Zt?void 0:Zt.httpUnsafeOrigin;ue.fetchApi(o,"config",!0,(e=>{var o,a;(null===(o=null==e?void 0:e.adminKeys)||void 0===o?void 0:o.includes(n))&&r.push("admin");(null===(a=null==e?void 0:e.moderatorKeys)||void 0===a?void 0:a.includes(n))&&r.push("moderator"),t(r)}))},er=(e,n,t)=>{e.Store.anonRpcMsg("",{msg:"IS_PREMIUM",data:n},(e=>{let n=Array.isArray(e)&&e[0];t(n?["premium"]:[])}))},nr={admin:$t,moderator:$t,premium:er},tr={init:(e,n,t)=>{const r={store:e.store,Store:e.Store,updateMetadata:e.updateMetadata};return{removeClient:()=>{},execCommand:(e,n,t)=>{console.log("Exex command",e,n);const o=n.cmd,a=n.data;"LIST_BADGES"!==o?"CHECK_BADGE"!==o?t():((e,n,t,r)=>{const{badge:o,ed:a,sig:i,nid:c}=n,s=ue.decodeBase64(a),u=ue.decodeBase64(i),l=Xt.sign.open(u,s);if(!l)return void r({verified:!1});if(ue.encodeUTF8(l)!==c)return void r({verified:!1});let f=nr[o];f?f(e,a,(e=>{r({verified:e.includes(o),badge:o})})):r({verified:!1,error:"EINVAL"})})(r,a,0,t):((e,n,t,r)=>{var o,a;const i=[];null==Zt||Zt.httpUnsafeOrigin;const c=n.edPublic||(null===(a=null===(o=e.store)||void 0===o?void 0:o.proxy)||void 0===a?void 0:a.edPublic);ot((e=>{$t(0,c,e((e=>{Array.prototype.push.apply(i,e)})))})).nThen((n=>{er(e,c,n((e=>{Array.prototype.push.apply(i,e)})))})).nThen((()=>{r(i)}))})(r,a,0,t)}}},setCustomize:e=>{Zt=null==e?void 0:e.ApiConfig}};var rr,or,ar=o(Object.freeze({__proto__:null,Badge:tr}));function ir(){if(or)return rr;or=1;return rr=((e,n,t,r,o,a,i,c,s,u,l,f,d,h,p,v,y,m,g,E,b,A,_,w,O,D,S,T,x,C,N,I,R,P,k,M)=>{const F=p.Account,L=v.Drive,K=y.Pad,H=T.Badge,j=globalThis;globalThis.nacl=globalThis.nacl||N.Nacl;let U={},B={};const V=a.Saferphore;var Y=a.mkEvent(!0),G=a.mkEvent(!0),J=a.mkEvent(!0);var q={drive:{hideDuplicate:!0},pad:{width:!0,spellcheck:!0},security:{unsafeLinks:!1},general:{allowUserFeedback:!0}};return{setCustomize:e=>{U=e.ApiConfig,B=e.AppConfig},create:function(p){var v=j.Cryptpad_Store={};let y=p.query||function(){},T=p.broadcast||function(){};var I=j.CryptPad_AsyncStore={modules:{}};v.onReadyEvt=Y,v.pad=K.init({Store:v,store:I,postMessage:y,broadcast:T}),v.drive=L.initAPI({Store:v,store:I,postMessage:y,broadcast:T});var R=[],P=I.sendDriveEvent=function(e,n,t){R.forEach((function(r){r!==t&&y(r,e,n)}))},W=v.getStore=function(e){if(!e)return I;try{var n=I.modules.team.getTeam(e);return n||void console.error("Team not found",e)}catch(n){return console.error(n),void console.error("Team not found",e)}},z=v.onSync=function(e,n){var t=W(e);t?M((function(e){if(t.realtime&&s.whenRealtimeSyncs(t.realtime,e()),!t.id&&t.drive?.realtime&&s.whenRealtimeSyncs(t.drive.realtime,e()),t.sharedFolders&&"object"==typeof t.sharedFolders)for(var n in t.sharedFolders)t.sharedFolders[n].realtime&&s.whenRealtimeSyncs(t.sharedFolders[n].realtime,e())})).nThen((function(){n()})):n({error:"ENOTFOUND"})};v.get=function(e,n,t){var r=W(n.teamId);r?r.proxy?t(a.find(r.proxy,n.key)):t({error:"ENODRIVE"}):t({error:"ENOTFOUND"})},v.set=function(e,n,t){var r=W(n.teamId);if(r)if(r.proxy){var o=n.key.slice(),i=o.pop(),c=a.find(r.proxy,o);c&&"object"==typeof c?(void 0===n.value?delete c[i]:c[i]=n.value,n.teamId||(T([e],"UPDATE_METADATA"),Array.isArray(o)&&"profile"===o[0]&&I.messenger&&u.updateMyData(I)),z(n.teamId,t)):t({error:"INVALID_PATH"})}else t({error:"ENODRIVE"});else t({error:"ENOTFOUND"})},v.getSharedFolder=function(e,t,r){var o,i=W(t.teamId),c=t.id;if(i&&i.manager){if(i.manager.folders[c])return(o=a.clone(i.manager.folders[c].proxy)).offline=Boolean(i.manager.folders[c].offline),void r(o);var s=a.find(i.proxy,["drive",n.SHARED_FOLDERS])||{};s[c]?v.loadSharedFolder(t.teamId,c,s[c],(function(){r(i.manager.folders[c].proxy)})):r({})}else r({error:"ENOTFOUND"})},v.restoreSharedFolder=function(e,n,t){if(n.sfId&&n.drive){var r=W(n.teamId);r.sharedFolders[n.sfId]&&(Object.keys(n.drive).forEach((function(e){r.sharedFolders[n.sfId].proxy[e]=n.drive[e]})),Object.keys(r.sharedFolders[n.sfId].proxy).forEach((function(e){n.drive[e]||delete r.sharedFolders[n.sfId].proxy[e]}))),z(n.teamId,t)}else t({error:"EINVAL"})},v.hasSigningKeys=function(){if(I.proxy)return"string"==typeof I.proxy.edPrivate&&"string"==typeof I.proxy.edPublic},v.hasCurveKeys=function(){if(I.proxy)return"string"==typeof I.proxy.curvePrivate&&"string"==typeof I.proxy.curvePublic},v.isOwned=function(e){var n=I.proxy.edPublic;if(!n)return!1;if(!Array.isArray(e)||!e.length)return!1;if(-1!==e.indexOf(n))return!0;var t=I.proxy.teams;return!!t&&Object.keys(t).some((function(n){var r=a.find(t[n],["keys","drive","edPublic"]);return r&&-1!==e.indexOf(r)}))};var Q=function(e){var n=e?I.manager.getChannelsList("expirable"):function(){var e=`${I.driveChannel}#drive`;if(!e)return null;var n=I.manager.getChannelsList("pin"),t=I.proxy.profile;if(t){var r=t.edit?o.hrefToHexChannelId("/profile/#"+t.edit,null):null;r&&n.push(r);var a=t.avatar?o.hrefToHexChannelId(t.avatar,null):null;a&&n.push(a)}if(I.proxy.todo&&n.push(o.hrefToHexChannelId("/todo/#"+I.proxy.todo,null)),I.proxy.friends){var i=u.getFriendChannelsList(I.proxy);n=n.concat(i)}if(I.proxy.mailboxes){var c=Object.keys(I.proxy.mailboxes).map((function(e){if("broadcast"!==e||I.isAdmin)return I.proxy.mailboxes[e].channel})).filter(Boolean);n=n.concat(c)}if(I.proxy.calendars){var s=Object.keys(I.proxy.calendars).map((function(e){return I.proxy.calendars[e].channel}));n=n.concat(s)}return n.push(e),I.data&&I.data.blockId&&n.push(`${I.data.blockId}#block`),n.sort(),n}();return a.deduplicateString(n).sort()};v.pinPads=function(e,n,t){if(n){var r=W(n&&n.teamId);if(r.rpc){"function"!=typeof t&&(console.error("expected a callback"),t=function(){});var o=n.pads||n;r.rpc.pin(o,(function(e){t(e?{error:e}:{})}))}else t({error:"RPC_NOT_READY"})}else t({error:"EINVAL"})},v.unpinPads=function(e,n,t){if(n){var r=W(n&&n.teamId);if(r.rpc){var o=n.pads||n;r.rpc.unpin(o,(function(e){t(e?{error:e}:{})}))}else t({error:"RPC_NOT_READY"})}else t({error:"EINVAL"})};var X=I.account={};v.getPinnedUsage=function(e,n,t){var r=W(n&&n.teamId);r&&r.rpc?r.rpc.getFileListSize((function(e,n){r.id||"number"!=typeof n||(X.usage=n),t({bytes:n})})):t({error:"RPC_NOT_READY"})},v.getPinLimit=function(e,n,t){var r=W(n&&n.teamId);r.rpc?r.rpc.getLimit((function(e,n,o,a){if(e)t({error:e});else{var i=r.id?{}:X;i.limit=n,i.plan=o,i.note=a,t(i)}})):t({error:"RPC_NOT_READY"})};v.uploadComplete=function(e,n,t){var r=W(n.teamId);r?r.rpc?n.owned?r.rpc.ownedUploadComplete(n.id,(function(e,n){t(e?{error:e}:n)})):r.rpc.uploadComplete(n.id,(function(e,n){t(e?{error:e}:n)})):t({error:"RPC_NOT_READY"}):t({error:"ENOTFOUND"})},v.uploadStatus=function(e,n,t){var r=W(n.teamId);r?r.rpc?r.rpc.uploadStatus(n.size,(function(e,n){t(e?{error:e}:n)})):t({error:"RPC_NOT_READY"}):t({error:"ENOTFOUND"})},v.uploadCancel=function(e,n,t){var r=W(n.teamId);r?r.rpc?r.rpc.uploadCancel(n.size,(function(e,n){t(e?{error:e}:n)})):t({error:"RPC_NOT_READY"}):t({error:"ENOTFOUND"})},v.uploadChunk=function(e,n,t){var r=W(n.teamId);r?r.rpc?r.rpc.send.unauthenticated("UPLOAD",n.chunk,(function(e,n){t({error:e,msg:n})})):t({error:"RPC_NOT_READY"}):t({error:"ENOTFOUND"})};v.anonRpcMsg=function(e,n,t){I.anon_rpc?I.anon_rpc.send(n.msg,n.data,(function(e,n){t(e?{error:e}:n)})):t({error:"ANON_RPC_NOT_READY"})},v.getFileSize=function(e,n,t){var r=a.once(a.mkAsync(t));if(I.anon_rpc){var i=n.channel||o.hrefToHexChannelId(n.href,n.password);I.anon_rpc.send("GET_FILE_SIZE",i,(function(e,n){if(!e)return n&&n.length&&"number"==typeof n[0]?(0===n[0]&&d.clearChannel(i),void r({size:n[0]})):void r({error:"INVALID_RESPONSE"});r({error:e})}))}else r({error:"ANON_RPC_NOT_READY"})},v.isNewChannel=function(e,n,t){if(I.anon_rpc){var r=n.channel||o.hrefToHexChannelId(n.href,n.password);I.anon_rpc.send("IS_NEW_CHANNEL",r,(function(e,n){if(!e)return n&&n.length&&"object"==typeof n[0]?(n[0].isNew&&d.clearChannel(r),void t(n[0])):void t({error:"INVALID_RESPONSE"});t({error:e})}))}else t({error:"ANON_RPC_NOT_READY"})},v.getMultipleFileSize=function(e,n,t){I.anon_rpc?Array.isArray(n.files)?I.anon_rpc.send("GET_MULTIPLE_FILE_SIZE",n.files,(function(e,n){e?t({error:e}):n&&n.length&&"object"==typeof n[0]?t({size:n[0]}):t({error:"UNEXPECTED_RESPONSE"})})):t({error:"INVALID_FILE_LIST"}):t({error:"ANON_RPC_NOT_READY"})},v.getDeletedPads=function(e,n,t){if(I.anon_rpc){var r=n&&n.list||Q(!0);Array.isArray(r)?I.anon_rpc.send("GET_DELETED_PADS",r,(function(e,n){e?t({error:e}):n&&n.length&&Array.isArray(n[0])?t(n[0]):t({error:"UNEXPECTED_RESPONSE"})})):t({error:"INVALID_FILE_LIST"})}else t({error:"ANON_RPC_NOT_READY"})};var Z=function(e,n,t){I.anon_rpc?t():f.createAnonymous(I.network,(function(e,n){e?t({error:e}):(I.anon_rpc=n,t())}))},$=v.getAllStores=function(){if(!I.proxy||!I.manager)return[];var e=[I],n=I.modules.team;if(n){var t=n.getTeams().map((function(e){return n.getTeam(e)}));Array.prototype.push.apply(e,t)}return e};v.getUserColor=function(){var e=a.find(I,["proxy","settings","general","cursor","color"]);return e||(e=a.getRandomColor(!0),v.setAttribute(null,{attr:["general","cursor","color"],value:e},(function(){}))),e},v.getMetadata=function(e,n,t){var r=I.proxy||{},c=a.find(r,["settings","general","disableThumbnails"]),s=I.modules.team&&I.modules.team.getTeamsData(n)||{};r.uid||(I.noDriveUid=I.noDriveUid||o.createChannelId());var u={user:{name:r[i.displayNameKey]||I.noDriveName||"",uid:r.uid||I.noDriveUid,avatar:a.find(r,["profile","avatar"]),profile:a.find(r,["profile","view"]),color:v.getUserColor(),notifications:a.find(r,["mailboxes","notifications","channel"]),curvePublic:r.curvePublic,edPublic:r.edPublic,netfluxId:I?.network?.webChannels?.[0]?.myID,badge:a.find(r,["profile","badge"])},priv:{clientId:e,edPublic:r.edPublic,edPrivate:r.edPrivate,friends:r.friends||{},settings:r.settings||q,thumbnails:!1===c,isDriveOwned:Boolean(a.find(I,["driveMetadata","owners"])),driveChannel:I.driveChannel,pendingFriends:r.friends_pending||{},supportPrivateKey:a.find(r,["mailboxes","supportadmin","keys","curvePrivate"]),accountName:r.login_name||"",offline:I.proxy&&I.offline,teams:s,plan:I.ready?X.plan||"":void 0,mutedChannels:r.mutedChannels}};return t(JSON.parse(JSON.stringify(u))),u},v.onMaintenanceUpdate=function(){let e=U.httpUnsafeOrigin;a.fetchApi(e,"broadcast",!0,(e=>{e&&T([],"UNIVERSAL_EVENT",{type:"broadcast",data:{ev:"MAINTENANCE",data:e.maintenance}})}))},v.onSurveyUpdate=function(){let e=U.httpUnsafeOrigin;a.fetchApi(e,"broadcast",!0,(e=>{T([],"UNIVERSAL_EVENT",{type:"broadcast",data:{ev:"SURVEY",data:e.surveyURL}})}))};v.addPad=function(e,t,r){if(t.href||t.roHref){var a;if(!t.roHref){var i=o.parsePadUrl(t.href);"pad"===i.hashData.type&&(a=o.getSecrets(i.type,i.hash,t.password),t.roHref="/"+i.type+"/#"+o.getViewHashFromKeys(a))}var c,s,u,l,f=(c=t.href,s=t.roHref,u=t.title,l=+new Date,{href:c,roHref:s,atime:l,ctime:l,title:u||n.getDefaultName(o.parsePadUrl(c))});t.owners&&(f.owners=t.owners),t.expire&&(f.expire=t.expire),t.password&&(f.password=t.password),(t.channel||a)&&(f.channel=t.channel||a.channel),t.readme&&(f.readme=1),Object.keys(t.attributes||{}).forEach((e=>{t.attributes[e]&&(f[e]=t.attributes[e])})),-1===t.teamId&&(t.teamId=void 0);var d=W(t.teamId);d&&d.manager?d.manager.addPad(t.path,f,(function(o){o?r({error:o}):($().forEach((function(t){(t.id?t.sendEvent:P)("DRIVE_CHANGE",{path:["drive",n.FILES_DATA]},e)})),z(t.teamId,r))})):r({error:"ENOTFOUND"})}else r({error:"NO_HREF"})};var ee=function(e,n){var t=a.find(I,["proxy","edPublic"]),r=function(e){var n=[];return e?(I.proxy.todo&&n.push(o.hrefToHexChannelId("/todo/#"+I.proxy.todo,null)),I.proxy.profile&&I.proxy.profile.edit&&n.push(o.hrefToHexChannelId("/profile/#"+I.proxy.profile.edit,null)),I.proxy.mailboxes&&Object.keys(I.proxy.mailboxes||{}).forEach((function(e){if("supportadmin"!==e){var t=I.proxy.mailboxes[e];n.push(t.channel)}}))):n=I.manager.getChannelsList("owned"),n.filter((function(e){if("string"==typeof e)return-1!==[32,48].indexOf(e.length)}))}(e),i=V.create(10),c=function(n){e||I.manager.findChannel(n).forEach((function(e){var n=I.manager.findFile(e.id);I.manager.delete({paths:n})}))};r.forEach((function(e){var r=n();i.take((function(n){var o=!1;M((function(a){32===e.length&&v.anonRpcMsg(null,{msg:"GET_METADATA",data:e},a((function(i){if(i&&i.error)return n(),r(),void a.abort();var s=i[0];return Object.keys(s||{}).length?s&&Array.isArray(s.owners)&&-1!==s.owners.indexOf(t)?void(o=s.owners.some((function(e){return e!==t}))):(n(),r(),void a.abort()):(c(e),n(),r(),void a.abort())})))})).nThen((function(n){o?v.pad.setMetadata(null,{channel:e,command:"RM_OWNERS",value:[t]},n()):I.rpc.removeOwnedChannel(e,n((function(n){n?console.error(n):c(e)})))})).nThen((function(){n(),r()}))}))}))};v.removeOwnedPads=function(e,n,t){I.proxy.edPublic?M((function(e){ee(!1,e)})).nThen(t):t({error:"NOT_LOGGED_IN"})},v.deleteAccount=function(n,t,r){var o=I.proxy.edPublic,c=t&&t.keys,s=t&&t.auth;v.anonRpcMsg(n,{msg:"GET_METADATA",data:I.driveChannel},(function(t){var u=t[0];if(u&&u.owners&&1===u.owners.length&&-1!==u.owners.indexOf(o))M((function(e){x.checkRights({auth:s,blockKeys:c},e((function(n){if(n)return e.abort(),console.error(n),void r({error:"INVALID_CODE"})})))})).nThen((function(e){globalThis.accountDeletion=n,I.proxy[i.tokenKey]="DELETED",z(null,e())})).nThen((function(e){I.rpc.removePins(e((function(e){e&&console.error(e)})))})).nThen((function(e){I.ownDeletion=!0,v.pad.destroy(n,{channel:I.driveChannel,force:!0},e())})).nThen((function(e){c&&x.removeLoginBlock({reason:"ARCHIVE_OWNED",auth:s,edPublic:o,blockKeys:c},e((function(e){e&&console.error(e)})))})).nThen((function(e){ee(!0,e)})).nThen((function(){T([n],"DRIVE_DELETED","ARCHIVE_OWNED"),y(n,"DELETE_ACCOUNT","DELETED",(function(){})),I.network.disconnect(),r({state:!0})}));else{var l={intent:"Please delete my account."};l.drive=I.driveChannel,l.edPublic=o;var f=a.decodeBase64(I.proxy.edPrivate),d=N.CryptoAgility.signDetached(a.decodeUTF8(e(l)),f);N.CryptoAgility.verifyDetached(a.decodeUTF8(e(l)),d,a.decodeBase64(o))||console.error("signed message failed verification");var h=a.encodeBase64(d);r({proof:h,toSign:JSON.parse(e(l))})}}))},v.setDisplayName=function(e,n,t){if(!I.proxy)return I.noDriveName=n,T([e],"UPDATE_METADATA"),void t();I.modules.profile&&I.modules.profile.setName(n),I.proxy[i.displayNameKey]=n,T([e],"UPDATE_METADATA"),u.updateMyData(I),z(null,t)},v.resetDrive=function(e,n,t){M((function(e){ee(e)})).nThen((function(){I.proxy.drive=I.userObject.getStructure(),P("DRIVE_CHANGE",{path:["drive","filesData"]},e),z(null,t)}))},v.setPadAttribute=function(e,t,r){M((function(r){$().forEach((function(o){o.manager.setPadAttribute(t,r((function(){(o.id?o.sendEvent:P)("DRIVE_CHANGE",{path:["drive",n.FILES_DATA]},e),z(o.id,r())})))}))})).nThen(r)},v.getPadAttribute=function(e,n,t){var r={};M((function(e){$().forEach((function(t){t.manager.getPadAttribute(n,e((function(e,n){e||(n&&"object"==typeof n?(!r.value||r.atime<n.atime)&&(r.atime=n.atime,r.value=n.value):console.error("Not an object!"))})))}))})).nThen((function(){t(r.value)}))};var ne=function(e){if("string"==typeof e)return console.error("DEPRECATED: use setAttribute with an array, not a string"),{path:["settings"],obj:I.proxy.settings,key:e};if(Array.isArray(e)){if(0!==e.length){var n=I.proxy.settings;return e.forEach((function(t,r){if(r!==e.length-1){if(n[t]){if("object"!=typeof n[t])return void console.error("Wrong attribute")}else n[t]={};n=n[t]}})),{path:["settings"].concat(e),obj:n,key:e[e.length-1]}}console.error("Attribute can't be empty")}else console.error("Attribute must be string or array")};v.setAttribute=function(e,n,t){try{var r=ne(n.attr);r.obj[r.key]=n.value}catch(e){return void t({error:e})}z(null,(function(){t(),T([],"UPDATE_METADATA")}))},v.getAttribute=function(e,n,t){var r;try{r=ne(n.attr)}catch(e){return void t({error:e})}t(r.obj[r.key])},v.listAllTags=function(e,n,t){var r={};$().forEach((function(e){var n=e.manager.getTagsList();Object.keys(n).forEach((function(e){r[e]=(r[e]||0)+n[e]}))})),t(r)},v.getTemplates=function(e,n,t){var r=[],o=[];$().forEach((function(e){e.userObject.getFiles(["template"]).forEach((function(n){var t=e.userObject.getFileData(n);-1===o.indexOf(t.channel)&&(o.push(t.channel),r.push(JSON.parse(JSON.stringify(t))))}))})),t(r)},v.incrementTemplateUse=function(e,n){$().forEach((function(e){e.userObject.getPadAttribute(n,"used",(function(t,r){if(!t){var o="number"==typeof r?++r:1;e.userObject.setPadAttribute(n,"used",o)}}))}))},v.isOnlyInSharedFolder=function(e,n,t){var r=!1,o=function(e){return!e.fId};return $().some((function(e){var t=e.manager.findChannel(n);if(t.length)return t.some(o)?(r=!1,!0):void(r=!0)})),t(r)},v.moveToTrash=function(e,t,r){var a=o.getRelativeHref(t.href),i=!0;M((function(t){$().forEach((function(r){r.userObject.forget(a)&&(i=!1,(r.id?r.sendEvent:P)("DRIVE_CHANGE",{path:["drive",n.FILES_DATA]},e),z(r.id,t()))}))})).nThen((function(){r({error:i?"FORBIDDEN":void 0})}))},v.setPadTitle=function(e,t,r){Y.reg((function(){var i=t.title,s=t.href,u=t.channel,l=o.parsePadUrl(s),f=l.hashData;if(""===i.trim()&&(i=n.getDefaultName(l)),!B.disableAnonymousStore||I.loggedIn)if("debug"!==l.type){var d,h,p=v.pad.getChannels()[u];p&&p.wc&&u===p.wc.id&&(d=p.data.owners||void 0),t.owners&&(d=t.owners),p&&p.wc&&u===p.wc.id&&(h=+p.data.expire||void 0),t.expire&&(h=t.expire),t.teamId&&(t.teamId=Number(t.teamId));var m,g,E=[],b=[];$().forEach((function(e){if("edit"!==f.mode||!e.id||e.secondaryKey){var n=e.manager.findChannel(u,!0);n.length&&b.push(e.id),(e.id||t.teamId&&-1!==t.teamId)&&Number(e.id)!==t.teamId||m||(m=n.length),e.id||(g=n.length),Array.prototype.push.apply(E,n)}}));var A=0!==E.length;if(!I.offline||A)if(I.offline)r();else{if(E.forEach((function(e){var n=e.data;n.atime=+new Date,n.title=i,(d||"file"!==f.type)&&(n.owners=d),n.expire=h,n.readme&&(delete n.readme,c.send("OPEN_README")),"view"!==f.mode&&(n.href||e.userObject.restoreHref(s),e.userObject.setHref(u,null,s))})),!A||t.forceSave&&!m){var _,w=a.find(I.proxy,["settings","general","autostore"]);return 1===w||t.forceSave||t.path?("view"===f.mode&&(_=s,s=void 0),v.addPad(e,{teamId:t.teamId,href:s,roHref:_,channel:u,title:i,owners:d,expire:h,password:t.password,path:t.path,attributes:t.attributes},r),void y(e,"AUTOSTORE_DISPLAY_POPUP",{stored:!0,inMyDrive:g||!A&&!t.teamId})):(y(e,"AUTOSTORE_DISPLAY_POPUP",{autoStore:w}),void r({notStored:!0}))}b.forEach((function(t){(t?W(t).sendEvent:P)("DRIVE_CHANGE",{path:["drive",n.FILES_DATA]},e)})),y(e,"AUTOSTORE_DISPLAY_POPUP",{stored:!0,inMyDrive:g}),M((function(e){b.forEach((function(n){z(n,e())}))})).nThen(r)}else r({error:"OFFLINE"})}else r({notStored:!0});else r({notStored:!0})}))},v.getSecureFilesList=function(e,n,t){var r={},a=n.types,i=n.where,c=n.filter||{},s=[];$().forEach((function(e){e.manager.getSecureFilesList(i).forEach((function(e){var n=e.data;if(-1===s.indexOf(n.channel||n.id)){var t=e.id;if(n.channel&&s.push(n.channel||n.id),n.static)-1!==a.indexOf("link")&&(r[t]=n);else{var i=o.parsePadUrl(n.href||n.roHref);a&&0!==a.length&&-1===a.indexOf(i.type)||function(e,n){var t,r=c.fileType||[];if("file"===e&&r.length){if(!n.fileType)return!0;t=!r.some((function(e){return 0===n.fileType.indexOf(e)}))}return t}(i.type,n)||(r[t]=n)}}}))})),t(r)},v.getPadData=function(e,n,t){var r={};$().some((function(e){var t=e.userObject.getFileData(n);if(t.roHref||t.href)return r=t,!0})),t(r)},v.getPadDataFromChannel=function(e,n,t){var r,o,a=n.channel,i=n.edit,c=n.file;$().some((function(e){var n=e.manager.findChannel(a);if(Array.isArray(n))return n.some((function(e){if(e&&e.data){var n=e.data;if(i&&n.href||!i&&n.roHref||c)return r=n,!0;i&&!o&&n.roHref&&(o=n)}}))}));var s=r||o;s||!I.offline?t(s||{}):Y.reg((function(){v.getPadDataFromChannel(e,n,t)}))},v.checkDeletedPad=function(e,n){e&&v.getPadDataFromChannel(null,{channel:e,isFile:!0},(function(t){"function"==typeof n&&setTimeout(n),Object.keys(t).length||T([],"CHANNEL_DELETED",e)}))},v.answerFriendRequest=function(e,n,t){var r=n.value,o=n.data;if("notifications"===o.type){var a=o.content.hash,i=o.content.msg,c=function(e){e=e||function(){},I.mailbox.dismiss({hash:a,type:"notifications"},e)};r?u.acceptFriendRequest(I,i.content.user,(function(e){e&&e.error?t(e):u.addToFriendList({proxy:I.proxy,realtime:I.realtime,pinPads:function(e,n){v.pinPads(null,e,n)}},i.content.user,(function(e){I.messenger&&I.messenger.onFriendAdded(i.content.user),T([],"UPDATE_METADATA"),e?t({error:e}):c(t)}))})):(u.declineFriendRequest(I,i.content.user,(function(e){T([],"UPDATE_METADATA"),t(e)})),c())}else t({error:"EINVAL"})},v.sendFriendRequest=function(e,n,t){u.getFriend(I.proxy,n.curvePublic)?t({error:"ALREADY_FRIEND"}):n.notifications&&n.curvePublic?(I.proxy.friends_pending=I.proxy.friends_pending||{},I.proxy.friends_pending[n.curvePublic]?t({error:"ALREADY_SENT"}):(I.proxy.friends_pending[n.curvePublic]={time:+new Date,channel:n.notifications,curvePublic:n.curvePublic},T([],"UPDATE_METADATA"),I.mailbox.sendTo("FRIEND_REQUEST",{user:u.createData(I.proxy)},{channel:n.notifications,curvePublic:n.curvePublic},(function(e){t(e)})))):t({error:"INVALID_USER"})},v.cancelFriendRequest=function(e,n){if(e.curvePublic&&e.notifications){var t=I.proxy;if(u.getFriend(t,e.curvePublic))return console.error("You can't cancel an accepted friend request"),void n({error:"ALREADY_FRIEND"});a.find(I,["proxy","friends_pending"])||{}?I.mailbox.sendTo("CANCEL_FRIEND_REQUEST",{user:u.createData(I.proxy)},{channel:e.notifications,curvePublic:e.curvePublic},(function(t){t&&t.error?n(t):(delete I.proxy.friends_pending[e.curvePublic],T([],"UPDATE_METADATA"),z(null,(function(){n(t)})))})):n()}else n({error:"EINVAL"})},v.anonGetPreviewContent=function(e,n,t){w.anonGetPreviewContent({store:I},n,t)},v.getStrongerHash=function(e,n,t){var r=a.once(t);$().some((function(e){var t=e.manager.getEditHash(n.channel);if(t)return r(t),!0}))||r()},v.universal={execCommand:function(e,n,t){var r=function(){var r=n.type,o=n.data;I.modules[r]?I.modules[r].execCommand(e,o,t):t({error:r+" is disabled"})};-1===["team","calendar"].indexOf(n.type)&&I.proxy?Y.reg(r):r()}};var te=function(e,n,t,r){I.modules[n]||(I.modules[n]=e.init({Store:v,store:I,updateLoadingProgress:function(e){e.type="team",y(r,"LOADING_DRIVE",e)},updateMetadata:function(){T([],"UPDATE_METADATA")},pinPads:function(e,n){v.pinPads(null,e,n)},unpinPads:function(e,n){v.unpinPads(null,e,n)}},t,(function(e,t,r){r.forEach((function(r){y(r,"UNIVERSAL_EVENT",{type:n,data:{ev:e,data:t}})}))})))};v.onlyoffice={execCommand:function(e,n,t){I.onlyoffice?I.onlyoffice.execCommand(e,n,t):t({error:"OnlyOffice is disabled"})}},v.mailbox={execCommand:function(e,n,t){Y.reg((function(){I.mailbox?I.mailbox.execCommand(e,n,t):t({error:"Mailbox is disabled"})}))}},v.adminRpc=function(e,n,t){I.rpc.adminRpc(n,(function(e,n){t(e?{error:e}:n)}))},v.addAdminMailbox=function(e,n,t){var r=n&&n.priv,a=o.getBoxPublicFromSecret(r),i=n&&2===n.version;if(r&&a){var c=o.getChannelIdFromKey(a),s=i?"supportteam":"supportadmin",u=(I.proxy.mailboxes=I.proxy.mailboxes||{})[s]={channel:c,viewed:[],lastKnownHash:n.lastKnownHash||"",keys:{curvePublic:a,curvePrivate:r}};v.pinPads(null,[c],(function(){})),I.mailbox.open(s,u,(function(){console.log("ready")})),z(null,t)}else t({error:"EINVAL"})},v.getSnapshot=function(e,n,t){v.getHistoryRange(e,{cpCount:1,channel:n.channel,lastKnownHash:n.hash},t)},v.onRejected=function(e,n){var t=a.once(a.mkAsync(n));Array.isArray(e)?(J.fire(),Y.reg((()=>{if(I.loggedIn&&I.proxy.edPublic){var n,r=I.modules.team,o=r&&r.getTeams()||[];-1!==e.indexOf(I.proxy.edPublic)?n=I:o.some((function(t){var o=a.find(I,["proxy","teams",t,"keys","drive","edPublic"]),i=a.find(I,["proxy","teams",t,"keys","drive","edPrivate"]);if(-1===e.indexOf(o))return!1;if(!i)return!1;var c=r.getTeam(t);return n=c,!0}));var i=function(){if(n){var e=n.rpc;e?e.send("COOKIE","",(function(e){t(e)})):t("ERESTRICTED")}else t("ERESTRICTED")};n&&n.onRpcReadyEvt?n.onRpcReadyEvt.reg((function(){i()})):i()}else t("ERESTRICTED")}))):t("ERESTRICTED")},v.changePadPasswordPin=function(e,n,t){var r=n.oldChannel,o=n.channel;M((function(e){$().forEach((function(n){n.manager.findChannel(o).length&&(n.rpc.unpin([r],e()),n.rpc.pin([o],e()))}))})).nThen(t)},v.contactPadOwner=function(e,n,t){var r=n.owners;if(!Array.isArray(r)||!r.length)return t({state:!1});n.send?M((function(e){r.forEach((function(t){!function(e,t,r,o){if(I.mailbox&&!n.anon)return I.mailbox.sendTo(e,t,r,o);A.sendToAnon(I.anon_rpc,e,t,r,o)}(n.query,{channel:n.channel,data:n.msgData},{channel:t.notifications,curvePublic:t.curvePublic},e())}))})).nThen((function(){t({state:!0})})):t({state:!0})},v.givePadAccess=function(e,n,t){var r,o,a=I.proxy.edPublic,i=n.channel,c=I.manager.findChannel(i);n.user&&n.user.notifications&&n.user.curvePublic?c.some((function(e){if(e.data&&Array.isArray(e.data.owners)&&-1!==e.data.owners.indexOf(a)&&e.data.href)return r=e.data.href,o=e.data.title,!0}))?(I.mailbox.sendTo("GIVE_PAD_ACCESS",{channel:i,href:r,title:o},{channel:n.user.notifications,curvePublic:n.user.curvePublic}),t()):t({error:"ENOTFOUND"}):t({error:"EINVAL"})};v.burnPad=function(e,n){var t=n.channel,r=N.b64AddSlashes(n.ownerKey||"");if(t&&r)try{var a=o.decodeBase64(r),i=N.CryptoAgility.signKeyPairFromSecretKey(a);l.create(I.network,{edPublic:o.encodeBase64(i.publicKey),edPrivate:o.encodeBase64(i.secretKey)},(function(e,r){e?console.error(e):v.pad.getMetadata(null,{channel:t},(function(e){r.removeOwnedChannel(t,(function(t){t?console.error(t):function(e,n){var t=e.channel,r=e.href,a=o.parsePadUrl(r),i=o.getSecrets(a.type,a.hash,e.password);if((!n||!n.error)&&n.mailbox){var c,s=N.createEncryptor(i.keys),u=[];try{"string"==typeof n.mailbox?u.push(s.decrypt(n.mailbox,!0,!0)):Object.keys(n.mailbox).forEach((function(e){u.push(s.decrypt(n.mailbox[e],!0,!0))}))}catch(e){console.error(e)}try{c=I.proxy.curvePublic}catch(e){return void console.error(e)}u.forEach((function(e){var n=JSON.parse(e);n.curvePublic!==c&&I.mailbox.sendTo("OWNED_PAD_REMOVED",{channel:t},{channel:n.notifications,curvePublic:n.curvePublic},(function(){}))}))}}(n,e)}))}))}))}catch(e){console.error(e)}else console.error("Can't delete BAR pad")},v.deleteMailboxMessage=function(e,n,t){I.anon_rpc?I.anon_rpc.send("DELETE_MAILBOX_MESSAGE",n,(function(e){t({error:e})})):t({error:"RPC_NOT_READY"})},v.getFullHistory=function(e,n,t){var r=I.network,o=r.historyKeeper,a=[],i=!1,c=function(e){if(!i){var o=function(e){try{return JSON.parse(e)}catch(e){return null}}(e);if(o)return"FULL_HISTORY_END"===o[0]?(t(a),r.off("message",c),void(i=!0)):void("FULL_HISTORY"===o[0]&&(o[1]&&o[1].validateKey||o[1][3]===n.channel&&(e=o[1][4])&&(e=e.replace(/cp\|(([A-Za-z0-9+\/=]+)\|)?/,""),n.debug?a.push({serverHash:e.slice(0,64),msg:e,author:o[1][1],time:o[1][5]}):a.push(e))))}};r.on("message",c),r.sendto(o,JSON.stringify(["GET_FULL_HISTORY",n.channel,n.validateKey]))},v.getHistory=function(e,n,t,r){var o=a.once(a.mkAsync(t)),i=I.network,c=i.historyKeeper,s=Math.floor(1e6*Math.random()),u=[],l=!1,f=function(e,t){if(!l&&t===c){var a=function(e){try{return JSON.parse(e)}catch(e){return null}}(e);if(a&&!(a.txid&&a.txid!==s||a.validateKey&&a.channel))if(a.error&&a.channel)a.channel===n.channel&&(i.off("message",f),l=!0,o({error:a.error}));else{if(1===a.state&&a.channel){if(a.channel!==n.channel)return;return o(u),i.off("message",f),void(l=!0)}Array.isArray(a)&&a[0]&&a[0]!==s||a[3]===n.channel&&(a[4]&&r?u.push({msg:e,hash:a[4].slice(0,64)}):(e=a[4])&&(e=e.replace(/cp\|(([A-Za-z0-9+\/=]+)\|)?/,""),u.push(e)))}}};i.on("message",f);var d={txid:s,lastKnownHash:n.lastKnownHash},h=["GET_HISTORY",n.channel,d];i.sendto(c,JSON.stringify(h))},v.getHistoryRange=function(e,n,t){var r,o=I.network,i=o.historyKeeper,c=[],s=!0,u=!1,l=!1,f=a.uid();o.on("message",(function(e){if(!l){var o=function(e){try{return JSON.parse(e)}catch(e){return null}}(e);if(o[1]===f){if("HISTORY_RANGE_ERROR"===o[0]){let e=o[2];return"ENOENT"===e?.code?(l=!0,void t({messages:c,isFull:!0})):void t({error:o[2]})}if("HISTORY_RANGE_END"===o[0])return t({messages:c,isFull:u,lastKnownHash:r}),void(l=!0);"HISTORY_RANGE"===o[0]&&(o[2]&&o[1].validateKey||o[2][3]===n.channel&&(e=o[2][4])&&(s&&(/^cp\|/.test(e)||n.toHash||(u=!0),r=e.slice(0,64),s=!1),e=e.replace(/cp\|(([A-Za-z0-9+\/=]+)\|)?/,""),c.push({serverHash:e.slice(0,64),msg:e,author:o[2][1],time:o[2][5]})))}else console.log("bad txid")}})),o.sendto(i,JSON.stringify(["GET_HISTORY_RANGE",n.channel,{from:n.lastKnownHash,to:n.toHash,cpCount:n.cpCount||2,txid:f}]))};var re=function(e,t){e&&(e.deprecated||e.restricted||(t||e.on("change",["drive",n.SHARED_FOLDERS],(function(t,r,a){if(a.length>3&&"password"===a[3]){var i=a[2],c=e.drive[n.SHARED_FOLDERS][i],s=I.manager.user.userObject.getHref?I.manager.user.userObject.getHref(c):c.href,u=o.parsePadUrl(s),l=o.getSecrets(u.type,u.hash,t);return h.updatePassword(v,{oldChannel:l.channel,password:r,href:s},I.network,(function(){console.log("Shared folder password changed")})),!1}})),e.on("change",[],(function(e,r,o){if(t){if(o[0]===n.FILES_DATA&&"object"==typeof r&&r.channel&&!r.owners){var a=[r.channel];r.rtChannel&&a.push(r.rtChannel),r.lastVersion&&a.push(r.lastVersion),v.pinPads(null,a,(function(e){console.error(e)}))}if(o[0]===n.FILES_DATA&&"object"==typeof e&&e.channel&&!r){var i=[e.channel];I.manager.findChannel(e.channel).some((function(e){return e.fId!==t}))||(e.rtChannel&&i.push(e.rtChannel),e.lastVersion&&i.push(e.lastVersion),v.unpinPads(null,i,(function(e){console.error(e)})))}}e&&!r&&Array.isArray(o)&&(o[0]===n.FILES_DATA||"drive"===o[0]&&o[1]===n.FILES_DATA)&&setTimeout((function(){v.checkDeletedPad(e&&e.channel)})),P("DRIVE_CHANGE",{id:t,old:e,new:r,path:o})})),e.on("remove",[],(function(e,n){P("DRIVE_REMOVE",{id:t,old:e,path:n})}))))};v.loadSharedFolder=function(e,n,t,r,a){var i=W(e);if(i){var c=o.parsePadUrl(t.href||t.roHref);c||c.hashData?h.load({isNew:a,network:I.network||I.networkPromise,store:i,Store:v,isNewChannel:v.isNewChannel},n,t,r):r({error:"EINVAL"})}else r({error:"ENOTFOUND"})};var oe=function(e,n,t,r){v.loadSharedFolder(null,e,n,t,r)};v.loadSharedFolderAnon=function(e,n,t){v.loadSharedFolder(null,n.id,n.data,(function(e){t({error:e?void 0:"EDELETED"})}))},v.addSharedFolder=function(e,t,r){Y.reg((function(){var o=W(t.teamId);o.manager.addSharedFolder(t,(function(a){a&&"object"==typeof a&&a.error?r(a):((t.teamId?o.sendEvent:P)("DRIVE_CHANGE",{path:["drive",n.FILES_DATA]},e),r(a))}))}))},v.updateSharedFolderPassword=function(e,n,t){h.updatePassword(v,n,I.network,t)},v.userObjectCommand=function(e,t,r){if(t&&t.cmd){var o=W(t.teamId);if(o.offline)return(o.id?o.sendEvent:P)("NETWORK_DISCONNECT"),void r({error:"OFFLINE"});o.manager.command(t,(function(o){$().forEach((function(t){(t.id?t.sendEvent:P)("DRIVE_CHANGE",{path:["drive",n.FILES_DATA]},e)})),z(t.teamId,(function(){r(o)}))}))}},v._removeClient=function(e){var n=R.indexOf(e);-1!==n&&R.splice(n,1),I.onlyoffice?.removeClient?.(e),I.mailbox?.removeClient?.(e),Object.keys(I.modules).forEach((function(n){I.modules[n]?.removeClient?.(e)})),v.pad?.removeClient?.(e)};v.refreshDriveUI=function(){$().forEach((function(e){(e.id?e.sendEvent:P)("DRIVE_CHANGE",{path:["drive",n.FILES_DATA]})}))};var ae=function(e,n){const r=a.mkAsync(n);var o=I.proxy,i=I.drive;if(I.manager)r();else{var c=I.manager=t.create(i.proxy,{onSync:function(e){z(null,e)},edPublic:o.edPublic,pin:function(e,n){I.loggedIn?v.pinPads(null,e,n):n()},unpin:function(e,n){I.loggedIn?v.unpinPads(null,e,n):n()},loadSharedFolder:oe,settings:o.settings,removeOwnedChannel:function(e,n){v.pad.destroy("",e,n)},store:I,Store:v},{outer:!0,edPublic:I.proxy.edPublic,loggedIn:I.loggedIn,log:function(e){P("DRIVE_LOG",e)},rt:i.realtime}),s=I.userObject=c.user.userObject;M((function(e){I.sharedFolders={},I.handleSharedFolder=function(e,n){n?(I.sharedFolders[e]=n,I.driveEvents&&re(n.proxy,e)):delete I.sharedFolders[e]},s.migrate(e())})).nThen((function(n){var t=I.network||I.networkPromise;h.loadSharedFolders(v,t,I,i.proxy,s,n,(n=>{var t={type:"sf",progress:100*n.progress/n.max};y(e,"LOADING_DRIVE",t)}),!0)})).nThen((function(n){te(w,"team",n,e)})).nThen((function(e){te(S,"calendar",e)})).nThen((function(){r()}))}};const ie=(e=function(){})=>{te(m,"cursor",e),te(E,"integration",e),te(O,"messenger",e),te(D,"history",e),te(H,"badge",e),I.onlyoffice||(I.onlyoffice=b.init(I,(function(e,n,t){t.forEach((function(t){y(t,"OO_EVENT",{ev:e,data:n})}))}))),I&&(I.messenger=I.modules.messenger)},ce=(e,n,t)=>{const r=a.mkAsync(t);ae(e,(function(){G.fire(),r(n)}))};var se=function(e,n,t){I.ready=!0;var s=I.proxy,u=I.manager,f=I.userObject;M((function(t){s.settings||(s.settings=q),s.forms||(s.forms={}),s.friends_pending||(s.friends_pending={}),s.form_seed||(s.form_seed=o.createChannelId()),u||(ce(e,n,t()),u=I.manager,f=I.userObject),Z(0,0,t()),function(e,n,t){if(!I.loggedIn)return t();I.rpc?t(X):l.create(I.network,I.proxy,(function(e,n){e?t({error:e}):(I.rpc=n,I.onRpcReadyEvt.fire(),v.getPinLimit(null,null,(function(e){e.error&&console.error(e.error),X.limit=e.limit,X.plan=e.plan,X.note=e.note,t(e)})))}),d)}(0,0,t()),y(e,"LOADING_DRIVE",{type:"migrate",progress:0})})).nThen((function(n){void 0===s.version&&(s.version=11),r(s,n(),(function(n,t){y(e,"LOADING_DRIVE",{type:"migrate",progress:t})}),I)})).nThen((function(n){y(e,"LOADING_DRIVE",{type:"sf",progress:0}),f.fixFiles(),h.loadSharedFolders(v,I.network,I,I.drive.proxy,f,n,(n=>{var t={type:"sf",progress:100*n.progress/n.max};y(e,"LOADING_DRIVE",t)})),ie(n),te(_,"profile",n),te(S,"calendar",n),te(g,"support",n),M((e=>{I.modules.team&&I.modules.team.onReady(e)}))})).nThen((function(){var e,r=function(){T([],"REQUEST_LOGIN")};I.loggedIn&&(function(e){if(I.rpc){var n=Q(!1),t=o.hashChannelList(n);I.rpc.getServerHash((function(n,r){n?e(n):e(null,r===t)}))}else e({error:"RPC_NOT_READY"})}((function(e,n){n||function(e){if(I.rpc){var n=Q(!1);I.rpc.reset(n,(function(n){e(n||null)}))}else e({error:"RPC_NOT_READY"})}((function(e){if(e)return console.error(e);console.log("RESET DONE")}))})),"number"!=typeof s.loginToken&&(s[i.tokenKey]=I.data.localToken||Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)),n[i.tokenKey]=s[i.tokenKey],I.data.localToken&&I.data.localToken!==s[i.tokenKey])?r():(n.feedback=a.find(s,["settings","general","allowUserFeedback"]),c.init(n.feedback),I.returned=n,"function"==typeof t&&t(n),I.offline=!1,P("NETWORK_RECONNECT"),T([],"UPDATE_METADATA"),T([],"STORE_READY",n),"string"==typeof s.uid&&32===s.uid.length||(console.log("generating a persistent identifier"),s.uid=o.createChannelId()),!I.loggedIn||v.hasSigningKeys()&&v.hasCurveKeys()?(s.on("change",[i.displayNameKey],(function(e,n){"string"==typeof n&&T([],"UPDATE_METADATA")})),s.on("change",["profile"],(function(){T([],"UPDATE_METADATA")})),s.on("change",["friends"],(function(e,n,t){if(T([],"UPDATE_METADATA"),I.messenger&&void 0===e){var r=t.slice(-1)[0],o=s.friends&&s.friends[r];I.messenger.onFriendAdded(o)}})),s.on("remove",["friends"],(function(e,n){if(T([],"UPDATE_METADATA"),I.messenger){var t=n[1];t&&"channel"===n[2]&&I.messenger.onFriendRemoved(t,e)}})),s.on("change",["friends_pending"],(function(){T([],"UPDATE_METADATA")})),s.on("remove",["friends_pending"],(function(){T([],"UPDATE_METADATA")})),s.on("change",["settings"],(function(){T([],"UPDATE_METADATA")})),s.on("change",[i.tokenKey],(function(){I.isDeleted||"DELETED"===s[i.tokenKey]||T([],"UPDATE_TOKEN",{token:s[i.tokenKey]})})),I.mailbox=A.init({Store:v,store:I,updateMetadata:function(){T([],"UPDATE_METADATA")},updateDrive:function(){P("DRIVE_CHANGE",{path:["drive","filesData"]})},pinPads:function(e,n){v.pinPads(null,e,n)}},e,(function(e,n,t,r){var o=a.once(r||function(){});t.forEach((function(t){y(t,"MAILBOX_EVENT",{ev:e,data:n},o)}))})),Y.fire()):r())}))};const ue=(e,n,t,r)=>{if(I.accountModule)return I.accountModule;const o=F.init({userHash:n.userHash,anonHash:n.anonHash,cache:n.cache,form_seed:n.form_seed,store:I,broadcast:T,postMessage:y});I.accountModule=o;const{channel:i,onAccountReady:c,onAccountCacheReady:s,onDisconnect:u,onReconnect:l}=o;I.driveChannel=i,s((e=>{I.returned||=e,t(e)})),c((e=>{I.returned||=e,r(e)})),u((()=>{P("NETWORK_DISCONNECT")})),l((()=>{P("NETWORK_RECONNECT")}));return setInterval((function(){var e=[];const n=v.pad.getChannels();Object.keys(n).forEach((function(t){var r=n[t].clients;Array.prototype.push.apply(e,r)})),(e=a.deduplicateString(e)).forEach((function(e){var n=0,t=function(){if(n>=2)return v._removeClient(e),y(e,"TIMEOUT"),void console.error("TIMEOUT",e);n++;var r=setTimeout(t,3e4);y(e,"PING",null,(function(e){e&&console.error(e),clearTimeout(r)}))};t()}))}),12e4),o},le=(e,n,t,r)=>{const o=a.once((e=>{const n=L.init({account:e,store:I,broadcast:T,postMessage:y}),{onDriveReady:o,onDriveCacheReady:a,onDisconnect:i,onReconnect:c}=n;a((()=>{t(I.returned)})),o((()=>{r(I.returned)})),i((()=>{})),c((()=>{}))})),i=()=>{},c=ue(0,n,i,i);c.onAccountCacheReady((()=>{o(c)})),c.onAccountReady((()=>{o(c)}))};v.disableCache=function(e,n,t){n?d.disable():d.enable(),t()};var fe=!1;const de=e=>{if(I?.network?.historyKeeper)return setTimeout(e);const n=n=>{I.network||=n;n.join("0000000000000000000000000000000000").then((function(t){let r;t.members.forEach((e=>{16===e.length&&(r=e)})),n.historyKeeper=r,t.leave(),e()}),(function(n){console.error(n),e({error:"GET_HK"})}))};if(I.network)return n(I.network);I.networkPromise?.then(n)};var he=function(e,n,t){var r=function(){ie();let e=()=>{Z(0,0,(function(){c.send("NO_DRIVE",!0),n({})}))};if(t)return((e,n)=>{if(I.rpc)n(I.rpc);else{var t=N.CryptoAgility.signKeyPair(),r={edPublic:a.encodeBase64(t.publicKey),edPrivate:a.encodeBase64(t.secretKey)};l.create(I.network,r,(function(e,t){e?n({error:e}):(I.rpc=t,n(t))}))}})(0,e);e()};if(I.network)r();else{var o=C.getWebsocketURL();k.connect(o).then((function(e){I.network?(e.disconnect(),e=I.network):I.network=e,de((e=>{e?n(e):r()}))}),(function(e){console.error(e),n({error:"OFFLINE"})}))}};const pe=(e,n,t)=>{I.manager?G.reg((function(){de((r=>{I.network||=r,se(e,n,(()=>{t(n)}))}))})):se(e,n,(()=>{t(n)}))};return v.init=function(e,n,t){var r=a.once((function(r){n.driveEvents&&function(e){G.reg((()=>{-1===R.indexOf(e)&&R.push(e),I.driveEvents||(I.driveEvents=!0,re(I.proxy),Object.keys(I.manager.folders).forEach((function(e){var n=I.manager.folders[e].proxy;re(n,e)})))}))}(e),t(r)}));if(fe&&!I.returned&&n.cache)G.reg((function(){r({state:"ALREADY_INIT",returned:I.cacheReturned})}));else{if(fe)return I.networkTimeout&&y(e,"LOADING_DRIVE",{type:"offline"}),void Y.reg((function(){r({state:"ALREADY_INIT",returned:I.returned})}));n.disableCache&&d.disable(),n.noDrive&&!n.requires&&(n.requires="pad"),((e,n,t)=>{if(n.neverDrive||n.noDrive&&!n.userHash&&!n.anonHash)return n.neverDrive&&(I.neverCache=!0),void he(0,(e=>{e?.error&&c.send("NO_DRIVE_ERROR",!0),t(e)}),!!n.neverDrive);const r=n.requires,o=!n.noDrive;fe=!0,I.data=n;let s=e=>{1===Object.keys(I.proxy).length&&c.send("FIRST_APP_USE",!0),e&&e.error&&(fe=!1)};if("pad"===r&&!o)return void he(0,(function(r){if(r&&r.error)return;t(r);let o=a.once((()=>{le(0,n,(n=>{ce(e,n,s)}),(n=>{pe(e,n,s)}))}));v.pad.onJoined(o),J.reg(o)}));if("file"===r&&!o)return void he(0,(function(r){r&&r.error||(t(r),le(0,n,(n=>{ce(e,n,s)}),(n=>{pe(e,n,s)})))}));if("team"===r){let r=!1;const o=o=>a=>{r||(r=!0,M((e=>{o||Z(0,0,e())})).nThen((n=>{te(w,"team",n,e)})).nThen((e=>{!o&&I.modules.team&&I.modules.team.onReady(e)})).nThen((()=>{t(a),le(0,n,(n=>{ce(e,n,s)}),(n=>{pe(e,n,s)}))})))};return void ue(0,n,o(!0),o(!1))}if("drive"===r)return void le(0,n,(n=>{t(n),ce(e,n,s)}),(n=>{t(n),pe(e,n,s)}));let u=e=>{s(e);const n=i.prefersDriveRedirectKey,r=a.find(I,["proxy","settings","general",n]);e[n]=r,t(e)};le(0,n,(n=>{ce(e,n,u)}),(n=>{pe(e,n,u)}))})(e,n,a.once((e=>{"GET_HK"!==e.error?r(e):r({error:"ERROR"})})))}},Y.reg((function(){var e=+new Date-7776e6;d.getKeys((function(n,t){if(n)console.error(n);else{var r=function(){if(t.length){var n=t.pop();d.getTime(n,(function(t,o){t?r():!o||o<e?d.clearChannel(n,r()):r()}))}};r()}}))})),v.disconnect=function(){globalThis.accountDeletion||I.network&&I.network.disconnect()},v}}})(An(),Be(),Qe(),Un(),ae(),ee(),q(),De(),je(),_n(),Nn(),Cn(),he(),ze(),Yn,tt,Rt,Pt(),kt(),Mt(),Ft(),jn(),Lt(),Ht(),jt(),Ut(),Qt(),ar,pn(),B(),K(),N(),O(),S(),u(),We()),rr}var cr,sr,ur=ir(),lr=n({__proto__:null,default:r(ur)},[ur]);var fr,dr,hr,pr,vr,yr={exports:{}};function mr(){return fr||(fr=1,function(e){(()=>{const n=(e,n={})=>({create:function(t,r,o){var a,i=[],c=e.mkEvent(!0);t.reg((function(e){if(!a){var n=e.data;if("_READY"===n)return r("_READY"),a=!0,c.fire(),void i.forEach((function(e){t.fire(e)}));i.push(n)}}));var s={},u={},l={},f=[],d={},h={};h.query=function(e,n,t,o){var a,i=Math.random().toString(16).replace("0.","")+Math.random().toString(16).replace("0.",""),s=(o=o||{}).timeout||3e4;s>0&&(a=setTimeout((function(){delete u[i],t("TIMEOUT")}),s)),l[i]=function(e){clearTimeout(a),delete l[i],e&&(delete u[i],t("UNHANDLED"))},u[i]=function(e,n){delete u[i],t(void 0,e.content,n)},c.reg((function(){var t={txid:i,content:n,q:e,raw:o.raw};r(o.raw?t:JSON.stringify(t))}))};var p=h.event=function(e,n,t){t=t||{},c.reg((function(){var o={content:n,q:e,raw:t.raw};r(t.raw?o:JSON.stringify(o))}))};h.on=function(e,n,t){var o=function(e,t,o){n(e.content,(function(n){var t={txid:e.txid,content:n};r(o?t:JSON.stringify(t))}),t)};return(s[e]=s[e]||[]).push(o),t||p("EV_REGISTER_HANDLER",e),{stop:function(){var n=s[e].indexOf(o);-1!==n&&s[e].splice(n,1)}}},h.whenReg=function(e,n,t){var r=t;f.indexOf(e)>-1?n():r=!0,r&&(d[e]=d[e]||[]).push(n)},h.onReg=function(e,n){h.whenReg(e,n,!0)},h.on("EV_REGISTER_HANDLER",(function(e){d[e]&&(d[e].forEach((function(e){e()})),delete d[e]),f.push(e)}));var v=!1;h.onReady=function(e){v?e():"function"==typeof e&&h.on("EV_RPC_READY",(function(){v=!0,e()}))},h.ready=function(){h.whenReg("EV_RPC_READY",(function(){h.event("EV_RPC_READY")}))};var y=[""];n.httpUnsafeOrigin?(y.push(n.httpUnsafeOrigin),y.push(n.httpSafeOrigin)):globalThis.location&&y.push(globalThis.location.origin),t.reg((function(e){if(a&&e.data&&"_READY"!==e.data&&y.includes(e.origin)){var n;try{n="object"==typeof e.data?e.data:JSON.parse(e.data)}catch(e){return void console.warn(e)}void 0!==n.ack?l[n.txid]&&l[n.txid](!n.ack):"string"==typeof n.q?s[n.q]?(n.txid&&r(JSON.stringify({txid:n.txid,ack:!0})),s[n.q].forEach((function(t){t(n||JSON.parse(e.data),e,n&&n.raw),n=void 0}))):n.txid&&r(JSON.stringify({txid:n.txid,ack:!1})):void 0===n.q&&u[n.txid]&&u[n.txid](n,e)}})),r("_READY"),o(h)}});e.exports&&(e.exports=n(ee()))})()}(yr)),yr.exports}function gr(){if(hr)return dr;hr=1;var e;return dr=((e,n,t)=>{const r={};let o,a,i={},c=()=>{};return r.init=n=>{if(a)return;a=e.create({query:(e,n,t,r)=>{r=r||function(){},i[e].chan.query(n,t,(function(e,n){r(e?{error:e}:n)}))},broadcast:(e,n,t,r)=>{r=r||function(){},Object.keys(i).forEach((o=>{-1===e.indexOf(+o)&&i[o].chan.query(n,t,((e,n)=>{r(e?{error:e}:n)}))}))}}),c=n},r.initClient=(e,r)=>{if(!a)return console.error("Not initialized"),void r("NOT_INIT");const{postMsg:s}=e,u=t.mkEvent(),l=Number(Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)),f=()=>{a._removeClient(l)};n.create(u,s,(function(e){let n=i[l]={chan:e};console.debug("SharedW Channel created"),Object.keys(a.queries).forEach((function(t){"CONNECT"!==t&&"JOIN_PAD"!==t&&"SEND_PAD_MSG"!==t&&"STOPWORKER"!==t&&e.on(t,(function(e,r){try{a.queries[t](l,e,r)}catch(n){console.error("Error in webworker when executing query "+t),console.error(n),console.log(e)}"DISCONNECT"===t&&(f(),globalThis.accountDeletion&&globalThis.accountDeletion===n.id&&(a=void 0,o=void 0))}))})),e.on("STOPWORKER",(function(e,n){c(),a.queries.DISCONNECT(l,e,n)})),e.on("CONNECT",(function(e,n){console.debug("Connecting to store..."),a.queries.CONNECT(l,e,(function(e){if(e&&"ALREADY_INIT"===e.state)return console.debug("Store already exists!"),o=o||e.returned,void n(e);o=e,n(e)}))})),e.on("JOIN_PAD",(function(e,t){n.channelId=e.channel;try{a.queries.JOIN_PAD(l,e,t)}catch(n){console.error("Error in webworker when executing query JOIN_PAD"),console.error(n),console.log(e)}})),e.on("SEND_PAD_MSG",(function(e,t){var r={msg:e,channel:n.channelId};try{a.queries.SEND_PAD_MSG(l,r,t)}catch(e){console.error("Error in webworker when executing query SEND_PAD_MSG"),console.error(e),console.log(r)}})),r(u,f)}),!0)},r})((sr||(sr=1,e=ir(),cr={create:function(n){var t=e.create(n),r={},o=r.queries={CONNECT:t.init,DISCONNECT:t.disconnect,PING:function(e,n,t){t()},CACHE_DISABLE:t.disableCache,GET_PIN_LIMIT:t.getPinLimit,PIN_PADS:t.pinPads,UNPIN_PADS:t.unpinPads,GET_PINNED_USAGE:t.getPinnedUsage,GET_DELETED_PADS:t.getDeletedPads,UPLOAD_CHUNK:t.uploadChunk,UPLOAD_COMPLETE:t.uploadComplete,UPLOAD_STATUS:t.uploadStatus,UPLOAD_CANCEL:t.uploadCancel,ANON_RPC_MESSAGE:t.anonRpcMsg,GET_FILE_SIZE:t.getFileSize,GET_MULTIPLE_FILE_SIZE:t.getMultipleFileSize,GET:t.get,SET:t.set,ADD_PAD:t.addPad,SET_PAD_TITLE:t.setPadTitle,MOVE_TO_TRASH:t.moveToTrash,RESET_DRIVE:t.resetDrive,GET_METADATA:t.getMetadata,IS_ONLY_IN_SHARED_FOLDER:t.isOnlyInSharedFolder,SET_DISPLAY_NAME:t.setDisplayName,SET_PAD_ATTRIBUTE:t.setPadAttribute,GET_PAD_ATTRIBUTE:t.getPadAttribute,SET_ATTRIBUTE:t.setAttribute,GET_ATTRIBUTE:t.getAttribute,LIST_ALL_TAGS:t.listAllTags,GET_TEMPLATES:t.getTemplates,GET_SECURE_FILES_LIST:t.getSecureFilesList,GET_PAD_DATA:t.getPadData,GET_PAD_DATA_FROM_CHANNEL:t.getPadDataFromChannel,GET_STRONGER_HASH:t.getStrongerHash,INCREMENT_TEMPLATE_USE:t.incrementTemplateUse,GET_SHARED_FOLDER:t.getSharedFolder,ADD_SHARED_FOLDER:t.addSharedFolder,LOAD_SHARED_FOLDER:t.loadSharedFolderAnon,RESTORE_SHARED_FOLDER:t.restoreSharedFolder,UPDATE_SHARED_FOLDER_PASSWORD:t.updateSharedFolderPassword,ANSWER_FRIEND_REQUEST:t.answerFriendRequest,SEND_FRIEND_REQUEST:t.sendFriendRequest,ANON_GET_PREVIEW_CONTENT:t.anonGetPreviewContent,OO_COMMAND:t.onlyoffice.execCommand,MAILBOX_COMMAND:t.mailbox.execCommand,UNIVERSAL_COMMAND:t.universal.execCommand,SEND_PAD_MSG:t.pad.sendMessage,JOIN_PAD:t.pad.join,LEAVE_PAD:t.pad.leave,REMOVE_OWNED_CHANNEL:t.pad.destroy,CLEAR_OWNED_CHANNEL:t.pad.clear,CORRUPTED_CACHE:t.pad.onCorruptedCache,GET_LAST_HASH:t.pad.getLastHash,GET_FULL_HISTORY:t.getFullHistory,GET_HISTORY:t.getHistory,GET_HISTORY_RANGE:t.getHistoryRange,IS_NEW_CHANNEL:t.isNewChannel,CONTACT_PAD_OWNER:t.contactPadOwner,GIVE_PAD_ACCESS:t.givePadAccess,BURN_PAD:t.burnPad,GET_PAD_METADATA:t.pad?.getMetadata,SET_PAD_METADATA:t.pad?.setMetadata,CHANGE_PAD_PASSWORD_PIN:t.changePadPasswordPin,GET_SNAPSHOT:t.getSnapshot,DELETE_MAILBOX_MESSAGE:t.deleteMailboxMessage,DRIVE_USEROBJECT:t.userObjectCommand,GET_DRIVE:t.drive.get,SET_DRIVE:t.drive.set,MIGRATE_ANON_DRIVE:t.drive.migrateAnon,HAS_DRIVE:t.drive.exists,DELETE_ACCOUNT:t.deleteAccount,REMOVE_OWNED_PADS:t.removeOwnedPads,ADMIN_RPC:t.adminRpc,ADMIN_ADD_MAILBOX:t.addAdminMailbox};return r.query=function(e,n,t){o[e]?o[e]("0",n,t):console.error("UNHANDLED_STORE_RPC")},r._removeClient=t._removeClient,r}}),cr),mr(),ee()),dr}var Er,br,Ar=function(){if(vr)return pr;vr=1;const e=gr();return pr={start:n=>{let t=!1,r=()=>{globalThis.close()};globalThis.window=globalThis,addEventListener("connect",(o=>{console.debug("New SharedWorker client");const a=o.ports[0],i=e=>{a.postMessage(e)};let c,s=!1,u=()=>{};a.onmessage=function(o){if("INIT"===o.data?.type){if((o=>{t||(n(o),e.init(r),t=!0)})(o.data.cfg),s)return;s=!0,e.initClient({postMsg:i},(function(e,n){c=e,u=n,i("SW_READY")}))}else"CLOSE"===o.data?(console.debug("leave"),u()):c&&c.fire(o)}}))}}}();var _r,wr,Or=function(){if(br)return Er;br=1;const e=gr();return Er={start:n=>{let t,r=!1;const o=()=>{globalThis.close()},a=e=>{postMessage(e)};globalThis.window=globalThis,onmessage=function(i){if("INIT"===i.data?.type){let c=i.data.cfg;if(r)return;return n(c),e.init(o),r=!0,void e.initClient({postMsg:a},(function(e){t=e,a("WW_READY")}))}t&&t.fire(i)}}}}();var Dr=function(){if(wr)return _r;wr=1;const e=gr(),n=ee();return _r={start:t=>{let r,o=!1,a=!1;const i=n.mkEvent(),c=()=>{a=!0},s=e=>{a||i.fire(e)};return{init:n=>{o||(t(n),e.init(c),o=!0,e.initClient({postMsg:s},(function(e){r=e,s("STORE_READY")})))},onMessage:e=>{i.reg((n=>{setTimeout((()=>{e(n)}))}))},query:e=>{r&&!a&&r.fire({data:e,origin:""})}}}}}(),Sr=Un(),Tr=n({__proto__:null,default:r(Sr)},[Sr]),xr=jn(),Cr=n({__proto__:null,default:r(xr)},[xr]),Nr=Pt(),Ir=n({__proto__:null,default:r(Nr)},[Nr]),Rr=kt(),Pr=n({__proto__:null,default:r(Rr)},[Rr]),kr=Qt(),Mr=n({__proto__:null,default:r(kr)},[kr]);let Fr=e=>{[xe,tn,Q,en,G,Tr,En,ln,Me,Ir,Pr,Mr,lr,Ae,Cr,tr].forEach((n=>{"function"==typeof n.setCustomize&&n.setCustomize(e)}))},Lr="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope,Kr="undefined"!=typeof SharedWorkerGlobalScope&&self instanceof SharedWorkerGlobalScope;e.store={},Kr?Ar.start(Fr):Lr?Or.start(Fr):("undefined"!=typeof module&&module.exports,e.store=Dr.start(Fr)),e.start=Fr}));
